
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u S·ª± c·ªë L∆∞·ªõi ƒëi·ªán (Geo & Weather v2.1)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: #eef2f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        h2 { margin-top: 0; color: #b71c1c; text-align: center; margin-bottom: 5px; } /* M√†u ƒë·ªè c·∫£nh b√°o */
        .subtitle { text-align: center; color: #666; font-size: 13px; margin-bottom: 20px; font-style: italic; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
        textarea { width: 100%; height: 50px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; }
        input[type="datetime-local"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        
        button { width: 100%; padding: 12px; background-color: #b71c1c; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        button:hover { background-color: #8e1515; }
        button:disabled { background-color: #ccc; }

        #result { margin-top: 25px; display: none; }
        .section-title { font-weight: bold; font-size: 14px; color: #444; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; }
        
        /* Grid Layout cho th√¥ng s·ªë */
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .param-box { background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 4px solid #ccc; }
        .param-label { font-size: 12px; color: #666; }
        .param-value { font-size: 18px; font-weight: bold; color: #222; margin-top: 2px; }
        .param-unit { font-size: 12px; color: #888; font-weight: normal; }

        /* Highlight box */
        .danger-box { border-left-color: #d32f2f; background-color: #ffebee; }
        .safe-box { border-left-color: #2e7d32; }

        .loading { text-align: center; color: #666; display: none; margin-top: 10px; }
        .address-text { font-size: 14px; margin-bottom: 5px; }
        .coords-debug { font-family: monospace; font-size: 12px; color: #d32f2f; background: #ffebee; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2>‚ö° ƒêi·ªÅu tra S·ª± c·ªë L∆∞·ªõi ƒëi·ªán</h2>
    <div class="subtitle">Tra c·ª©u ƒê·ªãa ch·ªâ & D·ªØ li·ªáu Th·ªùi ti·∫øt Qu√° kh·ª©</div>
    
    <div class="form-group">
        <label>1. T·ªça ƒë·ªô c·ªôt ƒëi·ªán/s·ª± c·ªë:</label>
        <textarea id="rawCoords" placeholder="V√≠ d·ª•: 10,8238318, 106,7448612"></textarea>
    </div>

    <div class="form-group">
        <label>2. Th·ªùi ƒëi·ªÉm x·∫£y ra s·ª± c·ªë:</label>
        <input type="datetime-local" id="queryTime">
    </div>

    <button id="btnSearch" onclick="processAndSearch()">üîç Ph√¢n t√≠ch d·ªØ li·ªáu</button>
    <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu v·ªá tinh & tr·∫°m quan tr·∫Øc...</div>

    <div id="result">
        <div class="section-title">üìç V·ªã tr√≠ ƒë·ªãa l√Ω</div>
        <div id="addressText" class="address-text"></div>
        <span id="parsedCoords" class="coords-debug"></span>

        <div class="section-title">‚õàÔ∏è Th·ªùi ti·∫øt t·∫°i th·ªùi ƒëi·ªÉm s·ª± c·ªë</div>
        
        <div id="thunderAlert" style="display:none; background:#d32f2f; color:white; padding:10px; border-radius:6px; margin-bottom:15px; text-align:center; font-weight:bold;">
            ‚ö†Ô∏è C·∫¢NH B√ÅO: C√ì D√îNG S√âT / B√ÉO (Thunderstorm)
        </div>

        <div class="weather-grid">
            <div class="param-box" id="windBox">
                <div class="param-label">T·ªëc ƒë·ªô Gi√≥ TB (10m)</div>
                <div class="param-value"><span id="wSpeed">--</span> <span class="param-unit">km/h</span></div>
            </div>
            <div class="param-box danger-box">
                <div class="param-label">Gi√≥ gi·∫≠t m·∫°nh nh·∫•t (Gusts)</div>
                <div class="param-value"><span id="wGust">--</span> <span class="param-unit">km/h</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">H∆∞·ªõng gi√≥</div>
                <div class="param-value" style="font-size:16px;"><span id="wDirTxt">--</span> <span class="param-unit" id="wDirDeg">(--¬∞)</span></div>
            </div>

            <div class="param-box" id="rainBox">
                <div class="param-label">L∆∞·ª£ng m∆∞a (Precipitation)</div>
                <div class="param-value"><span id="wRain">--</span> <span class="param-unit">mm</span></div>
            </div>
            
            <div class="param-box">
                <div class="param-label">Nhi·ªát ƒë·ªô</div>
                <div class="param-value"><span id="wTemp">--</span> <span class="param-unit">¬∞C</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">ƒê·ªô ·∫©m</div>
                <div class="param-value"><span id="wHum">--</span> <span class="param-unit">%</span></div>
            </div>
        </div>
        
        <div style="margin-top:15px; padding:10px; background:#e3f2fd; border-radius:6px;">
            <div class="param-label">Di·ªÖn bi·∫øn th·ªùi ti·∫øt:</div>
            <div id="wDesc" style="font-weight:600; color:#0d47a1;">--</div>
        </div>

        <div style="font-size: 11px; color: #888; margin-top: 15px; text-align: center;">
            D·ªØ li·ªáu cung c·∫•p b·ªüi Open-Meteo Archive API. <br>
            L∆∞u √Ω: S·ªë li·ªáu l√† ∆∞·ªõc t√≠nh m√¥ ph·ªèng (Reanalysis), d√πng ƒë·ªÉ tham kh·∫£o ƒëi·ªÅu tra s∆° b·ªô.
        </div>
    </div>
</div>

<script>
    // Set default time to Now
    window.onload = function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('queryTime').value = now.toISOString().slice(0,16);
    };

    async function processAndSearch() {
        const rawInput = document.getElementById('rawCoords').value;
        const timeInput = document.getElementById('queryTime').value;
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const btn = document.getElementById('btnSearch');

        resultDiv.style.display = 'none';
        
        if (!rawInput.trim()) { alert("Ch∆∞a nh·∫≠p t·ªça ƒë·ªô!"); return; }
        if (!timeInput) { alert("Ch∆∞a ch·ªçn th·ªùi gian!"); return; }

        // --- 1. X·ª¨ L√ù T·ªåA ƒê·ªò ---
        let lat, lon;
        try {
            let cleanStr = rawInput.trim();
            let parts;
            if (cleanStr.includes('.') && !cleanStr.includes(',,')) {
                parts = cleanStr.split(/[\s,]+/);
            } else {
                if (cleanStr.includes(', ')) { let temp = cleanStr.replace(', ', '|'); parts = temp.split('|'); }
                else { let rawParts = cleanStr.split(','); if (rawParts.length === 4) parts = [rawParts[0]+'.'+rawParts[1], rawParts[2]+'.'+rawParts[3]]; else if (rawParts.length === 2) parts = rawParts; }
            }
            const numbers = parts.map(p => parseFloat(p.replace(/,/g, '.').replace(/[^0-9.-]/g, ''))).filter(n => !isNaN(n));
            if (numbers.length < 2) throw new Error("Format");
            lat = numbers[0]; lon = numbers[1];
        } catch (e) { alert("L·ªói t·ªça ƒë·ªô. Vui l√≤ng ki·ªÉm tra l·∫°i."); return; }

        document.getElementById('parsedCoords').textContent = `LAT: ${lat} | LON: ${lon}`;

        // --- 2. G·ªåI API ---
        loadingDiv.style.display = 'block';
        btn.disabled = true;

        try {
            const addrPromise = fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`, { headers: {'Accept-Language': 'vi'} }).then(res => res.json());
            const weatherPromise = fetchWeather(lat, lon, timeInput);

            const [addrData, weatherData] = await Promise.all([addrPromise, weatherPromise]);

            // Hi·ªÉn th·ªã ƒê·ªãa ch·ªâ
            document.getElementById('addressText').textContent = addrData.display_name || "Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ";

            // Hi·ªÉn th·ªã Th·ªùi ti·∫øt
            if (weatherData) {
                document.getElementById('wTemp').textContent = weatherData.temperature_2m;
                document.getElementById('wHum').textContent = weatherData.relative_humidity_2m;
                
                // M∆∞a
                document.getElementById('wRain').textContent = weatherData.precipitation;
                document.getElementById('rainBox').style.borderLeftColor = weatherData.precipitation > 0 ? '#1976d2' : '#ccc';

                // Gi√≥
                document.getElementById('wSpeed').textContent = weatherData.wind_speed_10m;
                document.getElementById('wGust').textContent = weatherData.wind_gusts_10m;
                
                // H∆∞·ªõng gi√≥
                const dir = weatherData.wind_direction_10m;
                document.getElementById('wDirDeg').textContent = `(${dir}¬∞)`;
                document.getElementById('wDirTxt').textContent = getWindDirection(dir);
                
                // M√£ th·ªùi ti·∫øt & C·∫£nh b√°o S√©t
                const wCode = weatherData.weather_code;
                document.getElementById('wDesc').textContent = getWeatherDesc(wCode);
                
                // M√£ 95, 96, 99 l√† D√¥ng b√£o
                if ([95, 96, 99].includes(wCode)) {
                    document.getElementById('thunderAlert').style.display = 'block';
                } else {
                    document.getElementById('thunderAlert').style.display = 'none';
                }
            } else {
                document.getElementById('wDesc').textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu cho th·ªùi gian n√†y.";
            }

            resultDiv.style.display = 'block';

        } catch (err) {
            alert("L·ªói: " + err.message);
        } finally {
            loadingDiv.style.display = 'none';
            btn.disabled = false;
        }
    }

    async function fetchWeather(lat, lon, isoTimeStr) {
        const inputDate = new Date(isoTimeStr);
        const today = new Date();
        today.setHours(0,0,0,0);
        const dateStr = isoTimeStr.split('T')[0];
        const isPast = inputDate < today;
        
        // Th√™m tham s·ªë: wind_speed_10m, wind_direction_10m, wind_gusts_10m, precipitation, weather_code
        const params = "hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,precipitation";
        
        let url = isPast 
            ? `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&${params}&timezone=auto`
            : `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&${params}&timezone=auto`;

        const res = await fetch(url);
        const data = await res.json();
        if (!data.hourly) return null;

        const hourIndex = inputDate.getHours();
        return {
            temperature_2m: data.hourly.temperature_2m[hourIndex],
            relative_humidity_2m: data.hourly.relative_humidity_2m[hourIndex],
            weather_code: data.hourly.weather_code[hourIndex],
            wind_speed_10m: data.hourly.wind_speed_10m[hourIndex],
            wind_direction_10m: data.hourly.wind_direction_10m[hourIndex],
            wind_gusts_10m: data.hourly.wind_gusts_10m[hourIndex],
            precipitation: data.hourly.precipitation[hourIndex]
        };
    }

    function getWindDirection(deg) {
        if (deg >= 337.5 || deg < 22.5) return "B·∫Øc (N)";
        if (deg >= 22.5 && deg < 67.5) return "ƒê√¥ng B·∫Øc (NE)";
        if (deg >= 67.5 && deg < 112.5) return "ƒê√¥ng (E)";
        if (deg >= 112.5 && deg < 157.5) return "ƒê√¥ng Nam (SE)";
        if (deg >= 157.5 && deg < 202.5) return "Nam (S)";
        if (deg >= 202.5 && deg < 247.5) return "T√¢y Nam (SW)";
        if (deg >= 247.5 && deg < 292.5) return "T√¢y (W)";
        if (deg >= 292.5 && deg < 337.5) return "T√¢y B·∫Øc (NW)";
        return "--";
    }

    function getWeatherDesc(code) {
        const map = {
            0: "Quang ƒë√£ng (Clear sky)", 1: "N·∫Øng nh·∫π", 2: "C√≥ m√¢y", 3: "√Çm u",
            45: "S∆∞∆°ng m√π", 48: "S∆∞∆°ng mu·ªëi",
            51: "M∆∞a ph√πn nh·∫π", 53: "M∆∞a ph√πn v·ª´a", 55: "M∆∞a ph√πn d√†y",
            61: "M∆∞a nh·ªè", 63: "M∆∞a v·ª´a", 65: "M∆∞a to",
            80: "M∆∞a r√†o nh·∫π", 81: "M∆∞a r√†o v·ª´a", 82: "M∆∞a r√†o r·∫•t to",
            95: "‚ö° D√îNG S√âT (Thunderstorm)", 
            96: "‚ö° D√îNG S√âT + M∆∞a ƒë√° nh·∫π", 
            99: "‚ö° D√îNG S√âT + M∆∞a ƒë√° n·∫∑ng"
        };
        return map[code] || `M√£: ${code}`;
    }
</script>

</body>
</html>
