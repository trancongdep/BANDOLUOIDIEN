
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>H·ªá Th·ªëng L∆∞·ªõi ƒêi·ªán - Version 1.50</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* CSS CHU·∫®N (Gi·ªØ nguy√™n v1.45) */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        #sidebar { 
            position: fixed; top: 0; left: -100%; width: 90%; max-width: 450px; 
            bottom: calc(30px + env(safe-area-inset-bottom, 10px));
            background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); 
            transition: left 0.3s ease-in-out; display: flex; flex-direction: column;
        }
        #sidebar.active { left: 0; }

        .header { background: #004d40; color: white; padding: 15px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 1.1rem; }
        .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        .content { padding: 10px; overflow-y: auto; flex: 1; background: #fafafa; }
        
        .footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; min-height: 30px;
            padding-top: 5px; padding-bottom: env(safe-area-inset-bottom, 10px);
            background: #212121; color: #eceff1; 
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; border-top: 3px solid #ff6f00; z-index: 4000;
        }

        #menu-toggle {
            position: absolute; top: 10px; left: 10px; z-index: 2000;
            background: #004d40; color: white; border: none;
            padding: 10px 15px; border-radius: 4px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold;
        }

        .accordion {
            background-color: #eee; color: #444; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left;
            outline: none; font-size: 0.95rem; font-weight: bold; transition: 0.4s; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
        }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        .accordion:after { content: '\002B'; font-weight: bold; float: right; margin-left: 5px; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-bottom: 1px solid #ddd; }

        label { font-weight: 600; font-size: 0.85rem; display: block; margin: 8px 0 4px; color: #333; }
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; color: white; }
        .btn-check { background: #00796b; }
        .btn-merge { background: #2e7d32; }
        .btn-replace { background: #c62828; }
        .btn-find { background: #d32f2f; }
        .btn-add { background: #1565c0; margin-top: 10px; }
        .btn-pick { background: #ff9800; color: white; width: auto; padding: 5px 10px; font-size: 0.8rem; margin-left: 5px; }
        .btn-export { background: #2e7d32; margin-top: 5px; }
        input, select { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .tab-container { display: flex; margin-bottom: 10px; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { color: #004d40; border-bottom: 3px solid #004d40; }
        .edit-section { display: none; }
        .edit-section.active { display: block; }
        #console { background: #212121; color: #00e676; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 100px; overflow-y: auto; margin-bottom: 10px; }
        #upload-actions { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; font-size: 0.9rem; }
        .radio-group label { margin: 0; font-weight: normal; cursor: pointer; display: flex; align-items: center; }
        .radio-group input { width: auto; margin-right: 5px; margin-bottom: 0; }

        .legend { 
            background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 5px; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); font-size: 0.75rem; min-width: 130px; 
            display: block; margin-right: 10px;
            margin-bottom: calc(45px + env(safe-area-inset-bottom, 10px)) !important;
        }
        .legend h4 { margin: 0 0 5px 0; color: #004d40; font-size: 0.85rem; border-bottom: 2px solid #b2dfdb; padding-bottom: 3px; font-weight: bold; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-icon { width: 14px; height: 14px; margin-right: 6px; display: inline-block; vertical-align: middle; border: 1px solid #999; }

        .fault-box { 
            display: none; background: white; padding: 15px; border-radius: 8px; 
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); border-left: 5px solid #d32f2f; 
            width: 260px; font-size: 0.9rem; margin-right: 10px;
            margin-bottom: calc(45px + env(safe-area-inset-bottom, 10px)) !important;
        }
        .fault-header { color: #d32f2f; font-weight: bold; font-size: 1rem; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .fault-row { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
        .fault-label { font-weight: bold; color: #555; }
        .btn-close-fault { background: #eee; border: none; padding: 2px 8px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }

        #custom-confirm { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .win-dialog { background: #f0f0f0; width: 90%; max-width: 400px; border-radius: 4px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: popIn 0.2s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .win-header { background: white; padding: 10px 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; font-weight: bold; }
        .win-body { padding: 20px; background: white; display: flex; align-items: center; gap: 15px; }
        .win-icon { font-size: 2rem; color: #0078d7; }
        .win-footer { padding: 10px 15px; background: #f3f3f3; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #ddd; }
        .win-btn { padding: 6px 20px; border: 1px solid #ccc; cursor: pointer; border-radius: 2px; }
        .win-btn.primary { background: #0078d7; color: white; border-color: #005a9e; }

        .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.6); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; }
        .icon-mc-on { background: #ff0000; border: 2px solid white; border-radius: 2px; z-index: 1000; }
        .icon-mc-off { background: #388e3c; border: 2px solid white; border-radius: 2px; z-index: 1000; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; }
        .icon-moc { background: #7b1fa2; border-radius: 0px; width: 8px !important; height: 8px !important; margin-left: -4px !important; margin-top: -4px !important; }
        .icon-cot-moc { background: #4a148c; border-radius: 2px 2px 0 0; border-bottom: none; }
        .icon-ham-cap { background: #5d4037; border-radius: 4px; font-family: sans-serif; }
        .warning-msg { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; border: 1px solid #ffcdd2; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="map" style="flex:1;"></div>
    <button id="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i> MENU</button>

    <div id="custom-confirm">
        <div class="win-dialog">
            <div class="win-header"><span>Th√¥ng b√°o</span><button style="border:none;background:none;font-size:1.2rem;cursor:pointer;" onclick="closeWinDialog()">√ó</button></div>
            <div class="win-body"><i class="fas fa-question-circle win-icon"></i><span id="win-msg">...</span></div>
            <div class="win-footer"><button class="win-btn primary" id="win-btn-yes">ƒê·ªìng √Ω</button><button class="win-btn" onclick="closeWinDialog()">H·ªßy</button></div>
        </div>
    </div>

    <div id="sidebar">
        <div class="header">
            <h2>QU·∫¢N L√ù L∆Ø·ªöI ƒêI·ªÜN</h2>
            <button class="close-btn" onclick="closeSidebar()">√ó</button>
        </div>
        <div class="content">
            <button class="accordion">1. C·∫≠p nh·∫≠t & Xu·∫•t Excel</button>
            <div class="panel" id="panel-update">
                <label>Nh·∫≠p t·ª´ File:</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn btn-check" onclick="window.analyzeFiles()">Ki·ªÉm tra</button>
                <div id="console">Ch·ªù file...</div>
                <div id="upload-actions" style="display:none;">
                    <button class="action-btn btn-merge" onclick="window.showUploadConfirm('merge')">G·ªòP D·ªÆ LI·ªÜU</button>
                    <button class="action-btn btn-replace" onclick="window.showUploadConfirm('replace')">X√ìA & GHI M·ªöI</button>
                </div>
                <hr>
                <button class="action-btn btn-export" onclick="window.exportToExcel()">XU·∫§T EXCEL</button>
            </div>

            <button class="accordion">2. Nh·∫≠p li·ªáu (Th√™m m·ªõi)</button>
            <div class="panel" id="panel-entry">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('tab-pole')">Tr·ª•/MC</button>
                    <button class="tab-btn" onclick="switchTab('tab-seg')">ƒêo·∫°n</button>
                    <button class="tab-btn" onclick="switchTab('tab-cir')">M·∫°ch</button>
                </div>
                <div id="tab-pole" class="edit-section active">
                    <label>T√™n Tuy·∫øn:</label><input type="text" id="inp-pole-route" placeholder="VD: MAYCAT" oninput="this.value=this.value.toUpperCase()">
                    <label>T√™n Tr·ª•/MC:</label><input type="text" id="inp-pole-name" placeholder="VD: MC_171">
                    <label>Lo·∫°i:</label><select id="inp-pole-type"><option value="TRU_DO">Tr·ª• ƒê·ª°</option><option value="TRU_NEO">Tr·ª• N√©o</option><option value="MC">M√°y C·∫Øt</option><option value="MOC">M·ªëc C√°p</option><option value="HAM_CAP">H·∫ßm C√°p</option></select>
                    <label>T·ªça ƒë·ªô: <button class="btn-pick" onclick="enableMapPick()">üìç Ch·∫•m b·∫£n ƒë·ªì</button></label>
                    <div style="display:flex;gap:5px;"><input type="number" id="inp-lat" placeholder="Lat"><input type="number" id="inp-lng" placeholder="Lng"></div>
                    <button class="action-btn btn-add" onclick="window.savePole()">L∆ØU TR·ª§</button>
                </div>
                <div id="tab-seg" class="edit-section">
                    <label>M√£ ƒêo·∫°n:</label><input type="text" id="inp-seg-id" placeholder="VD: SEG_01">
                    <label>ƒêi·ªÉm ƒê·∫¶U:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line1" onchange="updatePoleSelect('sel-seg-line1','sel-seg-pole1')"></select><select id="sel-seg-pole1"></select></div>
                    <label>ƒêi·ªÉm CU·ªêI:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line2" onchange="updatePoleSelect('sel-seg-line2','sel-seg-pole2')"></select><select id="sel-seg-pole2"></select></div>
                    <label>Lo·∫°i:</label><select id="inp-seg-type"><option value="NOI">D√¢y N·ªïi</option><option value="NGAM">C√°p Ng·∫ßm</option></select>
                    <button class="action-btn btn-add" onclick="window.saveSegment()">L∆ØU ƒêO·∫†N</button>
                </div>
                <div id="tab-cir" class="edit-section">
                    <label>T√™n M·∫°ch:</label><input type="text" id="inp-cir-id" list="list-circuits"><datalist id="list-circuits"></datalist>
                    <label>Ch·ªçn ƒêo·∫°n:</label><select id="sel-cir-seg"></select>
                    <button class="action-btn btn-add" onclick="window.saveCircuitItem()">TH√äM V√ÄO M·∫†CH</button>
                </div>
            </div>

            <button class="accordion">3. V·∫≠n h√†nh & T√¨m S·ª± C·ªë</button>
            <div class="panel">
                <label>Ch·ªçn M·∫°ch:</label>
                <select id="circuitSelect" onchange="window.zoomToCircuit()"><option value="">-- To√†n c·∫£nh --</option></select>
                <div style="margin-top:10px;">Tr·∫°ng th√°i: <span id="status-text" style="font-weight:bold;">---</span></div>
                
                <div id="circuit-info" style="font-size:0.8rem; color:#00695c; margin-top:5px; font-weight:bold;"></div>

                <div style="border-top:1px dashed #ccc; margin:15px 0;"></div>
                <label>Nh·∫≠p Km s·ª± c·ªë:</label><input type="number" id="faultKm" step="0.01" />
                <div class="radio-group"><label><input type="radio" name="faultDir" value="start" checked> T·ª´ ƒê·∫ßu</label><label><input type="radio" name="faultDir" value="end"> T·ª´ Cu·ªëi</label></div>
                <button class="action-btn btn-find" onclick="window.findFault()">T√åM V·ªä TR√ç</button>
                <div id="result" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div class="footer">Copyright TCD software @2025 - Version 1.50</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, push, child, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.set = set; window.update = update; window.ref = ref; window.onValue = onValue; window.push = push; window.child = child; window.get = get;
        window.listenCloud();
    </script>

    <script>
        let map = L.map('map', { zoomControl: false }).setView([10.762, 106.660], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {opacity:0.4}).addTo(map);
        
        let layers = { 
            main: L.layerGroup().addTo(map), 
            minor: L.layerGroup().addTo(map), 
            important: L.layerGroup().addTo(map),
            mc: L.layerGroup().addTo(map), 
            fault: L.layerGroup().addTo(map) 
        };
        
        let appData = { poles: {}, segments: {}, circuits: {}, states: {}, mcStates: {} }; 
        let stagingData = null;
        let currentPath = []; let currentPathTotalDist = 0;
        let isPickingMap = false;
        
        // ZOOM VISIBILITY
        const ZOOM_THRESHOLD = 15;
        function updateLayerVisibility() {
            let z = map.getZoom();
            if (z < ZOOM_THRESHOLD) {
                if (map.hasLayer(layers.minor)) map.removeLayer(layers.minor);
            } else {
                if (!map.hasLayer(layers.minor)) map.addLayer(layers.minor);
            }
        }
        map.on('zoomend', updateLayerVisibility);

        function openSidebar() { document.getElementById('sidebar').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
        
        map.on('click', function(e) {
            if (isPickingMap) {
                document.getElementById('inp-lat').value = e.latlng.lat.toFixed(6);
                document.getElementById('inp-lng').value = e.latlng.lng.toFixed(6);
                isPickingMap = false;
                document.querySelector('.btn-pick').innerText = "üìç Ch·∫•m b·∫£n ƒë·ªì";
                document.querySelector('.btn-pick').style.background = "#ff9800";
                openSidebar(); 
                alert("ƒê√£ l·∫•y t·ªça ƒë·ªô!");
            } else { closeSidebar(); }
        });

        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = panel.scrollHeight + "px";
            });
        }
        function refreshPanelHeight(pid) { let p=document.getElementById(pid); if(p.style.maxHeight) p.style.maxHeight=p.scrollHeight+"px"; }

        window.switchTab = function(tabId) {
            document.querySelectorAll('.edit-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            refreshDropdowns(); refreshPanelHeight('panel-entry');
        }
        window.enableMapPick = function() { isPickingMap=true; closeSidebar(); let btn=document.querySelector('.btn-pick'); btn.innerText="ƒêang ch·ªçn..."; btn.style.background="red"; }

        // DIALOG
        let pendingAction = null; 
        window.showMCConfirm = function(mcName) {
            let currentState = appData.mcStates[mcName] !== false; 
            let actionText = currentState ? "M·ªû (C·∫ÆT ƒêI·ªÜN)" : "ƒê√ìNG (C·∫§P ƒêI·ªÜN)";
            document.getElementById('win-msg').innerHTML = `B·∫°n c√≥ mu·ªën <b>${actionText}</b> m√°y c·∫Øt <b>${mcName}</b>?`;
            pendingAction = { type: 'mc', name: mcName };
            document.getElementById('custom-confirm').style.display = 'flex';
        }
        window.showUploadConfirm = function(mode) {
            let msg = mode === 'merge' ? "G·ªòP d·ªØ li·ªáu m·ªõi?" : "C·∫¢NH B√ÅO: X√ìA TO√ÄN B·ªò c≈©?";
            document.getElementById('win-msg').innerHTML = msg;
            pendingAction = { type: 'upload', mode: mode };
            document.getElementById('custom-confirm').style.display = 'flex';
        }
        window.closeWinDialog = function() { document.getElementById('custom-confirm').style.display = 'none'; pendingAction = null; }
        
        document.getElementById('win-btn-yes').onclick = function() {
            if (!pendingAction) return;
            if (pendingAction.type === 'mc') {
                let mcName = pendingAction.name;
                window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), { [mcName]: !(appData.mcStates[mcName] !== false) });
            } else if (pendingAction.type === 'upload') {
                executeUpload(pendingAction.mode);
            }
            closeWinDialog();
        };

        // CONTROLS
        var legendControl = L.control({position: 'bottomright'});
        legendControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.id = "main-legend";
            div.innerHTML = `<h4>CH√ö TH√çCH</h4><div class="legend-item"><span class="legend-icon" style="background:#ff0000;"></span> D√¢y ƒê√≥ng (ƒê·ªè)</div><div class="legend-item"><span class="legend-icon" style="background:#388e3c;"></span> D√¢y C·∫Øt (Xanh)</div>`;
            return div;
        };
        legendControl.addTo(map);

        var faultControl = L.control({position: 'bottomright'});
        faultControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'fault-box');
            div.id = "fault-info-box";
            div.innerHTML = `<div class="fault-header"><span><i class="fas fa-exclamation-triangle"></i> S·ª∞ C·ªê</span><button class="btn-close-fault" onclick="window.closeFaultInfo()">X</button></div><div class="fault-row"><span class="fault-label">M·∫°ch:</span> <span id="fi-name"></span></div><div class="fault-row"><span class="fault-label">C√°ch ngu·ªìn:</span> <span id="fi-dist"></span></div><div class="fault-row"><span class="fault-label">ƒêo·∫°n:</span> <span id="fi-seg"></span></div><div class="fault-row"><span id="fi-addr"></span></div>`;
            return div;
        };
        faultControl.addTo(map);
        window.closeFaultInfo = function() { document.getElementById('fault-info-box').style.display = 'none'; document.getElementById('main-legend').style.display = 'block'; layers.fault.clearLayers(); }

        // CORE LOGIC
        function log(msg) { document.getElementById('console').innerHTML += `<div>> ${msg}</div>`; document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight; }
        function getCol(row, candidates) { let k=Object.keys(row); for(let c of candidates){ let m=k.find(key=>key.trim().replace(/^\uFEFF/,'')===c); if(m) return m; } return null; }

        window.analyzeFiles = function() {
            const input = document.getElementById('excelFile');
            if(!input.files.length) return alert("Ch∆∞a ch·ªçn file");
            Promise.all(Array.from(input.files).map(readFile)).then(res => processSheets(Object.assign({}, ...res)));
        }
        function readFile(file) { return new Promise(r => { const rd = new FileReader(); rd.onload=e=>{ const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); let s={}; w.SheetNames.forEach(n=>s[n]=XLSX.utils.sheet_to_json(w.Sheets[n])); r(s); }; rd.readAsArrayBuffer(file); }); }
        
        function processSheets(sheets) {
            const sPoles=Object.keys(sheets).find(n=>n.includes("TOA_DO")), sSegs=Object.keys(sheets).find(n=>n.includes("DM_DOAN")), sCircs=Object.keys(sheets).find(n=>n.includes("CAU_HINH"));
            if(!sPoles||!sSegs||!sCircs) return alert("Thi·∫øu file!");
            
            let data = { poles: {}, segments: {}, circuits: {}, states: {}, mcStates: {} };
            
            let polesData = sheets[sPoles];
            if(polesData.length) {
                let cMa=getCol(polesData[0],["MA_TUYEN"]), cTen=getCol(polesData[0],["TEN_TRU"]), cLat=getCol(polesData[0],["LAT"]), cLong=getCol(polesData[0],["LONG"]), cLoai=getCol(polesData[0],["LOAI_DIEM"]);
                if(cMa) polesData.forEach(r => {
                    let l=String(r[cMa]).trim(), n=String(r[cTen]).trim(), t=cLoai?String(r[cLoai]).trim().toUpperCase():"TRU_DO";
                    if(l&&r[cLat]) { if(!data.poles[l]) data.poles[l]=[]; data.poles[l].push({name:n,lat:parseFloat(r[cLat]),lng:parseFloat(r[cLong]),type:t}); if(t.includes('MC')) data.mcStates[n]=true; }
                });
            }
            let segsData = sheets[sSegs];
            if(segsData.length) {
                let cId=getCol(segsData[0],["MA_DOAN"]), cT1=getCol(segsData[0],["TUYEN_TU"]), cTr1=getCol(segsData[0],["TRU_TU"]), cT2=getCol(segsData[0],["TUYEN_DEN"]), cTr2=getCol(segsData[0],["TRU_DEN"]), cL=getCol(segsData[0],["LOAI_DIEM","LOAI"]);
                if(cId) segsData.forEach(r => { let id=r[cId]; if(id) data.segments[id]={id, type:(cL&&String(r[cL]).includes("NGAM")?"NGAM":"NOI"), lineFrom:r[cT1], poleFrom:String(r[cTr1]).trim(), lineTo:r[cT2], poleTo:String(r[cTr2]).trim()}; });
            }
            let circsData = sheets[sCircs];
            if(circsData.length) {
                let cCid=getCol(circsData[0],["MA_DUONG_DAY"]), cSid=getCol(circsData[0],["MA_DOAN"]), cStt=getCol(circsData[0],["STT"]);
                if(cCid) circsData.forEach(r => { let cid=r[cCid], sid=r[cSid]; if(sid) { if(!data.circuits[cid]) data.circuits[cid]=[]; data.circuits[cid].push({segId:sid, order:parseInt(r[cStt]||999)}); data.states[cid]=false; } });
                for(let k in data.circuits) data.circuits[k].sort((a,b)=>a.order-b.order);
            }

            stagingData = data;
            document.getElementById('console').innerHTML = "‚úÖ D·ªØ li·ªáu s·∫µn s√†ng!";
            document.getElementById('upload-actions').style.display = "block";
            refreshPanelHeight('panel-update');
        }

        function executeUpload(mode) {
            if(!stagingData) return;
            if(mode === 'replace') window.set(window.ref(window.db, 'he_thong_luoi_dien'), stagingData).then(() => alert("Thay th·∫ø th√†nh c√¥ng!"));
            else { window.update(window.ref(window.db, 'he_thong_luoi_dien'), stagingData).then(() => alert("G·ªôp th√†nh c√¥ng!")); }
        }

        // DATA ENTRY
        window.refreshDropdowns = function() {
            let routes = Object.keys(appData.poles || {});
            let op = '<option value="">Ch·ªçn Tuy·∫øn...</option>' + routes.map(r => `<option value="${r}">${r}</option>`).join('');
            document.getElementById('sel-seg-line1').innerHTML = op; document.getElementById('sel-seg-line2').innerHTML = op;
            let circs = Object.keys(appData.circuits || {});
            document.getElementById('list-circuits').innerHTML = circs.map(c => `<option value="${c}">`).join('');
            let segs = Object.keys(appData.segments || {});
            document.getElementById('sel-cir-seg').innerHTML = '<option value="">-- Ch·ªçn ƒëo·∫°n --</option>' + segs.map(s => `<option value="${s}">${s}</option>`).join('');
        }
        window.updatePoleSelect = function(lid, pid) {
            let line = document.getElementById(lid).value;
            let poles = appData.poles[line] || [];
            document.getElementById(pid).innerHTML = '<option value="">Ch·ªçn Tr·ª•...</option>' + poles.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        }
        window.savePole = function() {
            let line=document.getElementById('inp-pole-route').value.trim(), name=document.getElementById('inp-pole-name').value.trim();
            let type=document.getElementById('inp-pole-type').value, lat=document.getElementById('inp-lat').value, lng=document.getElementById('inp-lng').value;
            if(!line||!name||!lat||!lng) return alert("Thi·∫øu th√¥ng tin!");
            let path=`he_thong_luoi_dien/poles/${line}`;
            window.get(window.child(window.ref(window.db), path)).then(snap=>{
                let list=snap.val()||[], idx=list.findIndex(p=>p.name===name);
                let p={name, type, lat:parseFloat(lat), lng:parseFloat(lng)};
                if(idx>=0) list[idx]=p; else list.push(p);
                window.set(window.ref(window.db, path), list).then(()=>{ alert("ƒê√£ l∆∞u!"); if(type==='MC') window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), {[name]:true}); });
            });
        }
        window.saveSegment = function() {
            let id=document.getElementById('inp-seg-id').value.trim();
            let l1=document.getElementById('sel-seg-line1').value, p1=document.getElementById('sel-seg-pole1').value;
            let l2=document.getElementById('sel-seg-line2').value, p2=document.getElementById('sel-seg-pole2').value;
            if(!id||!l1||!p1) return alert("Thi·∫øu th√¥ng tin!");
            window.set(window.ref(window.db, `he_thong_luoi_dien/segments/${id}`), {id, type:document.getElementById('inp-seg-type').value, lineFrom:l1, poleFrom:p1, lineTo:l2, poleTo:p2}).then(()=>alert("ƒê√£ l∆∞u!"));
        }
        window.saveCircuitItem = function() {
            let cid=document.getElementById('inp-cir-id').value.trim(), sid=document.getElementById('sel-cir-seg').value;
            if(!cid||!sid) return alert("Thi·∫øu th√¥ng tin!");
            window.get(window.child(window.ref(window.db), `he_thong_luoi_dien/circuits/${cid}`)).then(snap=>{
                let list=snap.val()||[]; list.push({segId:sid, order:list.length+1});
                window.set(window.ref(window.db, `he_thong_luoi_dien/circuits/${cid}`), list).then(()=>alert("ƒê√£ th√™m!"));
            });
        }
        window.exportToExcel = function() {
            if(!appData.poles) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
            let d1=[], d2=[], d3=[];
            for(let l in appData.poles) appData.poles[l].forEach(p=>d1.push({"MA_TUYEN":l,"TEN_TRU":p.name,"LAT":p.lat,"LONG":p.lng,"LOAI_DIEM":p.type}));
            if(appData.segments) Object.values(appData.segments).forEach(s=>d2.push({"MA_DOAN":s.id,"TUYEN_TU":s.lineFrom,"TRU_TU":s.poleFrom,"TUYEN_DEN":s.lineTo,"TRU_DEN":s.poleTo,"LOAI_DIEM":s.type}));
            if(appData.circuits) for(let c in appData.circuits) appData.circuits[c].forEach(i=>d3.push({"MA_DUONG_DAY":c,"STT":i.order,"MA_DOAN":i.segId}));
            let wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d1),"TOA_DO");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d2),"DM_DOAN");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d3),"CAU_HINH");
            XLSX.writeFile(wb,"DuLieuLuoiDien.xlsx");
        }

        // RENDER
        window.listenCloud = function() {
            window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), snap => {
                let val = snap.val();
                if(val) { 
                    appData = val; if(!appData.mcStates) appData.mcStates={}; 
                    updateUI(); 
                    // CALCULATE OFFSET & RENDER
                    calculateOffsets(); // T√≠nh to√°n l·ªách d√≤ng
                    renderGlobalMap(); // V·∫Ω l·∫°i
                    refreshDropdowns();
                    if(document.getElementById('circuitSelect').value) window.zoomToCircuit();
                }
            });
        }

        function updateUI() {
            const s = document.getElementById('circuitSelect');
            let cur = s.value; s.innerHTML = '<option value="">-- To√†n c·∫£nh --</option>';
            if(appData.circuits) Object.keys(appData.circuits).forEach(k => { let o=document.createElement('option'); o.value=k; o.text=k; s.add(o); });
            s.value = cur;
        }

        function createIcon(type, name, isClosed=true) {
            let cls='my-icon icon-tru-do', sz=[12,12];
            if(type.includes('MC')) { cls=isClosed?'my-icon icon-mc-on':'my-icon icon-mc-off'; sz=[16,16]; }
            else if(type.includes('NEO')) cls='my-icon icon-tru-neo';
            else if(type.includes('MOC')) { cls='my-icon icon-moc'; sz=[8,8]; }
            else if(type.includes('COT')) { cls='my-icon icon-cot-moc'; sz=[10,14]; }
            else if(type.includes('HAM')) { cls='my-icon icon-ham-cap'; sz=[14,10]; }
            return L.divIcon({ className: cls, html: type.includes('MC')?'MC':'', iconSize: sz });
        }

        // --- OFFSET CALCULATION (NEW v1.50) ---
        let segmentCounts = {}; // L∆∞u s·ªë l∆∞·ª£ng ƒë∆∞·ªùng d√¢y qua m·ªói ƒëo·∫°n (A-B)
        
        function getSegmentKey(p1, p2) {
            // T·∫°o key duy nh·∫•t cho ƒëo·∫°n th·∫≥ng b·∫•t k·ªÉ chi·ªÅu (A-B hay B-A gi·ªëng nhau)
            let k1 = p1.lat + "_" + p1.lng;
            let k2 = p2.lat + "_" + p2.lng;
            return (k1 < k2) ? (k1 + "|" + k2) : (k2 + "|" + k1);
        }

        function calculateOffsets() {
            segmentCounts = {};
            if (appData.circuits) {
                Object.keys(appData.circuits).forEach(cid => {
                    appData.circuits[cid].forEach(item => {
                        let def = appData.segments[item.segId];
                        if (def) {
                            let p1 = getPoleExact(def.lineFrom, def.poleFrom);
                            let p2 = getPoleExact(def.lineTo, def.poleTo);
                            if (p1 && p2) {
                                let key = getSegmentKey(p1, p2);
                                if (!segmentCounts[key]) segmentCounts[key] = [];
                                segmentCounts[key].push(cid); // L∆∞u ID m·∫°ch v√†o ƒëo·∫°n n√†y
                            }
                        }
                    });
                });
            }
        }

        function renderGlobalMap() {
            layers.main.clearLayers(); 
            layers.minor.clearLayers(); 
            layers.important.clearLayers(); 
            layers.mc.clearLayers();
            layers.fault.clearLayers();
            updateLayerVisibility(); 

            if(appData.poles) for(let l in appData.poles) appData.poles[l].forEach(p => {
                let isMC = p.type.includes('MC');
                let isMinor = p.type === 'TRU_DO' || p.type === 'MOC'; 
                let target = isMC?layers.mc:(isMinor?layers.minor:layers.important);
                let isClosed = isMC ? (appData.mcStates[p.name] !== false) : true;
                let marker = L.marker([p.lat,p.lng], {icon: createIcon(p.type,p.name,isClosed), zIndexOffset:isMC?1000:0}).addTo(target);
                if(isMC) marker.bindPopup(`<b>${p.name}</b><br>Click ƒê√≥ng/C·∫Øt`).on('click', () => window.showMCConfirm(p.name));
                else marker.bindPopup(`<b>${p.name}</b><br>${l}`);
            });
            if(appData.circuits) Object.keys(appData.circuits).forEach(cid => drawSingleCircuit(cid, false));
        }

        function getPoleExact(line, name) { if(!appData.poles[line]) return null; return appData.poles[line].find(p=>String(p.name).toUpperCase()===String(name).toUpperCase()); }
        function getPoleGlobal(name) { for(let l in appData.poles) { let p=appData.poles[l].find(p=>String(p.name).toUpperCase()===String(name).toUpperCase()); if(p) return {...p, foundRoute:l}; } return null; }
        function getPoleRange(line, from, to) { let lData=appData.poles[line]; if(!lData) return []; let i1=lData.findIndex(p=>p.name===from), i2=lData.findIndex(p=>p.name===to); if(i1<0||i2<0) return []; return (i1<=i2)?lData.slice(i1,i2+1):lData.slice(i2,i1+1).reverse(); }

        function drawSingleCircuit(circuitId, calcPath) {
            const segs = appData.circuits[circuitId]; if(!segs) return;
            
            // Logic m√†u s·∫Øc
            let connectedMCs = [];
            segs.forEach(item => { 
                let def = appData.segments[item.segId]; 
                if(def) {
                    let p1=getPoleExact(def.lineFrom, def.poleFrom), p2=getPoleExact(def.lineTo, def.poleTo);
                    if(p1&&p1.type.includes('MC')) connectedMCs.push(p1.name);
                    if(p2&&p2.type.includes('MC')) connectedMCs.push(p2.name);
                }
            });
            let isEnergized = (connectedMCs.length>0 && connectedMCs.some(mc=>appData.mcStates[mc]!==false));
            let color = (connectedMCs.length===0)?'#000':(isEnergized?'#ff0000':'#388e3c');
            
            if(calcPath) { 
                document.getElementById('status-text').innerHTML = `<span style="color:${color}">${isEnergized?'ƒêANG C√ì ƒêI·ªÜN':'ƒêANG M·∫§T ƒêI·ªÜN (AN TO√ÄN)'}</span>`;
                currentPath=[]; currentPathTotalDist=0;
            }

            segs.forEach(item => {
                let def = appData.segments[item.segId]; if(!def) return;
                let p1=getPoleExact(def.lineFrom, def.poleFrom)||getPoleGlobal(def.poleFrom), p2=getPoleExact(def.lineTo, def.poleTo)||getPoleGlobal(def.poleTo);
                if(!p1||!p2) return;
                
                let pts = [];
                let r1=p1.foundRoute||def.lineFrom, r2=p2.foundRoute||def.lineTo;
                
                // OFFSET CALCULATION
                let offset = 0;
                let key = getSegmentKey(p1, p2);
                let list = segmentCounts[key];
                if (list && list.length > 1) {
                    let idx = list.indexOf(circuitId);
                    if (idx !== -1) {
                        // T√≠nh to√°n ƒë·ªô l·ªách: (index - gi·ªØa) * kho·∫£ng c√°ch (6px)
                        let center = (list.length - 1) / 2;
                        offset = (idx - center) * 6; 
                    }
                }

                if(r1!==r2) pts=[p1,p2]; else { let d=appData.poles[r1], i1=d.findIndex(p=>p.name===p1.name), i2=d.findIndex(p=>p.name===p2.name); pts=(i1<=i2)?d.slice(i1,i2+1):d.slice(i2,i1+1).reverse(); }
                
                if(pts.length) {
                    let isCable=def.type.includes("NGAM"), c=isCable?(isEnergized?'#7b1fa2':'#000'):color;
                    
                    // S·ª≠ d·ª•ng offset trong polyline
                    L.polyline(pts.map(p=>[p.lat,p.lng]), {
                        color:c, 
                        weight:calcPath?5:3, 
                        opacity:calcPath?1:0.8, 
                        dashArray:isCable?"5,5":null,
                        offset: offset // HERE IS THE MAGIC
                    }).addTo(layers.main);
                    
                    if(calcPath) pts.forEach((p,i)=>{ if(i>0) currentPathTotalDist+=getDist(pts[i-1].lat,pts[i-1].lng,p.lat,p.lng); currentPath.push({...p, accDist:currentPathTotalDist}); });
                }
            });
        }

        window.zoomToCircuit = function() {
            let id = document.getElementById('circuitSelect').value;
            layers.main.clearLayers(); renderGlobalMap();
            if(!id) { document.getElementById('status-text').innerText = "---"; return; }
            drawSingleCircuit(id, true);
            document.getElementById('circuit-info').innerText = `T·ªïng d√†i: ${(currentPathTotalDist/1000).toFixed(3)} km`;
            if(currentPath.length) map.fitBounds(currentPath.map(p=>[p.lat,p.lng]));
        }

        window.findFault = function() { /* Logic t√¨m s·ª± c·ªë gi·ªØ nguy√™n */
            layers.fault.clearLayers();
            document.getElementById('result').style.display='none'; 
            document.getElementById('fault-info-box').style.display='none';
            document.getElementById('main-legend').style.display='block';

            let kmInput = parseFloat(document.getElementById('faultKm').value);
            let direction = document.querySelector('input[name="faultDir"]:checked').value;
            let cName = document.getElementById('circuitSelect').value;
            let res = document.getElementById('result');
            
            if(isNaN(kmInput) || currentPath.length<2) { res.style.display='block'; res.className='warning-msg'; res.innerHTML='Vui l√≤ng ch·ªçn m·∫°ch tr∆∞·ªõc!'; return; }

            let targetDist = kmInput * 1000;
            if (direction === 'end') targetDist = currentPathTotalDist - (kmInput * 1000);

            if (targetDist < -10 || targetDist > currentPathTotalDist + 10) {
                res.style.display = 'block'; res.className='warning-msg'; res.innerHTML = `‚ö†Ô∏è Ngo√†i ph·∫°m vi!`; return;
            }

            for(let i=1; i<currentPath.length; i++) {
                let p1=currentPath[i-1], p2=currentPath[i];
                if(targetDist>=(p1.accDist-0.1) && targetDist<=(p2.accDist+0.1)) {
                    let ratio = (p2.accDist > p1.accDist) ? (targetDist-p1.accDist)/(p2.accDist-p1.accDist) : 0;
                    let lat = p1.lat + (p2.lat-p1.lat)*ratio, lng = p1.lng + (p2.lng-p1.lng)*ratio;
                    
                    document.getElementById('main-legend').style.display='none';
                    document.getElementById('fault-info-box').style.display='block';
                    document.getElementById('fi-name').innerText=cName;
                    document.getElementById('fi-dist').innerText=`${kmInput} km`;
                    document.getElementById('fi-seg').innerHTML=`${p1.name} <i class="fas fa-arrow-right"></i> ${p2.name}`;
                    document.getElementById('fi-addr').innerHTML=`<a href="http://googleusercontent.com/maps.google.com/maps?q=${lat},${lng}" target="_blank">Google Maps</a>`;
                    
                    L.marker([lat,lng], {icon: L.divIcon({html:'<i class="fas fa-bolt" style="color:red;font-size:32px;"></i>', className:'d'})}).addTo(layers.fault).bindPopup("S·ª∞ C·ªê").openPopup();
                    map.setView([lat,lng], 16); closeSidebar(); return;
                }
            }
        }

        function getDist(lat1,lon1,lat2,lon2) {
            const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }
    </script>
</body>
</html>
