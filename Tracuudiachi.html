
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u S·ª± c·ªë L∆∞·ªõi ƒëi·ªán v2.3</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: #eef2f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 650px; }
        h2 { margin-top: 0; color: #b71c1c; text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; font-size: 13px; margin-bottom: 20px; font-style: italic; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
        textarea { width: 100%; height: 50px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; }
        input[type="datetime-local"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
        #btnSearch { background-color: #b71c1c; }
        #btnSearch:hover { background-color: #8e1515; }
        
        #btnCopy { background-color: #2e7d32; display: none; } /* M·∫∑c ƒë·ªãnh ·∫©n, hi·ªán khi c√≥ kq */
        #btnCopy:hover { background-color: #1b5e20; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #result { margin-top: 25px; display: none; }
        .section-title { font-weight: bold; font-size: 14px; color: #444; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; }
        
        /* Grid Weather */
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .param-box { background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #ccc; }
        .param-label { font-size: 11px; color: #666; text-transform: uppercase; }
        .param-value { font-size: 16px; font-weight: bold; color: #222; margin-top: 2px; }
        .param-unit { font-size: 11px; color: #888; font-weight: normal; }

        /* Report Box */
        .report-box { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 15px; background: #fff; }
        .risk-level { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; margin-bottom: 5px;}
        .risk-high { background-color: #d32f2f; }
        .risk-med { background-color: #f57c00; }
        .risk-low { background-color: #388e3c; }
        
        .report-text { font-size: 14px; color: #333; line-height: 1.5; margin-top: 5px; }

        .loading { text-align: center; color: #666; display: none; margin-top: 10px; }
        .coords-debug { font-family: monospace; font-size: 12px; color: #d32f2f; background: #ffebee; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2>‚ö° Ph√¢n t√≠ch S·ª± c·ªë L∆∞·ªõi ƒëi·ªán</h2>
    <div class="subtitle">Version 2.3: B·ªï sung t√≠nh nƒÉng Copy B√°o c√°o</div>
    
    <div class="form-group">
        <label>1. T·ªça ƒë·ªô s·ª± c·ªë:</label>
        <textarea id="rawCoords" placeholder="V√≠ d·ª•: 10,8238318, 106,7448612"></textarea>
    </div>

    <div class="form-group">
        <label>2. Th·ªùi gian x·∫£y ra (Gi·ªù:Ph√∫t Ng√†y/Th√°ng/NƒÉm):</label>
        <input type="datetime-local" id="queryTime">
    </div>

    <div class="btn-group">
        <button id="btnSearch" onclick="processAndSearch()">üîç Ph√¢n t√≠ch</button>
        <button id="btnCopy" onclick="copyReport()">üìã Sao ch√©p tin nh·∫Øn</button>
    </div>
    
    <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ tr·∫°m kh√≠ t∆∞·ª£ng...</div>

    <div id="result">
        <div class="section-title">üìç V·ªã tr√≠ & Th·ªùi gian</div>
        <div id="addressText" style="font-size:14px; margin-bottom:5px;"></div>
        <span id="parsedCoords" class="coords-debug"></span>

        <div class="section-title">üìä S·ªë li·ªáu quan tr·∫Øc</div>
        <div class="weather-grid">
            <div class="param-box" style="border-left-color: #d32f2f;">
                <div class="param-label">Gi√≥ gi·∫≠t (Gusts)</div>
                <div class="param-value"><span id="wGust">--</span> <span class="param-unit">km/h</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">T·ªëc ƒë·ªô gi√≥ TB</div>
                <div class="param-value"><span id="wSpeed">--</span> <span class="param-unit">km/h</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">H∆∞·ªõng gi√≥</div>
                <div class="param-value" style="font-size:14px;"><span id="wDirTxt">--</span></div>
            </div>
            <div class="param-box" style="border-left-color: #1976d2;">
                <div class="param-label">L∆∞·ª£ng m∆∞a</div>
                <div class="param-value"><span id="wRain">--</span> <span class="param-unit">mm</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">Nhi·ªát ƒë·ªô</div>
                <div class="param-value"><span id="wTemp">--</span> <span class="param-unit">¬∞C</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">M√£ th·ªùi ti·∫øt</div>
                <div class="param-value" style="font-size:12px; margin-top:5px;"><span id="wCodeDesc">--</span></div>
            </div>
        </div>

        <div class="section-title">üõ°Ô∏è Nh·∫≠n ƒë·ªãnh chuy√™n gia</div>
        
        <div class="report-box" id="lightningReportBox">
            <div id="lightningBadge" class="risk-level risk-low">R·ª¶I RO S√âT: TH·∫§P</div>
            <div id="lightningComment" class="report-text">--</div>
        </div>

        <div class="report-box" id="windReportBox">
            <div id="windBadge" class="risk-level risk-low">R·ª¶I RO GI√ì/M∆ØA: TH·∫§P</div>
            <div id="windComment" class="report-text">--</div>
        </div>

        <div style="font-size: 11px; color: #888; margin-top: 15px; text-align: right;">
            D·ªØ li·ªáu: Open-Meteo Archive API.
        </div>
    </div>
</div>

<script>
    // Global var ƒë·ªÉ l∆∞u text b√°o c√°o
    let reportText = "";

    window.onload = function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('queryTime').value = now.toISOString().slice(0,16);
    };

    async function processAndSearch() {
        const rawInput = document.getElementById('rawCoords').value;
        const timeInput = document.getElementById('queryTime').value;
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const btn = document.getElementById('btnSearch');
        const btnCopy = document.getElementById('btnCopy');

        resultDiv.style.display = 'none';
        btnCopy.style.display = 'none';
        
        if (!rawInput.trim()) { alert("Ch∆∞a nh·∫≠p t·ªça ƒë·ªô!"); return; }
        if (!timeInput) { alert("Ch∆∞a ch·ªçn th·ªùi gian!"); return; }

        let lat, lon;
        try {
            let cleanStr = rawInput.trim();
            let parts;
            if (cleanStr.includes('.') && !cleanStr.includes(',,')) { parts = cleanStr.split(/[\s,]+/); } 
            else { 
                if (cleanStr.includes(', ')) { let temp = cleanStr.replace(', ', '|'); parts = temp.split('|'); }
                else { let rawParts = cleanStr.split(','); if (rawParts.length === 4) parts = [rawParts[0]+'.'+rawParts[1], rawParts[2]+'.'+rawParts[3]]; else if (rawParts.length === 2) parts = rawParts; }
            }
            const numbers = parts.map(p => parseFloat(p.replace(/,/g, '.').replace(/[^0-9.-]/g, ''))).filter(n => !isNaN(n));
            if (numbers.length < 2) throw new Error("Format");
            lat = numbers[0]; lon = numbers[1];
        } catch (e) { alert("L·ªói t·ªça ƒë·ªô."); return; }

        document.getElementById('parsedCoords').textContent = `${lat}, ${lon}`;
        loadingDiv.style.display = 'block';
        btn.disabled = true;

        try {
            const addrPromise = fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`, { headers: {'Accept-Language': 'vi'} }).then(res => res.json());
            const weatherPromise = fetchWeather(lat, lon, timeInput);

            const [addrData, weatherData] = await Promise.all([addrPromise, weatherPromise]);

            const address = addrData.display_name || "Kh√¥ng x√°c ƒë·ªãnh";
            document.getElementById('addressText').textContent = address;

            if (weatherData) {
                // Hi·ªÉn th·ªã s·ªë li·ªáu
                const temp = weatherData.temperature_2m;
                const rain = weatherData.precipitation;
                const speed = weatherData.wind_speed_10m;
                const gust = weatherData.wind_gusts_10m;
                const dir = weatherData.wind_direction_10m;
                const wCode = weatherData.weather_code;
                const dirTxt = getWindDirection(dir);
                const wDesc = getWeatherDesc(wCode);

                document.getElementById('wTemp').textContent = temp;
                document.getElementById('wRain').textContent = rain;
                document.getElementById('wSpeed').textContent = speed;
                document.getElementById('wGust').textContent = gust;
                document.getElementById('wDirTxt').textContent = `${dirTxt} (${dir}¬∞)`;
                document.getElementById('wCodeDesc').textContent = wDesc;

                // Logic nh·∫≠n x√©t
                const lightningRisk = getLightningRisk(wCode, rain);
                const windRisk = getWindRisk(gust, rain);

                updateUIReport(lightningRisk, windRisk);

                // --- T·∫†O TEXT B√ÅO C√ÅO (Zalo/SMS) ---
                const formatTime = timeInput.replace('T', ' ');
                reportText = `‚ö° B√ÅO C√ÅO S·ª∞ C·ªê L∆Ø·ªöI ƒêI·ªÜN ‚ö°\n` +
                             `üïí Th·ªùi gian: ${formatTime}\n` +
                             `üìç V·ªã tr√≠: ${address}\n` +
                             `üåç T·ªça ƒë·ªô: ${lat}, ${lon}\n` +
                             `------------------------------\n` +
                             `üìä TH·ªúI TI·∫æT T·∫†I HI·ªÜN TR∆Ø·ªúNG:\n` +
                             `‚Ä¢ Gi√≥ gi·∫≠t: ${gust} km/h (TB: ${speed} km/h)\n` +
                             `‚Ä¢ H∆∞·ªõng gi√≥: ${dirTxt}\n` +
                             `‚Ä¢ L∆∞·ª£ng m∆∞a: ${rain} mm\n` +
                             `‚Ä¢ Di·ªÖn bi·∫øn: ${wDesc}\n` +
                             `------------------------------\n` +
                             `üõ°Ô∏è NH·∫¨N ƒê·ªäNH R·ª¶I RO:\n` +
                             `‚Ä¢ S√©t/D√¥ng: ${lightningRisk.level}\n` +
                             `‚Ä¢ Gi√≥ b√£o: ${windRisk.level}`;
                
                btnCopy.style.display = 'block';
            }

            resultDiv.style.display = 'block';

        } catch (err) { alert("L·ªói: " + err.message); } 
        finally { loadingDiv.style.display = 'none'; btn.disabled = false; }
    }

    // --- C√ÅC H√ÄM PH·ª§ TR·ª¢ ---
    function copyReport() {
        navigator.clipboard.writeText(reportText).then(() => {
            alert("‚úÖ ƒê√£ sao ch√©p n·ªôi dung b√°o c√°o!\nB·∫°n c√≥ th·ªÉ d√°n v√†o Zalo/Tin nh·∫Øn ngay.");
        }).catch(err => {
            alert("Kh√¥ng th·ªÉ copy: " + err);
        });
    }

    async function fetchWeather(lat, lon, isoTimeStr) {
        const inputDate = new Date(isoTimeStr);
        const today = new Date(); today.setHours(0,0,0,0);
        const dateStr = isoTimeStr.split('T')[0];
        const isPast = inputDate < today;
        const params = "hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,precipitation";
        let url = isPast 
            ? `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&${params}&timezone=auto`
            : `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&${params}&timezone=auto`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.hourly) return null;
        const hourIndex = inputDate.getHours();
        return {
            temperature_2m: data.hourly.temperature_2m[hourIndex],
            relative_humidity_2m: data.hourly.relative_humidity_2m[hourIndex],
            weather_code: data.hourly.weather_code[hourIndex],
            wind_speed_10m: data.hourly.wind_speed_10m[hourIndex],
            wind_direction_10m: data.hourly.wind_direction_10m[hourIndex],
            wind_gusts_10m: data.hourly.wind_gusts_10m[hourIndex],
            precipitation: data.hourly.precipitation[hourIndex]
        };
    }

    function getLightningRisk(code, rain) {
        if ([95, 96, 99].includes(code)) return { level: "üî¥ CAO (C√≥ d√¥ng s√©t)", type: "high", msg: "Ph√°t hi·ªán m√£ D√¥ng b√£o. Nguy c∆° s√©t ƒë√°nh tr·ª±c ti·∫øp/lan truy·ªÅn cao." };
        if ([80, 81, 82].includes(code) || (rain > 5 && [61,63,65].includes(code))) return { level: "üü† TRUNG B√åNH", type: "med", msg: "M∆∞a r√†o n·∫∑ng h·∫°t. ƒêi·ªÅu ki·ªán kh√≠ quy·ªÉn b·∫•t ·ªïn." };
        return { level: "üü¢ TH·∫§P", type: "low", msg: "√çt c√≥ kh·∫£ nƒÉng s√©t." };
    }

    function getWindRisk(gust, rain) {
        if (gust >= 60) return { level: "üî¥ CAO (Gi√≥ l·ªëc)", type: "high", msg: "Gi√≥ >60km/h d·ªÖ g√¢y ƒë·ªï c√¢y/ƒë·ª©t d√¢y." };
        if (gust >= 40 || (gust>=30 && rain>0)) return { level: "üü† TRUNG B√åNH", type: "med", msg: "Gi√≥ gi·∫≠t m·∫°nh/M∆∞a t·∫°t." };
        return { level: "üü¢ TH·∫§P", type: "low", msg: "Gi√≥ b√¨nh th∆∞·ªùng." };
    }

    function updateUIReport(lRisk, wRisk) {
        // Lightning UI
        const lb = document.getElementById('lightningBadge');
        lb.textContent = "R·ª¶I RO S√âT: " + lRisk.level.replace(/üî¥|üü†|üü¢/g, '').trim();
        lb.className = `risk-level risk-${lRisk.type}`;
        document.getElementById('lightningComment').textContent = lRisk.msg;

        // Wind UI
        const wb = document.getElementById('windBadge');
        wb.textContent = "R·ª¶I RO GI√ì: " + wRisk.level.replace(/üî¥|üü†|üü¢/g, '').trim();
        wb.className = `risk-level risk-${wRisk.type}`;
        document.getElementById('windComment').textContent = wRisk.msg;
    }

    function getWindDirection(deg) {
        const dirs = ["B·∫Øc", "ƒê√¥ng B·∫Øc", "ƒê√¥ng", "ƒê√¥ng Nam", "Nam", "T√¢y Nam", "T√¢y", "T√¢y B·∫Øc"];
        return dirs[Math.round(deg / 45) % 8];
    }
    
    function getWeatherDesc(code) {
        const map = { 0: "Quang ƒë√£ng", 1: "N·∫Øng nh·∫π", 2: "C√≥ m√¢y", 3: "√Çm u", 45: "S∆∞∆°ng m√π", 51: "M∆∞a ph√πn", 61: "M∆∞a nh·ªè", 63: "M∆∞a v·ª´a", 65: "M∆∞a to", 80: "M∆∞a r√†o nh·∫π", 81: "M∆∞a r√†o", 82: "M∆∞a r√†o to", 95: "D√¥ng b√£o", 96: "D√¥ng + M∆∞a ƒë√°" };
        return map[code] || `M√£ ${code}`;
    }
</script>

</body>
</html>
