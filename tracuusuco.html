
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u S·ª± c·ªë L∆∞·ªõi ƒëi·ªán v2.5</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: #eef2f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 650px; }
        h2 { margin-top: 0; color: #b71c1c; text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; font-size: 13px; margin-bottom: 20px; font-style: italic; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
        textarea { width: 100%; height: 60px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; font-size: 14px; }
        input[type="datetime-local"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
        #btnSearch { background-color: #b71c1c; }
        #btnSearch:hover { background-color: #8e1515; }
        #btnCopy { background-color: #2e7d32; display: none; }
        #btnCopy:hover { background-color: #1b5e20; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #result { margin-top: 25px; display: none; }
        .section-title { font-weight: bold; font-size: 14px; color: #444; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; }
        
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .param-box { background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #ccc; }
        .param-label { font-size: 11px; color: #666; text-transform: uppercase; }
        .param-value { font-size: 16px; font-weight: bold; color: #222; margin-top: 2px; }
        .param-unit { font-size: 11px; color: #888; font-weight: normal; }

        .report-box { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 15px; background: #fff; }
        .risk-level { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; margin-bottom: 5px;}
        .risk-high { background-color: #d32f2f; }
        .risk-med { background-color: #f57c00; }
        .risk-low { background-color: #388e3c; }
        .report-text { font-size: 14px; color: #333; line-height: 1.5; margin-top: 5px; }

        .loading { text-align: center; color: #666; display: none; margin-top: 10px; }
        .coords-debug { font-family: monospace; font-size: 12px; color: #d32f2f; background: #ffebee; padding: 2px 5px; border-radius: 4px; }
        .input-hint { font-size: 12px; color: #666; margin-top: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2>‚ö° Ph√¢n t√≠ch S·ª± c·ªë L∆∞·ªõi ƒëi·ªán</h2>
    <div class="subtitle">Version 2.5: Hybrid Plus Code Decoder</div>
    
    <div class="form-group">
        <label>1. Nh·∫≠p T·ªça ƒë·ªô / Full Plus Code / Short Code:</label>
        <textarea id="rawInput" placeholder="VD1 (T·ªça ƒë·ªô): 10.8238, 106.7448&#10;VD2 (Full Code): 7P28WH7G+P25&#10;VD3 (Short Code): WH7G+P25 H√≥c M√¥n"></textarea>
        <div class="input-hint">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ch·ªçn thu·∫≠t to√°n gi·∫£i m√£ ph√π h·ª£p nh·∫•t.</div>
    </div>

    <div class="form-group">
        <label>2. Th·ªùi gian x·∫£y ra:</label>
        <input type="datetime-local" id="queryTime">
    </div>

    <div class="btn-group">
        <button id="btnSearch" onclick="processAndSearch()">üîç Ph√¢n t√≠ch</button>
        <button id="btnCopy" onclick="copyReport()">üìã Sao ch√©p tin nh·∫Øn</button>
    </div>
    
    <div id="loading" class="loading">ƒêang x·ª≠ l√Ω...</div>

    <div id="result">
        <div class="section-title">üìç V·ªã tr√≠ & Th·ªùi gian</div>
        <div id="addressText" style="font-size:14px; margin-bottom:5px;"></div>
        <span id="parsedCoords" class="coords-debug"></span>

        <div class="section-title">üìä S·ªë li·ªáu quan tr·∫Øc</div>
        <div class="weather-grid">
            <div class="param-box" style="border-left-color: #d32f2f;">
                <div class="param-label">Gi√≥ gi·∫≠t</div>
                <div class="param-value"><span id="wGust">--</span> <span class="param-unit">km/h</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">T·ªëc ƒë·ªô gi√≥</div>
                <div class="param-value"><span id="wSpeed">--</span> <span class="param-unit">km/h</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">H∆∞·ªõng gi√≥</div>
                <div class="param-value" style="font-size:14px;"><span id="wDirTxt">--</span></div>
            </div>
            <div class="param-box" style="border-left-color: #1976d2;">
                <div class="param-label">L∆∞·ª£ng m∆∞a</div>
                <div class="param-value"><span id="wRain">--</span> <span class="param-unit">mm</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">Nhi·ªát ƒë·ªô</div>
                <div class="param-value"><span id="wTemp">--</span> <span class="param-unit">¬∞C</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">M√£ th·ªùi ti·∫øt</div>
                <div class="param-value" style="font-size:12px; margin-top:5px;"><span id="wCodeDesc">--</span></div>
            </div>
        </div>

        <div class="section-title">üõ°Ô∏è Nh·∫≠n ƒë·ªãnh chuy√™n gia</div>
        <div class="report-box">
            <div id="lightningBadge" class="risk-level risk-low">R·ª¶I RO S√âT: TH·∫§P</div>
            <div id="lightningComment" class="report-text">--</div>
        </div>
        <div class="report-box">
            <div id="windBadge" class="risk-level risk-low">R·ª¶I RO GI√ì: TH·∫§P</div>
            <div id="windComment" class="report-text">--</div>
        </div>
    </div>
</div>

<script>
    // --- TH∆Ø VI·ªÜN GI·∫¢I M√É PLUS CODE (Open Location Code) MINIFIED ---
    // ƒê∆∞·ª£c t√≠ch h·ª£p s·∫µn ƒë·ªÉ c√≥ th·ªÉ t√≠nh to√°n Offline cho Full Code
    const OpenLocationCode={CODE_ALPHABET_:"23456789CFGHJMPQRVWX",SEPARATOR_:"+",SEPARATOR_POSITION_:8,PADDING_CHARACTER_:"0",decode:function(a){if(!this.isFull(a))throw Error("Not a valid full code: "+a);a=a.replace(this.SEPARATOR_,"");a=a.replace(new RegExp(this.PADDING_CHARACTER_+"+$"),"");a=a.toUpperCase();let b=20,c=-90,d=0,e=-180,f=0,g=0;for(let h=0;h<a.length;h++){var k=this.CODE_ALPHABET_.indexOf(a.charAt(h)),l=this.PADDING_CHARACTER_.indexOf(a.charAt(h));if(0>k&&0>l)throw Error("Invalid character: "+a.charAt(h));if(0>k)break;10>h?(b/=20,e/=20,c+=Math.floor(k/20)*b*20,d+=k%20*e*20):(b/=5,e/=4,c+=Math.floor(k/4)*b*5,d+=k%4*e*4);g=h}return{latitudeCenter:c+b/2,longitudeCenter:d+e/2,latitudeLo:c,longitudeLo:d+e,latitudeHi:c+b,longitudeHi:d+e,codeLength:Math.min(g+1,15)}},isFull:function(a){if(-1==a.indexOf(this.SEPARATOR_))return!1;if(8<a.indexOf(this.SEPARATOR_))return!1;if(a.length-a.indexOf(this.SEPARATOR_)-1<2)return!1;return!0}};
    
    let reportText = "";

    window.onload = function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('queryTime').value = now.toISOString().slice(0,16);
    };

    async function processAndSearch() {
        const rawInput = document.getElementById('rawInput').value.trim();
        const timeInput = document.getElementById('queryTime').value;
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const btn = document.getElementById('btnSearch');
        const btnCopy = document.getElementById('btnCopy');

        resultDiv.style.display = 'none';
        btnCopy.style.display = 'none';
        
        if (!rawInput) { alert("Ch∆∞a nh·∫≠p th√¥ng tin v·ªã tr√≠!"); return; }
        if (!timeInput) { alert("Ch∆∞a ch·ªçn th·ªùi gian!"); return; }

        loadingDiv.textContent = "ƒêang x·ª≠ l√Ω v·ªã tr√≠...";
        loadingDiv.style.display = 'block';
        btn.disabled = true;

        let lat, lon, displayName;

        try {
            // LOGIC QUY·∫æT ƒê·ªäNH X·ª¨ L√ù (HYBRID)
            
            // 1. Ki·ªÉm tra xem c√≥ ph·∫£i t·ªça ƒë·ªô s·ªë kh√¥ng (10.123, 106.123)
            const isCoord = /^-?[\d]+[.,][\d]+.*-?[\d]+[.,][\d]+/.test(rawInput);
            
            if (isCoord) {
                // --> X·ª≠ l√Ω nh∆∞ T·ªça ƒë·ªô
                console.log("Detect: T·ªça ƒë·ªô s·ªë");
                let cleanStr = rawInput;
                let parts;
                if (cleanStr.includes('.') && !cleanStr.includes(',,')) { parts = cleanStr.split(/[\s,]+/); } 
                else { 
                    if (cleanStr.includes(', ')) { let temp = cleanStr.replace(', ', '|'); parts = temp.split('|'); }
                    else { let rawParts = cleanStr.split(','); if (rawParts.length >= 4) parts = [rawParts[0]+'.'+rawParts[1], rawParts[2]+'.'+rawParts[3]]; else if (rawParts.length >= 2) parts = rawParts; }
                }
                const numbers = parts.map(p => parseFloat(p.replace(/,/g, '.').replace(/[^0-9.-]/g, ''))).filter(n => !isNaN(n));
                lat = numbers[0]; lon = numbers[1];
                
                // Reverse Geo ƒë·ªÉ l·∫•y t√™n
                const addrData = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`, { headers: {'Accept-Language': 'vi'} }).then(r => r.json());
                displayName = addrData.display_name;

            } else {
                // 2. Kh√¥ng ph·∫£i s·ªë, th·ª≠ xem c√≥ ph·∫£i Full Code kh√¥ng?
                // Full Code th∆∞·ªùng c√≥ d·∫•u +, v√† ƒë·ªô d√†i > 8 k√Ω t·ª±, kh√¥ng ch·ª©a kho·∫£ng tr·∫Øng (tr·ª´ khi format sai)
                // VD: 7P28WH7G+P25
                let possibleCode = rawInput.split(' ')[0].trim(); // L·∫•y t·ª´ ƒë·∫ßu ti√™n
                
                let isFullCode = false;
                try {
                    // Th·ª≠ decode b·∫±ng th∆∞ vi·ªán OLC Offline
                    if(possibleCode.includes('+') && OpenLocationCode.isFull(possibleCode)) {
                        const decoded = OpenLocationCode.decode(possibleCode);
                        lat = decoded.latitudeCenter;
                        lon = decoded.longitudeCenter;
                        displayName = `M√£ Plus Code: ${possibleCode}`;
                        isFullCode = true;
                        console.log("Detect: Full Plus Code (Offline Decode)");
                    }
                } catch(e) { isFullCode = false; }

                if (!isFullCode) {
                    // 3. N·∫øu kh√¥ng ph·∫£i Full Code, th√¨ l√† Short Code ho·∫∑c ƒê·ªãa ch·ªâ text
                    // --> Ph·∫£i d√πng API Search
                    console.log("Detect: Short Code / Text Address -> D√πng API Search");
                    loadingDiv.textContent = "ƒêang tra c·ª©u m√°y ch·ªß b·∫£n ƒë·ªì...";
                    
                    const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(rawInput)}&format=json&limit=1`;
                    const searchRes = await fetch(searchUrl, { headers: {'User-Agent': 'PowerGridApp/2.5', 'Accept-Language': 'vi'} });
                    const searchData = await searchRes.json();

                    if (!searchData || searchData.length === 0) {
                        throw new Error("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm. N·∫øu d√πng m√£ Plus Code ng·∫Øn, h√£y th√™m T√™n Qu·∫≠n/Huy·ªán ph√≠a sau.");
                    }
                    lat = parseFloat(searchData[0].lat);
                    lon = parseFloat(searchData[0].lon);
                    displayName = searchData[0].display_name;
                }
            }

            document.getElementById('parsedCoords').textContent = `T·ªça ƒë·ªô: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            document.getElementById('addressText').textContent = displayName || "Kh√¥ng x√°c ƒë·ªãnh";

            // --- TRA C·ª®U TH·ªúI TI·∫æT ---
            loadingDiv.textContent = "ƒêang l·∫•y d·ªØ li·ªáu kh√≠ t∆∞·ª£ng...";
            const weatherData = await fetchWeather(lat, lon, timeInput);

            if (weatherData) {
                renderWeather(weatherData, displayName, lat, lon, timeInput);
                btnCopy.style.display = 'block';
            }
            resultDiv.style.display = 'block';

        } catch (err) {
            alert("L·ªói: " + err.message);
        } finally {
            loadingDiv.style.display = 'none';
            btn.disabled = false;
        }
    }

    async function fetchWeather(lat, lon, isoTimeStr) {
        const inputDate = new Date(isoTimeStr);
        const today = new Date(); today.setHours(0,0,0,0);
        const dateStr = isoTimeStr.split('T')[0];
        const isPast = inputDate < today;
        const params = "hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,precipitation";
        
        let url = isPast 
            ? `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&${params}&timezone=auto`
            : `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&${params}&timezone=auto`;

        const res = await fetch(url);
        const data = await res.json();
        if (!data.hourly) return null;
        const hourIndex = inputDate.getHours();
        return {
            temperature_2m: data.hourly.temperature_2m[hourIndex],
            relative_humidity_2m: data.hourly.relative_humidity_2m[hourIndex],
            weather_code: data.hourly.weather_code[hourIndex],
            wind_speed_10m: data.hourly.wind_speed_10m[hourIndex],
            wind_direction_10m: data.hourly.wind_direction_10m[hourIndex],
            wind_gusts_10m: data.hourly.wind_gusts_10m[hourIndex],
            precipitation: data.hourly.precipitation[hourIndex]
        };
    }

    function renderWeather(data, address, lat, lon, timeInput) {
        const dirTxt = getWindDirection(data.wind_direction_10m);
        const wDesc = getWeatherDesc(data.weather_code);

        document.getElementById('wTemp').textContent = data.temperature_2m;
        document.getElementById('wRain').textContent = data.precipitation;
        document.getElementById('wSpeed').textContent = data.wind_speed_10m;
        document.getElementById('wGust').textContent = data.wind_gusts_10m;
        document.getElementById('wDirTxt').textContent = `${dirTxt} (${data.wind_direction_10m}¬∞)`;
        document.getElementById('wCodeDesc').textContent = wDesc;

        const lRisk = getLightningRisk(data.weather_code, data.precipitation);
        const wRisk = getWindRisk(data.wind_gusts_10m, data.precipitation);

        const lb = document.getElementById('lightningBadge');
        lb.textContent = "R·ª¶I RO S√âT: " + lRisk.level;
        lb.className = `risk-level risk-${lRisk.type}`;
        document.getElementById('lightningComment').textContent = lRisk.msg;

        const wb = document.getElementById('windBadge');
        wb.textContent = "R·ª¶I RO GI√ì: " + wRisk.level;
        wb.className = `risk-level risk-${wRisk.type}`;
        document.getElementById('windComment').textContent = wRisk.msg;

        const formatTime = timeInput.replace('T', ' ');
        reportText = `‚ö° B√ÅO C√ÅO S·ª∞ C·ªê L∆Ø·ªöI ƒêI·ªÜN ‚ö°\n` +
                     `üïí Th·ªùi gian: ${formatTime}\n` +
                     `üìç V·ªã tr√≠: ${address}\n` +
                     `üåç T·ªça ƒë·ªô: ${lat.toFixed(5)}, ${lon.toFixed(5)}\n` +
                     `------------------------------\n` +
                     `üìä TH·ªúI TI·∫æT T·∫†I HI·ªÜN TR∆Ø·ªúNG:\n` +
                     `‚Ä¢ Gi√≥ gi·∫≠t: ${data.wind_gusts_10m} km/h (H∆∞·ªõng: ${dirTxt})\n` +
                     `‚Ä¢ L∆∞·ª£ng m∆∞a: ${data.precipitation} mm\n` +
                     `‚Ä¢ Th·ªùi ti·∫øt: ${wDesc}\n` +
                     `------------------------------\n` +
                     `üõ°Ô∏è NH·∫¨N ƒê·ªäNH R·ª¶I RO:\n` +
                     `‚Ä¢ S√©t/D√¥ng: ${lRisk.level}\n` +
                     `‚Ä¢ Gi√≥ b√£o: ${wRisk.level}`;
    }
    
    function copyReport() { navigator.clipboard.writeText(reportText).then(() => alert("‚úÖ ƒê√£ sao ch√©p!")).catch(e => alert("L·ªói copy")); }
    function getLightningRisk(code, rain) { if ([95, 96, 99].includes(code)) return { level: "CAO (C√≥ d√¥ng s√©t)", type: "high", msg: "C·∫£nh b√°o D√¥ng b√£o." }; if ([80, 81, 82].includes(code) || (rain > 5 && [61,63,65].includes(code))) return { level: "TRUNG B√åNH", type: "med", msg: "M∆∞a r√†o n·∫∑ng h·∫°t." }; return { level: "TH·∫§P", type: "low", msg: "√çt c√≥ kh·∫£ nƒÉng s√©t." }; }
    function getWindRisk(gust, rain) { if (gust >= 60) return { level: "CAO (Gi√≥ l·ªëc)", type: "high", msg: "Gi√≥ >60km/h." }; if (gust >= 40 || (gust>=30 && rain>0)) return { level: "TRUNG B√åNH", type: "med", msg: "Gi√≥ gi·∫≠t m·∫°nh." }; return { level: "TH·∫§P", type: "low", msg: "Gi√≥ b√¨nh th∆∞·ªùng." }; }
    function getWindDirection(deg) { const dirs = ["B·∫Øc", "ƒê√¥ng B·∫Øc", "ƒê√¥ng", "ƒê√¥ng Nam", "Nam", "T√¢y Nam", "T√¢y", "T√¢y B·∫Øc"]; return dirs[Math.round(deg / 45) % 8]; }
    function getWeatherDesc(code) { const map = { 0: "Quang ƒë√£ng", 1: "N·∫Øng nh·∫π", 2: "C√≥ m√¢y", 3: "√Çm u", 45: "S∆∞∆°ng m√π", 51: "M∆∞a ph√πn", 61: "M∆∞a nh·ªè", 63: "M∆∞a v·ª´a", 65: "M∆∞a to", 80: "M∆∞a r√†o nh·∫π", 81: "M∆∞a r√†o", 82: "M∆∞a r√†o to", 95: "D√¥ng b√£o", 96: "D√¥ng + M∆∞a ƒë√°" }; return map[code] || `M√£ ${code}`; }
</script>

</body>
</html>
