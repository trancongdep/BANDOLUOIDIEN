<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng L∆∞·ªõi ƒêi·ªán v14.1 (Fix L·ªói Ti·∫øng Vi·ªát)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background: #f4f6f8; }
        #sidebar { width: 450px; background: white; border-right: 1px solid #ccc; display: flex; flex-direction: column; z-index: 2000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .header { background: #2c3e50; color: white; padding: 15px; } .header h2 { margin: 0; font-size: 1.1rem; }
        .content { padding: 15px; overflow-y: auto; flex: 1; }
        #debug-console { background: #212121; color: #00e676; font-family: 'Consolas', monospace; padding: 10px; border-radius: 4px; font-size: 0.8rem; max-height: 250px; overflow-y: auto; margin-bottom: 15px; white-space: pre-wrap; border: 1px solid #444; }
        .card { background: white; padding: 15px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; }
        button { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .btn-check { background: #607d8b; color: white; } .btn-upload { background: #e65100; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="header"><h2><i class="fas fa-tools"></i> Admin & Debugger v14.1</h2></div>
        <div class="content">
            <div class="card">
                <label>1. Ki·ªÉm tra & Upload (H·ªó tr·ª£ ti·∫øng Vi·ªát):</label>
                <input type="file" id="excelFile" accept=".xlsx" style="margin-bottom:10px; width:100%"/>
                <button class="btn-check" onclick="analyzeFile()"><i class="fas fa-stethoscope"></i> Ph√¢n T√≠ch T√¨m L·ªói</button>
                <div id="debug-console">S·∫µn s√†ng...</div>
                <button class="btn-upload" id="btnUpload" onclick="uploadToCloud()" disabled><i class="fas fa-cloud-upload-alt"></i> Upload Firebase</button>
            </div>
        </div>
    </div>
    <div id="map" style="flex:1;"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.set = set; window.ref = ref;
    </script>

    <script>
        let map = L.map('map').setView([10.762, 106.660], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let stagingData = null;

        function log(msg, type='info') {
            const c = document.getElementById('debug-console');
            let color = type=='err'?'#ff5252':(type=='warn'?'#ffab40':'#00e676');
            c.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        // --- H√ÄM CHU·∫®N H√ìA M·∫†NH M·∫º (B·ªé D·∫§U) ---
        function norm(obj) {
            let n = {};
            Object.keys(obj).forEach(k => {
                // 1. Chuy·ªÉn th√†nh chu·ªói
                let key = String(k);
                // 2. B·ªè d·∫•u ti·∫øng Vi·ªát (Huy·ªÅn, s·∫Øc, h·ªèi...)
                key = key.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                // 3. ƒê·ªïi ch·ªØ ƒê -> D
                key = key.replace(/ƒë/g, "d").replace(/ƒê/g, "D");
                // 4. Vi·∫øt hoa, trim, thay d·∫•u c√°ch b·∫±ng _
                key = key.trim().toUpperCase().replace(/[^A-Z0-9]/g, "_"); // Ch·ªâ gi·ªØ l·∫°i Ch·ªØ v√† S·ªë
                
                n[key] = obj[k];
            });
            return n;
        }

        function analyzeFile() {
            const input = document.getElementById('excelFile');
            document.getElementById('debug-console').innerHTML = "";
            if(!input.files.length) return log("Ch∆∞a ch·ªçn file!", 'err');

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    
                    const findS = (k) => wb.SheetNames.find(n => k.some(x => n.toUpperCase().includes(x)));
                    const sCircs = findS(["CAU_HINH","MACH","DUONG"]);
                    const sPoles = findS(["TOA_DO","TRU"]);
                    const sSegs = findS(["DOAN","SEG"]);

                    if(!sCircs) return log("‚ùå Kh√¥ng th·∫•y Sheet M·∫°ch (c·∫ßn t√™n 'MACH', 'CAU_HINH')", 'err');
                    if(!sPoles) return log("‚ùå Kh√¥ng th·∫•y Sheet Tr·ª•", 'err');
                    if(!sSegs) return log("‚ùå Kh√¥ng th·∫•y Sheet ƒêo·∫°n", 'err');

                    const rawCircs = XLSX.utils.sheet_to_json(wb.Sheets[sCircs]);
                    const rawPoles = XLSX.utils.sheet_to_json(wb.Sheets[sPoles]);
                    const rawSegs = XLSX.utils.sheet_to_json(wb.Sheets[sSegs]);

                    // DEBUG: In ra c√°c c·ªôt t√¨m th·∫•y ƒë·ªÉ ki·ªÉm tra
                    if(rawCircs.length > 0) {
                        let sampleRow = norm(rawCircs[0]);
                        log(`‚ÑπÔ∏è Sheet M·∫°ch c√≥ c√°c c·ªôt: ${Object.keys(sampleRow).join(", ")}`, 'warn');
                    }

                    // --- PARSE DATA ---
                    let cleanData = { poles: {}, segments: {}, circuits: {} };
                    let errors = 0;

                    // 1. Poles
                    rawPoles.forEach(r => {
                        let row = norm(r);
                        let l = row.MA_TUYEN || row.TUYEN;
                        let n = row.TEN_TRU || row.VI_TRI;
                        if(l && row.LAT && row.LONG) {
                            if(!cleanData.poles[l]) cleanData.poles[l] = [];
                            let sort = parseInt((String(n).match(/\d+/) || [9999])[0]);
                            cleanData.poles[l].push({name:String(n), lat:row.LAT, lng:row.LONG, sort});
                        }
                    });

                    // 2. Segments
                    rawSegs.forEach(r => {
                        let row = norm(r);
                        let id = row.MA_DOAN || row.MA_DOAN_TUYEN;
                        if(id) cleanData.segments[id] = { id, line: row.MA_TUYEN || row.TUYEN, from: row.TU_TRU, to: row.DEN_TRU };
                    });

                    // 3. Circuits (Check L·ªói k·ªπ h∆°n)
                    rawCircs.forEach((r, i) => {
                        let row = norm(r);
                        let cid = row.MA_DUONG_DAY || row.MA_MACH || row.TEN_MACH; // Th·ª≠ nhi·ªÅu key
                        let sid = row.MA_DOAN || row.MA_DOAN_TUYEN || row.DOAN;   // Th·ª≠ nhi·ªÅu key
                        
                        if(!cid) return; // D√≤ng tr·ªëng

                        if(!sid) {
                            log(`‚ùå D√≤ng ${i+2}: M·∫°ch '${cid}' thi·∫øu M√£ ƒêo·∫°n.`, 'err');
                            log(`   -> C·ªôt hi·ªán c√≥: ${Object.keys(row).join(", ")}`, 'warn');
                            errors++;
                            return;
                        }
                        
                        // Check link
                        if(!cleanData.segments[sid]) {
                            log(`‚ùå D√≤ng ${i+2}: M·∫°ch g·ªçi ƒëo·∫°n '${sid}' nh∆∞ng kh√¥ng c√≥ trong Sheet ƒêo·∫°n`, 'err');
                            errors++;
                        } else {
                            if(!cleanData.circuits[cid]) cleanData.circuits[cid] = [];
                            cleanData.circuits[cid].push({ segId: sid, order: parseInt(row.STT||999) });
                        }
                    });

                    if(errors > 0) {
                        log(`üö´ C√≥ ${errors} l·ªói. H√£y ki·ªÉm tra l·∫°i t√™n c·ªôt trong Excel.`, 'err');
                        log(`üí° G·ª£i √Ω: T√™n c·ªôt ph·∫£i l√† 'MA_DOAN' ho·∫∑c 'M√£ ƒêo·∫°n'`, 'info');
                    } else {
                        log("‚ú® D·ªØ li·ªáu OK! S·∫µn s√†ng Upload.", 'info');
                        stagingData = cleanData;
                        document.getElementById('btnUpload').disabled = false;
                    }

                } catch(e) { log(e.message, 'err'); }
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function uploadToCloud() {
            if(!stagingData) return;
            log("ƒêang upload...");
            window.set(window.ref(window.db, 'he_thong_luoi_dien'), stagingData)
                .then(() => log("‚úÖ Th√†nh c√¥ng!", 'info'))
                .catch(e => log(e.message, 'err'));
        }
    </script>
</body>
</html>
