<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hệ Thống Lưới Điện - Version 2.7</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* CSS CHUẨN */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; overflow: hidden; }
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 1; }
        
        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 2000; background: #004d40; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; }
        
        #sidebar { 
            position: fixed; top: 0; left: -100%; width: 90%; max-width: 450px; 
            bottom: calc(30px + env(safe-area-inset-bottom, 10px)); 
            background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); 
            transition: left 0.3s ease-in-out; display: flex; flex-direction: column; 
        }
        #sidebar.active { left: 0; }

        .header { background: #004d40; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 1.1rem; }
        .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .content { padding: 10px; overflow-y: auto; flex: 1; background: #fafafa; }
        
        .footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; min-height: 30px; 
            padding-top: 5px; padding-bottom: env(safe-area-inset-bottom, 10px); 
            background: #212121; color: #eceff1; display: flex; align-items: center; justify-content: center; 
            font-size: 0.75rem; border-top: 3px solid #ff6f00; z-index: 4000; 
        }
        
        .accordion { background-color: #eee; color: #444; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left; outline: none; font-size: 0.95rem; font-weight: bold; transition: 0.4s; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-bottom: 1px solid #ddd; }

        label { font-weight: 600; font-size: 0.85rem; display: block; margin: 8px 0 4px; color: #333; }
        input, select { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 10px; color: white; background: #00796b; }
        
        .legend { background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); font-size: 0.75rem; min-width: 130px; display: block; margin-right: 10px; margin-bottom: calc(45px + env(safe-area-inset-bottom, 10px)) !important; }
        .legend-icon { width: 14px; height: 14px; margin-right: 6px; border: 1px solid #999; display: inline-block; vertical-align: middle; }

        /* ICONS */
        .icon-mc-on { background: #d32f2f; border: 2px solid white; border-radius: 2px; font-size: 9px; color: white; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); text-align:center; }
        .icon-mc-off { background: #388e3c; border: 2px solid white; border-radius: 2px; font-size: 9px; color: white; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); text-align:center; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; border: 1px solid white; width: 10px !important; height: 10px !important; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; border: 1px solid white; width: 8px !important; height: 8px !important; }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i> MENU</button>

    <div id="sidebar">
        <div class="header"><h2>HỆ THỐNG ĐIỆN V2.7</h2><button class="close-btn" onclick="closeSidebar()">×</button></div>
        <div class="content">
            <button class="accordion">1. Cập nhật Dữ liệu</button>
            <div class="panel" id="panel-update">
                <label>Nhập từ File (TOA_DO, DM_DOAN):</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn" onclick="window.analyzeFiles()">Nạp Dữ liệu</button>
                <div id="console" style="background:#222; color:#0f0; padding:10px; font-family:monospace; font-size:0.7rem; height:100px; overflow:auto;"></div>
            </div>
            
            <button class="accordion">2. Vận hành (Đóng/Cắt)</button>
            <div class="panel">
                <div style="padding:10px; text-align:center; font-style:italic;">
                    Click trực tiếp vào Máy Cắt trên bản đồ để thao tác.
                </div>
            </div>
        </div>
    </div>

    <div class="footer">Copyright TCD software @2026 - Version 2.7</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // INIT MAP
        let map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([10.762, 106.660], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {opacity:0.4}).addTo(map);

        let layers = {
            line: L.layerGroup().addTo(map),
            points: L.layerGroup().addTo(map), 
            mc: L.layerGroup().addTo(map)
        };

        let appData = { poles: {}, segments: {}, mcStates: {} }; 
        let globalPoleMap = {}; // Map tên trụ -> object trụ (để tìm nhanh)

        // UI LOGIC
        function openSidebar() { document.getElementById('sidebar').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
        document.getElementById('menu-toggle').onclick = openSidebar;
        document.querySelector('.close-btn').onclick = closeSidebar;
        
        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = panel.scrollHeight + "px";
            });
        }

        function log(msg) { 
            let c = document.getElementById('console'); 
            c.innerHTML += `<div>> ${msg}</div>`; 
            c.scrollTop = c.scrollHeight; 
        }

        // --- EXCEL IMPORT (FIXED LOGIC) ---
        function getCol(row, candidates) { 
            let k = Object.keys(row); 
            for(let c of candidates){ 
                let m = k.find(key => key.trim().toUpperCase().replace(/^\uFEFF/,'') === c); 
                if(m) return m; 
            } 
            return null; 
        }

        window.analyzeFiles = function() {
            const input = document.getElementById('excelFile');
            if(!input.files.length) return alert("Chưa chọn file");
            Promise.all(Array.from(input.files).map(readFile)).then(res => processSheets(Object.assign({}, ...res)));
        }

        function readFile(file) { 
            return new Promise(r => { 
                const rd = new FileReader(); 
                rd.onload = e => { 
                    const w = XLSX.read(new Uint8Array(e.target.result),{type:'array'}); 
                    let s = {}; 
                    w.SheetNames.forEach(n => s[n] = XLSX.utils.sheet_to_json(w.Sheets[n])); 
                    r(s); 
                }; 
                rd.readAsArrayBuffer(file); 
            }); 
        }

        function processSheets(sheets) {
            const sPoles = Object.keys(sheets).find(n => n.includes("TOA_DO"));
            const sSegs = Object.keys(sheets).find(n => n.includes("DM_DOAN"));

            if(!sPoles || !sSegs) return alert("Thiếu file TOA_DO hoặc DM_DOAN!");

            // RESET DATA
            appData = { poles: {}, segments: {}, mcStates: {} };
            globalPoleMap = {};
            layers.line.clearLayers(); layers.points.clearLayers(); layers.mc.clearLayers();

            // 1. PROCESS POLES
            let pData = sheets[sPoles];
            // Tìm tên cột (chấp nhận nhiều kiểu viết)
            let cMa = getCol(pData[0], ["MA_TUYEN"]);
            let cTen = getCol(pData[0], ["TEN_TRU", "TEN_DIEM"]);
            let cLat = getCol(pData[0], ["LAT"]);
            let cLng = getCol(pData[0], ["LONG"]);
            let cLoai = getCol(pData[0], ["LOAI_DIEM"]);

            pData.forEach(r => {
                let l = String(r[cMa]).trim();
                let n = String(r[cTen]).trim();
                let lat = parseFloat(r[cLat]);
                let lng = parseFloat(r[cLng]);
                let type = r[cLoai] ? String(r[cLoai]).trim().toUpperCase() : "TRU_DO";

                if (lat && lng) {
                    if (!appData.poles[l]) appData.poles[l] = [];
                    // Trích xuất số thứ tự từ tên trụ (để sắp xếp)
                    let num = parseInt((n.match(/\d+/) || [0])[0]);
                    let pObj = { name: n, lat: lat, lng: lng, type: type, line: l, sort: num };
                    
                    appData.poles[l].push(pObj);
                    
                    // Lưu vào Global Map để tìm kiếm nhanh bất kể tuyến
                    globalPoleMap[n] = pObj; 
                    // Lưu cả key kết hợp tuyến để chính xác hơn
                    globalPoleMap[l + "_" + n] = pObj;

                    if (type === 'MC') appData.mcStates[n] = true; // Mặc định đóng
                }
            });

            // Sắp xếp trụ trong tuyến
            for(let l in appData.poles) appData.poles[l].sort((a,b) => a.sort - b.sort);

            // 2. PROCESS SEGMENTS & DRAW INSTANTLY
            let sData = sheets[sSegs];
            let cId = getCol(sData[0], ["MA_DOAN"]);
            let cT1 = getCol(sData[0], ["TUYEN_TU"]);
            let cN1 = getCol(sData[0], ["TRU_TU"]);
            let cT2 = getCol(sData[0], ["TUYEN_DEN"]);
            let cN2 = getCol(sData[0], ["TRU_DEN"]);
            let cL = getCol(sData[0], ["LOAI", "LOAI_DIEM"]); // Fix tên cột

            sData.forEach(r => {
                let id = r[cId];
                if (id) {
                    let t1 = String(r[cT1]).trim();
                    let n1 = String(r[cN1]).trim();
                    let t2 = String(r[cT2]).trim();
                    let n2 = String(r[cN2]).trim();
                    let type = r[cL] ? String(r[cL]).trim().toUpperCase() : "NOI";

                    // LOGIC TÌM ĐIỂM THÔNG MINH (Smart Find)
                    // Ưu tiên 1: Tìm chính xác theo Tuyến_Tên
                    let p1 = globalPoleMap[t1 + "_" + n1];
                    let p2 = globalPoleMap[t2 + "_" + n2];

                    // Ưu tiên 2: Tìm theo Tên (nếu chỉ có tên trụ duy nhất)
                    if (!p1) p1 = globalPoleMap[n1];
                    if (!p2) p2 = globalPoleMap[n2];

                    if (p1 && p2) {
                        // AUTO FILL (Nối các trụ trung gian nếu cùng tuyến)
                        if (t1 === t2 && p1.line === p2.line) {
                            let linePoles = appData.poles[t1];
                            let i1 = linePoles.indexOf(p1);
                            let i2 = linePoles.indexOf(p2);
                            
                            // Nếu tìm thấy cả 2 và khoảng cách index > 1 -> Có trụ giữa
                            if (i1 !== -1 && i2 !== -1) {
                                let start = Math.min(i1, i2);
                                let end = Math.max(i1, i2);
                                // Vẽ nối tiếp từng đoạn nhỏ
                                for (let i = start; i < end; i++) {
                                    let pa = linePoles[i];
                                    let pb = linePoles[i+1];
                                    drawSegment(pa, pb, type);
                                }
                            } else {
                                // Fallback: Vẽ thẳng
                                drawSegment(p1, p2, type);
                            }
                        } else {
                            // Khác tuyến -> Vẽ thẳng
                            drawSegment(p1, p2, type);
                        }
                    } else {
                        log(`⚠️ Không tìm thấy điểm nối: ${n1} (${t1}) -> ${n2} (${t2})`);
                    }
                }
            });

            renderPoles(); // Vẽ trụ sau cùng để đè lên dây
            log("✅ Đã vẽ xong bản đồ!");
        }

        function drawSegment(p1, p2, type) {
            let color = '#333'; // Mặc định đen (chưa có nguồn)
            let dash = (type === 'NGAM') ? "5, 5" : null;
            let weight = 2;

            L.polyline([[p1.lat, p1.lng], [p2.lat, p2.lng]], {
                color: color, 
                weight: weight,
                dashArray: dash
            }).addTo(layers.line);
        }

        function renderPoles() {
            for (let l in appData.poles) {
                appData.poles[l].forEach(p => {
                    let icon;
                    let zIndex = 0;
                    let target = layers.points;

                    if (p.type === 'MC') {
                        target = layers.mc;
                        zIndex = 2000;
                        let label = p.name.slice(-3); // Lấy 3 số cuối
                        icon = L.divIcon({
                            className: 'icon-mc-on', // Mặc định đỏ
                            html: label,
                            iconSize: [24, 14]
                        });
                    } else {
                        // Trụ thường
                        icon = L.divIcon({
                            className: 'icon-tru-do',
                            iconSize: [8, 8]
                        });
                    }

                    L.marker([p.lat, p.lng], {
                        icon: icon,
                        zIndexOffset: zIndex
                    }).addTo(target).bindPopup(`<b>${p.name}</b><br>${p.line}`);
                });
            }
        }

        // --- LEGEND ---
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <div class="legend-item"><span class="legend-icon" style="background:#d32f2f"></span> MC Đóng</div>
                <div class="legend-item"><span class="legend-icon" style="background:#388e3c"></span> MC Mở</div>
                <div class="legend-item"><span class="legend-icon" style="background:#333; height:2px; margin-top:6px;"></span> Dây dẫn</div>
            `;
            return div;
        };
        legend.addTo(map);

    </script>
</body>
</html>
