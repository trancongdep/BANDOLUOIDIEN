<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng L∆∞·ªõi ƒêi·ªán v16.0 (Smart Merge)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background: #f0f2f5; }
        #sidebar { width: 480px; background: white; border-right: 1px solid #ccc; display: flex; flex-direction: column; z-index: 2000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .header { background: #37474f; color: white; padding: 15px; } .header h2 { margin: 0; font-size: 1.1rem; }
        .content { padding: 15px; overflow-y: auto; flex: 1; }
        
        .admin-box { background: #e0f7fa; border: 1px dashed #006064; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
        #console { background: #263238; color: #80cbc4; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 150px; overflow-y: auto; margin-top: 5px; white-space: pre-wrap; }
        
        button { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; transition: 0.2s; }
        .btn-analyze { background: #546e7a; color: white; }
        .btn-merge { background: #00897b; color: white; } 
        .btn-replace { background: #d32f2f; color: white; }
        button:hover { opacity: 0.9; } button:disabled { opacity: 0.5; cursor: not-allowed; }

        .stat-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: white; margin-right: 5px; }
        .bg-new { background: #2e7d32; } .bg-dup { background: #f57c00; }
        
        /* Modal Style */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 400px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="header"><h2><i class="fas fa-server"></i> Qu·∫£n L√Ω D·ªØ Li·ªáu (Smart Sync)</h2></div>
        <div class="content">
            <div class="admin-box">
                <label><b>1. Ch·ªçn File Excel:</b></label>
                <input type="file" id="excelFile" accept=".xlsx, .csv" multiple style="width:100%; margin-bottom:10px"/>
                
                <button class="btn-analyze" onclick="analyzeAndCompare()">
                    <i class="fas fa-search"></i> Ki·ªÉm tra Tr√πng l·∫∑p
                </button>
                
                <div id="console">Ch·ªù file...</div>

                <div id="action-buttons" style="display:none; margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                    <p style="margin:0 0 5px 0; font-size:0.9rem; font-weight:bold;">Ch·ªçn ph∆∞∆°ng th·ª©c Upload:</p>
                    
                    <button class="btn-merge" onclick="confirmUpload('merge')">
                        <i class="fas fa-code-branch"></i> G·ªòP D·ªÆ LI·ªÜU (Gi·ªØ c≈© + Th√™m m·ªõi)
                    </button>
                    
                    <button class="btn-replace" onclick="confirmUpload('replace')">
                        <i class="fas fa-trash-alt"></i> X√ìA C≈® - N·∫†P M·ªöI (C·∫©n th·∫≠n!)
                    </button>
                </div>
            </div>

            <div style="text-align:center; margin-bottom:10px;">
                <button onclick="drawAll()" style="background:#1565c0; color:white;"><i class="fas fa-map"></i> V·∫Ω L·∫°i B·∫£n ƒê·ªì</button>
             </div>
        </div>
    </div>
    
    <div id="map" style="flex:1;"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.set = set; window.ref = ref; window.get = get; window.update = update; window.onValue = onValue;
        
        // Load data on start
        listenCloud();
    </script>

    <script>
        let map = L.map('map').setView([10.762, 106.660], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let layers = { main: L.layerGroup().addTo(map) };

        let localData = null; // Data from Excel
        let cloudData = null; // Data from Firebase
        let diffReport = null; // Result of comparison

        function log(msg, type='info') {
            const c = document.getElementById('console');
            let color = type=='err'?'#ff5252':(type=='warn'?'#ffab40':(type=='success'?'#69f0ae':'#80cbc4'));
            c.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        function norm(obj) {
            let n = {};
            Object.keys(obj).forEach(k => {
                let key = String(k).normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D").trim().toUpperCase().replace(/[^A-Z0-9]/g, "_");
                if(key==='MADOAN'||key==='MADOANTUYEN') key='MA_DOAN';
                n[key] = obj[k];
            });
            return n;
        }

        // 1. T·∫¢I D·ªÆ LI·ªÜU T·ª™ CLOUD ƒê·ªÇ SO S√ÅNH
        function listenCloud() {
            window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), (snap) => {
                cloudData = snap.val() || { poles: {}, segments: {}, circuits: {} };
            });
        }

        // 2. PH√ÇN T√çCH FILE V√Ä SO S√ÅNH
        function analyzeAndCompare() {
            const input = document.getElementById('excelFile');
            document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('console').innerHTML = "";
            
            if(!input.files.length) return log("Ch∆∞a ch·ªçn file!", 'err');

            const promises = Array.from(input.files).map(readFile);
            Promise.all(promises).then(res => {
                let combined = {}; res.forEach(r => Object.assign(combined, r));
                processAndCompare(combined);
            }).catch(e => log(e.message, 'err'));
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const r = new FileReader();
                r.onload = e => {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    let sheets = {};
                    wb.SheetNames.forEach(n => sheets[n] = XLSX.utils.sheet_to_json(wb.Sheets[n]));
                    resolve(sheets);
                };
                r.readAsArrayBuffer(file);
            });
        }

        function processAndCompare(sheets) {
            // ... (Gi·ªØ nguy√™n logic t√¨m sheet v√† parse d·ªØ li·ªáu gi·ªëng v15.0) ...
            const findS = (k) => Object.keys(sheets).find(n => k.some(x => n.toUpperCase().includes(x)));
            const sPoles = findS(["TOA_DO","TRU"]); const sSegs = findS(["DOAN","SEG"]); const sCircs = findS(["CAU_HINH","MACH"]);
            
            if(!sPoles || !sSegs || !sCircs) return log("‚ùå Thi·∫øu Sheet c·∫ßn thi·∫øt.", 'err');

            let parsed = { poles: {}, segments: {}, circuits: {} };
            
            // Parse logic (r√∫t g·ªçn)
            sheets[sPoles].forEach(r => {
                let row = norm(r); let l = row.MA_TUYEN||row.TUYEN; let n = row.TEN_TRU||row.VI_TRI;
                if(!n && row.VI_TRI && row.VI_TRI.includes('_')) { let p=row.VI_TRI.split('_'); n=p[0]; l=p[1]; }
                if(l && row.LAT) {
                    if(!parsed.poles[l]) parsed.poles[l] = [];
                    parsed.poles[l].push({name:String(n).trim(), lat:row.LAT, lng:row.LONG, sort:parseInt((String(n).match(/\d+/)||[999])[0])});
                }
            });
            for(let k in parsed.poles) parsed.poles[k].sort((a,b)=>a.sort-b.sort);

            sheets[sSegs].forEach(r => {
                let row = norm(r); let id = row.MA_DOAN;
                if(id) parsed.segments[id] = { id, line: row.MA_TUYEN, from: String(row.TU_TRU).trim(), to: String(row.DEN_TRU).trim() };
            });

            sheets[sCircs].forEach(r => {
                let row = norm(r); let cid = row.MA_DUONG_DAY||row.MA_MACH;
                if(cid && row.MA_DOAN) {
                    if(!parsed.circuits[cid]) parsed.circuits[cid] = [];
                    parsed.circuits[cid].push({ segId: row.MA_DOAN, order: parseInt(row.STT||999) });
                }
            });

            localData = parsed;
            
            // --- B·∫ÆT ƒê·∫¶U SO S√ÅNH (DIFF) ---
            log("üîé ƒêang so s√°nh v·ªõi Cloud...", 'warn');
            
            let stats = {
                poles: { new: 0, exist: 0 },
                segments: { new: 0, exist: 0 },
                circuits: { new: 0, exist: 0 }
            };

            // Check Poles (Routes)
            Object.keys(localData.poles).forEach(k => {
                if(cloudData && cloudData.poles && cloudData.poles[k]) stats.poles.exist++;
                else stats.poles.new++;
            });

            // Check Segments
            Object.keys(localData.segments).forEach(k => {
                if(cloudData && cloudData.segments && cloudData.segments[k]) stats.segments.exist++;
                else stats.segments.new++;
            });

            // Check Circuits
            Object.keys(localData.circuits).forEach(k => {
                if(cloudData && cloudData.circuits && cloudData.circuits[k]) stats.circuits.exist++;
                else stats.circuits.new++;
            });

            // REPORT
            log(`üìä K·∫æT QU·∫¢ SO S√ÅNH:`);
            log(`- Tuy·∫øn d√¢y: ${stats.poles.new} m·ªõi, ${stats.poles.exist} tr√πng.`);
            log(`- ƒêo·∫°n m·∫´u: ${stats.segments.new} m·ªõi, ${stats.segments.exist} tr√πng.`);
            log(`- M·∫°ch ƒëi·ªán: ${stats.circuits.new} m·ªõi, ${stats.circuits.exist} tr√πng.`);

            if(stats.circuits.exist > 0) {
                log(`‚ö†Ô∏è Ch√∫ √Ω: C√≥ ${stats.circuits.exist} m·∫°ch ƒë√£ t·ªìn t·∫°i. N·∫øu ch·ªçn 'G·ªôp', s·∫Ω ghi ƒë√® c·∫•u h√¨nh m·ªõi cho m·∫°ch n√†y.`, 'warn');
            } else {
                log(`‚úÖ D·ªØ li·ªáu ho√†n to√†n m·ªõi.`, 'success');
            }

            document.getElementById('action-buttons').style.display = 'block';
        }

        // 3. TH·ª∞C HI·ªÜN UPLOAD
        function confirmUpload(mode) {
            if(!localData) return;

            if(mode === 'replace') {
                if(!confirm("C·∫¢NH B√ÅO: Ch·∫ø ƒë·ªô n√†y s·∫Ω X√ìA S·∫†CH d·ªØ li·ªáu c≈© tr√™n Cloud v√† thay b·∫±ng file n√†y. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?")) return;
                log("ƒêang x√≥a v√† ghi m·ªõi...", 'warn');
                window.set(window.ref(window.db, 'he_thong_luoi_dien'), localData)
                    .then(() => log("‚úÖ ƒê√£ thay th·∫ø to√†n b·ªô d·ªØ li·ªáu!", 'success'));
            } 
            else if (mode === 'merge') {
                log("ƒêang g·ªôp d·ªØ li·ªáu...", 'info');
                
                // Logic Merge: D√πng update() ƒë·ªÉ kh√¥ng x√≥a c√°c nh√°nh kh√°c
                let updates = {};

                // Merge Poles
                Object.keys(localData.poles).forEach(key => {
                    updates[`he_thong_luoi_dien/poles/${key}`] = localData.poles[key];
                });

                // Merge Segments
                Object.keys(localData.segments).forEach(key => {
                    updates[`he_thong_luoi_dien/segments/${key}`] = localData.segments[key];
                });

                // Merge Circuits
                Object.keys(localData.circuits).forEach(key => {
                    updates[`he_thong_luoi_dien/circuits/${key}`] = localData.circuits[key];
                });

                window.update(window.ref(window.db), updates)
                    .then(() => log("‚úÖ ƒê√£ g·ªôp th√†nh c√¥ng! D·ªØ li·ªáu c≈© kh√¥ng b·ªã m·∫•t.", 'success'))
                    .catch(e => log("L·ªói: " + e.message, 'err'));
            }
        }

        // Map Drawing (Gi·ªØ nguy√™n t·ª´ b·∫£n tr∆∞·ªõc)
        function drawAll() {
            layers.main.clearLayers();
            if(!cloudData || !cloudData.circuits) return;
            let keys = Object.keys(cloudData.circuits);
            keys.forEach((cid, i) => {
                let pts = getPoints(cid);
                if(pts.length) {
                    let offset = (i - keys.length/2)*5;
                    L.polyline(pts.map(p=>[p.lat,p.lng]), {color:'blue', weight:2, offset:offset}).addTo(layers.main).bindPopup(cid);
                }
            });
            if(keys.length) { let p=getPoints(keys[0]); if(p.length) map.fitBounds(p.map(x=>[x.lat,x.lng])); }
        }

        function getPoints(cid) {
            let pts = [];
            const segs = cloudData.circuits[cid];
            segs.forEach(item => {
                const def = cloudData.segments[item.segId];
                if(def && cloudData.poles[def.line]) {
                    const lData = cloudData.poles[def.line];
                    let i1 = lData.findIndex(p=>p.name===def.from);
                    let i2 = lData.findIndex(p=>p.name===def.to);
                    if(i1>=0 && i2>=0) {
                        let sub = (i1<=i2) ? lData.slice(i1,i2+1) : lData.slice(i2,i1+1).reverse();
                        pts = pts.concat(sub);
                    }
                }
            });
            return pts;
        }

    </script>
</body>
</html>
