<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u T·ªça ƒë·ªô Th√¥ng minh v1.1</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
        }
        h2 {
            margin-top: 0;
            color: #1a73e8;
            text-align: center;
            font-size: 24px;
        }
        .instruction {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 20px;
            text-align: center;
            background: #e8f0fe;
            padding: 10px;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #202124;
        }
        textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 16px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background-color: #1557b0;
        }
        button:disabled {
            background-color: #dadce0;
            cursor: not-allowed;
        }
        #result {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: none;
        }
        .result-item {
            margin-bottom: 10px;
        }
        .label-res {
            font-weight: bold;
            font-size: 13px;
            color: #5f6368;
            text-transform: uppercase;
        }
        .value-res {
            font-size: 16px;
            color: #202124;
            line-height: 1.5;
        }
        .coords-debug {
            font-family: monospace;
            color: #d93025;
            background: #fce8e6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
        .map-link {
            display: inline-block;
            margin-top: 10px;
            text-decoration: none;
            color: #1a73e8;
            font-weight: 600;
        }
        .map-link:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            color: #5f6368;
            display: none;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>üìç Tra c·ª©u ƒê·ªãa ch·ªâ OSM</h2>
    
    <div class="instruction">
        H·ªó tr·ª£ ƒë·ªãnh d·∫°ng Vi·ªát Nam:<br>
        <code>10,7603659, 106,6853132</code>
    </div>

    <div class="form-group">
        <label for="rawCoords">D√°n t·ªça ƒë·ªô v√†o ƒë√¢y:</label>
        <textarea id="rawCoords" placeholder="V√≠ d·ª•: 10,7603659, 106,6853132"></textarea>
    </div>

    <button id="btnSearch" onclick="processAndSearch()">üîç T√¨m ƒë·ªãa ch·ªâ</button>
    
    <div id="loading" class="loading">ƒêang k·∫øt n·ªëi OpenStreetMap...</div>

    <div id="result">
        <div class="result-item">
            <div class="label-res">T·ªça ƒë·ªô ƒë√£ x·ª≠ l√Ω:</div>
            <div class="value-res"><span id="parsedCoords" class="coords-debug"></span></div>
        </div>
        <div class="result-item">
            <div class="label-res">ƒê·ªãa ch·ªâ t√¨m ƒë∆∞·ª£c:</div>
            <div id="addressText" class="value-res" style="font-weight: 500;"></div>
        </div>
        <a id="mapLink" href="#" target="_blank" class="map-link">Xem tr√™n b·∫£n ƒë·ªì l·ªõn &rarr;</a>
    </div>
</div>

<script>
    async function processAndSearch() {
        const rawInput = document.getElementById('rawCoords').value;
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const btn = document.getElementById('btnSearch');

        // Reset UI
        resultDiv.style.display = 'none';
        
        if (!rawInput.trim()) {
            alert("Vui l√≤ng nh·∫≠p t·ªça ƒë·ªô!");
            return;
        }

        // --- B∆Ø·ªöC 1: X·ª¨ L√ù CHU·ªñI ƒê·∫¶U V√ÄO (PARSING) ---
        // M·ª•c ti√™u: Chuy·ªÉn "10,123, 106,456" th√†nh lat=10.123, lon=106.456
        let lat, lon;
        
        try {
            // 1. Chu·∫©n h√≥a: X√≥a kho·∫£ng tr·∫Øng th·ª´a
            let cleanStr = rawInput.trim();
            
            // 2. Ph√°t hi·ªán ƒë·ªãnh d·∫°ng: 
            // N·∫øu chu·ªói ch·ª©a d·∫•u ph·∫©y gi·ªØa c√°c s·ªë (V√≠ d·ª•: "10,123" thay v√¨ "10.123")
            // Ta d√πng Regex ƒë·ªÉ t√¨m d·∫•u ph·∫©y ngƒÉn c√°ch 2 t·ªça ƒë·ªô.
            // Logic: T√¨m n∆°i c√≥ ", " (ph·∫©y + kho·∫£ng tr·∫Øng) ho·∫∑c t√°ch ƒë√¥i chu·ªói d·ª±a tr√™n s·ªë l∆∞·ª£ng d·∫•u ph·∫©y.
            
            let parts;
            
            // Tr∆∞·ªùng h·ª£p 1: D√πng d·∫•u ch·∫•m chu·∫©n (10.123, 106.123)
            if (cleanStr.includes('.') && !cleanStr.includes(',,')) {
                parts = cleanStr.split(/[\s,]+/); // T√°ch b·∫±ng ph·∫©y ho·∫∑c kho·∫£ng tr·∫Øng
            } 
            // Tr∆∞·ªùng h·ª£p 2: D√πng to√†n d·∫•u ph·∫©y (10,123, 106,123)
            else {
                // Thay th·∫ø ", " (ph·∫©y c√°ch) th√†nh k√Ω t·ª± ƒë·∫∑c bi·ªát "|" ƒë·ªÉ t√°ch
                // Gi·∫£ ƒë·ªãnh ng∆∞·ªùi d√πng copy c√≥ kho·∫£ng tr·∫Øng sau d·∫•u ph·∫©y ngƒÉn c√°ch
                if (cleanStr.includes(', ')) {
                    let temp = cleanStr.replace(', ', '|'); 
                    parts = temp.split('|');
                } else {
                    // N·∫øu d√≠nh li·ªÅn (10,123,106,123), ta c·∫Øt ƒë√¥i m·∫£ng
                    let rawParts = cleanStr.split(',');
                    if (rawParts.length === 4) {
                        parts = [
                            rawParts[0] + '.' + rawParts[1],
                            rawParts[2] + '.' + rawParts[3]
                        ];
                    } else if (rawParts.length === 2) {
                        parts = rawParts; // C√≥ th·ªÉ l√† 10.123,106.123
                    }
                }
            }

            // L·ªçc l·∫•y s·ªë v√† thay d·∫•u ph·∫©y th√†nh d·∫•u ch·∫•m cho t·ª´ng ph·∫ßn
            const numbers = parts.map(p => {
                // Gi·ªØ l·∫°i s·ªë, d·∫•u ch·∫•m, d·∫•u tr·ª´. Thay d·∫•u ph·∫©y th√†nh ch·∫•m.
                let processed = p.replace(/,/g, '.').replace(/[^0-9.-]/g, '');
                return parseFloat(processed);
            }).filter(n => !isNaN(n));

            if (numbers.length < 2) throw new Error("Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c 2 to·∫° ƒë·ªô.");

            lat = numbers[0];
            lon = numbers[1];

            // Validate c∆° b·∫£n Vi·ªát Nam (Lat ~8-23, Lon ~102-109) - Optional
            
        } catch (e) {
            alert("Kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c t·ªça ƒë·ªô. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng.\nN√™n nh·∫≠p: 10,7603659, 106,6853132");
            return;
        }

        // Hi·ªÉn th·ªã t·ªça ƒë·ªô ƒë√£ hi·ªÉu
        document.getElementById('parsedCoords').textContent = `Lat: ${lat} | Lon: ${lon}`;

        // --- B∆Ø·ªöC 2: G·ªåI API OPENSTREETMAP ---
        loadingDiv.style.display = 'block';
        btn.disabled = true;

        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
            
            const response = await fetch(url, {
                headers: {
                    'Accept-Language': 'vi' // Y√™u c·∫ßu tr·∫£ v·ªÅ ti·∫øng Vi·ªát
                }
            });

            if (!response.ok) throw new Error("L·ªói k·∫øt n·ªëi API");

            const data = await response.json();

            // --- B∆Ø·ªöC 3: HI·ªÇN TH·ªä K·∫æT QU·∫¢ ---
            if (data.error) {
                document.getElementById('addressText').textContent = "Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ (C√≥ th·ªÉ t·ªça ƒë·ªô n·∫±m gi·ªØa bi·ªÉn/r·ª´ng).";
            } else {
                document.getElementById('addressText').textContent = data.display_name;
                
                // C·∫≠p nh·∫≠t link map
                const mapLink = document.getElementById('mapLink');
                mapLink.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=18/${lat}/${lon}`;
            }
            
            resultDiv.style.display = 'block';

        } catch (err) {
            alert("L·ªói: " + err.message);
        } finally {
            loadingDiv.style.display = 'none';
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
