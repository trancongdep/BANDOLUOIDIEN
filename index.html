<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng L∆∞·ªõi ƒêi·ªán - Version 1.27 (Absolute Strict)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* CSS CHU·∫®N */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        #sidebar { 
            position: fixed; top: 0; left: -100%; width: 85%; max-width: 400px; 
            height: calc(100% - 30px); 
            background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); 
            transition: left 0.3s ease-in-out; display: flex; flex-direction: column;
        }
        #sidebar.active { left: 0; }

        .header { background: #004d40; color: white; padding: 15px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 1.1rem; }
        .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        .content { padding: 10px; overflow-y: auto; flex: 1; background: #fafafa; }
        .footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 30px;
            background: #212121; color: #eceff1; 
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; border-top: 3px solid #ff6f00; z-index: 4000;
        }

        #menu-toggle {
            position: absolute; top: 10px; left: 10px; z-index: 2000;
            background: #004d40; color: white; border: none;
            padding: 10px 15px; border-radius: 4px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold;
        }

        .accordion {
            background-color: #eee; color: #444; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left;
            outline: none; font-size: 0.95rem; font-weight: bold; transition: 0.4s; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
        }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        .accordion:after { content: '\002B'; font-weight: bold; float: right; margin-left: 5px; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-bottom: 1px solid #ddd; }

        label { font-weight: 600; font-size: 0.85rem; display: block; margin: 10px 0 5px; color: #333; }
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; }
        .btn-check { background: #00796b; color: white; }
        .btn-merge { background: #2e7d32; color: white; }
        .btn-replace { background: #c62828; color: white; }
        .btn-find { background: #d32f2f; color: white; }
        input, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #console { background: #212121; color: #00e676; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 120px; overflow-y: auto; margin-bottom: 10px; }
        #upload-actions { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }

        /* LEGEND */
        .legend { background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); font-size: 0.75rem; min-width: 130px; display: block; margin-bottom: 30px; }
        .legend h4 { margin: 0 0 5px 0; color: #004d40; font-size: 0.85rem; border-bottom: 2px solid #b2dfdb; padding-bottom: 3px; font-weight: bold; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-icon { width: 14px; height: 14px; margin-right: 6px; display: inline-block; vertical-align: middle; border: 1px solid #999; }

        /* FAULT BOX */
        .fault-box { display: none; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); border-left: 5px solid #d32f2f; width: 260px; font-size: 0.9rem; margin-bottom: 30px; }
        .fault-header { color: #d32f2f; font-weight: bold; font-size: 1rem; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .fault-row { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
        .fault-label { font-weight: bold; color: #555; }
        .btn-close-fault { background: #eee; border: none; padding: 2px 8px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }

        /* ICONS */
        .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.6); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; }
        .icon-mc-on { background: #ff0000; border: 2px solid white; border-radius: 2px; z-index: 1000; }
        .icon-mc-off { background: #388e3c; border: 2px solid white; border-radius: 2px; z-index: 1000; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; }
        .icon-moc { background: #7b1fa2; border-radius: 0px; width: 8px !important; height: 8px !important; margin-left: -4px !important; margin-top: -4px !important; }
        .icon-cot-moc { background: #4a148c; border-radius: 2px 2px 0 0; border-bottom: none; }
        .icon-ham-cap { background: #5d4037; border-radius: 4px; font-family: sans-serif; }
        .warning-msg { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; border: 1px solid #ffcdd2; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="map" style="flex:1;"></div>
    <button id="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i> MENU</button>

    <div id="sidebar">
        <div class="header">
            <h2>QU·∫¢N L√ù L∆Ø·ªöI ƒêI·ªÜN</h2>
            <button class="close-btn" onclick="closeSidebar()">√ó</button>
        </div>
        <div class="content">
            <button class="accordion">1. C·∫≠p nh·∫≠t D·ªØ li·ªáu</button>
            <div class="panel">
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn btn-check" onclick="window.analyzeFiles()">Ki·ªÉm tra (Chu·∫©n x√°c)</button>
                <div id="console">Ch·ªù file...</div>
                <div id="upload-actions" style="display:none;">
                    <button class="action-btn btn-merge" onclick="window.confirmUpload('merge')">G·ªòP D·ªÆ LI·ªÜU</button>
                    <button class="action-btn btn-replace" onclick="window.confirmUpload('replace')">X√ìA & GHI M·ªöI</button>
                </div>
            </div>

            <button class="accordion">2. V·∫≠n h√†nh (SCADA)</button>
            <div class="panel">
                <select id="circuitSelect" onchange="window.drawCircuit()">
                    <option value="">-- Ch·ªçn m·∫°ch --</option>
                </select>
                <div style="margin-top:10px;">Tr·∫°ng th√°i: <span id="status-text" style="font-weight:bold;">---</span></div>
                <div id="circuit-info" style="font-size:0.8rem; color:#00695c; margin-top:5px; font-weight:bold;"></div>
            </div>

            <button class="accordion">3. T√¨m ƒëi·ªÉm S·ª± c·ªë</button>
            <div class="panel">
                <input type="number" id="faultKm" step="0.01" placeholder="Nh·∫≠p s·ªë Km..." />
                <div class="radio-group">
                    <label><input type="radio" name="faultDir" value="start" checked> T·ª´ ƒê·∫ßu ngu·ªìn</label>
                    <label><input type="radio" name="faultDir" value="end"> T·ª´ Cu·ªëi ngu·ªìn</label>
                </div>
                <button class="action-btn btn-find" onclick="window.findFault()">T√åM V·ªä TR√ç</button>
                <div id="result" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div class="footer">Copyright TCD software @2025 - Version 1.27</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.set = set; window.update = update; window.ref = ref; window.onValue = onValue;
        window.listenCloud();
    </script>

    <script>
        let map = L.map('map').setView([10.762, 106.660], 12);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {opacity:0.4}).addTo(map);
        
        let layers = { bg: L.layerGroup().addTo(map), bgPoints: L.layerGroup().addTo(map), mc: L.layerGroup().addTo(map), main: L.layerGroup().addTo(map), fault: L.layerGroup().addTo(map) };
        let appData = { poles: {}, segments: {}, circuits: {}, states: {} }; 
        let stagingData = null;
        let currentPathTotalDist = 0; 
        let currentPath = [];

        function openSidebar() { document.getElementById('sidebar').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
        map.on('click', closeSidebar);

        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = panel.scrollHeight + "px";
            });
        }

        var legendControl = L.control({position: 'bottomright'});
        legendControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.id = "main-legend";
            div.innerHTML = `
                <h4>CH√ö TH√çCH</h4>
                <div class="legend-item"><span class="legend-icon" style="background:#ff0000;"></span> D√¢y C√≥ ƒëi·ªán (ƒê·ªè)</div>
                <div class="legend-item"><span class="legend-icon" style="background:#388e3c;"></span> D√¢y C·∫Øt (Xanh)</div>
                <div class="legend-item"><span class="legend-icon" style="background:#000;"></span> M·∫•t ƒëi·ªán/Ch∆∞a r√µ</div>
                <hr style="margin:5px 0;">
                <div class="legend-item"><span class="legend-icon" style="background:#ff0000; border-radius:2px;"></span> MC ƒê√≥ng</div>
                <div class="legend-item"><span class="legend-icon" style="background:#388e3c; border-radius:2px;"></span> MC M·ªü</div>
                <div class="legend-item"><span class="legend-icon" style="background:#ff6f00; transform:rotate(45deg);"></span> Tr·ª• N√©o</div>
                <div class="legend-item"><span class="legend-icon" style="background:#1976d2; border-radius:50%;"></span> Tr·ª• ƒê·ª°</div>
                <div class="legend-item"><span class="legend-icon" style="background:#7b1fa2;"></span> M·ªëc C√°p</div>
                <div class="legend-item"><span class="legend-icon" style="background:#5d4037; border-radius:4px;"></span> H·∫ßm C√°p</div>
            `;
            return div;
        };
        legendControl.addTo(map);

        var faultControl = L.control({position: 'bottomright'});
        faultControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'fault-box');
            div.id = "fault-info-box";
            div.innerHTML = `
                <div class="fault-header">
                    <span><i class="fas fa-exclamation-triangle"></i> S·ª∞ C·ªê</span>
                    <button class="btn-close-fault" onclick="window.closeFaultInfo()">X</button>
                </div>
                <div class="fault-row"><span class="fault-label">M·∫°ch:</span> <span id="fi-name"></span></div>
                <div class="fault-row"><span class="fault-label">C√°ch ngu·ªìn:</span> <span id="fi-dist"></span></div>
                <div class="fault-row"><span class="fault-label">Kho·∫£ng tr·ª•:</span> <span id="fi-seg"></span></div>
                <div class="fault-row"><span class="fault-label">V·ªã tr√≠:</span> <span id="fi-addr"></span></div>
            `;
            return div;
        };
        faultControl.addTo(map);

        window.closeFaultInfo = function() {
            document.getElementById('fault-info-box').style.display = 'none';
            document.getElementById('main-legend').style.display = 'block';
            layers.fault.clearLayers();
        }

        function log(msg, type='info') {
            const c = document.getElementById('console');
            let color = type=='err'?'#ff5252':(type=='warn'?'#ffab40':(type=='success'?'#00e676':'#fff'));
            c.innerHTML += `<div style="color:${color}">> ${msg}</div>`; c.scrollTop = c.scrollHeight;
        }

        // --- H√ÄM T√åM C·ªòT CH√çNH X√ÅC ---
        function getCol(row, candidates) {
            let keys = Object.keys(row);
            for (let c of candidates) {
                // Lo·∫°i b·ªè BOM, so s√°nh ch√≠nh x√°c
                let match = keys.find(k => k.trim().replace(/^\uFEFF/, '') === c);
                if (match) return match;
            }
            return null;
        }

        window.analyzeFiles = function() {
            const input = document.getElementById('excelFile');
            document.getElementById('console').innerHTML = "";
            document.getElementById('upload-actions').style.display = "none";
            if(!input.files.length) return log("Ch∆∞a ch·ªçn file", 'err');
            Promise.all(Array.from(input.files).map(readFile)).then(res => processSheets(Object.assign({}, ...res))).catch(e => log(e.message, 'err'));
        }

        function readFile(file) { return new Promise(r => { const rd = new FileReader(); rd.onload=e=>{ const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); let s={}; w.SheetNames.forEach(n=>s[n]=XLSX.utils.sheet_to_json(w.Sheets[n])); r(s); }; rd.readAsArrayBuffer(file); }); }

        function processSheets(sheets) {
            const findS = k => Object.keys(sheets).find(n => n.includes(k));
            const sPoles=findS("TOA_DO"), sSegs=findS("DM_DOAN"), sCircs=findS("CAU_HINH");
            if(!sPoles||!sSegs||!sCircs) return log("Thi·∫øu file TOA_DO, DM_DOAN ho·∫∑c CAU_HINH", 'err');

            let data = { poles: {}, segments: {}, circuits: {}, states: {} };
            let errors = 0;

            // 1. POLES
            let polesData = sheets[sPoles];
            if (polesData.length) {
                let cMa = getCol(polesData[0], ["MA_TUYEN"]);
                let cTen = getCol(polesData[0], ["TEN_TRU"]);
                let cLat = getCol(polesData[0], ["LAT"]);
                let cLong = getCol(polesData[0], ["LONG"]);
                let cLoai = getCol(polesData[0], ["LOAI_DIEM"]);

                if(!cMa || !cTen || !cLat || !cLong) return log("File TOA_DO sai t√™n c·ªôt (MA_TUYEN, TEN_TRU, LAT, LONG)", 'err');

                polesData.forEach(r => {
                    let l = String(r[cMa]).trim(); 
                    let n = String(r[cTen]).trim();
                    let t = cLoai ? String(r[cLoai]).trim().toUpperCase() : "TRU_DO"; 
                    if(l && r[cLat]) {
                        if(!data.poles[l]) data.poles[l]=[];
                        let sNum = parseInt((n.match(/\d+/)||[9999])[0]);
                        data.poles[l].push({name:n, lat:parseFloat(r[cLat]), lng:parseFloat(r[cLong]), sort:sNum, type:t});
                    }
                });
                for(let k in data.poles) data.poles[k].sort((a,b)=>a.sort-b.sort);
            }

            // 2. SEGMENTS
            let segsData = sheets[sSegs];
            if (segsData.length) {
                let cId = getCol(segsData[0], ["MA_DOAN"]);
                let cT1 = getCol(segsData[0], ["TUYEN_TU"]);
                let cTr1 = getCol(segsData[0], ["TRU_TU"]);
                let cT2 = getCol(segsData[0], ["TUYEN_DEN"]);
                let cTr2 = getCol(segsData[0], ["TRU_DEN"]);
                let cL = getCol(segsData[0], ["LOAI_DIEM", "LOAI"]);

                if(!cId || !cT1 || !cTr1 || !cT2 || !cTr2) return log("File DM_DOAN sai t√™n c·ªôt (MA_DOAN, TUYEN_TU, TRU_TU, TUYEN_DEN, TRU_DEN)", 'err');

                segsData.forEach(r => {
                    let id = r[cId]; if(!id) return;
                    let t1 = String(r[cT1]).trim(), tr1 = String(r[cTr1]).trim();
                    let t2 = String(r[cT2]).trim(), tr2 = String(r[cTr2]).trim();

                    // CHECK STRICT
                    let p1 = data.poles[t1]?.find(p=>p.name===tr1);
                    let p2 = data.poles[t2]?.find(p=>p.name===tr2);

                    if(!p1) { log(`‚ö†Ô∏è ƒêo·∫°n ${id}: Kh√¥ng th·∫•y tr·ª• '${tr1}' ·ªü tuy·∫øn '${t1}'`, 'warn'); errors++; }
                    if(!p2) { log(`‚ö†Ô∏è ƒêo·∫°n ${id}: Kh√¥ng th·∫•y tr·ª• '${tr2}' ·ªü tuy·∫øn '${t2}'`, 'warn'); errors++; }

                    data.segments[id] = { id, type:(cL && String(r[cL]).includes("NGAM")?"NGAM":"NOI"), lineFrom:t1, poleFrom:tr1, lineTo:t2, poleTo:tr2 };
                });
            }

            // 3. CIRCUITS
            let circsData = sheets[sCircs];
            if (circsData.length) {
                let cCid = getCol(circsData[0], ["MA_DUONG_DAY"]);
                let cSid = getCol(circsData[0], ["MA_DOAN"]);
                let cStt = getCol(circsData[0], ["STT"]);

                if(!cCid || !cSid) return log("File CAU_HINH sai t√™n c·ªôt (MA_DUONG_DAY, MA_DOAN)", 'err');

                circsData.forEach(r => {
                    let cid = r[cCid];
                    let sid = r[cSid];
                    if(!sid) return;
                    if(!data.segments[sid]) { log(`‚ö†Ô∏è M·∫°ch ${cid} g·ªçi ƒëo·∫°n ${sid} kh√¥ng t·ªìn t·∫°i`, 'warn'); errors++; }
                    if(!data.circuits[cid]) data.circuits[cid]=[];
                    data.circuits[cid].push({ segId:sid, order:parseInt(r[cStt]||999) });
                    data.states[cid] = false;
                });
                for(let k in data.circuits) data.circuits[k].sort((a,b)=>a.order-b.order);
            }

            stagingData = data;
            if (errors>0) log(`üö´ C√ì ${errors} L·ªñI D·ªÆ LI·ªÜU.`, 'err');
            else log(`‚úÖ D·ªØ li·ªáu chu·∫©n x√°c!`, 'success');
            document.getElementById('upload-actions').style.display = "block";
        }

        window.confirmUpload = function(mode) {
            if(!stagingData) return;
            if(mode==='replace' && !confirm("X√ìA H·∫æT c≈©?")) return;
            let updates = {};
            if(mode==='replace') window.set(window.ref(window.db, 'he_thong_luoi_dien'), stagingData).then(()=>log("Thay th·∫ø OK!",'success'));
            else {
                Object.keys(stagingData.poles).forEach(k => updates[`he_thong_luoi_dien/poles/${k}`] = stagingData.poles[k]);
                Object.keys(stagingData.segments).forEach(k => updates[`he_thong_luoi_dien/segments/${k}`] = stagingData.segments[k]);
                Object.keys(stagingData.circuits).forEach(k => updates[`he_thong_luoi_dien/circuits/${k}`] = stagingData.circuits[k]);
                if(stagingData.states) Object.keys(stagingData.states).forEach(k => updates[`he_thong_luoi_dien/states/${k}`] = false);
                window.update(window.ref(window.db), updates).then(()=>log("G·ªôp OK!",'success'));
            }
        }

        window.listenCloud = function() {
            window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), snap => {
                let val = snap.val();
                if(val) { appData = val; if(!appData.states) appData.states={}; updateUI(); drawBg(); if(document.getElementById('circuitSelect').value) window.drawCircuit(); }
            });
        }

        function updateUI() {
            const s = document.getElementById('circuitSelect');
            let cur = s.value; s.innerHTML = '<option value="">-- Ch·ªçn m·∫°ch --</option>';
            if(appData.circuits) Object.keys(appData.circuits).forEach(k => { let o=document.createElement('option'); o.value=k; o.text=k; s.add(o); });
            s.value = cur;
        }

        function createIcon(type, name, isClosed=true) {
            let cls='my-icon icon-tru-do', sz=[12,12];
            if(type.includes('MC')) { cls=isClosed?'my-icon icon-mc-on':'my-icon icon-mc-off'; sz=[16,16]; }
            else if(type.includes('NEO')) cls='my-icon icon-tru-neo';
            else if(type.includes('MOC')) { cls='my-icon icon-moc'; sz=[8,8]; }
            else if(type.includes('COT')) { cls='my-icon icon-cot-moc'; sz=[10,14]; }
            else if(type.includes('HAM')) { cls='my-icon icon-ham-cap'; sz=[14,10]; }
            return L.divIcon({ className: cls, html: type.includes('MC')?'MC':'', iconSize: sz });
        }

        function drawBg() {
            layers.bg.clearLayers(); layers.bgPoints.clearLayers(); layers.mc.clearLayers();
            if(appData.poles) for(let l in appData.poles) {
                let pts = appData.poles[l].map(p=>[p.lat,p.lng]);
                if(l !== 'MAYCAT' && pts.length>1) L.polyline(pts, {color:'#cfd8dc', weight:1}).addTo(layers.bg);
                appData.poles[l].forEach(p => {
                    let layer = (p.type.includes('MC')) ? layers.mc : layers.bgPoints;
                    L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.name, true) }).addTo(layer).bindPopup(p.name);
                });
            }
        }

        // Exact Match
        function getPole(line, name) {
            if(!appData.poles[line]) return null;
            return appData.poles[line].find(p => p.name === name);
        }

        function getPoleRange(line, from, to) {
            if(!appData.poles[line]) return [];
            const lData = appData.poles[line];
            let i1 = lData.findIndex(p=>p.name===from);
            let i2 = lData.findIndex(p=>p.name===to);
            if(i1<0 || i2<0) return [];
            return (i1<=i2) ? lData.slice(i1,i2+1) : lData.slice(i2,i1+1).reverse();
        }

        window.toggleCircuitState = function() {
            let cid = document.getElementById('circuitSelect').value;
            if(!cid) return;
            window.update(window.ref(window.db, 'he_thong_luoi_dien/states'), { [cid]: !appData.states[cid] });
        }

        window.drawCircuit = function() {
            const id = document.getElementById('circuitSelect').value;
            layers.main.clearLayers(); layers.fault.clearLayers(); layers.mc.clearLayers();
            currentPath = []; currentPathTotalDist = 0; 
            document.getElementById('circuit-info').innerText = "";

            if(!id || !appData.circuits[id]) { document.getElementById('status-text').innerText = "---"; return; }

            const segs = appData.circuits[id];
            let isClosed = appData.states[id] === true;
            let statusColor = isClosed ? '#ff0000' : '#388e3c';
            document.getElementById('status-text').innerHTML = `<span style="color:${statusColor}">${isClosed?'ƒêANG ƒê√ìNG (C√ì ƒêI·ªÜN)':'ƒêANG C·∫ÆT (AN TO√ÄN)'}</span>`;

            segs.forEach((item) => {
                const def = appData.segments[item.segId];
                if(!def) return;
                
                let p1 = getPole(def.lineFrom, def.poleFrom);
                let p2 = getPole(def.lineTo, def.poleTo);
                if(!p1 || !p2) return;

                let pts = [];
                if(def.lineFrom !== def.lineTo) pts = [p1, p2];
                else pts = getPoleRange(def.lineFrom, def.poleFrom, def.poleTo);

                if(pts.length) {
                    let isCable = (def.type.includes('NGAM'));
                    let color = statusColor;
                    if (isCable) color = isClosed ? '#7b1fa2' : '#000';
                    L.polyline(pts.map(p=>[p.lat,p.lng]), {color:color, weight:4, dashArray: isCable?"5,5":null}).addTo(layers.main);
                    
                    pts.forEach(p => {
                        let icon = createIcon(p.type, p.name, isClosed);
                        if(p.type.includes('MC')) {
                            L.marker([p.lat, p.lng], { icon: icon, zIndexOffset: 1000 }).addTo(layers.main)
                             .bindPopup(`<b>${p.name}</b><br>Click ƒë·ªÉ ƒê√≥ng/C·∫Øt`).on('click', window.toggleCircuitState);
                        } else {
                            L.marker([p.lat, p.lng], { icon: icon }).addTo(layers.main).bindPopup(p.name);
                        }
                    });

                    pts.forEach((p, i) => {
                        if(i>0) currentPathTotalDist += getDist(pts[i-1].lat, pts[i-1].lng, p.lat, p.lng);
                        currentPath.push({ ...p, accDist: currentPathTotalDist });
                    });
                }
            });
            document.getElementById('circuit-info').innerText = `T·ªïng d√†i: ${(currentPathTotalDist/1000).toFixed(2)} km`;
            map.fitBounds(currentPath.map(p=>[p.lat,p.lng]));
        }

        window.findFault = function() {
            let kmInput = parseFloat(document.getElementById('faultKm').value);
            let direction = document.querySelector('input[name="faultDir"]:checked').value;
            let cName = document.getElementById('circuitSelect').value;
            let res = document.getElementById('result');
            res.style.display = 'none'; 
            
            if(isNaN(kmInput) || currentPath.length<2) { res.style.display='block'; res.innerHTML='Ch∆∞a ch·ªçn m·∫°ch!'; return; }

            let targetDist = kmInput * 1000;
            if (direction === 'end') targetDist = currentPathTotalDist - (kmInput * 1000);

            if (targetDist < 0 || targetDist > currentPathTotalDist + 10) {
                res.style.display = 'block';
                res.className = 'warning-msg';
                res.innerHTML = `<i class="fas fa-exclamation-circle"></i> <b>L·ªñI:</b> Kho·∫£ng c√°ch ${kmInput}km v∆∞·ª£t qu√° chi·ªÅu d√†i d√¢y (${(currentPathTotalDist/1000).toFixed(2)}km)`;
                return;
            }

            for(let i=1; i<currentPath.length; i++) {
                let p1 = currentPath[i-1], p2 = currentPath[i];
                let segmentLen = p2.accDist - p1.accDist;
                
                if (targetDist >= p1.accDist && targetDist <= p2.accDist) {
                    let ratio = segmentLen > 0 ? (targetDist - p1.accDist) / segmentLen : 0;
                    
                    let lat = p1.lat + (p2.lat - p1.lat) * ratio;
                    let lng = p1.lng + (p2.lng - p1.lng) * ratio;

                    document.getElementById('main-legend').style.display = 'none';
                    document.getElementById('fault-info-box').style.display = 'block';
                    document.getElementById('fi-name').innerText = cName;
                    document.getElementById('fi-dist').innerText = `${kmInput} km (${direction==='start'?'ƒê·∫ßu':'Cu·ªëi'})`;
                    document.getElementById('fi-seg').innerHTML = `${p1.name} <i class="fas fa-arrow-right"></i> ${p2.name}`;
                    document.getElementById('fi-addr').innerHTML = `<a href="http://googleusercontent.com/maps.google.com/maps?q=${lat},${lng}" target="_blank" style="color:blue;text-decoration:underline;">M·ªü Google Maps</a>`;

                    L.marker([lat,lng], {icon: L.divIcon({html:'<i class="fas fa-bolt" style="color:red;font-size:32px;"></i>', className:'d'})})
                     .addTo(layers.fault).bindPopup("ƒêI·ªÇM S·ª∞ C·ªê").openPopup();
                    
                    map.setView([lat,lng], 16);
                    closeSidebar(); 
                    return;
                }
            }
        }

        function getDist(lat1,lon1,lat2,lon2) {
            const R=6371000; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }
    </script>
</body>
</html>
