<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω L∆∞·ªõi ƒêi·ªán (Admin) - v2.5</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* --- CORE CSS --- */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #f0f2f5; }
        
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 30px; width: 100%; z-index: 1; }
        
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; height: 30px; background: #263238; color: #eceff1; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; border-top: 3px solid #ff6f00; z-index: 4000; letter-spacing: 1px; }
        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 2000; background: #00695c; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; transition: 0.3s; }
        #menu-toggle:hover { background: #004d40; }

        #sidebar { position: fixed; top: 0; left: -100%; width: 420px; bottom: 30px; background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); transition: left 0.3s ease-in-out; display: flex; flex-direction: column; }
        #sidebar.active { left: 0; }
        
        .header { background: #00695c; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .content { padding: 10px; overflow-y: auto; flex: 1; background: #f5f5f5; }
        
        .accordion { background-color: #fff; color: #37474f; cursor: pointer; padding: 14px; width: 100%; border: none; text-align: left; outline: none; font-size: 0.95rem; font-weight: 600; transition: 0.3s; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .accordion:hover { background-color: #f1f8e9; color: #2e7d32; }
        .accordion.active { background-color: #e8f5e9; color: #2e7d32; border-left: 4px solid #2e7d32; }
        .accordion:after { content: '\002B'; font-weight: bold; font-size: 1.1rem; }
        .accordion.active:after { content: "\2212"; }
        
        .panel { padding: 0 12px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border-bottom: 1px solid #e0e0e0; }
        
        /* FORM ELEMENTS */
        label { font-weight: 600; font-size: 0.85rem; display: block; margin: 10px 0 4px; color: #455a64; }
        input, select { width: 100%; padding: 8px 10px; margin-bottom: 5px; border: 1px solid #cfd8dc; border-radius: 4px; box-sizing: border-box; font-size: 0.9rem; transition: border 0.2s; }
        input:focus, select:focus { border-color: #009688; outline: none; }
        
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; color: white; box-shadow: 0 2px 2px rgba(0,0,0,0.1); }
        button.action-btn:active { transform: translateY(1px); box-shadow: none; }
        
        .btn-check { background: #00897b; } .btn-merge { background: #43a047; flex: 1; margin-bottom: 0 !important; } .btn-replace { background: #e53935; flex: 1; margin-bottom: 0 !important; } 
        .btn-find { background: #d32f2f; } .btn-add { background: #1976d2; margin-bottom: 20px !important; } .btn-save-cir { background: #f57c00; margin-bottom: 20px !important; }
        .btn-pick { background: #ffa000; color: white; width: auto; padding: 4px 12px; font-size: 0.8rem; margin-left: 5px; border-radius: 12px; }
        .btn-draw-control { background: #546e7a; width: 48%; display: inline-block; margin-right: 2%; font-size: 0.85rem; }
        .btn-ground { background: #039be5; margin-top: 5px; }
        .btn-export { background: #388e3c; margin-top: 5px; }

        .tab-container { display: flex; margin-bottom: 15px; border-bottom: 1px solid #cfd8dc; background: #eceff1; border-radius: 4px 4px 0 0; overflow: hidden; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-weight: 600; color: #78909c; font-size: 0.9rem; transition: 0.3s; }
        .tab-btn:hover { background: #e0f2f1; color: #00695c; }
        .tab-btn.active { color: #00695c; border-bottom: 3px solid #00695c; background: white; }
        
        .edit-section { display: none; padding-top: 5px; }
        .edit-section.active { display: block; }

        #circuit-segment-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; background: #fff; border-radius: 4px; }
        .cir-item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; cursor: pointer; }
        .cir-item-row:hover { background: #e3f2fd; }
        .cir-controls .btn-mini { border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; color: white; font-size: 0.7rem; margin-left: 2px; }
        .btn-up, .btn-down { background: #78909c; } .btn-del-seg { background: #ef5350; }

        #console { background: #263238; color: #69f0ae; font-family: 'Consolas', monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 80px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #37474f; }
        #upload-actions { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .upload-btn-row { display: flex; gap: 10px; width: 100%; margin-bottom: 10px; }

        #result { color: #c62828; font-weight: bold; margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 4px; display: none; border: 1px solid #ffcdd2; }
        #user-log-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; color: #333; }
        #user-log-table th, #user-log-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #user-log-table th { background-color: #e0f2f1; font-weight: bold; color: #00695c; }
        #user-log-table tr:nth-child(even) { background-color: #fafafa; }

        /* MAP ICONS */
        .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; white-space: nowrap; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; }
        .icon-mc-base { border: 2px solid white; border-radius: 2px; z-index: 1000; font-size: 10px; line-height: 16px; background: #555; }
        .icon-mc-on { background: #d32f2f; } .icon-mc-off { background: #388e3c; }
        .icon-mc-source { border: 2px solid #ffeb3b !important; box-shadow: 0 0 5px #ffeb3b; z-index: 1001 !important; }
        
        .fault-marker { font-size: 40px; color: red; text-shadow: 0 0 5px yellow; animation: flash 0.5s infinite; }
        @keyframes flash { from {opacity: 1;} to {opacity: 0.3;} }
        
        .radio-group { display: flex; gap: 20px; margin-bottom: 10px; align-items: center; background: #f5f5f5; padding: 5px; border-radius: 4px; }
        
        /* POPUP CONFIRM CSS */
        #custom-confirm { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .win-dialog { background: white; width: 90%; max-width: 380px; border-radius: 8px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.4); animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(1); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .win-header { background: #f8f9fa; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .win-header span { font-weight: 700; color: #37474f; font-size: 1rem; }
        .win-header button { border: none; background: none; font-size: 1.5rem; cursor: pointer; color: #999; line-height: 1; }
        
        .win-body { padding: 25px 20px; text-align: center; }
        .mc-icon-display { font-size: 3rem; margin-bottom: 15px; display: block; }
        .mc-name-display { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; color: #333; display: block; }
        .mc-status-display { font-size: 0.9rem; color: #666; margin-bottom: 20px; display: block; }

        .win-footer { padding: 15px 20px; background: #f1f3f4; display: flex; justify-content: space-between; gap: 10px; border-top: 1px solid #ddd; }
        .win-btn { flex: 1; padding: 12px; border: none; cursor: pointer; border-radius: 6px; font-weight: 700; font-size: 0.95rem; text-transform: uppercase; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .win-btn:active { transform: translateY(1px); box-shadow: none; }
        .win-btn.cancel { background: #fff; border: 1px solid #ccc; color: #555; }
        .win-btn.cancel:hover { background: #eee; }
        
        .win-btn.danger { background: #d32f2f; color: white; } /* Close/On */
        .win-btn.safe { background: #388e3c; color: white; } /* Open/Off */
        .win-btn.primary { background: #1976d2; color: white; } /* Generic */

        .leaflet-control-custom { background: white; padding: 5px; cursor: pointer; text-align: center; width: 34px; height: 34px; line-height: 34px; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); transition: background 0.2s; color: #333; }
        .leaflet-control-custom:hover { background: #f4f4f4; color: #000; }
        
        /* LEGEND CSS */
        .legend { background: rgba(255, 255, 255, 0.95); padding: 12px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 0.8rem; line-height: 1.6; color: #333; min-width: 150px; }
        .legend h4 { margin: 0 0 8px 0; font-size: 0.85rem; border-bottom: 2px solid #00695c; padding-bottom: 4px; color: #00695c; text-transform: uppercase; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .legend-icon { width: 18px; height: 4px; border-radius: 2px; display: inline-block; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="menu-toggle" onclick="window.openSidebar()"><i class="fas fa-bars"></i> MENU</button>
    <div class="footer">Copyright TCD software @2026 - Admin v2.5</div>

    <div id="custom-confirm">
        <div class="win-dialog">
            <div class="win-header">
                <span id="win-title">X√°c nh·∫≠n</span>
                <button onclick="window.closeWinDialog()">√ó</button>
            </div>
            <div class="win-body" id="win-content-default" style="display:none;">
                <i class="fas fa-question-circle" style="font-size:2.5rem;color:#0078d7;margin-bottom:15px;"></i>
                <div id="win-msg" style="font-size:1rem;">...</div>
            </div>
            
            <div class="win-body" id="win-content-mc" style="display:none;">
                <i id="mc-icon-visual" class="fas fa-power-off mc-icon-display"></i>
                <span id="mc-name-visual" class="mc-name-display">MC_NAME</span>
                <span id="mc-status-visual" class="mc-status-display">Tr·∫°ng th√°i: ...</span>
                <div style="font-size:1.1rem; color:#333;">B·∫°n c√≥ mu·ªën <b><span id="mc-action-text">...</span></b> m√°y c·∫Øt n√†y kh√¥ng?</div>
            </div>

            <div class="win-footer">
                <button class="win-btn cancel" onclick="window.closeWinDialog()">H·ª¶Y B·ªé</button>
                <button class="win-btn primary" id="win-btn-yes" onclick="window.confirmAction()">ƒê·ªíNG √ù</button>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div class="header">
            <h3>QU·∫¢N L√ù L∆Ø·ªöI ƒêI·ªÜN</h3>
            <button style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;" onclick="window.closeSidebar()">√ó</button>
        </div>
        
        <div class="content">
            <button class="accordion">1. C·∫≠p nh·∫≠t & Xu·∫•t Excel</button>
            <div class="panel" id="panel-update">
                <label>Ch·ªçn file Excel/CSV:</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn btn-check" onclick="window.analyzeFiles()">Ki·ªÉm tra d·ªØ li·ªáu</button>
                <div id="console">S·∫µn s√†ng...</div>
                <div id="upload-actions">
                    <div class="upload-btn-row">
                        <button class="action-btn btn-merge" onclick="window.confirmUpload('merge')">G·ªòP D·ªÆ LI·ªÜU</button>
                        <button class="action-btn btn-replace" onclick="window.confirmUpload('replace')">THAY TH·∫æ (X√ìA C≈®)</button>
                    </div>
                </div>
                <hr>
                <button class="action-btn btn-export" onclick="window.exportToExcel()">XU·∫§T RA EXCEL</button>
            </div>

            <button class="accordion" id="acc-entry">2. Nh·∫≠p li·ªáu & S·ª≠a ƒë·ªïi</button>
            <div class="panel" id="panel-entry">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="window.switchTab('tab-pole')">Tr·ª•</button>
                    <button class="tab-btn" onclick="window.switchTab('tab-seg')">ƒêo·∫°n</button>
                    <button class="tab-btn" onclick="window.switchTab('tab-cir')">M·∫°ch</button>
                    <button class="tab-btn" onclick="window.switchTab('tab-area')">V√πng</button>
                </div>
                
                <div id="tab-pole" class="edit-section active">
                    <label>T√™n Tuy·∫øn:</label><input type="text" id="inp-pole-route" placeholder="VD: TUYEN_1">
                    <label>T√™n Tr·ª•/MC:</label><input type="text" id="inp-pole-name" placeholder="VD: MC_472">
                    <label>Lo·∫°i:</label><select id="inp-pole-type"><option value="TRU_DO">Tr·ª• ƒê·ª°</option><option value="TRU_NEO">Tr·ª• N√©o</option><option value="MC">M√°y C·∫Øt</option><option value="MOC">M·ªëc C√°p</option><option value="HAM_CAP">H·∫ßm C√°p</option></select>
                    <label>Ngu·ªìn (MC):</label><select id="inp-pole-src"><option value="">-- Kh√¥ng --</option><option value="220kV">220kV</option><option value="110kV">110kV</option><option value="500kV">500kV</option></select>
                    <label>T·ªça ƒë·ªô: <button class="btn-pick" onclick="window.enableMapPick('pole')">üìç Ch·∫•m b·∫£n ƒë·ªì</button></label>
                    <div style="display:flex;gap:5px;"><input type="number" id="inp-lat" placeholder="Lat"><input type="number" id="inp-lng" placeholder="Lng"></div>
                    <button class="action-btn btn-add" onclick="window.savePole()">L∆ØU / C·∫¨P NH·∫¨T TR·ª§</button>
                </div>

                <div id="tab-seg" class="edit-section">
                    <label>M√£ ƒêo·∫°n (Click tr√™n b·∫£n ƒë·ªì ƒë·ªÉ s·ª≠a):</label>
                    <input type="text" id="inp-seg-id" placeholder="VD: SEG_001">
                    <input type="hidden" id="inp-seg-id-old">
                    <label>ƒêi·ªÉm ƒê·∫¶U:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line1" onchange="window.updatePoleSelect('sel-seg-line1','sel-seg-pole1')"></select><select id="sel-seg-pole1"></select></div>
                    <label>ƒêi·ªÉm CU·ªêI:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line2" onchange="window.updatePoleSelect('sel-seg-line2','sel-seg-pole2')"></select><select id="sel-seg-pole2"></select></div>
                    <label>Lo·∫°i d√¢y:</label><select id="inp-seg-type"><option value="NOI">D√¢y N·ªïi</option><option value="NGAM">C√°p Ng·∫ßm</option></select>
                    <div style="display:flex;gap:10px;">
                        <button class="action-btn btn-add" id="btn-save-segment" onclick="window.saveSegment()">L∆ØU ƒêO·∫†N</button>
                        <button class="action-btn btn-pick" onclick="window.resetSegmentForm()">+ TH√äM M·ªöI</button>
                    </div>
                </div>

                <div id="tab-cir" class="edit-section">
                    <label>T√™n M·∫°ch (Click tr√™n b·∫£n ƒë·ªì):</label><input type="text" id="inp-cir-id" list="list-circuits" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn..."><datalist id="list-circuits"></datalist>
                    <div id="circuit-segment-list"><div style="padding:15px;text-align:center;color:#999;font-style:italic">Ch∆∞a c√≥ d·ªØ li·ªáu</div></div>
                    <label>Th√™m ƒëo·∫°n:</label><select id="sel-cir-seg"></select>
                    <button class="action-btn btn-add" onclick="window.addSegToCir()">Th√™m v√†o danh s√°ch</button>
                    <button class="action-btn btn-save-cir" onclick="window.saveCircuitStructure()">L∆ØU C·∫§U TR√öC M·∫†CH</button>
                </div>

                <div id="tab-area" class="edit-section">
                    <label>T√™n V√πng:</label><input type="text" id="inp-area-name" placeholder="VD: Tr·∫°m 110kV">
                    <label>Lo·∫°i:</label><select id="inp-area-type"><option value="TBA">Tr·∫°m Bi·∫øn √Åp</option><option value="BUILDING">C√¥ng tr√¨nh</option><option value="CONSTRUCTION">Thi c√¥ng</option><option value="FOUNDATION">M√≥ng</option></select>
                    <div style="margin: 10px 0;">
                        <button class="action-btn btn-draw-control" onclick="window.startAreaDraw()">‚úèÔ∏è B·∫Øt ƒë·∫ßu v·∫Ω</button>
                        <button class="action-btn btn-draw-control" style="background:#fbc02d; color:black;" onclick="window.undoAreaPoint()">‚Ü©Ô∏è X√≥a ƒëi·ªÉm cu·ªëi</button>
                    </div>
                    <div id="draw-status" style="font-size:0.8rem; color:#d32f2f; margin-bottom:5px; font-weight:bold;"></div>
                    <button class="action-btn btn-add" onclick="window.saveArea()">L∆ØU V√ôNG</button>
                </div>
            </div>

            <button class="accordion" id="acc-opt">3. V·∫≠n h√†nh & T√¨m s·ª± c·ªë</button>
            <div class="panel" id="panel-opt">
                <label>Ch·ªçn M·∫°ch:</label>
                <select id="circuitSelect" onchange="window.zoomToCircuit()"><option value="">-- Ch·ªçn --</option></select>
                <div style="margin:10px 0;padding:12px;background:#e0f7fa;border-radius:4px;border:1px solid #b2ebf2;">
                    Tr·∫°ng th√°i: <span id="status-text" style="font-weight:bold;">---</span>
                    <div id="circuit-info" style="font-size:0.85rem;color:#006064;margin-top:5px"></div>
                </div>
                
                <button class="action-btn btn-ground" id="btn-grounding" onclick="window.toggleGrounding()" style="display:none;">üîí ƒê√ìNG TI·∫æP ƒê·ªäA</button>

                <label>Nh·∫≠p Km s·ª± c·ªë (T√≠nh t·ª´ ƒëi·ªÉm ngu·ªìn/ƒë·∫ßu):</label>
                <input type="number" id="faultKm" step="0.001" placeholder="V√≠ d·ª•: 5.23">
                <div class="radio-group">
                    <label style="margin:0;cursor:pointer"><input type="radio" name="faultDir" value="start" checked> T·ª´ ƒê·∫ßu</label> 
                    <label style="margin:0;cursor:pointer"><input type="radio" name="faultDir" value="end"> T·ª´ Cu·ªëi</label>
                </div>
                <button class="action-btn btn-find" onclick="window.findFault()">T√åM V·ªä TR√ç</button>
                <div id="result" style="display:none;"></div>
            </div>

            <button class="accordion" onclick="window.loadUserLogs()">4. Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</button>
            <div class="panel" id="panel-users">
                <div style="margin-top:10px;"><button class="action-btn btn-check" onclick="window.loadUserLogs()">üîÑ T·∫£i l·∫°i</button></div>
                <div style="overflow-x:auto; margin-top:10px;">
                    <table id="user-log-table"><thead><tr><th>Th·ªùi gian</th><th>T√™n</th><th>SƒêT</th><th>Email</th></tr></thead><tbody><tr><td colspan="4">...</td></tr></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, get, child, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. CONFIG & GLOBALS ---
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.appData = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: [] };
        window.stagingData = null;
        window.pendingAction = null;
        
        let currentPath = []; 
        let currentPathTotalDist = 0;
        let pickingMode = null; 
        let tempAreaPoints = []; 
        let tempAreaPoly = null;
        let currentEditingCircuit = [];
        let segmentCounts = {};

        // --- 2. MAP INITIALIZATION ---
        const map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([10.762, 106.660], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxNativeZoom: 19, maxZoom: 22 }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.4, maxNativeZoom: 19, maxZoom: 22 }).addTo(map);

        L.Control.Extent = L.Control.extend({ onAdd: function(map) { var c = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom'); c.innerHTML = '<i class="fas fa-home"></i>'; c.title="V·ªÅ to√†n c·∫£nh"; c.onclick = function(){ window.zoomToExtent() }; return c; } }); 
        new L.Control.Extent({ position: 'topright' }).addTo(map);

        map.createPane('areaPane'); map.getPane('areaPane').style.zIndex = 200;
        
        const layers = { 
            areas: L.layerGroup().addTo(map), 
            main: L.layerGroup().addTo(map), 
            minor: L.layerGroup().addTo(map), 
            mc: L.layerGroup().addTo(map), 
            fault: L.layerGroup().addTo(map), 
            editHighlight: L.layerGroup().addTo(map) 
        };
        layers.fault.setZIndex(9999);

        const legendControl = L.control({position: 'bottomright'});
        legendControl.onAdd = function (map) { 
            var div = L.DomUtil.create('div', 'legend'); 
            div.innerHTML = `<h4>TR·∫†NG TH√ÅI & C·∫§P ƒêI·ªÜN</h4><div class="legend-item"><span class="legend-dot" style="background:#d32f2f"></span> C√≥ ƒëi·ªán 220kV</div><div class="legend-item"><span class="legend-dot" style="background:#388e3c"></span> C√≥ ƒëi·ªán 110kV</div><div class="legend-item"><span class="legend-dot" style="background:#0d47a1"></span> C√≥ ƒëi·ªán 500kV</div><div class="legend-item"><span class="legend-dot" style="background:#2196f3"></span> ƒêang Ti·∫øp ƒê·ªãa</div><div class="legend-item"><span class="legend-dot" style="background:#000000"></span> M·∫•t ƒëi·ªán / C√¥ l·∫≠p</div><div class="legend-item" style="margin-top:5px;border-top:1px solid #ddd;padding-top:5px"><span class="legend-icon" style="background:#424242;border-bottom:1px dashed white"></span> C√°p ng·∫ßm</div>`; 
            return div; 
        };
        legendControl.addTo(map);

        // --- 3. EXPORTED UI LOGIC ---
        
        window.openSidebar = () => document.getElementById('sidebar').classList.add('active');
        window.closeSidebar = () => document.getElementById('sidebar').classList.remove('active');
        window.isEditMode = () => document.getElementById('acc-entry').classList.contains('active');
        
        window.getActiveTab = () => {
            if(document.getElementById('tab-pole').classList.contains('active')) return 'pole';
            if(document.getElementById('tab-seg').classList.contains('active')) return 'seg';
            if(document.getElementById('tab-cir').classList.contains('active')) return 'cir';
            if(document.getElementById('tab-area').classList.contains('active')) return 'area';
            return 'pole';
        };

        window.refreshPanelHeight = (pid) => { let p=document.getElementById(pid); if(p.style.maxHeight) p.style.maxHeight = (p.scrollHeight + 500) + "px"; };

        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) { 
            acc[i].addEventListener("click", function() { 
                for (var j = 0; j < acc.length; j++) { if (acc[j] !== this && acc[j].classList.contains("active")) { acc[j].classList.remove("active"); acc[j].nextElementSibling.style.maxHeight = null; } } 
                this.classList.toggle("active"); 
                var panel = this.nextElementSibling; 
                if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = panel.scrollHeight + "px"; 
                if (this.id === 'acc-entry' && this.classList.contains('active')) {
                    if(window.getActiveTab() === 'seg') renderGlobalMap('segment_edit'); 
                    else if(window.getActiveTab() === 'cir') renderGlobalMap('normal'); // Show lines for clicking
                    else renderGlobalMap('normal');
                } else { renderGlobalMap('normal'); layers.editHighlight.clearLayers(); }
            }); 
        }

        window.switchTab = (tabId) => {
            document.querySelectorAll('.edit-section').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            let btns = document.getElementsByClassName('tab-btn');
            for(let b of btns) { if(b.getAttribute('onclick').includes(tabId)) b.classList.add('active'); }
            
            window.refreshDropdowns();
            window.refreshPanelHeight('panel-entry');
            layers.editHighlight.clearLayers();
            
            // Logic for map mode based on tab
            if(tabId === 'tab-seg') renderGlobalMap('segment_edit'); 
            else renderGlobalMap('normal');
        };

        map.on('click', function(e) {
            if (pickingMode === 'pole') {
                document.getElementById('inp-lat').value = e.latlng.lat.toFixed(6);
                document.getElementById('inp-lng').value = e.latlng.lng.toFixed(6);
                pickingMode = null;
                let btn = document.querySelector('.btn-pick'); btn.innerText = "üìç Ch·∫•m b·∫£n ƒë·ªì"; btn.style.background = "#ff9800";
                window.openSidebar();
            } else if (pickingMode === 'area') {
                tempAreaPoints.push([e.latlng.lat, e.latlng.lng]);
                if(tempAreaPoly) map.removeLayer(tempAreaPoly);
                tempAreaPoly = L.polygon(tempAreaPoints, {color: 'red', dashArray: '5,5'}).addTo(map);
            } else {
                 if (window.isEditMode() && window.getActiveTab() === 'area') {
                    document.getElementById('inp-area-name').value = '';
                    document.getElementById('inp-area-type').value = 'TBA';
                }
            }
        });

        window.enableMapPick = (mode) => { pickingMode = mode; window.closeSidebar(); let btn = document.querySelector('.btn-pick'); btn.innerText = "ƒêang ch·ªçn..."; btn.style.background = "#4caf50"; };
        window.startAreaDraw = () => { pickingMode = 'area'; tempAreaPoints = []; if(tempAreaPoly) map.removeLayer(tempAreaPoly); window.closeSidebar(); document.getElementById('draw-status').innerText = "ƒêang v·∫Ω... (Click b·∫£n ƒë·ªì)"; };
        window.undoAreaPoint = () => { tempAreaPoints.pop(); if(tempAreaPoly) map.removeLayer(tempAreaPoly); if(tempAreaPoints.length>0) tempAreaPoly=L.polygon(tempAreaPoints,{color:'red',dashArray:'5,5'}).addTo(map); };
        
        window.saveArea = () => { 
            if(tempAreaPoints.length<3) return alert("C·∫ßn t·ªëi thi·ªÉu 3 ƒëi·ªÉm ƒë·ªÉ t·∫°o v√πng!"); 
            get(child(ref(db), 'he_thong_luoi_dien/areas')).then(snap => { 
                let areas = snap.val() || []; 
                areas.push({ name:document.getElementById('inp-area-name').value || 'V√πng M·ªõi', type:document.getElementById('inp-area-type').value, points: tempAreaPoints }); 
                set(ref(db, 'he_thong_luoi_dien/areas'), areas).then(() => { 
                    alert("ƒê√£ l∆∞u v√πng!"); pickingMode = null; document.getElementById('draw-status').innerText = "";
                    if(tempAreaPoly) map.removeLayer(tempAreaPoly); tempAreaPoints = []; 
                }); 
            }); 
        };

        window.zoomToExtent = () => { let bounds = L.latLngBounds([]); let hasData = false; if(window.appData.poles) { for(let l in window.appData.poles) { window.appData.poles[l].forEach(p => { bounds.extend([p.lat, p.lng]); hasData=true; }); } } if(hasData) map.fitBounds(bounds, {padding: [50,50]}); else map.setView([10.762, 106.660], 12); };

        // --- 4. DATA HANDLING & RENDERING ---
        
        function getSegmentKey(p1, p2) { let k1=p1.lat+"_"+p1.lng, k2=p2.lat+"_"+p2.lng; return (k1<k2)?(k1+"|"+k2):(k2+"|"+k1); }
        
        function calculateOffsets() { 
            segmentCounts={}; 
            if(window.appData.circuits) Object.keys(window.appData.circuits).forEach(cid=>{ 
                window.appData.circuits[cid].forEach(item=>{ 
                    let def=window.appData.segments[item.segId]; 
                    if(def){ 
                        let p1=getPole(def.lineFrom,def.poleFrom), p2=getPole(def.lineTo,def.poleTo); 
                        if(p1&&p2){ let k=getSegmentKey(p1,p2); if(!segmentCounts[k]) segmentCounts[k]=[]; segmentCounts[k].push(cid); } 
                    } 
                }); 
            }); 
        }

        function createIcon(type, name, isClosed, sourceVoltage) {
            let cls = 'my-icon icon-tru-do', sz = [12,12], label = '';
            if (type.includes('MC')) { 
                cls = isClosed ? 'my-icon icon-mc-base icon-mc-on' : 'my-icon icon-mc-base icon-mc-off'; 
                sz = [24, 16]; 
                if (sourceVoltage && sourceVoltage.length > 0) { cls += ' icon-mc-source'; sz = [26, 20]; }
                let parts = name.split('_'); label = parts.length > 1 ? parts[parts.length-1] : name;
            } else if (type.includes('NEO')) cls = 'my-icon icon-tru-neo';
            else if (type.includes('MOC')) { cls = 'my-icon icon-moc'; sz = [8,8]; }
            return L.divIcon({ className: cls, html: label, iconSize: sz });
        }

        function getPole(line, name) {
            if (window.appData.poles[line]) return window.appData.poles[line].find(p => p.name == name);
            for(let l in window.appData.poles) { let p = window.appData.poles[l].find(p => p.name == name); if(p) return {...p, foundRoute: l}; }
            return null;
        }

        function getPointsForSegment(seg) {
            let p1 = getPole(seg.lineFrom, seg.poleFrom);
            let p2 = getPole(seg.lineTo, seg.poleTo);
            if(!p1 || !p2) return [];
            let r1 = p1.foundRoute || seg.lineFrom;
            let r2 = p2.foundRoute || seg.lineTo;
            if (r1 && r2 && r1 === r2) {
                let routePoles = window.appData.poles[r1];
                if (routePoles) {
                    let i1 = routePoles.findIndex(p => p.name === p1.name);
                    let i2 = routePoles.findIndex(p => p.name === p2.name);
                    if (i1 !== -1 && i2 !== -1) {
                        let subPoles = (i1 <= i2) ? routePoles.slice(i1, i2 + 1) : routePoles.slice(i2, i1 + 1).reverse();
                        return subPoles.map(p => ({lat: p.lat, lng: p.lng, name: p.name}));
                    }
                }
            }
            return [{lat: p1.lat, lng: p1.lng, name: p1.name}, {lat: p2.lat, lng: p2.lng, name: p2.name}];
        }

        function drawSingleCircuit(circuitId, calcPath = false, excludeSegId, simulationOnly = false) {
            const segs = window.appData.circuits[circuitId]; if(!segs) return;
            let connectedMCs = []; 
            segs.forEach(item => { 
                let def = window.appData.segments[item.segId]; 
                if(def) { 
                    let p1 = getPole(def.lineFrom, def.poleFrom), p2 = getPole(def.lineTo, def.poleTo); 
                    if(p1 && p1.type.includes('MC')) connectedMCs.push(p1); 
                    if(p2 && p2.type.includes('MC')) connectedMCs.push(p2); 
                } 
            });
            let activeVoltage = null; 
            let isGrounded = window.appData.grounded ? window.appData.grounded[circuitId] : false;
            let activeSources = connectedMCs.filter(mc => (window.appData.mcStates[mc.name] !== false) && mc.sourceVoltage);
            if (activeSources.length > 0) { 
                activeSources.sort((a,b) => { let vA = parseInt(a.sourceVoltage)||0, vB = parseInt(b.sourceVoltage)||0; return vB - vA; }); 
                activeVoltage = activeSources[0].sourceVoltage; 
            }
            let color = '#000000', statusText = "M·∫§T ƒêI·ªÜN / C√î L·∫¨P";
            if (isGrounded) { color = '#2196f3'; statusText = "ƒêANG TI·∫æP ƒê·ªäA"; } 
            else if (activeVoltage) { 
                if (activeVoltage.includes('110')) { color = '#388e3c'; statusText = "C√ì ƒêI·ªÜN (110kV)"; } 
                else if (activeVoltage.includes('220')) { color = '#d32f2f'; statusText = "C√ì ƒêI·ªÜN (220kV)"; } 
                else if (activeVoltage.includes('500')) { color = '#0d47a1'; statusText = "C√ì ƒêI·ªÜN (500kV)"; } 
            }
            if(calcPath) { 
                if(!simulationOnly) {
                    document.getElementById('status-text').innerHTML = `<span style="color:${color}">${statusText}</span>`; 
                    let btnG = document.getElementById('btn-grounding'); 
                    if(!activeVoltage || isGrounded) { btnG.style.display = 'block'; btnG.innerHTML = isGrounded ? "üîì M·ªû TI·∫æP ƒê·ªäA" : "üîí ƒê√ìNG TI·∫æP ƒê·ªäA"; btnG.style.background = isGrounded ? "#7cb342" : "#0288d1"; } else { btnG.style.display = 'none'; }
                }
                currentPath=[]; currentPathTotalDist=0; 
            }
            segs.forEach(item => {
                let def = window.appData.segments[item.segId];
                if(def) {
                    let ptsObj = getPointsForSegment(def); 
                    if(ptsObj.length > 0) {
                        let latLngs = ptsObj.map(p => [p.lat, p.lng]);
                        let isCable = def.type === "NGAM";
                        let offset = 0;
                        let p1 = ptsObj[0], p2 = ptsObj[ptsObj.length-1];
                        if (p1 && p2 && !simulationOnly) {
                             let key = getSegmentKey(p1, p2); let list = segmentCounts[key];
                             if (list && list.length > 1) { 
                                 let idx = list.indexOf(circuitId); 
                                 if (idx !== -1) { let center = (list.length - 1) / 2; offset = (idx - center) * 6; } 
                             }
                        }
                        if (!calcPath) {
                            let poly = L.polyline(latLngs, {
                                color: color, weight: 3, 
                                dashArray: isCable?"5,5":null, 
                                offset: offset 
                            }).addTo(layers.main).bindPopup(`<b>${circuitId}</b><br>${statusText}`);
                            poly.on('click', () => {
                                if(window.isEditMode()) {
                                    if(window.getActiveTab()==='seg') window.onElementClick('seg', def);
                                    else if(window.getActiveTab()==='cir') window.onElementClick('cir', {circuitId: circuitId});
                                }
                            });
                        }
                        if(calcPath) {
                             ptsObj.forEach((p, i) => {
                                if (i > 0) {
                                    let d = getDist(ptsObj[i-1].lat, ptsObj[i-1].lng, p.lat, p.lng);
                                    currentPathTotalDist += d;
                                }
                                currentPath.push({lat: p.lat, lng: p.lng, accDist: currentPathTotalDist, name: p.name});
                            });
                        }
                    }
                }
            });
        }

        function renderGlobalMap(mode = 'normal') {
            layers.main.clearLayers(); layers.minor.clearLayers(); layers.mc.clearLayers(); layers.areas.clearLayers();
            
            if(window.appData.areas) window.appData.areas.forEach(a => { 
                let p = L.polygon(a.points, {color:'#9e9e9e', fillColor:'#9e9e9e', fillOpacity:0.3, weight:1}).addTo(layers.areas).bindPopup(`<b>${a.name}</b><br>${a.type}`); 
                p.on('click', () => { if(window.isEditMode() && window.getActiveTab()==='area') window.onElementClick('area', a); });
            });

            if(window.appData.poles) for(let l in window.appData.poles) window.appData.poles[l].forEach(p => {
                let isMC = p.type.includes('MC'), isMinor = (p.type==='TRU_DO'||p.type==='MOC');
                let target = isMC ? layers.mc : (isMinor ? layers.minor : layers.main);
                
                let isClosed = isMC ? (window.appData.mcStates[p.name] !== false) : true;
                let marker = L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.name, isClosed, p.sourceVoltage), zIndexOffset: isMC ? 1000 : 0 }).addTo(target);
                
                marker.on('click', () => {
                    if (window.isEditMode() && window.getActiveTab() === 'pole') {
                        window.onElementClick('pole', {route: l, ...p, srcVal: p.sourceVoltage});
                    } else if (!window.isEditMode() && isMC) {
                        window.showMCConfirm(p.name, isClosed);
                    }
                });
                if(!isMC && !window.isEditMode()) marker.bindPopup(p.name);
            });

            if (mode === 'segment_edit') {
                if(window.appData.segments) Object.values(window.appData.segments).forEach(seg => {
                    let ptsObj = getPointsForSegment(seg);
                    if(ptsObj.length > 0) {
                         let latLngs = ptsObj.map(p => [p.lat, p.lng]);
                         let poly = L.polyline(latLngs, {color: '#424242', weight: 4, dashArray: '10, 8', opacity: 0.8}).addTo(layers.main);
                         poly.bindPopup(`<b>${seg.id}</b>`);
                         poly.on('click', () => window.onElementClick('seg', seg));
                    }
                });
            } else {
                if(window.appData.circuits) Object.keys(window.appData.circuits).forEach(cid => drawSingleCircuit(cid));
            }
        }
        
        // --- 5. INTERACTIVE FUNCTIONS ---
        
        window.onElementClick = function(type, data) {
            if(type === 'pole') {
                document.getElementById('inp-pole-route').value = data.route;
                document.getElementById('inp-pole-name').value = data.name;
                document.getElementById('inp-pole-type').value = data.type;
                document.getElementById('inp-pole-src').value = data.srcVal || "";
                document.getElementById('inp-lat').value = data.lat;
                document.getElementById('inp-lng').value = data.lng;
            }
            else if (type === 'seg') {
                document.getElementById('inp-seg-id').value = data.id;
                document.getElementById('inp-seg-id-old').value = data.id;
                document.getElementById('inp-seg-type').value = data.type;
                
                // IMPORTANT: Wait for updatePoleSelect to finish filling options
                let s1 = document.getElementById('sel-seg-line1'); 
                s1.value = data.lineFrom; 
                window.updatePoleSelect('sel-seg-line1','sel-seg-pole1'); 
                document.getElementById('sel-seg-pole1').value = data.poleFrom;
                
                let s2 = document.getElementById('sel-seg-line2'); 
                s2.value = data.lineTo; 
                window.updatePoleSelect('sel-seg-line2','sel-seg-pole2'); 
                document.getElementById('sel-seg-pole2').value = data.poleTo;
                
                window.highlightSegment(data.id, 'orange');
            }
            else if (type === 'cir') {
                 let cid = data.circuitId;
                 document.getElementById('inp-cir-id').value = cid;
                 currentEditingCircuit = [...(window.appData.circuits[cid] || [])];
                 window.renderCircuitSegments();
                 // Highlight entire circuit lines? optional, but currently we just load list
                 // To show it's active, maybe flash it
            }
            else if (type === 'area') {
                document.getElementById('inp-area-name').value = data.name;
                document.getElementById('inp-area-type').value = data.type;
            }
            window.openSidebar();
        }

        window.savePole = () => { 
            let line=document.getElementById('inp-pole-route').value.trim(), name=document.getElementById('inp-pole-name').value.trim(); 
            if(!line||!name) return alert("Thi·∫øu t√™n!"); 
            let p = { name: name, type: document.getElementById('inp-pole-type').value, sourceVoltage: document.getElementById('inp-pole-src').value, lat: parseFloat(document.getElementById('inp-lat').value), lng: parseFloat(document.getElementById('inp-lng').value) }; 
            let path=`he_thong_luoi_dien/poles/${line}`; 
            get(child(ref(db), path)).then(snap=>{ let list=snap.val()||[], idx=list.findIndex(x=>x.name===name); if(idx>=0) list[idx]=p; else list.push(p); set(ref(db, path), list).then(()=>{ alert("ƒê√£ l∆∞u!"); if(p.type==='MC') update(ref(db, 'he_thong_luoi_dien/mcStates'), {[name]:true}); }); }); 
        };

        window.saveSegment = () => {
            let id = document.getElementById('inp-seg-id').value.trim();
            let oldId = document.getElementById('inp-seg-id-old').value.trim();
            if(!id) return alert("Thi·∫øu ID!");
            let btn = document.getElementById('btn-save-segment');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;
            let data = { id: id, type: document.getElementById('inp-seg-type').value, lineFrom: document.getElementById('sel-seg-line1').value, poleFrom: document.getElementById('sel-seg-pole1').value, lineTo: document.getElementById('sel-seg-line2').value, poleTo: document.getElementById('sel-seg-pole2').value };
            let updates = {}; updates[`he_thong_luoi_dien/segments/${id}`] = data;
            if(oldId && oldId !== id) {
                updates[`he_thong_luoi_dien/segments/${oldId}`] = null;
                if(window.appData.circuits) { for(let cid in window.appData.circuits) { let changed = false; let list = window.appData.circuits[cid]; list.forEach(item => { if(item.segId === oldId) { item.segId = id; changed = true; } }); if(changed) updates[`he_thong_luoi_dien/circuits/${cid}`] = list; } }
            }
            update(ref(db), updates).then(() => { alert("ƒê√£ l∆∞u!"); document.getElementById('inp-seg-id-old').value = id; layers.editHighlight.clearLayers(); btn.innerText = "L∆ØU ƒêO·∫†N"; btn.disabled = false; renderGlobalMap('segment_edit'); });
        };
        
        window.zoomToCircuit = () => {
            let cid = document.getElementById('circuitSelect').value;
            if(cid) {
                layers.main.clearLayers(); 
                drawSingleCircuit(cid, true);
                let km = (currentPathTotalDist / 1000).toFixed(3);
                document.getElementById('circuit-info').innerHTML = `<i class="fas fa-ruler"></i> T·ªïng chi·ªÅu d√†i: <b>${km} km</b>`;
            } else {
                renderGlobalMap('normal');
                document.getElementById('circuit-info').innerText = "";
                document.getElementById('status-text').innerText = "---";
            }
        };

        window.findFault = () => {
            let km = parseFloat(document.getElementById('faultKm').value);
            let dir = document.querySelector('input[name="faultDir"]:checked').value;
            if(!currentPath.length || isNaN(km)) return alert("Vui l√≤ng ch·ªçn m·∫°ch v√† nh·∫≠p s·ªë Km!");

            let targetDist = (dir === 'start') ? km * 1000 : currentPathTotalDist - (km * 1000);
            
            let found = false;
            for(let i=0; i<currentPath.length; i++) {
                if (currentPath[i].accDist >= targetDist) {
                    let p1 = currentPath[i-1] || currentPath[i];
                    let p2 = currentPath[i];
                    let distSegment = p2.accDist - p1.accDist;
                    let distInto = targetDist - p1.accDist;
                    let ratio = distSegment > 0 ? distInto / distSegment : 0;
                    let lat = p1.lat + (p2.lat - p1.lat) * ratio;
                    let lng = p1.lng + (p2.lng - p1.lng) * ratio;
                    let name1 = p1.name || "ƒêi·ªÉm ƒë·∫ßu"; let name2 = p2.name || "ƒêi·ªÉm cu·ªëi";
                    L.marker([lat, lng], { icon: L.divIcon({html:'<i class="fas fa-bolt fault-marker"></i>', className: 'd'}) }).addTo(layers.fault).bindPopup("S·ª∞ C·ªê").openPopup();
                    map.setView([lat, lng], 18);
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('result').innerHTML = `V·ªã tr√≠ d·ª± ki·∫øn: <b>${name1} - ${name2}</b>`;
                    found = true;
                    break;
                }
            }
            if(!found) document.getElementById('result').innerText = "Kh√¥ng t√¨m th·∫•y v·ªã tr√≠ trong ph·∫°m vi m·∫°ch.";
        }

        window.toggleGrounding = () => { /* Add logic if needed later */ };

        window.showMCConfirm = (name, currentlyClosed) => {
            window.pendingAction = { type: 'mc', name: name, currentState: currentlyClosed };
            document.getElementById('win-title').innerText = "ƒêI·ªÄU KHI·ªÇN M√ÅY C·∫ÆT";
            document.getElementById('win-content-default').style.display = 'none';
            document.getElementById('win-content-mc').style.display = 'block';
            document.getElementById('mc-name-visual').innerText = name;
            let btn = document.getElementById('win-btn-yes');
            let icon = document.getElementById('mc-icon-visual');
            let statusText = document.getElementById('mc-status-visual');
            let actionText = document.getElementById('mc-action-text');

            if(currentlyClosed) {
                icon.style.color = '#d32f2f'; 
                statusText.innerHTML = "ƒêang tr·∫°ng th√°i: <b style='color:#d32f2f'>ƒê√ìNG (ON)</b>";
                actionText.innerText = "C·∫ÆT ƒêI·ªÜN";
                actionText.style.color = "#388e3c";
                btn.innerText = "C·∫ÆT ƒêI·ªÜN";
                btn.className = "win-btn safe"; 
            } else {
                icon.style.color = '#388e3c'; 
                statusText.innerHTML = "ƒêang tr·∫°ng th√°i: <b style='color:#388e3c'>C·∫ÆT (OFF)</b>";
                actionText.innerText = "ƒê√ìNG ƒêI·ªÜN";
                actionText.style.color = "#d32f2f";
                btn.innerText = "ƒê√ìNG ƒêI·ªÜN";
                btn.className = "win-btn danger"; 
            }
            document.getElementById('custom-confirm').style.display = 'flex';
        }

        window.confirmUpload = (mode) => { 
            window.pendingAction = { type: 'upload', mode: mode }; 
            document.getElementById('win-title').innerText = "X√ÅC NH·∫¨N D·ªÆ LI·ªÜU";
            document.getElementById('win-content-default').style.display = 'block';
            document.getElementById('win-content-mc').style.display = 'none';
            document.getElementById('win-msg').innerHTML = mode==='merge' ? "B·∫°n mu·ªën <b>G·ªòP</b> d·ªØ li·ªáu m·ªõi v√†o h·ªá th·ªëng?" : "B·∫°n mu·ªën <b>X√ìA TO√ÄN B·ªò</b> c≈© v√† thay th·∫ø?";
            document.getElementById('win-btn-yes').innerText = "ƒê·ªíNG √ù";
            document.getElementById('win-btn-yes').className = "win-btn primary";
            document.getElementById('custom-confirm').style.display = 'flex'; 
        }
        
        window.closeWinDialog = () => { document.getElementById('custom-confirm').style.display = 'none'; window.pendingAction = null; };

        window.confirmAction = () => {
             if (!window.pendingAction) { window.closeWinDialog(); return; }
             if (window.pendingAction.type === 'mc') { 
                 let newState = !window.pendingAction.currentState;
                 update(ref(db, 'he_thong_luoi_dien/mcStates'), { [window.pendingAction.name]: newState }); 
                 window.closeWinDialog(); 
             }
             else if (window.pendingAction.type === 'upload') {
                if(window.stagingData) {
                    const rootRef = ref(db, 'he_thong_luoi_dien'); const d = window.stagingData;
                    let sequence = Promise.resolve();
                    if(window.pendingAction.mode === 'replace') { sequence = sequence.then(() => set(child(rootRef, 'poles'), null)).then(() => set(child(rootRef, 'segments'), null)).then(() => set(child(rootRef, 'circuits'), null)).then(() => set(child(rootRef, 'mcStates'), d.mcStates)); }
                    sequence.then(() => update(child(rootRef, 'poles'), d.poles)).then(() => update(child(rootRef, 'segments'), d.segments)).then(() => update(child(rootRef, 'circuits'), d.circuits)).then(() => { if(window.pendingAction.mode === 'merge') update(child(rootRef, 'mcStates'), d.mcStates); }).then(() => { alert("Th√†nh c√¥ng!"); window.closeWinDialog(); });
                }
             }
        }
        
        window.loadUserLogs = async () => {
            const tbody = document.querySelector('#user-log-table tbody'); tbody.innerHTML = '<tr><td colspan="4">ƒêang t·∫£i...</td></tr>';
            try {
                const snap = await get(ref(db, 'system_logs/logins'));
                if (snap.exists()) {
                    let logs = []; snap.forEach(c => logs.push(c.val()));
                    logs.sort((a,b)=>new Date(b.time)-new Date(a.time));
                    tbody.innerHTML = logs.map(l => `<tr><td>${new Date(l.time).toLocaleString('vi-VN')}</td><td>${l.name}</td><td>${l.phone}</td><td>${l.email}</td></tr>`).join('');
                } else tbody.innerHTML = '<tr><td colspan="4">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            } catch(e) { tbody.innerHTML = `<tr><td colspan="4" style="color:red">L·ªói: ${e.message}</td></tr>`; }
        }

        window.analyzeFiles = () => { 
            const input = document.getElementById('excelFile'); 
            const log = (msg, clear=false) => { let c=document.getElementById('console'); if(clear) c.innerHTML=''; c.innerHTML+=`<div>> ${msg}</div>`; c.scrollTop=c.scrollHeight; };
            log("ƒêang ƒë·ªçc file...", true); 
            if(!input.files.length) { log("‚ùå Ch∆∞a ch·ªçn file!"); return; } 
            
            Promise.all(Array.from(input.files).map(file => new Promise(r => { 
                const rd=new FileReader(); 
                rd.onload=e=>{ const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); let s={}; w.SheetNames.forEach(n=>s[n]=XLSX.utils.sheet_to_json(w.Sheets[n])); r(s); }; 
                rd.readAsArrayBuffer(file); 
            }))).then(res => { 
                let sheets = Object.assign({}, ...res);
                const getCol = (row, candidates) => { let k=Object.keys(row); for(let c of candidates){ let m=k.find(key=>key.trim().replace(/^\uFEFF/,'')===c); if(m) return m; } return null; };
                const sPoles=Object.keys(sheets).find(n=>n.includes("TOA_DO")); const sSegs=Object.keys(sheets).find(n=>n.includes("DM_DOAN")); const sCircs=Object.keys(sheets).find(n=>n.includes("CAU_HINH")); 
                if(!sPoles||!sSegs||!sCircs) { log("‚ùå Thi·∫øu sheet b·∫Øt bu·ªôc!"); return; } 
                
                let data = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: window.appData.areas || [] }; 
                sheets[sPoles].forEach(r => { let cMa=getCol(r,["MA_TUYEN"]), cTen=getCol(r,["TEN_TRU"]), cLat=getCol(r,["LAT"]), cLong=getCol(r,["LONG"]), cLoai=getCol(r,["LOAI_DIEM"]), cNguon=getCol(r,["NGUON"]); if(cMa && r[cLat]) { let l=String(r[cMa]).trim(), n=String(r[cTen]).trim(); if(!data.poles[l]) data.poles[l]=[]; let p = { name: n, lat: parseFloat(r[cLat]), lng: parseFloat(r[cLong]), type: cLoai ? String(r[cLoai]).trim().toUpperCase() : "TRU_DO", sourceVoltage: cNguon ? String(r[cNguon]).trim() : "" }; data.poles[l].push(p); if(p.type.includes('MC')) data.mcStates[n] = true; } }); 
                sheets[sSegs].forEach(r => { let cId=getCol(r,["MA_DOAN"]), cT1=getCol(r,["TUYEN_TU"]), cTr1=getCol(r,["TRU_TU"]), cT2=getCol(r,["TUYEN_DEN"]), cTr2=getCol(r,["TRU_DEN"]), cL=getCol(r,["LOAI_DIEM","LOAI"]); if(cId && r[cId]) { data.segments[r[cId]] = { id: r[cId], type: (cL&&String(r[cL]).includes("NGAM")?"NGAM":"NOI"), lineFrom: String(r[cT1]).trim(), poleFrom: String(r[cTr1]).trim(), lineTo: String(r[cT2]).trim(), poleTo: String(r[cTr2]).trim() }; } }); 
                sheets[sCircs].forEach(r => { let cCid=getCol(r,["MA_DUONG_DAY"]), cSid=getCol(r,["MA_DOAN"]), cStt=getCol(r,["STT"]); if(cCid && r[cCid] && cSid && r[cSid]) { let cid=r[cCid]; if(!data.circuits[cid]) data.circuits[cid]=[]; data.circuits[cid].push({segId: String(r[cSid]).trim(), order: parseInt(r[cStt]||999)}); } }); for(let k in data.circuits) data.circuits[k].sort((a,b)=>a.order-b.order); 
                window.stagingData = data; 
                document.getElementById('upload-actions').style.display = "block"; window.refreshPanelHeight('panel-update'); 
                log("‚úÖ Ki·ªÉm tra th√†nh c√¥ng! Ch·ªçn G·ªôp ho·∫∑c Thay th·∫ø."); 
            }).catch(e => log("‚ùå L·ªói: " + e.message)); 
        }
        
        window.exportToExcel = () => { if(!window.appData.poles) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!"); let d1=[], d2=[], d3=[], d4=[]; for(let l in window.appData.poles) window.appData.poles[l].forEach(p=>d1.push({"MA_TUYEN":l,"TEN_TRU":p.name,"LAT":p.lat,"LONG":p.lng,"LOAI_DIEM":p.type,"NGUON":p.sourceVoltage})); if(window.appData.segments) Object.values(window.appData.segments).forEach(s=>d2.push({"MA_DOAN":s.id,"TUYEN_TU":s.lineFrom,"TRU_TU":s.poleFrom,"TUYEN_DEN":s.lineTo,"TRU_DEN":s.poleTo,"LOAI_DIEM":s.type})); if(window.appData.circuits) for(let c in window.appData.circuits) window.appData.circuits[c].forEach(i=>d3.push({"MA_DUONG_DAY":c,"STT":i.order,"MA_DOAN":i.segId})); if(window.appData.areas) window.appData.areas.forEach(a => d4.push({NAME: a.name, TYPE: a.type, POINTS: JSON.stringify(a.points)})); let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d1),"TOA_DO"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d2),"DM_DOAN"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d3),"CAU_HINH"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d4),"VUNG"); XLSX.writeFile(wb,"DuLieuLuoiDien_Full.xlsx"); };

        window.updatePoleSelect = (lid, pid) => { let line=document.getElementById(lid).value, poles=window.appData.poles[line]||[]; document.getElementById(pid).innerHTML='<option value="">Ch·ªçn Tr·ª•...</option>'+poles.map(p=>`<option value="${p.name}">${p.name}</option>`).join(''); };
        
        window.refreshDropdowns = () => { 
            let routes=Object.keys(window.appData.poles||{}), circs=Object.keys(window.appData.circuits||{}), segs=Object.keys(window.appData.segments||{}); 
            document.getElementById('sel-seg-line1').innerHTML='<option value="">Ch·ªçn Tuy·∫øn...</option>'+routes.map(r=>`<option value="${r}">${r}</option>`).join(''); 
            document.getElementById('sel-seg-line2').innerHTML=document.getElementById('sel-seg-line1').innerHTML; 
            document.getElementById('list-circuits').innerHTML=circs.map(c=>`<option value="${c}">`).join(''); 
            document.getElementById('sel-cir-seg').innerHTML='<option value="">-- Ch·ªçn ƒëo·∫°n --</option>'+segs.map(s=>`<option value="${s}">${s}</option>`).join(''); 
        }
        
        window.highlightSegment = (segId, color = 'yellow') => {
            layers.editHighlight.clearLayers();
            let seg = window.appData.segments[segId];
            if(seg) {
                let ptsObj = getPointsForSegment(seg);
                if(ptsObj.length > 0) {
                    let latLngs = ptsObj.map(p => [p.lat, p.lng]);
                    let style = {color: color, weight: 6, opacity: 0.9};
                    if(color === 'black') { style.dashArray = null; style.weight = 5; style.opacity = 1; }
                    L.polyline(latLngs, style).addTo(layers.editHighlight);
                }
            }
        }
        
        window.resetSegmentForm = () => {
            document.getElementById('inp-seg-id').value = ''; document.getElementById('inp-seg-id-old').value = '';
            document.getElementById('sel-seg-line1').value = ''; document.getElementById('sel-seg-pole1').innerHTML = '';
            document.getElementById('sel-seg-line2').value = ''; document.getElementById('sel-seg-pole2').innerHTML = '';
            layers.editHighlight.clearLayers();
        }

        window.renderCircuitSegments = () => {
            let html = currentEditingCircuit.map((item, index) => {
                return `<div class="cir-item-row" onclick="window.highlightSegment('${item.segId}', 'orange')"><span>${index+1}. ${item.segId}</span><div class="cir-controls"><button class="btn-mini btn-up" onclick="event.stopPropagation(); window.moveSeg(${index}, -1)">‚ñ≤</button><button class="btn-mini btn-down" onclick="event.stopPropagation(); window.moveSeg(${index}, 1)">‚ñº</button><button class="btn-mini btn-del-seg" onclick="event.stopPropagation(); window.delSegFromTemp(${index})">X</button></div></div>`;
            }).join('');
            if(html === '') html = '<div style="padding:15px;text-align:center;color:#999;font-style:italic">Ch∆∞a c√≥ ƒëo·∫°n n√†o</div>';
            document.getElementById('circuit-segment-list').innerHTML = html;
        }

        window.moveSeg = (index, dir) => {
            if (dir === -1 && index > 0) { [currentEditingCircuit[index], currentEditingCircuit[index - 1]] = [currentEditingCircuit[index - 1], currentEditingCircuit[index]]; } 
            else if (dir === 1 && index < currentEditingCircuit.length - 1) { [currentEditingCircuit[index], currentEditingCircuit[index + 1]] = [currentEditingCircuit[index + 1], currentEditingCircuit[index]]; }
            window.renderCircuitSegments();
        }
        
        window.delSegFromTemp = (index) => { currentEditingCircuit.splice(index, 1); window.renderCircuitSegments(); }
        window.addSegToCir = () => { let segId = document.getElementById('sel-cir-seg').value; if(!segId) return alert("Ch∆∞a ch·ªçn ƒëo·∫°n!"); currentEditingCircuit.push({segId: segId, order: currentEditingCircuit.length + 1}); window.renderCircuitSegments(); }
        
        window.saveCircuitStructure = function() {
            let cid = document.getElementById('inp-cir-id').value.trim(); if(!cid) return alert("Ch∆∞a c√≥ t√™n m·∫°ch!");
            if(!confirm("L∆∞u thay ƒë·ªïi cho m·∫°ch n√†y?")) return;
            currentEditingCircuit.forEach((item, i) => item.order = i + 1);
            set(ref(db, `he_thong_luoi_dien/circuits/${cid}`), currentEditingCircuit).then(()=>{ 
                alert("ƒê√£ l∆∞u c·∫•u tr√∫c m·∫°ch!"); layers.editHighlight.clearLayers(); if(!window.appData.circuits) window.appData.circuits = {}; window.appData.circuits[cid] = currentEditingCircuit; renderGlobalMap('normal');
            });
        }

        function getDist(lat1,lon1,lat2,lon2) { 
            const R=6371000; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; 
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); 
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); 
        }

        // --- 5. START LISTENER ---
        onValue(ref(db, 'he_thong_luoi_dien'), snap => { 
            let val = snap.val(); 
            if(val) { 
                window.appData = val; 
                if(!window.appData.mcStates) window.appData.mcStates={}; 
                if(!window.appData.grounded) window.appData.grounded={};
                
                let s = document.getElementById('circuitSelect');
                let cur = s.value;
                s.innerHTML = '<option value="">-- Ch·ªçn --</option>';
                if(window.appData.circuits) Object.keys(window.appData.circuits).forEach(c => {
                    let o = document.createElement('option'); o.value = c; o.text = c; s.add(o);
                });
                s.value = cur;

                calculateOffsets(); 
                
                if(window.isEditMode() && window.getActiveTab() === 'seg') renderGlobalMap('segment_edit');
                else renderGlobalMap('normal');

                window.refreshDropdowns();
                if(document.getElementById('circuitSelect').value) window.zoomToCircuit();
            } 
        });

    </script>
</body>
</html>
