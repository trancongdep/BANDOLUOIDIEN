<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω L∆∞·ªõi ƒêi·ªán (Admin) - v1.98</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* --- CORE CSS --- */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #f0f2f5; }
        
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 30px; width: 100%; z-index: 1; }
        
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; height: 30px; background: #212121; color: #eceff1; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; border-top: 3px solid #ff6f00; z-index: 4000; }
        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 2000; background: #004d40; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; }
        
        #sidebar { position: fixed; top: 0; left: -100%; width: 420px; bottom: 30px; background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); transition: left 0.3s ease-in-out; display: flex; flex-direction: column; }
        #sidebar.active { left: 0; }
        
        .header { background: #004d40; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .content { padding: 10px; overflow-y: auto; flex: 1; background: #fafafa; }
        
        .accordion { background-color: #eee; color: #444; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left; outline: none; font-size: 0.9rem; font-weight: bold; transition: 0.4s; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        .accordion:after { content: '\002B'; font-weight: bold; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border-bottom: 1px solid #ddd; }
        
        /* FORM ELEMENTS */
        label { font-weight: 600; font-size: 0.85rem; display: block; margin: 8px 0 4px; color: #333; }
        input, select { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9rem; }
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; color: white; }
        
        .btn-check { background: #00796b; } .btn-merge { background: #2e7d32; flex: 1; margin-bottom: 0 !important; } .btn-replace { background: #c62828; flex: 1; margin-bottom: 0 !important; } 
        .btn-find { background: #d32f2f; } .btn-add { background: #1565c0; margin-bottom: 20px !important; } .btn-save-cir { background: #d84315; margin-bottom: 20px !important; }
        .btn-pick { background: #ff9800; color: white; width: auto; padding: 4px 10px; font-size: 0.8rem; margin-left: 5px; }
        .btn-draw-control { background: #607d8b; width: 48%; display: inline-block; margin-right: 2%; font-size: 0.85rem; }
        .btn-ground { background: #0288d1; margin-top: 5px; }
        .btn-export { background: #2e7d32; margin-top: 5px; }

        .tab-container { display: flex; margin-bottom: 10px; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; font-size: 0.9rem; }
        .tab-btn.active { color: #004d40; border-bottom: 3px solid #004d40; background: #e0f2f1; }
        .edit-section { display: none; padding-top: 10px; }
        .edit-section.active { display: block; }

        #circuit-segment-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; background: #fff; }
        .cir-item-row { display: flex; justify-content: space-between; align-items: center; padding: 6px; border-bottom: 1px solid #eee; font-size: 0.85rem; cursor: pointer; }
        .cir-item-row:hover { background: #e3f2fd; }
        .cir-controls .btn-mini { border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; color: white; font-size: 0.7rem; margin-left: 2px; }
        .btn-up, .btn-down { background: #607d8b; } .btn-del-seg { background: #ef5350; }

        #console { background: #212121; color: #00e676; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 80px; overflow-y: auto; margin-bottom: 10px; }
        #upload-actions { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .upload-btn-row { display: flex; gap: 10px; width: 100%; margin-bottom: 10px; }

        #result { color: #d32f2f; font-weight: bold; margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 4px; display: none; }
        #user-log-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; color: #333; }
        #user-log-table th, #user-log-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        #user-log-table th { background-color: #f2f2f2; font-weight: bold; color: #004d40; }
        #user-log-table tr:nth-child(even) { background-color: #f9f9f9; }

        .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.6); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; white-space: nowrap; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; }
        .icon-mc-base { border: 2px solid white; border-radius: 2px; z-index: 1000; font-size: 10px; line-height: 16px; background: #555; }
        .icon-mc-on { background: #d32f2f; } .icon-mc-off { background: #388e3c; }
        .icon-mc-source { border: 2px solid #ffeb3b !important; box-shadow: 0 0 5px #ffeb3b; z-index: 1001 !important; }
        .fault-marker { font-size: 40px; color: red; text-shadow: 0 0 5px yellow; animation: flash 0.5s infinite; }
        @keyframes flash { from {opacity: 1;} to {opacity: 0.3;} }
        .radio-group { display: flex; gap: 20px; margin-bottom: 10px; align-items: center; }
        
        #custom-confirm { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .win-dialog { background: #f0f0f0; width: 90%; max-width: 400px; border-radius: 4px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: popIn 0.2s ease-out; }
        .win-header { background: white; padding: 10px 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; font-weight: bold; }
        .win-body { padding: 20px; background: white; display: flex; align-items: center; gap: 15px; }
        .win-footer { padding: 10px 15px; background: #f3f3f3; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #ddd; }
        .win-btn { padding: 6px 20px; border: 1px solid #ccc; cursor: pointer; border-radius: 2px; }
        .win-btn.primary { background: #0078d7; color: white; border-color: #005a9e; }
        .leaflet-control-custom { background: white; padding: 5px; cursor: pointer; text-align: center; width: 30px; height: 30px; line-height: 30px; border-radius: 2px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); transition: background 0.2s; }
        .leaflet-control-custom:hover { background: #f4f4f4; }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i> MENU</button>
    <div class="footer">Copyright TCD software @2026 - Admin v1.98</div>

    <div id="custom-confirm">
        <div class="win-dialog">
            <div class="win-header"><span>Th√¥ng b√°o</span><button style="border:none;background:none;font-size:1.2rem;cursor:pointer;" onclick="closeWinDialog()">√ó</button></div>
            <div class="win-body"><i class="fas fa-question-circle" style="font-size:2rem;color:#0078d7"></i><span id="win-msg">...</span></div>
            <div class="win-footer"><button class="win-btn primary" id="win-btn-yes" onclick="window.confirmAction()">ƒê·ªìng √Ω</button><button class="win-btn" onclick="closeWinDialog()">H·ªßy</button></div>
        </div>
    </div>

    <div id="sidebar">
        <div class="header">
            <h3>QU·∫¢N L√ù L∆Ø·ªöI ƒêI·ªÜN</h3>
            <button style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;" onclick="closeSidebar()">√ó</button>
        </div>
        
        <div class="content">
            <button class="accordion">1. C·∫≠p nh·∫≠t & Xu·∫•t Excel</button>
            <div class="panel" id="panel-update">
                <label>Ch·ªçn file Excel/CSV:</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn btn-check" onclick="window.analyzeFiles()">Ki·ªÉm tra d·ªØ li·ªáu</button>
                <div id="console">S·∫µn s√†ng...</div>
                <div id="upload-actions">
                    <div class="upload-btn-row">
                        <button class="action-btn btn-merge" onclick="window.confirmUpload('merge')">G·ªòP D·ªÆ LI·ªÜU</button>
                        <button class="action-btn btn-replace" onclick="window.confirmUpload('replace')">THAY TH·∫æ (X√ìA C≈®)</button>
                    </div>
                </div>
                <hr>
                <button class="action-btn btn-export" onclick="window.exportToExcel()">XU·∫§T RA EXCEL</button>
            </div>

            <button class="accordion" id="acc-entry">2. Nh·∫≠p li·ªáu & S·ª≠a ƒë·ªïi</button>
            <div class="panel" id="panel-entry">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('tab-pole')">Tr·ª•</button>
                    <button class="tab-btn" onclick="switchTab('tab-seg')">ƒêo·∫°n</button>
                    <button class="tab-btn" onclick="switchTab('tab-cir')">M·∫°ch</button>
                    <button class="tab-btn" onclick="switchTab('tab-area')">V√πng</button>
                </div>
                
                <div id="tab-pole" class="edit-section active">
                    <label>T√™n Tuy·∫øn:</label><input type="text" id="inp-pole-route" placeholder="VD: MAYCAT">
                    <label>T√™n Tr·ª•/MC:</label><input type="text" id="inp-pole-name" placeholder="VD: MC_472">
                    <label>Lo·∫°i:</label><select id="inp-pole-type"><option value="TRU_DO">Tr·ª• ƒê·ª°</option><option value="TRU_NEO">Tr·ª• N√©o</option><option value="MC">M√°y C·∫Øt</option><option value="MOC">M·ªëc C√°p</option><option value="HAM_CAP">H·∫ßm C√°p</option></select>
                    <label>Ngu·ªìn (MC):</label><select id="inp-pole-src"><option value="">-- Kh√¥ng --</option><option value="220kV">220kV</option><option value="110kV">110kV</option><option value="500kV">500kV</option></select>
                    <label>T·ªça ƒë·ªô: <button class="btn-pick" onclick="enableMapPick('pole')">üìç Ch·∫•m b·∫£n ƒë·ªì</button></label>
                    <div style="display:flex;gap:5px;"><input type="number" id="inp-lat" placeholder="Lat"><input type="number" id="inp-lng" placeholder="Lng"></div>
                    <button class="action-btn btn-add" onclick="window.savePole()">L∆ØU / C·∫¨P NH·∫¨T TR·ª§</button>
                </div>

                <div id="tab-seg" class="edit-section">
                    <label>M√£ ƒêo·∫°n (Click tr√™n b·∫£n ƒë·ªì ƒë·ªÉ s·ª≠a):</label>
                    <input type="text" id="inp-seg-id" placeholder="VD: SEG_001">
                    <input type="hidden" id="inp-seg-id-old">
                    <label>ƒêi·ªÉm ƒê·∫¶U:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line1" onchange="updatePoleSelect('sel-seg-line1','sel-seg-pole1')"></select><select id="sel-seg-pole1"></select></div>
                    <label>ƒêi·ªÉm CU·ªêI:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line2" onchange="updatePoleSelect('sel-seg-line2','sel-seg-pole2')"></select><select id="sel-seg-pole2"></select></div>
                    <label>Lo·∫°i d√¢y:</label><select id="inp-seg-type"><option value="NOI">D√¢y N·ªïi</option><option value="NGAM">C√°p Ng·∫ßm</option></select>
                    <div style="display:flex;gap:10px;">
                        <button class="action-btn btn-add" id="btn-save-segment" onclick="window.saveSegment()">L∆ØU ƒêO·∫†N</button>
                        <button class="action-btn btn-pick" onclick="window.resetSegmentForm()">+ TH√äM M·ªöI</button>
                    </div>
                </div>

                <div id="tab-cir" class="edit-section">
                    <label>T√™n M·∫°ch (Click tr√™n b·∫£n ƒë·ªì):</label><input type="text" id="inp-cir-id" list="list-circuits"><datalist id="list-circuits"></datalist>
                    <div id="circuit-segment-list"><div style="padding:10px;text-align:center;color:#999">Ch∆∞a c√≥ d·ªØ li·ªáu</div></div>
                    <label>Th√™m ƒëo·∫°n:</label><select id="sel-cir-seg"></select>
                    <button class="action-btn btn-add" onclick="window.addSegToCir()">Th√™m v√†o danh s√°ch</button>
                    <button class="action-btn btn-save-cir" onclick="window.saveCircuitStructure()">L∆ØU C·∫§U TR√öC M·∫†CH</button>
                </div>

                <div id="tab-area" class="edit-section">
                    <label>T√™n V√πng:</label><input type="text" id="inp-area-name" placeholder="VD: Tr·∫°m 110kV">
                    <label>Lo·∫°i:</label><select id="inp-area-type"><option value="TBA">Tr·∫°m Bi·∫øn √Åp</option><option value="BUILDING">C√¥ng tr√¨nh</option><option value="CONSTRUCTION">Thi c√¥ng</option><option value="FOUNDATION">M√≥ng</option></select>
                    <div style="margin: 10px 0;">
                        <button class="action-btn btn-draw-control" onclick="startAreaDraw()">‚úèÔ∏è B·∫Øt ƒë·∫ßu v·∫Ω</button>
                        <button class="action-btn btn-draw-control" style="background:#fbc02d; color:black;" onclick="undoAreaPoint()">‚Ü©Ô∏è X√≥a ƒëi·ªÉm cu·ªëi</button>
                    </div>
                    <div id="draw-status" style="font-size:0.8rem; color:red; margin-bottom:5px;"></div>
                    <button class="action-btn btn-add" onclick="saveArea()">L∆ØU V√ôNG</button>
                </div>
            </div>

            <button class="accordion" id="acc-opt">3. V·∫≠n h√†nh & T√¨m s·ª± c·ªë</button>
            <div class="panel" id="panel-opt">
                <label>Ch·ªçn M·∫°ch:</label>
                <select id="circuitSelect" onchange="window.zoomToCircuit()"><option value="">-- Ch·ªçn --</option></select>
                <div style="margin:10px 0;padding:10px;background:#f5f5f5;">Tr·∫°ng th√°i: <span id="status-text" style="font-weight:bold;">---</span><div id="circuit-info" style="font-size:0.85rem;color:#00695c;margin-top:5px"></div></div>
                
                <button class="action-btn btn-ground" id="btn-grounding" onclick="toggleGrounding()" style="display:none;">üîí ƒê√ìNG TI·∫æP ƒê·ªäA</button>

                <label>Nh·∫≠p Km s·ª± c·ªë:</label><input type="number" id="faultKm" step="0.01">
                <div class="radio-group"><label><input type="radio" name="faultDir" value="start" checked> T·ª´ ƒê·∫ßu</label> <label><input type="radio" name="faultDir" value="end"> T·ª´ Cu·ªëi</label></div>
                <button class="action-btn btn-find" onclick="window.findFault()">T√åM V·ªä TR√ç</button>
                <div id="result" style="display:none;"></div>
            </div>

            <button class="accordion" onclick="loadUserLogs()">4. Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</button>
            <div class="panel" id="panel-users">
                <div style="margin-top:10px;"><button class="action-btn btn-check" onclick="window.loadUserLogs()">üîÑ T·∫£i l·∫°i</button></div>
                <div style="overflow-x:auto; margin-top:10px;">
                    <table id="user-log-table"><thead><tr><th>Th·ªùi gian</th><th>T√™n</th><th>SƒêT</th><th>Email</th></tr></thead><tbody><tr><td colspan="4">...</td></tr></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, get, child, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.set = set; window.update = update; window.ref = ref; window.onValue = onValue; window.get = get; window.child = child; window.remove = remove;
        window.listenCloud();

        window.loadUserLogs = async function() {
            const tbody = document.querySelector('#user-log-table tbody'); tbody.innerHTML = '<tr><td colspan="4">ƒêang t·∫£i...</td></tr>';
            try {
                const snap = await window.get(window.ref(window.db, 'system_logs/logins'));
                if (snap.exists()) {
                    let logs = []; snap.forEach(c => logs.push(c.val()));
                    logs.sort((a,b)=>new Date(b.time)-new Date(a.time));
                    tbody.innerHTML = logs.map(l => `<tr><td>${new Date(l.time).toLocaleString('vi-VN')}</td><td>${l.name}</td><td>${l.phone}</td><td>${l.email}</td></tr>`).join('');
                } else tbody.innerHTML = '<tr><td colspan="4">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            } catch(e) { tbody.innerHTML = `<tr><td colspan="4" style="color:red">L·ªói: ${e.message}</td></tr>`; }
        }
    </script>

    <script>
        let map = L.map('map', { zoomControl: false }).setView([10.762, 106.660], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.4 }).addTo(map);
        L.Control.Extent = L.Control.extend({ onAdd: function(map) { var c = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom'); c.innerHTML = 'üè†'; c.style.backgroundColor='white'; c.style.width='30px'; c.style.height='30px'; c.style.lineHeight='30px'; c.style.textAlign='center'; c.style.cursor='pointer'; c.style.fontSize='18px'; c.onclick = function(){window.zoomToExtent()}; return c; } }); new L.Control.Extent({ position: 'topright' }).addTo(map);

        map.createPane('areaPane'); map.getPane('areaPane').style.zIndex = 200;
        let layers = { areas: L.layerGroup().addTo(map), main: L.layerGroup().addTo(map), minor: L.layerGroup().addTo(map), mc: L.layerGroup().addTo(map), fault: L.layerGroup().addTo(map), editHighlight: L.layerGroup().addTo(map) };
        layers.fault.setZIndex(9999);
        
        let appData = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: [] };
        window.stagingData = null; window.pendingAction = null;
        let currentPath = []; let currentPathTotalDist = 0;
        let pickingMode = null; let tempAreaPoints = []; let tempAreaPoly = null;
        let currentEditingCircuit = [];
        let segmentCounts = {}; // Shared count for offsets

        function openSidebar() { document.getElementById('sidebar').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
        function isEditMode() { return document.getElementById('acc-entry').classList.contains('active'); }
        function getActiveTab() {
            if(document.getElementById('tab-pole').classList.contains('active')) return 'pole';
            if(document.getElementById('tab-seg').classList.contains('active')) return 'seg';
            if(document.getElementById('tab-cir').classList.contains('active')) return 'cir';
            if(document.getElementById('tab-area').classList.contains('active')) return 'area';
            return 'pole';
        }

        window.refreshPanelHeight = function(pid) { let p=document.getElementById(pid); if(p.style.maxHeight) p.style.maxHeight = (p.scrollHeight + 500) + "px"; }

        window.switchTab = function(tabId) {
            document.querySelectorAll('.edit-section').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            event.target.classList.add('active');
            window.refreshDropdowns();
            window.refreshPanelHeight('panel-entry');
            layers.editHighlight.clearLayers();
            
            // IF SEGMENT TAB -> RENDER SEGMENTS ONLY
            if(getActiveTab() === 'seg') renderGlobalMap('segment_edit'); 
            else renderGlobalMap('normal');
        }

        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) { 
            acc[i].addEventListener("click", function() { 
                for (var j = 0; j < acc.length; j++) { if (acc[j] !== this && acc[j].classList.contains("active")) { acc[j].classList.remove("active"); acc[j].nextElementSibling.style.maxHeight = null; } } 
                this.classList.toggle("active"); 
                var panel = this.nextElementSibling; 
                if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = panel.scrollHeight + "px"; 
                
                if (this.id === 'acc-entry' && this.classList.contains('active')) {
                    if(getActiveTab() === 'seg') renderGlobalMap('segment_edit'); else renderGlobalMap('normal');
                } else { renderGlobalMap('normal'); layers.editHighlight.clearLayers(); }
            }); 
        }

        map.on('click', function(e) {
            if (pickingMode === 'pole') {
                document.getElementById('inp-lat').value = e.latlng.lat.toFixed(6);
                document.getElementById('inp-lng').value = e.latlng.lng.toFixed(6);
                pickingMode = null;
                let btn = document.querySelector('.btn-pick'); btn.innerText = "üìç Ch·∫•m b·∫£n ƒë·ªì"; btn.style.background = "#ff9800";
                openSidebar();
            } else if (pickingMode === 'area') {
                tempAreaPoints.push([e.latlng.lat, e.latlng.lng]);
                if(tempAreaPoly) map.removeLayer(tempAreaPoly);
                tempAreaPoly = L.polygon(tempAreaPoints, {color: 'red', dashArray: '5,5'}).addTo(map);
            } else {
                 if (isEditMode() && getActiveTab() === 'area') {
                    document.getElementById('inp-area-name').value = '';
                    document.getElementById('inp-area-type').value = 'TBA';
                }
            }
        });
        
        window.enableMapPick = function(mode) { pickingMode = mode; closeSidebar(); let btn = document.querySelector('.btn-pick'); btn.innerText = "ƒêang ch·ªçn..."; btn.style.background = "#4caf50"; }
        window.startAreaDraw = function() { pickingMode = 'area'; tempAreaPoints = []; if(tempAreaPoly) map.removeLayer(tempAreaPoly); closeSidebar(); document.getElementById('draw-status').innerText = "ƒêang v·∫Ω..."; }
        window.undoAreaPoint = function() { tempAreaPoints.pop(); if(tempAreaPoly) map.removeLayer(tempAreaPoly); if(tempAreaPoints.length>0) tempAreaPoly=L.polygon(tempAreaPoints,{color:'red',dashArray:'5,5'}).addTo(map); }
        window.saveArea = function() { if(tempAreaPoints.length<3) return alert("C·∫ßn 3 ƒëi·ªÉm!"); window.get(window.child(window.ref(window.db), 'he_thong_luoi_dien/areas')).then(snap => { let areas = snap.val() || []; areas.push({ name:document.getElementById('inp-area-name').value, type:document.getElementById('inp-area-type').value, points: tempAreaPoints }); window.set(window.ref(window.db, 'he_thong_luoi_dien/areas'), areas).then(() => { alert("ƒê√£ l∆∞u v√πng!"); pickingMode = null; if(tempAreaPoly) map.removeLayer(tempAreaPoly); tempAreaPoints = []; }); }); }
        
        window.zoomToExtent = function() { let bounds = L.latLngBounds([]); let hasData = false; if(appData.poles) { for(let l in appData.poles) { appData.poles[l].forEach(p => { bounds.extend([p.lat, p.lng]); hasData=true; }); } } if(hasData) map.fitBounds(bounds, {padding: [50,50]}); else map.setView([10.762, 106.660], 12); }
        
        map.on('zoomend', function() {
            let z = map.getZoom();
            // SHOW/HIDE POLES (Minor)
            if (z < 15) {
                if (map.hasLayer(layers.minor)) map.removeLayer(layers.minor);
                if (map.hasLayer(layers.mc)) map.removeLayer(layers.mc);
            } else {
                if (!map.hasLayer(layers.minor)) map.addLayer(layers.minor);
                if (!map.hasLayer(layers.mc)) map.addLayer(layers.mc);
            }
            // ALWAYS SHOW MAIN & AREAS
            if(!map.hasLayer(layers.main)) map.addLayer(layers.main);
            if(!map.hasLayer(layers.areas)) map.addLayer(layers.areas);
        });

        window.listenCloud = function() { 
            window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), snap => { 
                let val = snap.val(); 
                if(val) { 
                    appData = val; 
                    if(!appData.mcStates) appData.mcStates={}; 
                    if(!appData.grounded) appData.grounded={};
                    updateUI(); 
                    calculateOffsets(); 
                    if(isEditMode() && getActiveTab() === 'seg') renderGlobalMap('segment_edit');
                    else renderGlobalMap('normal');
                    window.refreshDropdowns();
                    if(document.getElementById('circuitSelect').value) window.zoomToCircuit();
                } 
            }); 
        }

        // --- CALC OFFSETS ---
        function getSegmentKey(p1, p2) { let k1=p1.lat+"_"+p1.lng, k2=p2.lat+"_"+p2.lng; return (k1<k2)?(k1+"|"+k2):(k2+"|"+k1); }
        function calculateOffsets() { 
            segmentCounts={}; 
            if(appData.circuits) Object.keys(appData.circuits).forEach(cid=>{ 
                appData.circuits[cid].forEach(item=>{ 
                    let def=appData.segments[item.segId]; 
                    if(def){ 
                        let p1=getPole(def.lineFrom,def.poleFrom), p2=getPole(def.lineTo,def.poleTo); 
                        if(p1&&p2){ let k=getSegmentKey(p1,p2); if(!segmentCounts[k]) segmentCounts[k]=[]; segmentCounts[k].push(cid); } 
                    } 
                }); 
            }); 
        }

        // --- RENDER MAP ---
        function createIcon(type, name, isClosed, sourceVoltage) {
            let cls = 'my-icon icon-tru-do', sz = [12,12], label = '';
            if (type.includes('MC')) { 
                cls = isClosed ? 'my-icon icon-mc-base icon-mc-on' : 'my-icon icon-mc-base icon-mc-off'; 
                sz = [24, 16]; 
                if (sourceVoltage && sourceVoltage.length > 0) { cls += ' icon-mc-source'; sz = [26, 20]; }
                // FIX: Get label
                let parts = name.split('_'); label = parts.length > 1 ? parts[parts.length-1] : name;
            } else if (type.includes('NEO')) cls = 'my-icon icon-tru-neo';
            else if (type.includes('MOC')) { cls = 'my-icon icon-moc'; sz = [8,8]; }
            return L.divIcon({ className: cls, html: label, iconSize: sz });
        }

        function renderGlobalMap(mode = 'normal') {
            layers.main.clearLayers(); layers.minor.clearLayers(); layers.mc.clearLayers(); layers.areas.clearLayers();
            
            if(appData.areas) appData.areas.forEach(a => { 
                let p = L.polygon(a.points, {color:'#9e9e9e', fillColor:'#9e9e9e', fillOpacity:0.3, weight:1}).addTo(layers.areas).bindPopup(`<b>${a.name}</b><br>${a.type}`); 
                p.on('click', () => { if(isEditMode() && getActiveTab()==='area') window.onElementClick('area', a); });
            });

            if(appData.poles) for(let l in appData.poles) appData.poles[l].forEach(p => {
                let isMC = p.type.includes('MC'), isMinor = (p.type==='TRU_DO'||p.type==='MOC');
                let target = isMC ? layers.mc : (isMinor ? layers.minor : layers.main);
                
                let isClosed = isMC ? (appData.mcStates[p.name] !== false) : true;
                let marker = L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.name, isClosed, p.sourceVoltage), zIndexOffset: isMC ? 1000 : 0 }).addTo(target);
                
                marker.on('click', () => {
                    if (isEditMode() && getActiveTab() === 'pole') {
                        window.onElementClick('pole', {route: l, ...p, srcVal: p.sourceVoltage});
                    } else if (!isEditMode() && isMC) {
                        if(confirm(`ƒê·∫£o tr·∫°ng th√°i m√°y c·∫Øt ${p.name}?`)) {
                            window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), { [p.name]: !isClosed });
                        }
                    }
                });
                if(!isMC && !isEditMode()) marker.bindPopup(p.name);
            });

            if (mode === 'segment_edit') {
                if(appData.segments) Object.values(appData.segments).forEach(seg => {
                    let ptsObj = getPointsForSegment(seg);
                    if(ptsObj.length > 0) {
                         let latLngs = ptsObj.map(p => [p.lat, p.lng]);
                         let poly = L.polyline(latLngs, {color: '#424242', weight: 4, dashArray: '10, 8', opacity: 0.8}).addTo(layers.main);
                         poly.bindPopup(`<b>${seg.id}</b>`);
                         poly.on('click', () => window.onElementClick('seg', seg));
                    }
                });
            } else {
                if(appData.circuits) Object.keys(appData.circuits).forEach(cid => drawSingleCircuit(cid));
            }
        }

        // --- HELPER FOR POLES & PATH ---
        function getPole(line, name) {
            if (appData.poles[line]) return appData.poles[line].find(p => p.name == name);
            for(let l in appData.poles) { let p = appData.poles[l].find(p => p.name == name); if(p) return {...p, foundRoute: l}; }
            return null;
        }

        // PATH FINDING (Restored v1.93 logic)
        function getPointsForSegment(seg) {
            let p1 = getPole(seg.lineFrom, seg.poleFrom);
            let p2 = getPole(seg.lineTo, seg.poleTo);
            if(!p1 || !p2) return [];

            let r1 = p1.foundRoute || seg.lineFrom;
            let r2 = p2.foundRoute || seg.lineTo;

            if (r1 && r2 && r1 === r2) {
                let routePoles = appData.poles[r1];
                if (routePoles) {
                    let i1 = routePoles.findIndex(p => p.name === p1.name);
                    let i2 = routePoles.findIndex(p => p.name === p2.name);
                    if (i1 !== -1 && i2 !== -1) {
                        let subPoles = (i1 <= i2) ? routePoles.slice(i1, i2 + 1) : routePoles.slice(i2, i1 + 1).reverse();
                        return subPoles.map(p => ({lat: p.lat, lng: p.lng, name: p.name}));
                    }
                }
            }
            return [{lat: p1.lat, lng: p1.lng, name: p1.name}, {lat: p2.lat, lng: p2.lng, name: p2.name}];
        }

        // --- DRAW SINGLE CIRCUIT ---
        function drawSingleCircuit(circuitId, calcPath, excludeSegId, simulationOnly = false) {
            const segs = appData.circuits[circuitId]; if(!segs) return;
            
            // 1. Color Logic
            let connectedMCs = []; 
            segs.forEach(item => { 
                let def = appData.segments[item.segId]; 
                if(def) { 
                    let p1 = getPole(def.lineFrom, def.poleFrom), p2 = getPole(def.lineTo, def.poleTo); 
                    if(p1 && p1.type.includes('MC')) connectedMCs.push(p1); 
                    if(p2 && p2.type.includes('MC')) connectedMCs.push(p2); 
                } 
            });
            
            let activeVoltage = null; 
            let isGrounded = appData.grounded ? appData.grounded[circuitId] : false;
            let activeSources = connectedMCs.filter(mc => (appData.mcStates[mc.name] !== false) && mc.sourceVoltage);
            if (activeSources.length > 0) { 
                activeSources.sort((a,b) => { let vA = parseInt(a.sourceVoltage)||0, vB = parseInt(b.sourceVoltage)||0; return vB - vA; }); 
                activeVoltage = activeSources[0].sourceVoltage; 
            }
            
            let color = '#000000', statusText = "M·∫§T ƒêI·ªÜN";
            if (isGrounded) { color = '#2196f3'; statusText = "ƒêANG TI·∫æP ƒê·ªäA"; } 
            else if (activeVoltage) { 
                if (activeVoltage.includes('110')) { color = '#388e3c'; statusText = "C√ì ƒêI·ªÜN (110kV)"; } 
                else if (activeVoltage.includes('220')) { color = '#d32f2f'; statusText = "C√ì ƒêI·ªÜN (220kV)"; } 
                else if (activeVoltage.includes('500')) { color = '#0d47a1'; statusText = "C√ì ƒêI·ªÜN (500kV)"; } 
            }

            if(calcPath) { 
                if(!simulationOnly) {
                    document.getElementById('status-text').innerHTML = `<span style="color:${color}">${statusText}</span>`; 
                    let btnG = document.getElementById('btn-grounding'); 
                    if(!activeVoltage || isGrounded) { btnG.style.display = 'block'; btnG.innerHTML = isGrounded ? "üîì M·ªû TI·∫æP ƒê·ªäA" : "üîí ƒê√ìNG TI·∫æP ƒê·ªäA"; btnG.style.background = isGrounded ? "#7cb342" : "#0288d1"; } else { btnG.style.display = 'none'; }
                }
                currentPath=[]; currentPathTotalDist=0; 
            }

            // 2. Draw with Offset & Path Following
            segs.forEach(item => {
                let def = appData.segments[item.segId];
                if(def) {
                    let ptsObj = getPointsForSegment(def); 
                    if(ptsObj.length > 0) {
                        let latLngs = ptsObj.map(p => [p.lat, p.lng]);
                        let isCable = def.type === "NGAM";
                        
                        let offset = 0;
                        let p1 = ptsObj[0], p2 = ptsObj[ptsObj.length-1];
                        if (p1 && p2 && !simulationOnly) {
                             let key = getSegmentKey(p1, p2); let list = segmentCounts[key];
                             if (list && list.length > 1) { 
                                 let idx = list.indexOf(circuitId); 
                                 if (idx !== -1) { let center = (list.length - 1) / 2; offset = (idx - center) * 6; } 
                             }
                        }

                        if (!isCalc) {
                            let poly = L.polyline(latLngs, {
                                color: color, weight: 2, 
                                dashArray: isCable?"5,5":null, 
                                offset: offset 
                            }).addTo(layers.main).bindPopup(`<b>${circuitId}</b><br>${statusText}`);
                            
                            poly.on('click', () => {
                                if(isEditMode()) {
                                    if(getActiveTab()==='seg') window.onElementClick('seg', def);
                                    else if(getActiveTab()==='cir') window.onElementClick('cir', {circuitId: circuitId});
                                }
                            });
                        }
                        
                        if(isCalc) {
                             ptsObj.forEach((p, i) => {
                                if (i > 0) {
                                    let d = getDist(ptsObj[i-1].lat, ptsObj[i-1].lng, p.lat, p.lng);
                                    currentPathTotalDist += d;
                                }
                                currentPath.push({lat: p.lat, lng: p.lng, accDist: currentPathTotalDist, name: p.name});
                            });
                        }
                    }
                }
            });
        }

        function getDist(lat1,lon1,lat2,lon2) { 
            const R=6371000; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; 
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); 
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); 
        }

        // --- INTERACTIVE EDIT HANDLERS ---
        window.onElementClick = function(type, data) {
            if(type === 'pole') {
                document.getElementById('inp-pole-route').value = data.route;
                document.getElementById('inp-pole-name').value = data.name;
                document.getElementById('inp-pole-type').value = data.type;
                document.getElementById('inp-pole-src').value = data.srcVal || "";
                document.getElementById('inp-lat').value = data.lat;
                document.getElementById('inp-lng').value = data.lng;
            }
            else if (type === 'seg') {
                document.getElementById('inp-seg-id').value = data.id;
                document.getElementById('inp-seg-id-old').value = data.id;
                document.getElementById('inp-seg-type').value = data.type;
                let s1 = document.getElementById('sel-seg-line1'); s1.value = data.lineFrom; window.updatePoleSelect('sel-seg-line1','sel-seg-pole1'); document.getElementById('sel-seg-pole1').value = data.poleFrom;
                let s2 = document.getElementById('sel-seg-line2'); s2.value = data.lineTo; window.updatePoleSelect('sel-seg-line2','sel-seg-pole2'); document.getElementById('sel-seg-pole2').value = data.poleTo;
                window.highlightSegment(data.id, 'black');
            }
            else if (type === 'cir') {
                 let cid = data.circuitId;
                 document.getElementById('inp-cir-id').value = cid;
                 currentEditingCircuit = [...(appData.circuits[cid] || [])];
                 window.renderCircuitSegments();
            }
            else if (type === 'area') {
                document.getElementById('inp-area-name').value = data.name;
                document.getElementById('inp-area-type').value = data.type;
            }
            openSidebar();
        }

        // --- SAVE FUNCTIONS ---
        window.savePole = function() { 
            let line=document.getElementById('inp-pole-route').value.trim(), name=document.getElementById('inp-pole-name').value.trim(); 
            if(!line||!name) return alert("Thi·∫øu t√™n!"); 
            let p = { name: name, type: document.getElementById('inp-pole-type').value, sourceVoltage: document.getElementById('inp-pole-src').value, lat: parseFloat(document.getElementById('inp-lat').value), lng: parseFloat(document.getElementById('inp-lng').value) }; 
            let path=`he_thong_luoi_dien/poles/${line}`; 
            window.get(window.child(window.ref(window.db), path)).then(snap=>{ let list=snap.val()||[], idx=list.findIndex(x=>x.name===name); if(idx>=0) list[idx]=p; else list.push(p); window.set(window.ref(window.db, path), list).then(()=>{ alert("ƒê√£ l∆∞u!"); if(p.type==='MC') window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), {[name]:true}); }); }); 
        }

        window.saveSegment = function() {
            let id = document.getElementById('inp-seg-id').value.trim();
            let oldId = document.getElementById('inp-seg-id-old').value.trim();
            if(!id) return alert("Thi·∫øu ID!");
            
            let btn = document.getElementById('btn-save-segment');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

            let data = {
                id: id, type: document.getElementById('inp-seg-type').value, 
                lineFrom: document.getElementById('sel-seg-line1').value, poleFrom: document.getElementById('sel-seg-pole1').value, 
                lineTo: document.getElementById('sel-seg-line2').value, poleTo: document.getElementById('sel-seg-pole2').value
            };

            let updates = {};
            updates[`he_thong_luoi_dien/segments/${id}`] = data;

            if(oldId && oldId !== id) {
                updates[`he_thong_luoi_dien/segments/${oldId}`] = null;
                if(appData.circuits) {
                    for(let cid in appData.circuits) {
                        let changed = false;
                        let list = appData.circuits[cid];
                        list.forEach(item => { if(item.segId === oldId) { item.segId = id; changed = true; } });
                        if(changed) updates[`he_thong_luoi_dien/circuits/${cid}`] = list;
                    }
                }
            }

            window.update(window.ref(window.db), updates).then(() => {
                alert("ƒê√£ l∆∞u!");
                document.getElementById('inp-seg-id-old').value = id;
                layers.editHighlight.clearLayers();
                btn.innerText = "L∆ØU ƒêO·∫†N"; btn.disabled = false;
                renderGlobalMap('segment_edit');
            });
        }
        
        // --- IMPORT/EXPORT (Standard) ---
        function log(msg, clear=false) { let c=document.getElementById('console'); if(clear) c.innerHTML=''; c.innerHTML+=`<div>> ${msg}</div>`; c.scrollTop=c.scrollHeight; }
        function getCol(row, candidates) { let k=Object.keys(row); for(let c of candidates){ let m=k.find(key=>key.trim().replace(/^\uFEFF/,'')===c); if(m) return m; } return null; }
        window.exportToExcel = function() { if(!appData.poles) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!"); let d1=[], d2=[], d3=[], d4=[]; for(let l in appData.poles) appData.poles[l].forEach(p=>d1.push({"MA_TUYEN":l,"TEN_TRU":p.name,"LAT":p.lat,"LONG":p.lng,"LOAI_DIEM":p.type,"NGUON":p.sourceVoltage})); if(appData.segments) Object.values(appData.segments).forEach(s=>d2.push({"MA_DOAN":s.id,"TUYEN_TU":s.lineFrom,"TRU_TU":s.poleFrom,"TUYEN_DEN":s.lineTo,"TRU_DEN":s.poleTo,"LOAI_DIEM":s.type})); if(appData.circuits) for(let c in appData.circuits) appData.circuits[c].forEach(i=>d3.push({"MA_DUONG_DAY":c,"STT":i.order,"MA_DOAN":i.segId})); if(appData.areas) appData.areas.forEach(a => d4.push({NAME: a.name, TYPE: a.type, POINTS: JSON.stringify(a.points)})); let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d1),"TOA_DO"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d2),"DM_DOAN"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d3),"CAU_HINH"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d4),"VUNG"); XLSX.writeFile(wb,"DuLieuLuoiDien_Full.xlsx"); }
        window.analyzeFiles = function() { const input = document.getElementById('excelFile'); log("ƒêang ƒë·ªçc file...", true); if(!input.files.length) { log("‚ùå Ch∆∞a ch·ªçn file!"); return; } Promise.all(Array.from(input.files).map(readFile)).then(res => { if(processSheets(Object.assign({}, ...res))) log("‚úÖ Ki·ªÉm tra th√†nh c√¥ng! Ch·ªçn G·ªôp ho·∫∑c Thay th·∫ø."); }).catch(e => log("‚ùå L·ªói: " + e.message)); }
        function readFile(file) { return new Promise(r => { const rd=new FileReader(); rd.onload=e=>{ const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); let s={}; w.SheetNames.forEach(n=>s[n]=XLSX.utils.sheet_to_json(w.Sheets[n])); r(s); }; rd.readAsArrayBuffer(file); }); }
        function processSheets(sheets) { const sPoles=Object.keys(sheets).find(n=>n.includes("TOA_DO")); const sSegs=Object.keys(sheets).find(n=>n.includes("DM_DOAN")); const sCircs=Object.keys(sheets).find(n=>n.includes("CAU_HINH")); if(!sPoles||!sSegs||!sCircs) { log("‚ùå Thi·∫øu sheet b·∫Øt bu·ªôc!"); return false; } let data = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: appData.areas || [] }; sheets[sPoles].forEach(r => { let cMa=getCol(r,["MA_TUYEN"]), cTen=getCol(r,["TEN_TRU"]), cLat=getCol(r,["LAT"]), cLong=getCol(r,["LONG"]), cLoai=getCol(r,["LOAI_DIEM"]), cNguon=getCol(r,["NGUON"]); if(cMa && r[cLat]) { let l=String(r[cMa]).trim(), n=String(r[cTen]).trim(); if(!data.poles[l]) data.poles[l]=[]; let p = { name: n, lat: parseFloat(r[cLat]), lng: parseFloat(r[cLong]), type: cLoai ? String(r[cLoai]).trim().toUpperCase() : "TRU_DO", sourceVoltage: cNguon ? String(r[cNguon]).trim() : "" }; data.poles[l].push(p); if(p.type.includes('MC')) data.mcStates[n] = true; } }); sheets[sSegs].forEach(r => { let cId=getCol(r,["MA_DOAN"]), cT1=getCol(r,["TUYEN_TU"]), cTr1=getCol(r,["TRU_TU"]), cT2=getCol(r,["TUYEN_DEN"]), cTr2=getCol(r,["TRU_DEN"]), cL=getCol(r,["LOAI_DIEM","LOAI"]); if(cId && r[cId]) { data.segments[r[cId]] = { id: r[cId], type: (cL&&String(r[cL]).includes("NGAM")?"NGAM":"NOI"), lineFrom: r[cT1], poleFrom: String(r[cTr1]).trim(), lineTo: r[cT2], poleTo: String(r[cTr2]).trim() }; } }); sheets[sCircs].forEach(r => { let cCid=getCol(r,["MA_DUONG_DAY"]), cSid=getCol(r,["MA_DOAN"]), cStt=getCol(r,["STT"]); if(cCid && r[cCid] && cSid && r[cSid]) { let cid=r[cCid]; if(!data.circuits[cid]) data.circuits[cid]=[]; data.circuits[cid].push({segId: String(r[cSid]).trim(), order: parseInt(r[cStt]||999)}); } }); for(let k in data.circuits) data.circuits[k].sort((a,b)=>a.order-b.order); window.stagingData = data; document.getElementById('upload-actions').style.display = "block"; window.refreshPanelHeight('panel-update'); return true; }
        window.confirmUpload = function(mode) { document.getElementById('win-msg').innerHTML = mode==='merge' ? "G·ªòP d·ªØ li·ªáu?" : "X√ìA TO√ÄN B·ªò c≈©?"; window.pendingAction = { type: 'upload', mode: mode }; document.getElementById('custom-confirm').style.display = 'flex'; }
        window.closeWinDialog = function() { document.getElementById('custom-confirm').style.display = 'none'; window.pendingAction = null; }
        window.confirmAction = function() {
             if (!window.pendingAction) { closeWinDialog(); return; }
             if (window.pendingAction.type === 'mc') { window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), { [window.pendingAction.name]: !(appData.mcStates[window.pendingAction.name] !== false) }); closeWinDialog(); }
             else if (window.pendingAction.type === 'upload') {
                if(window.stagingData) {
                    const rootRef = window.ref(window.db, 'he_thong_luoi_dien'); const d = window.stagingData;
                    let sequence = Promise.resolve();
                    if(window.pendingAction.mode === 'replace') { sequence = sequence.then(() => window.set(window.child(rootRef, 'poles'), null)).then(() => window.set(window.child(rootRef, 'segments'), null)).then(() => window.set(window.child(rootRef, 'circuits'), null)).then(() => window.set(window.child(rootRef, 'mcStates'), d.mcStates)); }
                    sequence.then(() => window.update(window.child(rootRef, 'poles'), d.poles)).then(() => window.update(window.child(rootRef, 'segments'), d.segments)).then(() => window.update(window.child(rootRef, 'circuits'), d.circuits)).then(() => { if(window.pendingAction.mode === 'merge') window.update(window.child(rootRef, 'mcStates'), d.mcStates); }).then(() => { alert("Th√†nh c√¥ng!"); closeWinDialog(); });
                }
             }
        }

        // --- UI ---
        function updateUI() {
            let s = document.getElementById('circuitSelect');
            let cur = s.value;
            s.innerHTML = '<option value="">-- Ch·ªçn --</option>';
            if(appData.circuits) Object.keys(appData.circuits).forEach(c => {
                let o = document.createElement('option'); o.value = c; o.text = c; s.add(o);
            });
            s.value = cur;
            refreshDropdowns();
        }

        window.refreshDropdowns = function() { 
            let routes=Object.keys(appData.poles||{}), circs=Object.keys(appData.circuits||{}), segs=Object.keys(appData.segments||{}); 
            document.getElementById('sel-seg-line1').innerHTML='<option value="">Ch·ªçn Tuy·∫øn...</option>'+routes.map(r=>`<option value="${r}">${r}</option>`).join(''); 
            document.getElementById('sel-seg-line2').innerHTML=document.getElementById('sel-seg-line1').innerHTML; 
            document.getElementById('list-circuits').innerHTML=circs.map(c=>`<option value="${c}">`).join(''); 
            document.getElementById('sel-cir-seg').innerHTML='<option value="">-- Ch·ªçn ƒëo·∫°n --</option>'+segs.map(s=>`<option value="${s}">${s}</option>`).join(''); 
        }

        window.updatePoleSelect = function(lid, pid) { 
            let line=document.getElementById(lid).value, poles=appData.poles[line]||[]; 
            document.getElementById(pid).innerHTML='<option value="">Ch·ªçn Tr·ª•...</option>'+poles.map(p=>`<option value="${p.name}">${p.name}</option>`).join(''); 
        }

        window.highlightSegment = function(segId, color = 'yellow') {
            layers.editHighlight.clearLayers();
            let seg = appData.segments[segId];
            if(seg) {
                let ptsObj = getPointsForSegment(seg);
                if(ptsObj.length > 0) {
                    let latLngs = ptsObj.map(p => [p.lat, p.lng]);
                    let style = {color: color, weight: 6, opacity: 0.9};
                    if(color === 'black') { style.dashArray = null; style.weight = 5; style.opacity = 1; }
                    L.polyline(latLngs, style).addTo(layers.editHighlight);
                }
            }
        }
        
        window.resetSegmentForm = function() {
            document.getElementById('inp-seg-id').value = ''; document.getElementById('inp-seg-id-old').value = '';
            document.getElementById('sel-seg-line1').value = ''; document.getElementById('sel-seg-pole1').innerHTML = '';
            document.getElementById('sel-seg-line2').value = ''; document.getElementById('sel-seg-pole2').innerHTML = '';
            layers.editHighlight.clearLayers();
        }

        window.renderCircuitSegments = function() {
            let html = currentEditingCircuit.map((item, index) => {
                return `<div class="cir-item-row" onclick="window.highlightSegment('${item.segId}')"><span>${index+1}. ${item.segId}</span><div class="cir-controls"><button class="btn-mini btn-up" onclick="event.stopPropagation(); window.moveSeg(${index}, -1)">‚ñ≤</button><button class="btn-mini btn-down" onclick="event.stopPropagation(); window.moveSeg(${index}, 1)">‚ñº</button><button class="btn-mini btn-del-seg" onclick="event.stopPropagation(); window.delSegFromTemp(${index})">X</button></div></div>`;
            }).join('');
            if(html === '') html = '<div style="padding:5px;color:#999">Ch∆∞a c√≥ ƒëo·∫°n n√†o</div>';
            document.getElementById('circuit-segment-list').innerHTML = html;
        }

        window.moveSeg = function(index, dir) {
            if (dir === -1 && index > 0) { [currentEditingCircuit[index], currentEditingCircuit[index - 1]] = [currentEditingCircuit[index - 1], currentEditingCircuit[index]]; } 
            else if (dir === 1 && index < currentEditingCircuit.length - 1) { [currentEditingCircuit[index], currentEditingCircuit[index + 1]] = [currentEditingCircuit[index + 1], currentEditingCircuit[index]]; }
            window.renderCircuitSegments();
        }
        window.delSegFromTemp = function(index) { currentEditingCircuit.splice(index, 1); window.renderCircuitSegments(); }
        window.addSegToCir = function() { let segId = document.getElementById('sel-cir-seg').value; if(!segId) return alert("Ch∆∞a ch·ªçn ƒëo·∫°n!"); currentEditingCircuit.push({segId: segId, order: currentEditingCircuit.length + 1}); window.renderCircuitSegments(); }
        
        window.saveCircuitStructure = function() {
            let cid = document.getElementById('inp-cir-id').value.trim(); if(!cid) return alert("Ch∆∞a c√≥ t√™n m·∫°ch!");
            if(!confirm("L∆∞u thay ƒë·ªïi cho m·∫°ch n√†y?")) return;
            currentEditingCircuit.forEach((item, i) => item.order = i + 1);
            window.set(window.ref(window.db, `he_thong_luoi_dien/circuits/${cid}`), currentEditingCircuit).then(()=>{ 
                alert("ƒê√£ l∆∞u c·∫•u tr√∫c m·∫°ch!"); layers.editHighlight.clearLayers(); if(!appData.circuits) appData.circuits = {}; appData.circuits[cid] = currentEditingCircuit; renderGlobalMap();
            });
        }
        
        // --- FAULT FINDING ---
        window.zoomToCircuit = function() {
            let cid = document.getElementById('circuitSelect').value;
            layers.main.clearLayers(); 
            renderMap(); 
            if(cid) {
                drawCircuit(cid, true);
                let km = (currentPathTotalDist / 1000).toFixed(3);
                document.getElementById('circuit-info').innerText = `T·ªïng d√†i: ${km} km`;
            } else {
                document.getElementById('circuit-info').innerText = "";
            }
        }

        window.findFault = function() {
            let km = parseFloat(document.getElementById('faultKm').value);
            let dir = document.querySelector('input[name="faultDir"]:checked').value;
            if(!currentPath.length || isNaN(km)) return alert("Ch·ªçn m·∫°ch v√† nh·∫≠p Km!");

            let targetDist = (dir === 'start') ? km * 1000 : currentPathTotalDist - (km * 1000);
            
            let found = false;
            for(let i=0; i<currentPath.length; i++) {
                if (currentPath[i].accDist >= targetDist) {
                    let p1 = currentPath[i-1] || currentPath[i];
                    let p2 = currentPath[i];
                    
                    let distSegment = p2.accDist - p1.accDist;
                    let distInto = targetDist - p1.accDist;
                    let ratio = distSegment > 0 ? distInto / distSegment : 0;

                    let lat = p1.lat + (p2.lat - p1.lat) * ratio;
                    let lng = p1.lng + (p2.lng - p1.lng) * ratio;

                    let name1 = p1.name || "ƒêi·ªÉm ƒë·∫ßu";
                    let name2 = p2.name || "ƒêi·ªÉm cu·ªëi";

                    L.marker([lat, lng], { icon: L.divIcon({html:'<i class="fas fa-bolt fault-marker"></i>', className: 'd'}) }).addTo(layers.fault).bindPopup("S·ª∞ C·ªê").openPopup();
                    map.setView([lat, lng], 18);
                    
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('result').innerHTML = `V·ªã tr√≠ d·ª± ki·∫øn: <b>${name1} - ${name2}</b>`;
                    found = true;
                    break;
                }
            }
            if(!found) document.getElementById('result').innerText = "Kh√¥ng t√¨m th·∫•y trong ph·∫°m vi.";
        }
        
        var legendControl = L.control({position: 'bottomright'});
        legendControl.onAdd = function (map) { var div = L.DomUtil.create('div', 'legend'); div.innerHTML = `<h4>CH√ö TH√çCH</h4><div class="legend-item"><span class="legend-icon" style="background:#ff0000;"></span> D√¢y ƒê√≥ng</div><div class="legend-item"><span class="legend-icon" style="background:#388e3c;"></span> D√¢y C·∫Øt</div>`; return div; };
        legendControl.addTo(map);

    </script>
</body>
</html>
