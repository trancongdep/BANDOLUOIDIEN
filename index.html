<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>H·ªá Th·ªëng L∆∞·ªõi ƒêi·ªán - Version 1.62</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* --- CORE CSS --- */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #f0f2f5; }
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UI ELEMENTS */
        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 2000; background: #004d40; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; }
        #sidebar { position: fixed; top: 0; left: -100%; width: 90%; max-width: 450px; bottom: calc(30px + env(safe-area-inset-bottom, 10px)); background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); transition: left 0.3s ease-in-out; display: flex; flex-direction: column; }
        #sidebar.active { left: 0; }
        .header { background: #004d40; color: white; padding: 15px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 10px; overflow-y: auto; flex: 1; background: #fafafa; }
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; min-height: 30px; padding-top: 5px; padding-bottom: env(safe-area-inset-bottom, 10px); background: #212121; color: #eceff1; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; border-top: 3px solid #ff6f00; z-index: 4000; }
        
        /* ACCORDION & PANELS */
        .accordion { background-color: #eee; color: #444; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left; outline: none; font-size: 0.95rem; font-weight: bold; transition: 0.4s; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        .accordion:after { content: '\002B'; font-weight: bold; float: right; margin-left: 5px; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border-bottom: 1px solid #ddd; }
        
        /* INPUTS */
        label { font-weight: 600; font-size: 0.85rem; display: block; margin: 8px 0 4px; color: #333; }
        input, select { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; color: white; }
        
        /* BUTTONS COLORS */
        .btn-check { background: #00796b; } 
        .btn-merge { background: #2e7d32; flex: 1; margin-bottom: 0 !important; } 
        .btn-replace { background: #c62828; flex: 1; margin-bottom: 0 !important; } 
        .btn-find { background: #d32f2f; }
        .btn-add { background: #1565c0; margin-top: 10px; margin-bottom: 25px !important; }
        .btn-pick { background: #ff9800; color: white; width: auto; padding: 5px 10px; font-size: 0.8rem; margin-left: 5px; }
        .btn-draw-control { background: #607d8b; width: 48%; display: inline-block; margin-right: 2%; font-size: 0.85rem; }
        .btn-ground { background: #0288d1; margin-top: 5px; }
        
        .upload-btn-row { display: flex; gap: 10px; width: 100%; margin-bottom: 10px; }
        .tab-container { display: flex; margin-bottom: 10px; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; font-size: 0.8rem; }
        .tab-btn.active { color: #004d40; border-bottom: 3px solid #004d40; }
        .edit-section { display: none; padding-bottom: 10px; }
        .edit-section.active { display: block; }
        #console { background: #212121; color: #00e676; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 100px; overflow-y: auto; margin-bottom: 10px; }
        #upload-actions { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        /* LEGEND & POPUPS */
        .legend { background: rgba(255,255,255,0.95); padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-size: 0.75rem; min-width: 130px; display: block; margin-right: 10px; margin-bottom: calc(45px + env(safe-area-inset-bottom, 10px)) !important; }
        .legend h4 { margin: 0 0 5px 0; color: #004d40; font-size: 0.85rem; border-bottom: 2px solid #b2dfdb; padding-bottom: 3px; font-weight: bold; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-icon { width: 14px; height: 14px; margin-right: 6px; display: inline-block; vertical-align: middle; border: 1px solid #999; }
        
        /* DIALOG */
        #custom-confirm { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .win-dialog { background: #f0f0f0; width: 90%; max-width: 400px; border-radius: 4px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: popIn 0.2s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .win-header { background: white; padding: 10px 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; font-weight: bold; }
        .win-body { padding: 20px; background: white; display: flex; align-items: center; gap: 15px; }
        .win-footer { padding: 10px 15px; background: #f3f3f3; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #ddd; }
        .win-btn { padding: 6px 20px; border: 1px solid #ccc; cursor: pointer; border-radius: 2px; }
        .win-btn.primary { background: #0078d7; color: white; border-color: #005a9e; }
        
        /* FAULT & ICONS */
        .fault-box { display: none; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); border-left: 5px solid #d32f2f; width: 260px; font-size: 0.9rem; margin-right: 10px; margin-bottom: calc(45px + env(safe-area-inset-bottom, 10px)) !important; }
        .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.6); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; }
        .icon-moc { background: #7b1fa2; border-radius: 0; width: 8px !important; height: 8px !important; margin-left: -4px !important; margin-top: -4px !important; }
        .icon-mc-base { border: 2px solid white; border-radius: 2px; z-index: 1000; }
        .icon-mc-source { border: 2px solid #ffeb3b !important; box-shadow: 0 0 5px #ffeb3b, 1px 1px 3px rgba(0,0,0,0.8); z-index: 1001 !important; }
        .leaflet-control-custom { background: white; padding: 5px; cursor: pointer; text-align: center; width: 30px; height: 30px; line-height: 30px; border-radius: 2px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); transition: background 0.2s; }
        .leaflet-control-custom:hover { background: #f4f4f4; }
        .warning-msg { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; border: 1px solid #ffcdd2; margin-top: 10px; font-size: 0.9rem; font-weight: bold; }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i> MENU</button>

    <div id="custom-confirm">
        <div class="win-dialog">
            <div class="win-header"><span>Th√¥ng b√°o</span><button style="border:none;background:none;font-size:1.2rem;cursor:pointer;" onclick="closeWinDialog()">√ó</button></div>
            <div class="win-body"><i class="fas fa-question-circle" style="font-size:2rem;color:#0078d7"></i><span id="win-msg">...</span></div>
            <div class="win-footer"><button class="win-btn primary" id="win-btn-yes" onclick="window.confirmAction()">ƒê·ªìng √Ω</button><button class="win-btn" onclick="closeWinDialog()">H·ªßy</button></div>
        </div>
    </div>

    <div id="sidebar">
        <div class="header">
            <h2>QU·∫¢N L√ù L∆Ø·ªöI ƒêI·ªÜN</h2>
            <button style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;" onclick="closeSidebar()">√ó</button>
        </div>
        <div class="content">
            <button class="accordion">1. C·∫≠p nh·∫≠t & Xu·∫•t Excel</button>
            <div class="panel" id="panel-update">
                <label>Nh·∫≠p t·ª´ File (Th√™m c·ªôt NGUON):</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn btn-check" onclick="window.analyzeFiles()">Ki·ªÉm tra</button>
                <div id="console">Ch·ªù file...</div>
                <div id="upload-actions">
                    <div class="upload-btn-row">
                        <button class="action-btn btn-merge" onclick="window.showUploadConfirm('merge')">G·ªòP D·ªÆ LI·ªÜU</button>
                        <button class="action-btn btn-replace" onclick="window.showUploadConfirm('replace')">X√ìA & GHI M·ªöI</button>
                    </div>
                </div>
                <hr>
                <button class="action-btn btn-export" onclick="window.exportToExcel()">XU·∫§T EXCEL</button>
            </div>

            <button class="accordion" id="acc-entry">2. Nh·∫≠p li·ªáu (Ch·∫ø ƒë·ªô S·ª≠a)</button>
            <div class="panel" id="panel-entry">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('tab-pole')">Tr·ª•</button>
                    <button class="tab-btn" onclick="switchTab('tab-seg')">ƒêo·∫°n</button>
                    <button class="tab-btn" onclick="switchTab('tab-cir')">M·∫°ch</button>
                    <button class="tab-btn" onclick="switchTab('tab-area')">V√πng</button>
                </div>
                <div id="tab-pole" class="edit-section active">
                    <label>T√™n Tuy·∫øn:</label><input type="text" id="inp-pole-route" placeholder="VD: MAYCAT, AKHTTN" oninput="this.value=this.value.toUpperCase()">
                    <label>T√™n Tr·ª•/MC:</label><input type="text" id="inp-pole-name" placeholder="VD: MC_171">
                    <label>Lo·∫°i:</label><select id="inp-pole-type"><option value="TRU_DO">Tr·ª• ƒê·ª°</option><option value="TRU_NEO">Tr·ª• N√©o</option><option value="MC">M√°y C·∫Øt</option><option value="MOC">M·ªëc C√°p</option><option value="HAM_CAP">H·∫ßm C√°p</option></select>
                    <label>L√† Ngu·ªìn (Ch·ªâ √°p d·ª•ng MC):</label>
                    <select id="inp-pole-src"><option value="">-- Kh√¥ng ph·∫£i ngu·ªìn --</option><option value="110kV">110kV (Xanh l√°)</option><option value="220kV">220kV (ƒê·ªè)</option><option value="500kV">500kV (Xanh d∆∞∆°ng)</option></select>
                    <label>T·ªça ƒë·ªô: <button class="btn-pick" onclick="enableMapPick('pole')">üìç Ch·∫•m b·∫£n ƒë·ªì</button></label>
                    <div style="display:flex;gap:5px;"><input type="number" id="inp-lat" placeholder="Lat"><input type="number" id="inp-lng" placeholder="Lng"></div>
                    <button class="action-btn btn-add" onclick="window.savePole()">L∆ØU / C·∫¨P NH·∫¨T</button>
                </div>
                <div id="tab-seg" class="edit-section">
                    <label>M√£ ƒêo·∫°n:</label><input type="text" id="inp-seg-id" placeholder="VD: SEG_01">
                    <label>ƒêi·ªÉm ƒê·∫¶U:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line1" onchange="updatePoleSelect('sel-seg-line1','sel-seg-pole1')"></select><select id="sel-seg-pole1"></select></div>
                    <label>ƒêi·ªÉm CU·ªêI:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line2" onchange="updatePoleSelect('sel-seg-line2','sel-seg-pole2')"></select><select id="sel-seg-pole2"></select></div>
                    <label>Lo·∫°i:</label><select id="inp-seg-type"><option value="NOI">D√¢y N·ªïi</option><option value="NGAM">C√°p Ng·∫ßm</option></select>
                    <button class="action-btn btn-add" onclick="window.saveSegment()">L∆ØU ƒêO·∫†N</button>
                </div>
                <div id="tab-cir" class="edit-section">
                    <label>T√™n M·∫°ch:</label><input type="text" id="inp-cir-id" list="list-circuits"><datalist id="list-circuits"></datalist>
                    <label>Ch·ªçn ƒêo·∫°n:</label><select id="sel-cir-seg"></select>
                    <button class="action-btn btn-add" onclick="window.saveCircuitItem()">TH√äM V√ÄO M·∫†CH</button>
                </div>
                <div id="tab-area" class="edit-section">
                    <label>T√™n V√πng:</label><input type="text" id="inp-area-name" placeholder="VD: Tr·∫°m TBA 110kV">
                    <label>Lo·∫°i:</label><select id="inp-area-type"><option value="TBA">Tr·∫°m Bi·∫øn √Åp (Cam)</option><option value="BUILDING">Nh√†/C√¥ng tr√¨nh (X√°m)</option><option value="CONSTRUCTION">Khu v·ª±c thi c√¥ng (V√†ng)</option><option value="FOUNDATION">M√≥ng/H·∫ßm (N√¢u)</option></select>
                    <div style="margin: 10px 0;"><button class="action-btn btn-draw-control" onclick="startAreaDraw()">‚úèÔ∏è B·∫Øt ƒë·∫ßu v·∫Ω</button><button class="action-btn btn-draw-control" style="background:#fbc02d; color:black;" onclick="undoAreaPoint()">‚Ü©Ô∏è X√≥a ƒëi·ªÉm cu·ªëi</button></div>
                    <div id="draw-status" style="font-size:0.8rem; color:red; margin-bottom:5px;"></div>
                    <button class="action-btn btn-add" onclick="saveArea()">L∆ØU V√ôNG</button>
                </div>
            </div>

            <button class="accordion">3. V·∫≠n h√†nh & T√¨m S·ª± C·ªë</button>
            <div class="panel">
                <label>Ch·ªçn M·∫°ch:</label>
                <select id="circuitSelect" onchange="window.zoomToCircuit()"><option value="">-- To√†n c·∫£nh --</option></select>
                <div style="margin-top:10px;">Tr·∫°ng th√°i: <span id="status-text" style="font-weight:bold;">---</span></div>
                
                <button class="action-btn btn-ground" id="btn-grounding" onclick="toggleGrounding()" style="display:none;">üîí ƒê√ìNG TI·∫æP ƒê·ªäA</button>

                <div id="circuit-info" style="font-size:0.8rem; color:#00695c; margin-top:5px; font-weight:bold;"></div>
                <div style="border-top:1px dashed #ccc; margin:15px 0;"></div>
                <label>Nh·∫≠p Km s·ª± c·ªë:</label><input type="number" id="faultKm" step="0.01" />
                <div class="radio-group"><label><input type="radio" name="faultDir" value="start" checked> T·ª´ ƒê·∫ßu</label><label><input type="radio" name="faultDir" value="end"> T·ª´ Cu·ªëi</label></div>
                <button class="action-btn btn-find" onclick="window.findFault()">T√åM V·ªä TR√ç</button>
                <div id="result" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div class="footer">Copyright TCD software @2026 - Version 1.62</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, push, child, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.set = set; window.update = update; window.ref = ref; window.onValue = onValue; window.push = push; window.child = child; window.get = get; window.remove = remove;
        window.listenCloud();
    </script>

    <script>
        let map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([10.762, 106.660], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxNativeZoom: 19, maxZoom: 22 }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity:0.4, maxNativeZoom: 19, maxZoom: 22 }).addTo(map);
        
        L.Control.Extent = L.Control.extend({
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.innerHTML = 'üè†'; container.title = "To√†n c·∫£nh"; container.style.fontSize = '18px';
                container.onclick = function(e) { e.preventDefault(); window.zoomToExtent(); }
                return container;
            }
        });
        new L.Control.Extent({ position: 'topright' }).addTo(map);

        map.createPane('areaPane'); map.getPane('areaPane').style.zIndex = 200;
        let layers = { areas: L.layerGroup().addTo(map), main: L.layerGroup().addTo(map), minor: L.layerGroup().addTo(map), important: L.layerGroup().addTo(map), mc: L.layerGroup().addTo(map), fault: L.layerGroup().addTo(map) };
        
        let appData = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: [] }; 
        window.stagingData = null; window.pendingAction = null;
        let currentPath = []; let currentPathTotalDist = 0; let pickingMode = null; let tempAreaPoints = []; let tempAreaPoly = null;
        
        map.on('zoomend', () => { if (map.getZoom() < 15) { if(map.hasLayer(layers.minor)) map.removeLayer(layers.minor); } else { if(!map.hasLayer(layers.minor)) map.addLayer(layers.minor); } });
        function openSidebar() { document.getElementById('sidebar').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
        
        // --- S·ª¨A L·ªñI 1: C·∫¢I THI·ªÜN CHECK EDIT MODE ---
        function isEditMode() { 
            // Ki·ªÉm tra xem n√∫t accordion "Nh·∫≠p li·ªáu" c√≥ class active kh√¥ng
            return document.getElementById('acc-entry').classList.contains('active'); 
        }
        
        window.refreshPanelHeight = function(pid) { let p=document.getElementById(pid); if(p.style.maxHeight) p.style.maxHeight = (p.scrollHeight + 100) + "px"; }

        // --- FIX TAB SWITCHING ---
        window.switchTab = function(tabId) {
            document.querySelectorAll('.edit-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            // T√¨m button trigger v√† add active
            let btns = document.querySelectorAll('.tab-btn');
            for(let b of btns) { if(b.getAttribute('onclick').includes(tabId)) b.classList.add('active'); }
            window.refreshDropdowns(); window.refreshPanelHeight('panel-entry');
        }

        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) { acc[i].addEventListener("click", function() { for (var j = 0; j < acc.length; j++) { if (acc[j] !== this && acc[j].classList.contains("active")) { acc[j].classList.remove("active"); acc[j].nextElementSibling.style.maxHeight = null; } } this.classList.toggle("active"); var panel = this.nextElementSibling; if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = (panel.scrollHeight + 100) + "px"; }); }

        map.on('click', function(e) { if (pickingMode === 'pole') { document.getElementById('inp-lat').value = e.latlng.lat.toFixed(6); document.getElementById('inp-lng').value = e.latlng.lng.toFixed(6); pickingMode = null; let btn = document.querySelector('.btn-pick'); btn.innerText = "üìç Ch·∫•m b·∫£n ƒë·ªì"; btn.style.background = "#ff9800"; openSidebar(); } else if (pickingMode === 'area') { tempAreaPoints.push([e.latlng.lat, e.latlng.lng]); drawTempPoly(); } });

        window.zoomToExtent = function() { let bounds = L.latLngBounds([]); let hasData = false; if(appData.poles) { for(let l in appData.poles) { appData.poles[l].forEach(p => { bounds.extend([p.lat, p.lng]); hasData=true; }); } } if(hasData) map.fitBounds(bounds, {padding: [50,50]}); else map.setView([10.762, 106.660], 12); }

        function log(msg, clear=false) { let c=document.getElementById('console'); if(clear) c.innerHTML=''; c.innerHTML+=`<div>> ${msg}</div>`; c.scrollTop=c.scrollHeight; }
        function getCol(row, candidates) { let k=Object.keys(row); for(let c of candidates){ let m=k.find(key=>key.trim().replace(/^\uFEFF/,'')===c); if(m) return m; } return null; }

        window.analyzeFiles = function() {
            const input = document.getElementById('excelFile'); log("ƒêang ƒë·ªçc file...", true);
            if(!input.files.length) { log("‚ùå Ch∆∞a ch·ªçn file!"); return; }
            Promise.all(Array.from(input.files).map(readFile)).then(res => { if(processSheets(Object.assign({}, ...res))) log("‚úÖ Ki·ªÉm tra th√†nh c√¥ng! Ch·ªçn G·ªôp ho·∫∑c Thay th·∫ø."); }).catch(e => log("‚ùå L·ªói: " + e.message));
        }
        function readFile(file) { return new Promise(r => { const rd=new FileReader(); rd.onload=e=>{ const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); let s={}; w.SheetNames.forEach(n=>s[n]=XLSX.utils.sheet_to_json(w.Sheets[n])); r(s); }; rd.readAsArrayBuffer(file); }); }
        
        function processSheets(sheets) {
            const sPoles=Object.keys(sheets).find(n=>n.includes("TOA_DO")); const sSegs=Object.keys(sheets).find(n=>n.includes("DM_DOAN")); const sCircs=Object.keys(sheets).find(n=>n.includes("CAU_HINH"));
            if(!sPoles||!sSegs||!sCircs) { log("‚ùå Thi·∫øu sheet b·∫Øt bu·ªôc!"); return false; }
            let data = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: appData.areas || [] };
            sheets[sPoles].forEach(r => { let cMa=getCol(r,["MA_TUYEN"]), cTen=getCol(r,["TEN_TRU"]), cLat=getCol(r,["LAT"]), cLong=getCol(r,["LONG"]), cLoai=getCol(r,["LOAI_DIEM"]), cNguon=getCol(r,["NGUON"]); if(cMa && r[cLat]) { let l=String(r[cMa]).trim(), n=String(r[cTen]).trim(); if(!data.poles[l]) data.poles[l]=[]; let p = { name: n, lat: parseFloat(r[cLat]), lng: parseFloat(r[cLong]), type: cLoai ? String(r[cLoai]).trim().toUpperCase() : "TRU_DO", sourceVoltage: cNguon ? String(r[cNguon]).trim() : "" }; data.poles[l].push(p); if(p.type.includes('MC')) data.mcStates[n] = true; } });
            sheets[sSegs].forEach(r => { let cId=getCol(r,["MA_DOAN"]), cT1=getCol(r,["TUYEN_TU"]), cTr1=getCol(r,["TRU_TU"]), cT2=getCol(r,["TUYEN_DEN"]), cTr2=getCol(r,["TRU_DEN"]), cL=getCol(r,["LOAI_DIEM","LOAI"]); if(cId && r[cId]) { data.segments[r[cId]] = { id: r[cId], type: (cL&&String(r[cL]).includes("NGAM")?"NGAM":"NOI"), lineFrom: r[cT1], poleFrom: String(r[cTr1]).trim(), lineTo: r[cT2], poleTo: String(r[cTr2]).trim() }; } });
            sheets[sCircs].forEach(r => { let cCid=getCol(r,["MA_DUONG_DAY"]), cSid=getCol(r,["MA_DOAN"]), cStt=getCol(r,["STT"]); if(cCid && r[cCid] && cSid && r[cSid]) { let cid=r[cCid]; if(!data.circuits[cid]) data.circuits[cid]=[]; data.circuits[cid].push({segId: String(r[cSid]).trim(), order: parseInt(r[cStt]||999)}); } });
            for(let k in data.circuits) data.circuits[k].sort((a,b)=>a.order-b.order);
            window.stagingData = data; document.getElementById('upload-actions').style.display = "block"; window.refreshPanelHeight('panel-update'); return true;
        }
        
        window.showUploadConfirm = function(mode) { document.getElementById('win-msg').innerHTML = mode==='merge' ? "G·ªòP d·ªØ li·ªáu m·ªõi?" : "C·∫¢NH B√ÅO: X√ìA TO√ÄN B·ªò c≈©?"; window.pendingAction = { type: 'upload', mode: mode }; document.getElementById('custom-confirm').style.display = 'flex'; }
        window.closeWinDialog = function() { document.getElementById('custom-confirm').style.display = 'none'; window.pendingAction = null; }

        // --- C·∫¨P NH·∫¨T: onElementClick T·ª∞ ƒê·ªòNG SWITCH TAB ---
        window.onElementClick = function(type, name, route, lat, lng, srcVal) {
            if (isEditMode()) {
                window.switchTab('tab-pole'); // T·ª± ƒë·ªông m·ªü tab tr·ª•
                document.getElementById('inp-pole-route').value = route || ""; 
                document.getElementById('inp-pole-name').value = name; 
                document.getElementById('inp-pole-type').value = type; 
                document.getElementById('inp-pole-src').value = srcVal || ""; 
                document.getElementById('inp-lat').value = lat; 
                document.getElementById('inp-lng').value = lng; 
                openSidebar();
            } else {
                if (type.includes('MC')) {
                    let currentState = appData.mcStates[name] !== false; 
                    document.getElementById('win-msg').innerHTML = `ƒêi·ªÅu khi·ªÉn m√°y c·∫Øt <b>${name}</b>?<br><br>Tr·∫°ng th√°i hi·ªán t·∫°i: <b>${currentState?"ƒêANG ƒê√ìNG":"ƒêANG M·ªû"}</b>`;
                    window.pendingAction = { type: 'mc', name: name }; document.getElementById('custom-confirm').style.display = 'flex';
                }
            }
        }

        window.confirmAction = function() {
            if (!window.pendingAction) { closeWinDialog(); return; }
            let btn = document.getElementById('win-btn-yes');
            if (window.pendingAction.type === 'mc') { window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), { [window.pendingAction.name]: !(appData.mcStates[window.pendingAction.name] !== false) }); closeWinDialog(); } 
            else if (window.pendingAction.type === 'upload') {
                if(window.stagingData) {
                    btn.innerText = "ƒêang x·ª≠ l√Ω..."; btn.disabled = true;
                    const rootRef = window.ref(window.db, 'he_thong_luoi_dien');
                    const d = window.stagingData;
                    let sequence = Promise.resolve();
                    if(window.pendingAction.mode === 'replace') { sequence = sequence.then(() => window.set(window.child(rootRef, 'poles'), null)).then(() => window.set(window.child(rootRef, 'segments'), null)).then(() => window.set(window.child(rootRef, 'circuits'), null)).then(() => window.set(window.child(rootRef, 'mcStates'), d.mcStates)); }
                    sequence.then(() => { log("1/4: ƒêang ghi d·ªØ li·ªáu Tr·ª•..."); return window.update(window.child(rootRef, 'poles'), d.poles); })
                            .then(() => { log("2/4: ƒêang ghi d·ªØ li·ªáu ƒêo·∫°n..."); return window.update(window.child(rootRef, 'segments'), d.segments); })
                            .then(() => { log("3/4: ƒêang ghi d·ªØ li·ªáu M·∫°ch..."); return window.update(window.child(rootRef, 'circuits'), d.circuits); })
                            .then(() => { if(window.pendingAction.mode === 'merge') { log("4/4: C·∫≠p nh·∫≠t tr·∫°ng th√°i MC..."); return window.update(window.child(rootRef, 'mcStates'), d.mcStates); } })
                            .then(() => { alert("Th·ª±c hi·ªán th√†nh c√¥ng!"); btn.innerText = "ƒê·ªìng √Ω"; btn.disabled = false; closeWinDialog(); log("‚úÖ Ho√†n t·∫•t!"); })
                            .catch(err => { alert("L·ªói khi ghi d·ªØ li·ªáu: " + err.message); btn.innerText = "ƒê·ªìng √Ω"; btn.disabled = false; closeWinDialog(); });
                } else { closeWinDialog(); }
            }
        };

        window.savePole = function() { let line=document.getElementById('inp-pole-route').value.trim(), name=document.getElementById('inp-pole-name').value.trim(); if(!line||!name) return alert("Thi·∫øu t√™n Tuy·∫øn ho·∫∑c Tr·ª•!"); let p = { name: name, type: document.getElementById('inp-pole-type').value, sourceVoltage: document.getElementById('inp-pole-src').value, lat: parseFloat(document.getElementById('inp-lat').value), lng: parseFloat(document.getElementById('inp-lng').value) }; let path=`he_thong_luoi_dien/poles/${line}`; window.get(window.child(window.ref(window.db), path)).then(snap=>{ let list=snap.val()||[], idx=list.findIndex(x=>x.name===name); if(idx>=0) list[idx]=p; else list.push(p); window.set(window.ref(window.db, path), list).then(()=>{ alert("ƒê√£ l∆∞u!"); if(p.type==='MC') window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), {[name]:true}); }); }); }
        window.saveSegment = function() { let id=document.getElementById('inp-seg-id').value.trim(); if(!id) return alert("Thi·∫øu ID!"); window.set(window.ref(window.db, `he_thong_luoi_dien/segments/${id}`), {id, type:document.getElementById('inp-seg-type').value, lineFrom:document.getElementById('sel-seg-line1').value, poleFrom:document.getElementById('sel-seg-pole1').value, lineTo:document.getElementById('sel-seg-line2').value, poleTo:document.getElementById('sel-seg-pole2').value}).then(()=>alert("ƒê√£ l∆∞u!")); }
        window.saveCircuitItem = function() { let cid=document.getElementById('inp-cir-id').value.trim(), sid=document.getElementById('sel-cir-seg').value; if(!cid||!sid) return; window.get(window.child(window.ref(window.db), `he_thong_luoi_dien/circuits/${cid}`)).then(snap=>{ let list=snap.val()||[]; list.push({segId:sid, order:list.length+1}); window.set(window.ref(window.db, `he_thong_luoi_dien/circuits/${cid}`), list).then(()=>alert("ƒê√£ th√™m!")); }); }
        window.saveArea = function() { if(tempAreaPoints.length<3) return alert("C·∫ßn 3 ƒëi·ªÉm!"); window.get(window.child(window.ref(window.db), 'he_thong_luoi_dien/areas')).then(snap => { let areas = snap.val() || []; areas.push({ name:document.getElementById('inp-area-name').value, type:document.getElementById('inp-area-type').value, points: tempAreaPoints }); window.set(window.ref(window.db, 'he_thong_luoi_dien/areas'), areas).then(() => { alert("ƒê√£ l∆∞u v√πng!"); pickingMode = null; if(tempAreaPoly) map.removeLayer(tempAreaPoly); tempAreaPoints = []; }); }); }
        window.toggleGrounding = function() { let cid = document.getElementById('circuitSelect').value; if(!cid) return; let currentG = appData.grounded ? appData.grounded[cid] : false; window.update(window.ref(window.db, 'he_thong_luoi_dien/grounded'), { [cid]: !currentG }); }

        function createIcon(type, name, isClosed, sourceVoltage) {
            let cls = 'my-icon icon-tru-do', sz = [12,12], label = '';
            if (type.includes('MC')) { cls = isClosed ? 'my-icon icon-mc-base icon-mc-on' : 'my-icon icon-mc-base icon-mc-off'; sz = [22, 16]; if (sourceVoltage && sourceVoltage.length > 0) { cls += ' icon-mc-source'; sz = [26, 20]; } let parts = name.split('_'); label = parts.length > 1 ? parts[parts.length-1] : name; } 
            else if (type.includes('NEO')) cls = 'my-icon icon-tru-neo'; else if (type.includes('MOC')) { cls = 'my-icon icon-moc'; sz = [8,8]; }
            return L.divIcon({ className: cls, html: label, iconSize: sz });
        }
        function renderGlobalMap() {
            layers.main.clearLayers(); layers.minor.clearLayers(); layers.important.clearLayers(); layers.mc.clearLayers(); layers.areas.clearLayers();
            if(appData.areas) appData.areas.forEach(a => { let c='#9e9e9e'; if(a.type==='TBA') c='#ff9800'; else if(a.type==='CONSTRUCTION') c='#ffeb3b'; else if(a.type==='FOUNDATION') c='#795548'; L.polygon(a.points, {color:c, fillColor:c, fillOpacity:0.3, weight:1}).addTo(layers.areas).bindPopup(`<b>${a.name}</b><br>${a.type}`); });
            if(appData.poles) for(let l in appData.poles) appData.poles[l].forEach(p => {
                let isMC = p.type.includes('MC'), isMinor = p.type === 'TRU_DO' || p.type === 'MOC'; let target = isMC ? layers.mc : (isMinor ? layers.minor : layers.important);
                let isClosed = isMC ? (appData.mcStates[p.name] !== false) : true;
                let marker = L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.name, isClosed, p.sourceVoltage), zIndexOffset: isMC ? 1000 : 0 }).addTo(target);
                marker.on('click', () => window.onElementClick(p.type, p.name, l, p.lat, p.lng, p.sourceVoltage)); if(!isMC) marker.bindPopup(`<b>${p.name}</b><br>${l}`);
            });
            if(appData.circuits) Object.keys(appData.circuits).forEach(cid => drawSingleCircuit(cid, false));
        }

        function drawSingleCircuit(circuitId, calcPath) {
            const segs = appData.circuits[circuitId]; if(!segs) return;
            let connectedMCs = []; segs.forEach(item => { let def = appData.segments[item.segId]; if(def) { let p1 = getPoleExact(def.lineFrom, def.poleFrom), p2 = getPoleExact(def.lineTo, def.poleTo); if(p1 && p1.type.includes('MC')) connectedMCs.push(p1); if(p2 && p2.type.includes('MC')) connectedMCs.push(p2); } });
            let activeVoltage = null; let isGrounded = appData.grounded ? appData.grounded[circuitId] : false;
            let activeSources = connectedMCs.filter(mc => (appData.mcStates[mc.name] !== false) && mc.sourceVoltage);
            if (activeSources.length > 0) { activeSources.sort((a,b) => { let vA = parseInt(a.sourceVoltage)||0, vB = parseInt(b.sourceVoltage)||0; return vB - vA; }); activeVoltage = activeSources[0].sourceVoltage; }
            let color = '#000000', statusText = "M·∫§T ƒêI·ªÜN";
            if (isGrounded) { color = '#2196f3'; statusText = "ƒêANG TI·∫æP ƒê·ªäA"; } 
            else if (activeVoltage) { if (activeVoltage.includes('110')) { color = '#388e3c'; statusText = "C√ì ƒêI·ªÜN (110kV)"; } else if (activeVoltage.includes('220')) { color = '#d32f2f'; statusText = "C√ì ƒêI·ªÜN (220kV)"; } else if (activeVoltage.includes('500')) { color = '#0d47a1'; statusText = "C√ì ƒêI·ªÜN (500kV)"; } }
            
            if(calcPath) { 
                document.getElementById('status-text').innerHTML = `<span style="color:${color}">${statusText}</span>`; 
                let btnG = document.getElementById('btn-grounding'); 
                // LOGIC N√öT TI·∫æP ƒê·ªäA: Ch·ªâ hi·ªán khi M·∫•t ƒëi·ªán (activeVoltage null) HO·∫∂C ƒê√£ ti·∫øp ƒë·ªãa (isGrounded true)
                if(!activeVoltage || isGrounded) {
                    btnG.style.display = 'block'; 
                    btnG.innerHTML = isGrounded ? "üîì M·ªû TI·∫æP ƒê·ªäA" : "üîí ƒê√ìNG TI·∫æP ƒê·ªäA"; 
                    btnG.style.background = isGrounded ? "#7cb342" : "#0288d1"; 
                } else {
                    btnG.style.display = 'none';
                }
                currentPath=[]; currentPathTotalDist=0; 
            }
            
            segs.forEach(item => {
                let def = appData.segments[item.segId]; if(!def) return; let p1=getPoleExact(def.lineFrom, def.poleFrom)||getPoleGlobal(def.poleFrom), p2=getPoleExact(def.lineTo, def.poleTo)||getPoleGlobal(def.poleTo); if(!p1||!p2) return;
                let pts = []; let r1=p1.foundRoute||def.lineFrom, r2=p2.foundRoute||def.lineTo; let offset = 0, key = getSegmentKey(p1, p2), list = segmentCounts[key]; if (list && list.length > 1) { let idx = list.indexOf(circuitId); if (idx !== -1) { let center = (list.length - 1) / 2; offset = (idx - center) * 6; } }
                if(r1!==r2) pts=[p1,p2]; else { let d=appData.poles[r1], i1=d.findIndex(p=>p.name===p1.name), i2=d.findIndex(p=>p.name===p2.name); pts=(i1<=i2)?d.slice(i1,i2+1):d.slice(i2,i1+1).reverse(); }
                if(pts.length) { let isCable=def.type.includes("NGAM"); let poly = L.polyline(pts.map(p=>[p.lat,p.lng]), { color: color, weight: calcPath?5:3, opacity: calcPath?1:0.8, dashArray: isCable?"5,5":null, offset: offset }).addTo(layers.main); poly.bindPopup(`<b>${circuitId}</b><br>${statusText}<br>${isCable?'C√°p ng·∫ßm':'D√¢y n·ªïi'}`); if(calcPath) pts.forEach((p,i)=>{ if(i>0) currentPathTotalDist+=getDist(pts[i-1].lat,pts[i-1].lng,p.lat,p.lng); currentPath.push({...p, accDist:currentPathTotalDist}); }); }
            });
        }
        
        let segmentCounts = {};
        function getSegmentKey(p1, p2) { let k1=p1.lat+"_"+p1.lng, k2=p2.lat+"_"+p2.lng; return (k1<k2)?(k1+"|"+k2):(k2+"|"+k1); }
        function calculateOffsets() { segmentCounts={}; if(appData.circuits) Object.keys(appData.circuits).forEach(cid=>{ appData.circuits[cid].forEach(item=>{ let def=appData.segments[item.segId]; if(def){ let p1=getPoleExact(def.lineFrom,def.poleFrom), p2=getPoleExact(def.lineTo,def.poleTo); if(p1&&p2){ let k=getSegmentKey(p1,p2); if(!segmentCounts[k]) segmentCounts[k]=[]; segmentCounts[k].push(cid); } } }); }); }
        function getPoleExact(line, name) { if(!appData.poles[line]) return null; return appData.poles[line].find(p=>String(p.name).toUpperCase()===String(name).toUpperCase()); }
        function getPoleGlobal(name) { for(let l in appData.poles) { let p=appData.poles[l].find(p=>String(p.name).toUpperCase()===String(name).toUpperCase()); if(p) return {...p, foundRoute:l}; } return null; }
        function getDist(lat1,lon1,lat2,lon2) { const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
        
        window.zoomToCircuit = function() { let id = document.getElementById('circuitSelect').value; layers.main.clearLayers(); renderGlobalMap(); document.getElementById('btn-grounding').style.display = 'none'; if(!id) { document.getElementById('status-text').innerText = "---"; return; } drawSingleCircuit(id, true); document.getElementById('circuit-info').innerText = `T·ªïng d√†i: ${(currentPathTotalDist/1000).toFixed(3)} km`; if(currentPath.length) map.fitBounds(currentPath.map(p=>[p.lat,p.lng])); }
        
        // --- S·ª¨A L·ªñI 3: T√åM KI·∫æM & C·∫¢NH B√ÅO ---
        window.findFault = function() { 
            layers.fault.clearLayers(); 
            document.getElementById('result').style.display='none'; 
            let kmInput = parseFloat(document.getElementById('faultKm').value); 
            let direction = document.querySelector('input[name="faultDir"]:checked').value; 
            let cName = document.getElementById('circuitSelect').value; 
            let res = document.getElementById('result'); 

            if(isNaN(kmInput) || currentPath.length<2) { res.style.display='block'; res.className='warning-msg'; res.innerHTML='Vui l√≤ng ch·ªçn m·∫°ch tr∆∞·ªõc!'; return; } 
            
            // C·∫¢NH B√ÅO KHO·∫¢NG C√ÅCH
            let totalKm = currentPathTotalDist / 1000;
            if(kmInput > totalKm) {
                 res.style.display='block'; res.className='warning-msg'; 
                 res.innerHTML=`‚ö†Ô∏è Km nh·∫≠p (${kmInput}) > Chi·ªÅu d√†i m·∫°ch (${totalKm.toFixed(3)} km)!`; 
                 return; 
            }

            let targetDist = direction==='end' ? currentPathTotalDist-(kmInput*1000) : kmInput*1000; 
            if (targetDist < -10 || targetDist > currentPathTotalDist + 10) { res.style.display='block'; res.className='warning-msg'; res.innerHTML = `‚ö†Ô∏è Ngo√†i ph·∫°m vi!`; return; } 
            
            for(let i=1; i<currentPath.length; i++) { 
                let p1=currentPath[i-1], p2=currentPath[i]; 
                if(targetDist>=(p1.accDist-0.1) && targetDist<=(p2.accDist+0.1)) { 
                    let ratio = (p2.accDist > p1.accDist) ? (targetDist-p1.accDist)/(p2.accDist-p1.accDist) : 0; 
                    let lat = p1.lat + (p2.lat-p1.lat)*ratio, lng = p1.lng + (p2.lng-p1.lng)*ratio; 
                    document.getElementById('fault-info-box').style.display='block'; 
                    document.getElementById('fi-name').innerText=cName; 
                    document.getElementById('fi-dist').innerText=`${kmInput} km`; 
                    document.getElementById('fi-seg').innerHTML=`${p1.name} <i class="fas fa-arrow-right"></i> ${p2.name}`; 
                    document.getElementById('fi-addr').innerHTML=`<a href="http://googleusercontent.com/maps.google.com/maps?q=${lat},${lng}" target="_blank">Google Maps</a>`; 
                    L.marker([lat,lng], {icon: L.divIcon({html:'<i class="fas fa-bolt" style="color:red;font-size:32px;"></i>', className:'d'})}).addTo(layers.fault).bindPopup("S·ª∞ C·ªê").openPopup(); 
                    map.setView([lat,lng], 16); closeSidebar(); return; 
                } 
            } 
        }
        
        window.listenCloud = function() { window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), snap => { let val = snap.val(); if(val) { appData = val; if(!appData.mcStates) appData.mcStates={}; if(!appData.grounded) appData.grounded={}; updateUI(); calculateOffsets(); renderGlobalMap(); window.refreshDropdowns(); if(document.getElementById('circuitSelect').value) window.zoomToCircuit(); } }); }
        function updateUI() { const s = document.getElementById('circuitSelect'); let cur = s.value; s.innerHTML = '<option value="">-- To√†n c·∫£nh --</option>'; if(appData.circuits) Object.keys(appData.circuits).forEach(k => { let o=document.createElement('option'); o.value=k; o.text=k; s.add(o); }); s.value = cur; }
        window.refreshDropdowns = function() { let routes=Object.keys(appData.poles||{}), circs=Object.keys(appData.circuits||{}), segs=Object.keys(appData.segments||{}); document.getElementById('sel-seg-line1').innerHTML='<option value="">Ch·ªçn Tuy·∫øn...</option>'+routes.map(r=>`<option value="${r}">${r}</option>`).join(''); document.getElementById('sel-seg-line2').innerHTML=document.getElementById('sel-seg-line1').innerHTML; document.getElementById('list-circuits').innerHTML=circs.map(c=>`<option value="${c}">`).join(''); document.getElementById('sel-cir-seg').innerHTML='<option value="">-- Ch·ªçn ƒëo·∫°n --</option>'+segs.map(s=>`<option value="${s}">${s}</option>`).join(''); }
        window.updatePoleSelect = function(lid, pid) { let line=document.getElementById(lid).value, poles=appData.poles[line]||[]; document.getElementById(pid).innerHTML='<option value="">Ch·ªçn Tr·ª•...</option>'+poles.map(p=>`<option value="${p.name}">${p.name}</option>`).join(''); }
        window.exportToExcel = function() { if(!appData.poles) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!"); let d1=[], d2=[], d3=[]; for(let l in appData.poles) appData.poles[l].forEach(p=>d1.push({"MA_TUYEN":l,"TEN_TRU":p.name,"LAT":p.lat,"LONG":p.lng,"LOAI_DIEM":p.type,"NGUON":p.sourceVoltage})); if(appData.segments) Object.values(appData.segments).forEach(s=>d2.push({"MA_DOAN":s.id,"TUYEN_TU":s.lineFrom,"TRU_TU":s.poleFrom,"TUYEN_DEN":s.lineTo,"TRU_DEN":s.poleTo,"LOAI_DIEM":s.type})); if(appData.circuits) for(let c in appData.circuits) appData.circuits[c].forEach(i=>d3.push({"MA_DUONG_DAY":c,"STT":i.order,"MA_DOAN":i.segId})); let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d1),"TOA_DO"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d2),"DM_DOAN"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d3),"CAU_HINH"); XLSX.writeFile(wb,"DuLieuLuoiDien_v162.xlsx"); }
    </script>
</body>
</html>
