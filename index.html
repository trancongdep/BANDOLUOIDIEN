<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng L∆∞·ªõi ƒêi·ªán - Version 1.5 (Standard)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* LAYOUT */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        #sidebar { 
            width: 420px; background: white; border-right: 1px solid #ccc; 
            display: flex; flex-direction: column; z-index: 2000; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
        }

        .header { background: #00695c; color: white; padding: 15px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 1.1rem; text-transform: uppercase; }

        .content { padding: 15px; overflow-y: auto; flex: 1; background: #fafafa; }

        .footer { background: #263238; color: #eceff1; padding: 10px; text-align: center; font-size: 0.7rem; border-top: 3px solid #ff8f00; flex-shrink: 0; line-height: 1.4; }
        .footer strong { color: #ffca28; }

        /* UI COMPONENTS */
        .card { background: white; padding: 15px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { font-weight: bold; color: #00695c; border-bottom: 2px solid #b2dfdb; padding-bottom: 5px; margin-bottom: 10px; font-size: 0.9rem; }
        
        label { font-weight: 600; font-size: 0.85rem; display: block; margin-bottom: 5px; color: #455a64; }
        
        button { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; transition: 0.2s; }
        .btn-check { background: #455a64; color: white; }
        .btn-merge { background: #2e7d32; color: white; }
        .btn-replace { background: #c62828; color: white; }
        .btn-find { background: #d32f2f; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #cfd8dc; color: #90a4ae; cursor: not-allowed; transform: none; }

        input, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #console { background: #263238; color: #80cbc4; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 120px; overflow-y: auto; margin-top: 5px; border: 1px solid #37474f; }
        
        /* Upload Options Area */
        #upload-actions { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }

        /* LEGEND ON MAP */
        .legend { background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); line-height: 20px; color: #333; font-size: 0.8rem; min-width: 140px; }
        .legend h4 { margin: 0 0 8px 0; color: #00695c; font-size: 0.9rem; border-bottom: 2px solid #b2dfdb; padding-bottom: 4px; font-weight: bold; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .legend-icon { width: 16px; height: 16px; margin-right: 8px; display: inline-block; box-shadow: 1px 1px 2px rgba(0,0,0,0.3); vertical-align: middle; }

        /* ICONS */
        .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.6); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; }
        .icon-mc { background: #d32f2f; border-radius: 2px; font-size: 10px; border: 2px solid white; z-index: 1000 !important; } 
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; }
        .icon-moc { background: #7b1fa2; border-radius: 0px; width: 8px !important; height: 8px !important; margin-left: -4px !important; margin-top: -4px !important; }
        .icon-cot-moc { background: #4a148c; border-radius: 2px 2px 0 0; border-bottom: none; }
        .icon-ham-cap { background: #5d4037; border-radius: 4px; font-family: sans-serif; }

        #result { display: none; background: #e8f5e9; padding: 10px; border-left: 5px solid #2e7d32; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="header">
            <h2><i class="fas fa-bolt"></i> QU·∫¢N L√ù L∆Ø·ªöI ƒêI·ªÜN</h2>
        </div>
        
        <div class="content">
            <div class="card" style="background:#e0f2f1; border-color:#b2dfdb;">
                <div class="card-header">1. C·∫≠p nh·∫≠t D·ªØ li·ªáu (Strict)</div>
                <label>Ch·ªçn file Excel/CSV:</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                
                <button class="btn-check" onclick="window.analyzeFiles()">Ki·ªÉm tra C·∫•u tr√∫c</button>
                <div id="console">S·∫µn s√†ng...</div>

                <div id="upload-actions">
                    <button class="btn-merge" onclick="window.confirmUpload('merge')">
                        <i class="fas fa-code-branch"></i> G·ªòP D·ªÆ LI·ªÜU
                    </button>
                    <button class="btn-replace" onclick="window.confirmUpload('replace')">
                        <i class="fas fa-trash-alt"></i> X√ìA C≈® & GHI M·ªöI
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">2. V·∫≠n h√†nh</div>
                <label>Ch·ªçn M·∫°ch:</label>
                <select id="circuitSelect" onchange="window.drawCircuit()">
                    <option value="">-- ƒêang t·∫£i d·ªØ li·ªáu --</option>
                </select>
                <div id="circuit-info" style="font-size:0.8rem; color:#666; margin-top:5px; font-style:italic;"></div>
            </div>

            <div class="card">
                <div class="card-header">3. T√¨m S·ª± C·ªë</div>
                <label>Kho·∫£ng c√°ch t·ª´ ƒë·∫ßu ngu·ªìn (km):</label>
                <input type="number" id="faultKm" step="0.01" placeholder="Nh·∫≠p s·ªë Km..." />
                <button class="btn-find" onclick="window.findFault()">T√åM V·ªä TR√ç</button>
                <div id="result"></div>
            </div>
        </div>

        <div class="footer">
            Copyright <strong>TCD software</strong> @2025 - Version 1.5<br>
            Li√™n h·ªá: Tr·∫ßn C√¥ng ƒê·∫πp - 0963292882
        </div>
    </div>
    
    <div id="map" style="flex:1;"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };
        
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); 
        window.set = set; 
        window.update = update;
        window.ref = ref; 
        window.onValue = onValue;
        
        window.listenCloud();
    </script>

    <script>
        let map = L.map('map').setView([10.762, 106.660], 12);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {opacity:0.4}).addTo(map);
        
        let layers = { 
            bg: L.layerGroup().addTo(map), 
            bgPoints: L.layerGroup().addTo(map),
            mc: L.layerGroup().addTo(map), 
            main: L.layerGroup().addTo(map), 
            fault: L.layerGroup().addTo(map) 
        };
        let appData = { poles: {}, segments: {}, circuits: {} };
        let stagingData = null;
        let currentPath = [];

        // --- LEGEND ---
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>Ch√∫ Th√≠ch</h4>
                <div class="legend-item"><span class="legend-icon" style="background:#d32f2f; border:1px solid white;"></span> M√°y C·∫Øt (MC)</div>
                <div class="legend-item"><span class="legend-icon" style="background:#ff6f00; transform:rotate(45deg);"></span> Tr·ª• N√©o</div>
                <div class="legend-item"><span class="legend-icon" style="background:#1976d2; border-radius:50%;"></span> Tr·ª• ƒê·ª°</div>
                <div class="legend-item"><span class="legend-icon" style="background:#7b1fa2;"></span> M·ªëc C√°p</div>
                <div class="legend-item"><span class="legend-icon" style="background:#4a148c;"></span> C·ªôt M·ªëc</div>
                <div class="legend-item"><span class="legend-icon" style="background:#5d4037; border-radius:4px;"></span> H·∫ßm C√°p</div>
            `;
            return div;
        };
        legend.addTo(map);

        function log(msg, type='info') {
            const c = document.getElementById('console');
            let color = type=='err'?'#ff5252':(type=='warn'?'#ffab40':(type=='success'?'#00e676':'#fff'));
            c.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        // --- H√ÄM CHU·∫®N H√ìA NGHI√äM NG·∫∂T (STRICT) ---
        function strictNorm(obj) {
            let n = {};
            Object.keys(obj).forEach(k => {
                let key = String(k).trim().toUpperCase(); // Ch·ªâ vi·∫øt hoa, kh√¥ng b·ªè d·∫•u
                n[key] = obj[k];
            });
            return n;
        }

        // --- 1. X·ª¨ L√ù FILE ---
        window.analyzeFiles = function() {
            const input = document.getElementById('excelFile');
            document.getElementById('console').innerHTML = "";
            document.getElementById('upload-actions').style.display = "none";

            if(!input.files.length) return log("Ch∆∞a ch·ªçn file", 'err');
            
            Promise.all(Array.from(input.files).map(readFile)).then(res => {
                let combinedSheets = Object.assign({}, ...res);
                processSheets(combinedSheets);
            }).catch(e => log(e.message, 'err'));
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const r = new FileReader();
                r.onload = e => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, {type:'array'});
                        let sheets = {};
                        wb.SheetNames.forEach(n => {
                            let finalName = n;
                            if(file.name.toLowerCase().endsWith(".csv")) finalName = file.name.toUpperCase();
                            sheets[finalName] = XLSX.utils.sheet_to_json(wb.Sheets[n]);
                        });
                        resolve(sheets);
                    } catch(err) { reject(err); }
                };
                r.readAsArrayBuffer(file);
            });
        }

        function processSheets(sheets) {
            // T√¨m sheet theo t·ª´ kh√≥a trong t√™n file
            const findS = k => Object.keys(sheets).find(n => n.includes(k));
            
            const sPoles = findS("TOA_DO");
            const sSegs = findS("DM_DOAN");
            const sCircs = findS("CAU_HINH_MACH");

            if(!sPoles) return log("‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y file/sheet 'TOA_DO'", 'err');
            if(!sSegs) return log("‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y file/sheet 'DM_DOAN'", 'err');
            if(!sCircs) return log("‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y file/sheet 'CAU_HINH_MACH'", 'err');

            let data = { poles: {}, segments: {}, circuits: {} };
            let errors = 0;

            // 1. POLES
            sheets[sPoles].forEach((r, idx) => {
                let row = strictNorm(r);
                if(!row.MA_TUYEN || !row.TEN_TRU || !row.LAT || !row.LONG) return;

                let l = row.MA_TUYEN;
                let n = String(row.TEN_TRU).trim();
                let type = (row.LOAI_DIEM || "TRU_DO").trim().toUpperCase(); 

                if(!data.poles[l]) data.poles[l]=[];
                let sNum = parseInt((n.match(/\d+/)||[9999])[0]);
                data.poles[l].push({
                    name: n, lat: parseFloat(row.LAT), lng: parseFloat(row.LONG), sort: sNum, type: type 
                });
            });
            for(let k in data.poles) data.poles[k].sort((a,b)=>a.sort-b.sort);

            // 2. SEGMENTS
            sheets[sSegs].forEach((r, idx) => {
                let row = strictNorm(r);
                if(!row.MA_DOAN) return;

                let id = row.MA_DOAN;
                if(!row.TUYEN_TU || !row.TRU_TU || !row.TUYEN_DEN || !row.TRU_DEN) {
                    log(`‚ö†Ô∏è D√≤ng ${idx+2} (DM_DOAN): Thi·∫øu d·ªØ li·ªáu tuy·∫øn/tr·ª•`, 'warn');
                    errors++;
                    return;
                }

                data.segments[id] = { 
                    id, 
                    type: (row.LOAI || "NOI").toUpperCase(), 
                    lineFrom: row.TUYEN_TU, 
                    poleFrom: String(row.TRU_TU).trim(), 
                    lineTo: row.TUYEN_DEN, 
                    poleTo: String(row.TRU_DEN).trim() 
                };
            });

            // 3. CIRCUITS
            sheets[sCircs].forEach((r, idx) => {
                let row = strictNorm(r);
                if(!row.MA_DUONG_DAY) return;

                let cid = row.MA_DUONG_DAY;
                let sid = row.MA_DOAN;
                
                if(!sid) {
                    log(`‚ö†Ô∏è D√≤ng ${idx+2} (CAU_HINH): Thi·∫øu MA_DOAN`, 'warn');
                    errors++;
                    return;
                }

                if(!data.circuits[cid]) data.circuits[cid]=[];
                data.circuits[cid].push({ segId: sid, order: parseInt(row.STT||999) });
            });
            for(let k in data.circuits) data.circuits[k].sort((a,b)=>a.order-b.order);

            stagingData = data;
            
            if(errors > 0) log(`‚ö†Ô∏è C√≥ ${errors} c·∫£nh b√°o.`, 'warn');
            
            log(`‚úÖ ƒê√£ ƒë·ªçc: ${Object.keys(data.poles).length} tuy·∫øn, ${Object.keys(data.circuits).length} m·∫°ch.`);
            log(`üëâ H√£y ch·ªçn G·ªòP ho·∫∑c THAY M·ªöI b√™n d∆∞·ªõi.`);
            
            document.getElementById('upload-actions').style.display = "block";
        }

        // --- UPLOAD (MERGE/REPLACE) ---
        window.confirmUpload = function(mode) {
            if(!stagingData) return;

            if(mode === 'replace') {
                if(!confirm("C·∫¢NH B√ÅO: X√ìA H·∫æT d·ªØ li·ªáu c≈© tr√™n Cloud?")) return;
                log("ƒêang x√≥a c≈© v√† ghi m·ªõi...", 'warn');
                window.set(window.ref(window.db, 'he_thong_luoi_dien'), stagingData)
                    .then(() => log("‚úÖ ƒê√£ thay th·∫ø th√†nh c√¥ng!", 'success'))
                    .catch(e => log("L·ªói: " + e.message, 'err'));
            } 
            else if (mode === 'merge') {
                log("ƒêang g·ªôp d·ªØ li·ªáu...", 'info');
                let updates = {};
                Object.keys(stagingData.poles).forEach(k => updates[`he_thong_luoi_dien/poles/${k}`] = stagingData.poles[k]);
                Object.keys(stagingData.segments).forEach(k => updates[`he_thong_luoi_dien/segments/${k}`] = stagingData.segments[k]);
                Object.keys(stagingData.circuits).forEach(k => updates[`he_thong_luoi_dien/circuits/${k}`] = stagingData.circuits[k]);

                window.update(window.ref(window.db), updates)
                    .then(() => log("‚úÖ ƒê√£ g·ªôp th√†nh c√¥ng!", 'success'))
                    .catch(e => log("L·ªói Merge: " + e.message, 'err'));
            }
        }

        // --- 3. HI·ªÇN TH·ªä ---
        window.listenCloud = function() {
            if(window.ref) {
                window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), snap => {
                    appData = snap.val() || {poles:{}, segments:{}, circuits:{}};
                    updateUI();
                    drawBg();
                });
            }
        }

        function updateUI() {
            const s = document.getElementById('circuitSelect');
            s.innerHTML = '<option value="">-- Ch·ªçn m·∫°ch --</option>';
            if(appData.circuits) Object.keys(appData.circuits).forEach(k => {
                let o = document.createElement('option'); o.value=k; o.text=k; s.add(o);
            });
        }

        function createIcon(type, name) {
            let className = 'my-icon icon-tru-do'; 
            let size = [12, 12];
            let html = '';

            if(type === 'MC') { className = 'my-icon icon-mc'; size = [16, 16]; html = 'MC'; }
            else if(type === 'TRU_NEO') { className = 'my-icon icon-tru-neo'; size = [12, 12]; }
            else if(type === 'MOC') { className = 'my-icon icon-moc'; size = [8, 8]; }
            else if(type === 'COT_MOC') { className = 'my-icon icon-cot-moc'; size = [10, 14]; }
            else if(type === 'HAM_CAP') { className = 'my-icon icon-ham-cap'; size = [14, 10]; html = 'H'; }
            
            return L.divIcon({ className: className, html: html, iconSize: size, iconAnchor: [size[0]/2, size[1]/2] });
        }

        function drawBg() {
            layers.bg.clearLayers();
            layers.bgPoints.clearLayers();
            layers.mc.clearLayers();

            if(appData.poles) for(let l in appData.poles) {
                let pts = appData.poles[l].map(p=>[p.lat,p.lng]);
                if(pts.length>1) L.polyline(pts, {color:'#cfd8dc', weight:1}).addTo(layers.bg);
                
                appData.poles[l].forEach(p => {
                    let layer = (p.type === 'MC') ? layers.mc : layers.bgPoints;
                    L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.name) }).addTo(layer).bindPopup(`<b>${p.name}</b><br>Lo·∫°i: ${p.type}<br>Tuy·∫øn: ${l}`);
                });
            }
        }

        window.drawCircuit = function() {
            const id = document.getElementById('circuitSelect').value;
            layers.main.clearLayers(); layers.fault.clearLayers();
            currentPath = []; 
            document.getElementById('circuit-info').innerText = "";

            if(!id || !appData.circuits[id]) return;

            const segs = appData.circuits[id];
            let totalDist = 0;

            segs.forEach((item, idx) => {
                const def = appData.segments[item.segId];
                if(!def) return;
                
                let pts = [];
                let p1 = getPolePos(def.lineFrom, def.poleFrom);
                let p2 = getPolePos(def.lineTo, def.poleTo);

                if(!p1 || !p2) {
                    console.warn(`Thi·∫øu t·ªça ƒë·ªô cho ƒëo·∫°n ${item.segId}`);
                    return;
                }

                if(def.lineFrom !== def.lineTo) {
                     pts = [p1, p2];
                } else {
                     pts = getPoleRange(def.lineFrom, def.poleFrom, def.poleTo);
                }

                if(pts.length) {
                    let isCable = (def.type === 'NGAM');
                    let color = isCable ? '#7b1fa2' : '#1565c0';
                    let dash = isCable ? "5,5" : null;

                    L.polyline(pts.map(p=>[p.lat,p.lng]), {color:color, weight:3, dashArray:dash}).addTo(layers.main);
                    
                    pts.forEach(p => {
                        if(p.type !== 'MC') {
                            L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.name) }).addTo(layers.main).bindPopup(p.name);
                        }
                    });

                    pts.forEach((p, i) => {
                        if(i>0) totalDist += getDist(pts[i-1].lat, pts[i-1].lng, p.lat, p.lng);
                        currentPath.push({ ...p, line: def.lineFrom, accDist: totalDist });
                    });
                }
            });
            
            document.getElementById('circuit-info').innerText = `T·ªïng d√†i: ${(totalDist/1000).toFixed(2)} km`;
            if(currentPath.length) map.fitBounds(currentPath.map(p=>[p.lat,p.lng]));
        }

        function getPolePos(line, name) {
            if(!appData.poles[line]) return null;
            return appData.poles[line].find(p => p.name.toUpperCase() === String(name).toUpperCase());
        }
        function getPoleRange(line, from, to) {
            if(!appData.poles[line]) return [];
            const lData = appData.poles[line];
            let i1 = lData.findIndex(p=>p.name.toUpperCase()===String(from).toUpperCase());
            let i2 = lData.findIndex(p=>p.name.toUpperCase()===String(to).toUpperCase());
            if(i1<0 || i2<0) return [];
            return (i1<=i2) ? lData.slice(i1,i2+1) : lData.slice(i2,i1+1).reverse();
        }

        window.findFault = function() {
            let km = parseFloat(document.getElementById('faultKm').value);
            let res = document.getElementById('result');
            res.style.display='none';
            if(isNaN(km) || currentPath.length<2) return;
            
            let target = km * 1000;
            for(let i=1; i<currentPath.length; i++) {
                let p1 = currentPath[i-1], p2 = currentPath[i];
                if(p2.accDist >= target) {
                    let r = (target - p1.accDist)/(p2.accDist - p1.accDist);
                    let lat = p1.lat + (p2.lat-p1.lat)*r, lng = p1.lng + (p2.lng-p1.lng)*r;
                    
                    L.marker([lat,lng], {icon: L.divIcon({html:'<i class="fas fa-bolt" style="color:red;font-size:32px;"></i>', className:'d'})}).addTo(layers.fault).bindPopup("S·ª∞ C·ªê").openPopup();
                    map.setView([lat,lng], 16);
                    res.style.display='block'; res.innerHTML = `<b>T√åM TH·∫§Y!</b><br>ƒêo·∫°n: ${p1.name} -> ${p2.name}<br>C√°ch ƒëi·ªÉm tr∆∞·ªõc: ${(target-p1.accDist).toFixed(1)}m`;
                    return;
                }
            }
            res.style.display='block'; res.innerHTML = "Ngo√†i ph·∫°m vi (Max: "+(currentPath[currentPath.length-1].accDist/1000).toFixed(2)+"km)";
        }

        function getDist(lat1,lon1,lat2,lon2) {
            const R=6371000; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }
    </script>
</body>
</html>
