
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u ƒê·ªãa ch·ªâ & Th·ªùi ti·∫øt v2.0</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
        }
        h2 {
            margin-top: 0;
            color: #1a73e8;
            text-align: center;
            font-size: 24px;
            margin-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #5f6368;
            font-size: 13px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #202124;
            font-size: 14px;
        }
        textarea {
            width: 100%;
            height: 60px;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 15px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        input[type="datetime-local"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }
        button:hover { background-color: #1557b0; }
        button:disabled { background-color: #dadce0; cursor: not-allowed; }
        
        #result {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: none;
        }
        .result-section { margin-bottom: 15px; }
        .label-res { font-weight: bold; font-size: 12px; color: #5f6368; text-transform: uppercase; margin-bottom: 4px; }
        .value-res { font-size: 15px; color: #202124; line-height: 1.5; }
        
        .weather-box {
            background: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .weather-temp { font-size: 28px; font-weight: bold; color: #1a73e8; }
        .weather-detail { font-size: 14px; color: #444; }

        .coords-debug {
            font-family: monospace;
            color: #d93025;
            background: #fce8e6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        .loading { text-align: center; color: #5f6368; display: none; margin-top: 15px; font-size: 14px; }
    </style>
</head>
<body>

<div class="card">
    <h2>üìç Geo & Weather Tool</h2>
    <div class="subtitle">Version 2.0</div>
    
    <div class="form-group">
        <label for="rawCoords">1. Nh·∫≠p t·ªça ƒë·ªô (Lat, Lon):</label>
        <textarea id="rawCoords" placeholder="V√≠ d·ª•: 10,7603659, 106,6853132"></textarea>
    </div>

    <div class="form-group">
        <label for="queryTime">2. Ch·ªçn th·ªùi ƒëi·ªÉm (M·∫∑c ƒë·ªãnh: Hi·ªán t·∫°i):</label>
        <input type="datetime-local" id="queryTime">
    </div>

    <button id="btnSearch" onclick="processAndSearch()">üîç Tra c·ª©u ngay</button>
    
    <div id="loading" class="loading">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</div>

    <div id="result">
        <div class="result-section">
            <div class="label-res">ƒê·ªãa ch·ªâ (OpenStreetMap):</div>
            <div id="addressText" class="value-res" style="font-weight: 500;"></div>
            <div style="margin-top:5px;"><small class="coords-debug" id="parsedCoords"></small></div>
        </div>

        <div class="result-section" id="weatherSection">
            <div class="label-res">Th·ªùi ti·∫øt l√∫c tra c·ª©u:</div>
            <div class="weather-box">
                <div class="weather-temp" id="wTemp">--¬∞C</div>
                <div class="weather-detail">
                    <div id="wDesc" style="font-weight: 600; margin-bottom: 2px;">--</div>
                    <div>ƒê·ªô ·∫©m: <span id="wHum">--</span>%</div>
                    <div>Gi√≥: <span id="wWind">--</span> km/h</div>
                </div>
            </div>
            <div style="font-size: 11px; color: #888; margin-top: 5px; text-align: right;">Ngu·ªìn: Open-Meteo</div>
        </div>
    </div>
</div>

<script>
    // Set default time to Now (Local Time)
    window.onload = function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('queryTime').value = now.toISOString().slice(0,16);
    };

    async function processAndSearch() {
        const rawInput = document.getElementById('rawCoords').value;
        const timeInput = document.getElementById('queryTime').value;
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const btn = document.getElementById('btnSearch');

        // Reset UI
        resultDiv.style.display = 'none';
        
        if (!rawInput.trim()) { alert("Vui l√≤ng nh·∫≠p t·ªça ƒë·ªô!"); return; }
        if (!timeInput) { alert("Vui l√≤ng ch·ªçn th·ªùi gian!"); return; }

        // --- B∆Ø·ªöC 1: PARSE TO·∫† ƒê·ªò ---
        let lat, lon;
        try {
            let cleanStr = rawInput.trim();
            let parts;
            // Logic x·ª≠ l√Ω d·∫•u ph·∫©y/ch·∫•m nh∆∞ version 1.1
            if (cleanStr.includes('.') && !cleanStr.includes(',,')) {
                parts = cleanStr.split(/[\s,]+/);
            } else {
                if (cleanStr.includes(', ')) {
                    let temp = cleanStr.replace(', ', '|'); 
                    parts = temp.split('|');
                } else {
                    let rawParts = cleanStr.split(',');
                    if (rawParts.length === 4) parts = [rawParts[0]+'.'+rawParts[1], rawParts[2]+'.'+rawParts[3]];
                    else if (rawParts.length === 2) parts = rawParts;
                }
            }
            const numbers = parts.map(p => parseFloat(p.replace(/,/g, '.').replace(/[^0-9.-]/g, ''))).filter(n => !isNaN(n));
            if (numbers.length < 2) throw new Error("Format l·ªói");
            lat = numbers[0]; lon = numbers[1];
        } catch (e) {
            alert("L·ªói ƒë·ªãnh d·∫°ng t·ªça ƒë·ªô. H√£y nh·∫≠p: 10,7603659, 106,6853132");
            return;
        }

        document.getElementById('parsedCoords').textContent = `Lat: ${lat} | Lon: ${lon}`;

        // --- B∆Ø·ªöC 2: FETCH DATA ---
        loadingDiv.style.display = 'block';
        btn.disabled = true;

        try {
            // 2.1 Fetch ƒê·ªãa ch·ªâ (Reverse Geocoding)
            const addrPromise = fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`, {
                headers: {'Accept-Language': 'vi'}
            }).then(res => res.json());

            // 2.2 Fetch Th·ªùi ti·∫øt
            const weatherPromise = fetchWeather(lat, lon, timeInput);

            // Ch·∫°y song song 2 request
            const [addrData, weatherData] = await Promise.all([addrPromise, weatherPromise]);

            // --- B∆Ø·ªöC 3: HI·ªÇN TH·ªä ---
            // ƒê·ªãa ch·ªâ
            if (addrData.error) {
                document.getElementById('addressText').textContent = "Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ.";
            } else {
                document.getElementById('addressText').textContent = addrData.display_name;
            }

            // Th·ªùi ti·∫øt
            if (weatherData) {
                document.getElementById('wTemp').textContent = `${weatherData.temperature_2m}¬∞C`;
                document.getElementById('wDesc').textContent = getWeatherDesc(weatherData.weather_code);
                document.getElementById('wHum').textContent = weatherData.relative_humidity_2m;
                document.getElementById('wWind').textContent = weatherData.wind_speed_10m;
            } else {
                document.getElementById('wDesc').textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu th·ªùi ti·∫øt cho ng√†y n√†y.";
            }

            resultDiv.style.display = 'block';

        } catch (err) {
            alert("L·ªói k·∫øt n·ªëi: " + err.message);
        } finally {
            loadingDiv.style.display = 'none';
            btn.disabled = false;
        }
    }

    async function fetchWeather(lat, lon, isoTimeStr) {
        const inputDate = new Date(isoTimeStr);
        const today = new Date();
        today.setHours(0,0,0,0); // Reset v·ªÅ ƒë·∫ßu ng√†y h√¥m nay

        // Format YYYY-MM-DD
        const dateStr = isoTimeStr.split('T')[0];
        
        // Quy·∫øt ƒë·ªãnh d√πng API n√†o:
        // N·∫øu ng√†y nh·∫≠p < h√¥m nay -> D√πng Archive API (L·ªãch s·ª≠)
        // N·∫øu ng√†y nh·∫≠p >= h√¥m nay -> D√πng Forecast API (D·ª± b√°o)
        const isPast = inputDate < today;
        
        let url = "";
        if (isPast) {
            url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`;
        } else {
            url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`;
        }

        const res = await fetch(url);
        const data = await res.json();

        if (!data.hourly) return null;

        // T√¨m gi·ªù g·∫ßn nh·∫•t v·ªõi gi·ªù ng∆∞·ªùi d√πng nh·∫≠p
        // inputDate ƒëang l√† Local time. D·ªØ li·ªáu OpenMeteo tr·∫£ v·ªÅ m·∫£ng theo gi·ªù, c·∫ßn ƒë·ªëi chi·∫øu.
        // C√°ch ƒë∆°n gi·∫£n nh·∫•t: L·∫•y gi·ªù c·ªßa input (0-23) v√† l·∫•y index t∆∞∆°ng ·ª©ng trong m·∫£ng hourly.
        const hourIndex = inputDate.getHours(); // 0 -> 23

        // Tr·∫£ v·ªÅ object d·ªØ li·ªáu t·∫°i gi·ªù ƒë√≥
        return {
            temperature_2m: data.hourly.temperature_2m[hourIndex],
            weather_code: data.hourly.weather_code[hourIndex],
            relative_humidity_2m: data.hourly.relative_humidity_2m[hourIndex],
            wind_speed_10m: data.hourly.wind_speed_10m[hourIndex]
        };
    }

    function getWeatherDesc(code) {
        // M√£ WMO Weather interpretation codes
        const map = {
            0: "Tr·ªùi quang ƒë√£ng ‚òÄÔ∏è",
            1: "Ch·ªß y·∫øu l√† n·∫Øng üå§", 2: "C√≥ m√¢y ‚õÖ", 3: "Nhi·ªÅu m√¢y ‚òÅÔ∏è",
            45: "S∆∞∆°ng m√π üå´", 48: "S∆∞∆°ng mu·ªëi ‚ùÑÔ∏è",
            51: "M∆∞a ph√πn nh·∫π üåß", 53: "M∆∞a ph√πn v·ª´a", 55: "M∆∞a ph√πn d√†y",
            61: "M∆∞a nh·ªè ‚òîÔ∏è", 63: "M∆∞a v·ª´a ‚òîÔ∏è", 65: "M∆∞a to ‚õà",
            80: "M∆∞a r√†o nh·∫π", 81: "M∆∞a r√†o v·ª´a", 82: "M∆∞a r√†o r·∫•t to",
            95: "Gi√¥ng b√£o ‚ö°", 96: "Gi√¥ng b√£o + M∆∞a ƒë√° nh·∫π", 99: "Gi√¥ng b√£o + M∆∞a ƒë√° n·∫∑ng"
        };
        return map[code] || `M√£: ${code}`;
    }
</script>

</body>
</html>
