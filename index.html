<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản Lý Lưới Điện (Admin) - v1.92</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* --- CORE CSS --- */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #f0f2f5; }
        
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 30px; width: 100%; z-index: 1; }
        
        /* FOOTER */
        .footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 30px; 
            background: #212121; color: #eceff1; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.75rem; border-top: 3px solid #ff6f00; 
            z-index: 4000; 
        }

        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 2000; background: #004d40; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; }
        
        /* SIDEBAR */
        #sidebar { 
            position: fixed; top: 0; left: -100%; width: 400px; height: 100%; 
            background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); 
            transition: left 0.3s ease-in-out; display: flex; flex-direction: column; padding-bottom: 30px;
        }
        #sidebar.active { left: 0; }
        
        .header { background: #004d40; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 10px; overflow-y: auto; flex: 1; }
        
        .accordion { background-color: #eee; color: #444; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left; outline: none; font-size: 15px; font-weight: bold; transition: 0.4s; border-bottom: 1px solid #ddd; }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        .accordion:after { content: '\002B'; float: right; margin-left: 5px; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-bottom: 1px solid #ddd; }
        
        /* FORM ELEMENTS */
        label { font-weight: 600; font-size: 13px; display: block; margin: 8px 0 4px; }
        input, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; color: white; }
        
        .btn-check { background: #00796b; } 
        .btn-merge { background: #2e7d32; width: 48%; } 
        .btn-replace { background: #c62828; width: 48%; } 
        .btn-find { background: #d32f2f; }
        .btn-add { background: #1565c0; }
        .btn-save-cir { background: #e64a19; }
        .btn-export { background: #2e7d32; margin-top: 10px; }

        .tab-container { display: flex; margin-bottom: 10px; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { color: #004d40; border-bottom: 3px solid #004d40; }
        .edit-section { display: none; }
        .edit-section.active { display: block; }

        /* LISTS & LOGS */
        #circuit-segment-list { max-height: 150px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 10px; }
        .cir-item-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; }
        .cir-item-row:hover { background: #f0f0f0; }
        
        #console { background: #212121; color: #00e676; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 12px; height: 100px; overflow-y: auto; margin-bottom: 10px; }
        #upload-actions { display: none; margin-top: 10px; }

        /* ICONS & MARKERS */
        .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.6); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; }
        .icon-mc-base { border: 2px solid white; border-radius: 2px; z-index: 1000; }
        .icon-mc-source { border: 2px solid #ffeb3b !important; box-shadow: 0 0 5px #ffeb3b; z-index: 1001 !important; }
        
        /* FAULT MARKER */
        .fault-marker { font-size: 35px; color: red; text-shadow: 0 0 5px yellow; animation: flash 0.5s infinite; }
        @keyframes flash { from {opacity: 1;} to {opacity: 0.3;} }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i> MENU</button>
    <div class="footer">Copyright TCD software @2026 - Admin v1.92</div>

    <div id="sidebar">
        <div class="header">
            <h3>QUẢN LÝ LƯỚI ĐIỆN</h3>
            <button style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;" onclick="closeSidebar()">×</button>
        </div>
        
        <div class="content">
            <button class="accordion">1. Cập nhật & Xuất Excel</button>
            <div class="panel" id="panel-update">
                <label>Chọn file Excel/CSV:</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn btn-check" onclick="window.analyzeFiles()">Kiểm tra dữ liệu</button>
                <div id="console">Sẵn sàng...</div>
                <div id="upload-actions">
                    <button class="action-btn btn-merge" onclick="window.confirmUpload('merge')">GỘP DỮ LIỆU</button>
                    <button class="action-btn btn-replace" onclick="window.confirmUpload('replace')">THAY THẾ (XÓA CŨ)</button>
                </div>
                <hr>
                <button class="action-btn btn-export" onclick="window.exportToExcel()">XUẤT RA EXCEL</button>
            </div>

            <button class="accordion" id="acc-entry">2. Nhập liệu (Sửa đổi)</button>
            <div class="panel" id="panel-entry">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('tab-pole')">Trụ</button>
                    <button class="tab-btn" onclick="switchTab('tab-seg')">Đoạn</button>
                    <button class="tab-btn" onclick="switchTab('tab-cir')">Mạch</button>
                </div>
                
                <div id="tab-pole" class="edit-section active">
                    <label>Tên Tuyến:</label><input type="text" id="inp-pole-route">
                    <label>Tên Trụ:</label><input type="text" id="inp-pole-name">
                    <label>Loại:</label><select id="inp-pole-type"><option value="TRU_DO">Trụ Đỡ</option><option value="TRU_NEO">Trụ Néo</option><option value="MC">Máy Cắt</option></select>
                    <label>Nguồn (MC):</label><select id="inp-pole-src"><option value="">Không</option><option value="220kV">220kV</option><option value="110kV">110kV</option></select>
                    <div style="display:flex;gap:5px;"><input type="number" id="inp-lat" placeholder="Lat"><input type="number" id="inp-lng" placeholder="Lng"></div>
                    <button class="action-btn btn-add" onclick="window.savePole()">LƯU TRỤ</button>
                </div>

                <div id="tab-seg" class="edit-section">
                    <label>Mã Đoạn:</label><input type="text" id="inp-seg-id"><input type="hidden" id="inp-seg-id-old">
                    <label>Từ:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line1" onchange="updatePoleSelect('sel-seg-line1','sel-seg-pole1')"></select><select id="sel-seg-pole1"></select></div>
                    <label>Đến:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line2" onchange="updatePoleSelect('sel-seg-line2','sel-seg-pole2')"></select><select id="sel-seg-pole2"></select></div>
                    <button class="action-btn btn-add" onclick="window.saveSegment()">LƯU ĐOẠN</button>
                </div>

                <div id="tab-cir" class="edit-section">
                    <label>Tên Mạch:</label><input type="text" id="inp-cir-id" list="list-circuits"><datalist id="list-circuits"></datalist>
                    <div id="circuit-segment-list"></div>
                    <label>Thêm đoạn:</label><select id="sel-cir-seg"></select>
                    <button class="action-btn btn-add" onclick="window.addSegToCir()">Thêm đoạn</button>
                    <button class="action-btn btn-save-cir" onclick="window.saveCircuitStructure()">LƯU CẤU TRÚC MẠCH</button>
                </div>
            </div>

            <button class="accordion">3. Vận hành & Tìm sự cố</button>
            <div class="panel" id="panel-opt">
                <label>Chọn Mạch:</label>
                <select id="circuitSelect" onchange="window.zoomToCircuit()"><option value="">-- Chọn --</option></select>
                
                <div style="margin:10px 0;padding:10px;background:#f5f5f5;border-radius:4px;">
                    Trạng thái: <span id="status-text" style="font-weight:bold;">---</span>
                    <div id="circuit-info" style="margin-top:5px; color:#00695c; font-weight:bold;"></div>
                </div>
                
                <label>Nhập Km sự cố:</label><input type="number" id="faultKm" step="0.01">
                <div><label><input type="radio" name="faultDir" value="start" checked> Từ Đầu</label> <label><input type="radio" name="faultDir" value="end"> Từ Cuối</label></div>
                <button class="action-btn btn-find" onclick="window.findFault()">TÌM VỊ TRÍ</button>
                <div id="result" style="color:red;font-weight:bold;margin-top:5px;"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, get, child, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.set = set; window.update = update; window.ref = ref; window.onValue = onValue; window.get = get; window.child = child; window.remove = remove;
        window.listenCloud();
    </script>

    <script>
        // --- MAP SETUP ---
        let map = L.map('map', { zoomControl: false }).setView([10.762, 106.660], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.4 }).addTo(map);

        map.createPane('areaPane'); map.getPane('areaPane').style.zIndex = 200;
        let layers = { 
            areas: L.layerGroup().addTo(map), 
            main: L.layerGroup().addTo(map), 
            minor: L.layerGroup().addTo(map), // Trụ đỡ
            mc: L.layerGroup().addTo(map),    // Máy cắt
            fault: L.layerGroup().addTo(map) 
        };
        
        let appData = { poles: {}, segments: {}, circuits: {}, mcStates: {}, areas: [] };
        let currentEditingCircuit = []; 
        let currentPath = []; let currentPathTotalDist = 0;

        function openSidebar() { document.getElementById('sidebar').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
        
        // --- ZOOM LOGIC ---
        map.on('zoomend', function() {
            let z = map.getZoom();
            if (z < 15) {
                if (map.hasLayer(layers.minor)) map.removeLayer(layers.minor);
                if (map.hasLayer(layers.mc)) map.removeLayer(layers.mc);
            } else {
                if (!map.hasLayer(layers.minor)) map.addLayer(layers.minor);
                if (!map.hasLayer(layers.mc)) map.addLayer(layers.mc);
            }
        });

        // --- DATA SYNC ---
        window.listenCloud = function() { 
            window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), snap => { 
                let val = snap.val(); 
                if(val) { 
                    appData = val; 
                    if(!appData.mcStates) appData.mcStates={}; 
                    renderMap(); 
                    updateUI(); 
                } 
            }); 
        }

        // --- RENDER MAP ---
        function createIcon(type, name, isClosed, sourceVoltage) {
            let cls = 'my-icon icon-tru-do', sz = [12,12], label = '';
            if (type.includes('MC')) { 
                cls = isClosed ? 'my-icon icon-mc-base icon-mc-on' : 'my-icon icon-mc-base icon-mc-off'; 
                sz = [22, 16]; 
                if (sourceVoltage) { cls += ' icon-mc-source'; sz = [26, 20]; }
            } else if (type.includes('NEO')) cls = 'my-icon icon-tru-neo';
            return L.divIcon({ className: cls, html: label, iconSize: sz });
        }

        function renderMap() {
            layers.main.clearLayers(); layers.minor.clearLayers(); layers.mc.clearLayers(); layers.areas.clearLayers();
            
            // Areas
            if(appData.areas) appData.areas.forEach(a => { 
                L.polygon(a.points, {color:'#9e9e9e', fillColor:'#9e9e9e', fillOpacity:0.3, weight:1}).addTo(layers.areas); 
            });

            // Poles
            if(appData.poles) for(let l in appData.poles) appData.poles[l].forEach(p => {
                let isMC = p.type.includes('MC');
                let target = isMC ? layers.mc : layers.minor;
                let isClosed = isMC ? (appData.mcStates[p.name] !== false) : true;
                
                let marker = L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.name, isClosed, p.sourceVoltage) }).addTo(target);
                
                marker.on('click', () => {
                    if (isMC) {
                        if(confirm(`Đảo trạng thái máy cắt ${p.name}?`)) {
                            window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), { [p.name]: !isClosed });
                        }
                    }
                });
                if(!isMC) marker.bindPopup(p.name);
            });

            // Circuits
            if(appData.circuits) Object.keys(appData.circuits).forEach(cid => drawCircuit(cid));
        }

        function drawCircuit(cid, isCalc = false) {
            const segs = appData.circuits[cid]; if(!segs) return;
            
            // Default color
            let color = 'black'; 
            
            // Calculate Path Reset
            if(isCalc) { currentPath = []; currentPathTotalDist = 0; }

            segs.forEach(item => {
                let def = appData.segments[item.segId];
                if(def) {
                    let p1 = getPole(def.lineFrom, def.poleFrom);
                    let p2 = getPole(def.lineTo, def.poleTo);
                    if(p1 && p2) {
                        let pts = [[p1.lat, p1.lng], [p2.lat, p2.lng]];
                        // Add line to map if NOT just calculating
                        if (!isCalc) {
                            L.polyline(pts, {color: color, weight: 2}).addTo(layers.main).bindPopup(cid);
                        }
                        
                        // Calculation Logic (Fixed for v1.92)
                        if(isCalc) {
                            let d = getDist(p1.lat, p1.lng, p2.lat, p2.lng);
                            currentPathTotalDist += d;
                            currentPath.push({lat: p1.lat, lng: p1.lng, accDist: currentPathTotalDist, name: p1.name});
                            currentPath.push({lat: p2.lat, lng: p2.lng, accDist: currentPathTotalDist + d, name: p2.name});
                        }
                    }
                }
            });
        }

        // --- HELPERS ---
        function getPole(line, name) {
            if (appData.poles[line]) return appData.poles[line].find(p => p.name == name);
            // Global search fallback
            for(let l in appData.poles) {
                let p = appData.poles[l].find(p => p.name == name);
                if(p) return p;
            }
            return null;
        }

        function getDist(lat1,lon1,lat2,lon2) { 
            const R=6371000; 
            const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; 
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); 
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); 
        }

        // --- EXPORT FUNCTION ---
        window.exportToExcel = function() { 
            if(!appData.poles) return alert("Không có dữ liệu!"); 
            let d1=[], d2=[], d3=[], d4=[]; 
            for(let l in appData.poles) appData.poles[l].forEach(p=>d1.push({"MA_TUYEN":l,"TEN_TRU":p.name,"LAT":p.lat,"LONG":p.lng,"LOAI_DIEM":p.type,"NGUON":p.sourceVoltage})); 
            if(appData.segments) Object.values(appData.segments).forEach(s=>d2.push({"MA_DOAN":s.id,"TUYEN_TU":s.lineFrom,"TRU_TU":s.poleFrom,"TUYEN_DEN":s.lineTo,"TRU_DEN":s.poleTo,"LOAI_DIEM":s.type})); 
            if(appData.circuits) for(let c in appData.circuits) appData.circuits[c].forEach(i=>d3.push({"MA_DUONG_DAY":c,"STT":i.order,"MA_DOAN":i.segId})); 
            if(appData.areas) appData.areas.forEach(a => d4.push({NAME: a.name, TYPE: a.type, POINTS: JSON.stringify(a.points)}));

            let wb=XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d1),"TOA_DO"); 
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d2),"DM_DOAN"); 
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d3),"CAU_HINH"); 
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d4),"VUNG"); 
            XLSX.writeFile(wb,"DuLieuLuoiDien_v1.79.xlsx"); 
        }

        // --- UI LOGIC ---
        function updateUI() {
            let s = document.getElementById('circuitSelect');
            s.innerHTML = '<option value="">-- Chọn --</option>';
            if(appData.circuits) Object.keys(appData.circuits).forEach(c => {
                let o = document.createElement('option'); o.value = c; o.text = c; s.add(o);
            });
            refreshDropdowns();
        }

        window.refreshDropdowns = function() { 
            let routes=Object.keys(appData.poles||{}), circs=Object.keys(appData.circuits||{}), segs=Object.keys(appData.segments||{}); 
            document.getElementById('sel-seg-line1').innerHTML='<option value="">Chọn Tuyến...</option>'+routes.map(r=>`<option value="${r}">${r}</option>`).join(''); 
            document.getElementById('sel-seg-line2').innerHTML=document.getElementById('sel-seg-line1').innerHTML; 
            document.getElementById('list-circuits').innerHTML=circs.map(c=>`<option value="${c}">`).join(''); 
            document.getElementById('sel-cir-seg').innerHTML='<option value="">-- Chọn đoạn --</option>'+segs.map(s=>`<option value="${s}">${s}</option>`).join(''); 
        }

        window.updatePoleSelect = function(lid, pid) { 
            let line=document.getElementById(lid).value, poles=appData.poles[line]||[]; 
            document.getElementById(pid).innerHTML='<option value="">Chọn Trụ...</option>'+poles.map(p=>`<option value="${p.name}">${p.name}</option>`).join(''); 
        }

        // --- FAULT FINDING (FIXED v1.92) ---
        window.zoomToCircuit = function() {
            let cid = document.getElementById('circuitSelect').value;
            layers.main.clearLayers(); 
            renderMap(); // Redraw base
            
            // FIX: Display length immediately
            if(cid) {
                drawCircuit(cid, true); // Calculate
                let km = (currentPathTotalDist / 1000).toFixed(3);
                document.getElementById('circuit-info').innerText = `Tổng dài: ${km} km`;
                document.getElementById('status-text').innerText = "Đã chọn";
            } else {
                document.getElementById('circuit-info').innerText = "";
                document.getElementById('status-text').innerText = "---";
            }
        }

        window.findFault = function() {
            let km = parseFloat(document.getElementById('faultKm').value);
            let dir = document.querySelector('input[name="faultDir"]:checked').value;
            
            if(!currentPath.length || isNaN(km)) return alert("Chọn mạch và nhập Km!");

            let targetDist = (dir === 'start') ? km * 1000 : currentPathTotalDist - (km * 1000);
            
            let found = false;
            for(let i=0; i<currentPath.length; i++) {
                if (currentPath[i].accDist >= targetDist) {
                    let p = currentPath[i];
                    L.marker([p.lat, p.lng], { icon: L.divIcon({html:'<i class="fas fa-bolt fault-marker"></i>', className: 'd'}) }).addTo(layers.fault).bindPopup("SỰ CỐ").openPopup();
                    map.setView([p.lat, p.lng], 16);
                    document.getElementById('result').innerText = `Tìm thấy gần: ${p.name}`;
                    found = true;
                    break;
                }
            }
            if(!found) document.getElementById('result').innerText = "Không tìm thấy trong phạm vi.";
        }
        
        // --- ACCORDION LOGIC ---
        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) { 
            acc[i].addEventListener("click", function() { 
                this.classList.toggle("active"); 
                var panel = this.nextElementSibling; 
                if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = panel.scrollHeight + "px"; 
            }); 
        }

        // --- SWITCH TAB ---
        window.switchTab = function(tabId) {
            document.querySelectorAll('.edit-section').forEach(e => e.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

    </script>
</body>
</html>
