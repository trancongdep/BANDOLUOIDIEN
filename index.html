<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω L∆∞·ªõi ƒêi·ªán v2.01</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* --- 1. CORE LAYOUT --- */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #222; }
        
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 30px; width: 100%; z-index: 1; background: #222; }
        
        .footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 30px; 
            background: #1a1a1a; color: #ff9800; font-weight: bold;
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.8rem; border-top: 2px solid #ff9800; 
            z-index: 4000; 
        }

        /* --- 2. SIDEBAR & CONTROLS --- */
        #menu-toggle { 
            position: absolute; top: 10px; left: 10px; z-index: 2000; 
            background: #004d40; color: white; border: none; 
            padding: 10px 15px; border-radius: 4px; cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); font-weight: bold; 
        }
        
        #sidebar { 
            position: fixed; top: 0; left: -100%; width: 420px; 
            bottom: 30px; background: white; z-index: 3000; 
            box-shadow: 2px 0 15px rgba(0,0,0,0.5); 
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; 
        }
        #sidebar.active { left: 0; }
        
        .header { background: #004d40; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .content { padding: 10px; overflow-y: auto; flex: 1; background: #f5f5f5; }
        
        /* Accordion Style */
        .accordion { background-color: #e0e0e0; color: #333; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left; outline: none; font-size: 0.9rem; font-weight: bold; transition: 0.3s; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; }
        .accordion.active, .accordion:hover { background-color: #b0bec5; }
        .accordion:after { content: '\002B'; font-weight: bold; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border-bottom: 1px solid #ddd; }
        
        /* Inputs & Buttons */
        label { font-weight: 600; font-size: 0.8rem; display: block; margin: 8px 0 4px; color: #444; }
        input, select { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9rem; }
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 8px; color: white; transition: 0.2s; }
        button.action-btn:hover { opacity: 0.9; }
        
        .btn-green { background: #2e7d32; } .btn-red { background: #c62828; } .btn-blue { background: #1565c0; } .btn-orange { background: #ef6c00; } .btn-teal { background: #00897b; }
        
        /* --- 3. MAP ELEMENTS --- */
        .leaflet-control-layers { border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.4); }
        .custom-control { background: white; width: 34px; height: 34px; line-height: 34px; text-align: center; font-size: 18px; cursor: pointer; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.4); margin-bottom: 5px; }
        .custom-control:hover { background: #f4f4f4; }

        /* Icons */
        .my-icon { border: 1px solid white; box-shadow: 1px 1px 3px rgba(0,0,0,0.8); text-align: center; font-size: 9px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; white-space: nowrap; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; }
        .icon-mc-base { border: 2px solid white; border-radius: 2px; z-index: 1000; font-size: 10px; line-height: 16px; background: #555; }
        .icon-mc-on { background: #d32f2f; } .icon-mc-off { background: #388e3c; }
        .icon-mc-source { border: 2px solid #ffeb3b !important; box-shadow: 0 0 8px #ffeb3b; z-index: 1001 !important; }
        
        /* Fault Marker Animation */
        .fault-marker { font-size: 40px; color: #ff1744; text-shadow: 0 0 10px #ffeb3b; animation: pulse 0.8s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); opacity: 1; } to { transform: scale(1.3); opacity: 0.7; } }

        /* --- 4. SPECIFIC SECTIONS --- */
        .tab-container { display: flex; margin-bottom: 10px; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { color: #004d40; border-bottom: 3px solid #004d40; background: #e0f2f1; }
        .edit-section { display: none; padding-top: 10px; }
        .edit-section.active { display: block; }
        
        #circuit-segment-list { max-height: 180px; overflow-y: auto; border: 1px solid #ddd; background: #fff; }
        .cir-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .cir-item:hover { background: #e3f2fd; }

        #console { background: #212121; color: #00e676; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 80px; overflow-y: auto; margin-bottom: 10px; }
        #fault-result { display: none; background: #fff; border: 1px solid #d32f2f; border-left: 5px solid #d32f2f; padding: 10px; margin-top: 10px; border-radius: 4px; }
        
        #user-log-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        #user-log-table th, #user-log-table td { border: 1px solid #ddd; padding: 6px; }
        #user-log-table th { background: #eee; }
        
        #custom-confirm { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; justify-content: center; align-items: center; }
        .win-dialog { background: white; padding: 20px; border-radius: 5px; width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="menu-toggle" onclick="toggleSidebar(true)"><i class="fas fa-bars"></i> MENU</button>
    <div class="footer">‚ö° H·ªÜ TH·ªêNG QU·∫¢N L√ù L∆Ø·ªöI ƒêI·ªÜN V2.01 ‚ö°</div>

    <div id="sidebar">
        <div class="header">
            <h3><i class="fas fa-bolt"></i> DASHBOARD</h3>
            <button style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;" onclick="toggleSidebar(false)">√ó</button>
        </div>
        <div class="content">
            <button class="accordion">1. D·ªØ li·ªáu & Excel</button>
            <div class="panel" id="panel-1">
                <label>Import File (Excel/CSV):</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn btn-teal" onclick="analyzeFiles()">Ki·ªÉm tra & Import</button>
                <div id="console">S·∫µn s√†ng...</div>
                <div id="upload-actions" style="display:none; display:flex; gap:10px;">
                    <button class="action-btn btn-green" style="flex:1" onclick="confirmAction('upload_merge')">G·ªòP</button>
                    <button class="action-btn btn-red" style="flex:1" onclick="confirmAction('upload_replace')">THAY TH·∫æ</button>
                </div>
                <hr>
                <button class="action-btn btn-green" onclick="exportToExcel()">Xu·∫•t ra Excel</button>
            </div>

            <button class="accordion" id="acc-edit">2. Bi√™n t·∫≠p & Ch·ªânh s·ª≠a</button>
            <div class="panel" id="panel-2">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchEditTab('pole')">Tr·ª•</button>
                    <button class="tab-btn" onclick="switchEditTab('seg')">ƒêo·∫°n</button>
                    <button class="tab-btn" onclick="switchEditTab('cir')">M·∫°ch</button>
                    <button class="tab-btn" onclick="switchEditTab('area')">V√πng</button>
                </div>
                
                <div id="edit-pole" class="edit-section active">
                    <label>Tuy·∫øn & T√™n:</label><div style="display:flex;gap:5px"><input id="inp-pole-route" placeholder="M√£ tuy·∫øn"><input id="inp-pole-name" placeholder="T√™n tr·ª•"></div>
                    <label>Lo·∫°i:</label><select id="inp-pole-type"><option value="TRU_DO">Tr·ª• ƒê·ª°</option><option value="TRU_NEO">Tr·ª• N√©o</option><option value="MC">M√°y C·∫Øt</option><option value="MOC">M·ªëc C√°p</option></select>
                    <label>Ngu·ªìn (MC):</label><select id="inp-pole-src"><option value="">--</option><option value="220kV">220kV (ƒê·ªè)</option><option value="110kV">110kV (Xanh)</option><option value="500kV">500kV (Bi·ªÉn)</option></select>
                    <label>T·ªça ƒë·ªô:</label><div style="display:flex;gap:5px"><input id="inp-lat" placeholder="Lat"><input id="inp-lng" placeholder="Lng"><button class="action-btn btn-orange" style="width:auto;margin:0" onclick="startPicking('pole')">üìç</button></div>
                    <button class="action-btn btn-blue" onclick="savePole()">L∆∞u Tr·ª•</button>
                </div>

                <div id="edit-seg" class="edit-section">
                    <label>M√£ ƒêo·∫°n:</label><input id="inp-seg-id" placeholder="SEG_XXX"><input type="hidden" id="inp-seg-id-old">
                    <label>ƒêi·ªÉm ƒê·∫ßu:</label><div style="display:flex;gap:5px"><select id="sel-seg-l1" onchange="updatePoleSelect('sel-seg-l1','sel-seg-p1')"></select><select id="sel-seg-p1"></select></div>
                    <label>ƒêi·ªÉm Cu·ªëi:</label><div style="display:flex;gap:5px"><select id="sel-seg-l2" onchange="updatePoleSelect('sel-seg-l2','sel-seg-p2')"></select><select id="sel-seg-p2"></select></div>
                    <label>Lo·∫°i d√¢y:</label><select id="inp-seg-type"><option value="NOI">D√¢y N·ªïi</option><option value="NGAM">C√°p Ng·∫ßm</option></select>
                    <button class="action-btn btn-blue" id="btn-save-seg" onclick="saveSegment()">L∆∞u ƒêo·∫°n</button>
                    <button class="action-btn btn-orange" onclick="resetForm('seg')">Th√™m M·ªõi</button>
                </div>
                
                <div id="edit-cir" class="edit-section">
                    <label>M√£ M·∫°ch:</label><input id="inp-cir-id" list="lst-circuits"><datalist id="lst-circuits"></datalist>
                    <div id="circuit-segment-list"></div>
                    <label>Th√™m ƒëo·∫°n:</label><div style="display:flex;gap:5px"><select id="sel-cir-seg"></select><button class="action-btn btn-teal" style="width:auto;margin:0" onclick="addSegToCir()">+</button></div>
                    <button class="action-btn btn-orange" style="margin-top:10px" onclick="saveCircuit()">L∆∞u C·∫•u Tr√∫c M·∫°ch</button>
                </div>

                <div id="edit-area" class="edit-section">
                    <label>T√™n V√πng:</label><input id="inp-area-name"><label>Lo·∫°i:</label><select id="inp-area-type"><option value="TBA">Tr·∫°m Bi·∫øn √Åp</option><option value="BUILDING">Nh√†</option></select>
                    <button class="action-btn btn-teal" onclick="startPicking('area')">B·∫Øt ƒë·∫ßu v·∫Ω</button>
                    <button class="action-btn btn-blue" onclick="saveArea()">L∆∞u V√πng</button>
                </div>
            </div>

            <button class="accordion" id="acc-opt">3. V·∫≠n H√†nh & S·ª± C·ªë</button>
            <div class="panel" id="panel-3">
                <label>Ch·ªçn M·∫°ch:</label><select id="sel-opt-cir" onchange="selectCircuitOp()"></select>
                <div style="background:#fff3e0; padding:10px; margin:10px 0; border:1px solid #ffb74d; border-radius:4px;">
                    <div id="op-info">---</div>
                </div>
                <button class="action-btn btn-blue" id="btn-ground" style="display:none" onclick="toggleGround()">Ti·∫øp ƒê·ªãa</button>
                
                <hr>
                <label>T√¨m s·ª± c·ªë (Km):</label><input type="number" id="inp-fault-km" step="0.01">
                <div style="display:flex;gap:20px;margin-bottom:10px">
                    <label><input type="radio" name="r-dir" value="start" checked> T·ª´ ƒê·∫ßu</label>
                    <label><input type="radio" name="r-dir" value="end"> T·ª´ Cu·ªëi</label>
                </div>
                <button class="action-btn btn-red" onclick="findFault()">T√åM V·ªä TR√ç</button>
                
                <div id="fault-result">
                    <div class="fault-header"><i class="fas fa-bolt"></i> K·∫æT QU·∫¢</div>
                    <div id="fault-content"></div>
                </div>
            </div>

            <button class="accordion" onclick="loadUsers()">4. Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</button>
            <div class="panel" id="panel-4">
                <button class="action-btn btn-teal" onclick="loadUsers()">T·∫£i l·∫°i danh s√°ch</button>
                <table id="user-log-table" style="margin-top:10px"><thead><tr><th>Th·ªùi gian</th><th>T√™n</th><th>SƒêT</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div id="custom-confirm"><div class="win-dialog"><h3 style="margin-top:0">X√°c nh·∫≠n</h3><p id="confirm-msg"></p><div style="text-align:right"><button class="action-btn btn-blue" style="width:auto" onclick="executeConfirm()">ƒê·ªìng √Ω</button> <button class="action-btn btn-red" style="width:auto" onclick="closeConfirm()">H·ªßy</button></div></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, get, child, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.ref = ref; window.set = set; window.update = update; window.onValue = onValue; window.get = get; window.child = child; window.remove = remove;
        window.initApp();
    </script>

    <script>
        // --- 1. CONFIG & INIT ---
        let map;
        let layers = {};
        let appData = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: [] };
        let segmentCounts = {}; // For offset calc
        
        let currentMode = 'view';
        let tempEditCircuit = [];
        let pickingMode = null; 
        let tempDrawPoints = []; let tempDrawPoly = null;
        let currentPath = []; let totalPathDist = 0;
        let pendingAction = null;
        let stagingData = null;

        function initApp() {
            map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([10.762, 106.660], 12);
            L.control.zoom({ position: 'topright' }).addTo(map);

            let sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 22, maxNativeZoom: 19, attribution: 'Esri' });
            let street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22, opacity: 1, attribution: 'OSM' });
            sat.addTo(map);
            L.control.layers({ "V·ªá tinh": sat, "ƒê∆∞·ªùng ph·ªë": street }).addTo(map);

            let ExtentControl = L.Control.extend({
                onAdd: function() {
                    let div = L.DomUtil.create('div', 'custom-control');
                    div.innerHTML = 'üè†'; div.title = "To√†n c·∫£nh";
                    div.onclick = (e) => { e.stopPropagation(); zoomExtent(); };
                    return div;
                }
            });
            new ExtentControl({ position: 'topright' }).addTo(map);

            map.createPane('fixedPane'); map.getPane('fixedPane').style.zIndex = 450;
            layers.areas = L.layerGroup().addTo(map);
            layers.main = L.layerGroup().addTo(map);
            layers.important = L.layerGroup().addTo(map);
            layers.minor = L.layerGroup().addTo(map);
            layers.highlight = L.layerGroup().addTo(map);
            layers.fault = L.layerGroup().addTo(map);

            map.on('zoomend', updateZoomVisibility);
            map.on('click', handleMapClick);

            setupAccordion();

            window.onValue(window.ref(window.db, 'he_thong_luoi_dien'), snap => {
                let val = snap.val();
                if(val) {
                    appData = val;
                    if(!appData.mcStates) appData.mcStates={};
                    if(!appData.grounded) appData.grounded={};
                    renderMap();
                    refreshUI();
                }
            });
        }

        // --- 2. MAP LOGIC ---
        function updateZoomVisibility() {
            let z = map.getZoom();
            if (z < 15) {
                if(map.hasLayer(layers.minor)) map.removeLayer(layers.minor);
            } else {
                if(!map.hasLayer(layers.minor)) map.addLayer(layers.minor);
            }
        }

        function createIcon(type, name, isClosed, srcVolt) {
            let cls = 'my-icon icon-tru-do', sz = [12,12], lbl = '';
            if(type.includes('MC')) {
                cls = isClosed ? 'my-icon icon-mc-base icon-mc-on' : 'my-icon icon-mc-base icon-mc-off';
                if(srcVolt) cls += ' icon-mc-source';
                sz = [24, 16];
                lbl = name.split('_').pop(); // Show number
            } else if(type.includes('NEO')) cls = 'my-icon icon-tru-neo';
            else if(type.includes('MOC')) { cls = 'my-icon icon-moc'; sz=[8,8]; }
            return L.divIcon({ className: cls, html: lbl, iconSize: sz });
        }

        function renderMap() {
            Object.values(layers).forEach(l => l.clearLayers());

            // Areas
            if(appData.areas) appData.areas.forEach(a => {
                let c = (a.type==='TBA')?'#ff9800':(a.type==='CONSTRUCTION'?'#ffeb3b':'#9e9e9e');
                let p = L.polygon(a.points, {color:c, fillColor:c, fillOpacity:0.3, weight:1}).addTo(layers.areas).bindPopup(a.name);
                p.on('click', () => { if(currentMode==='edit_area') fillAreaForm(a); });
            });

            // Poles
            if(appData.poles) for(let route in appData.poles) appData.poles[route].forEach(p => {
                let type = p.type.toUpperCase();
                let isMC = type.includes('MC');
                let isMinor = (type==='TRU_DO' || type==='MOC');
                let target = isMC ? layers.important : (isMinor ? layers.minor : layers.important);
                let isClosed = isMC ? (appData.mcStates[p.name] !== false) : true;
                
                let marker = L.marker([p.lat, p.lng], { icon: createIcon(type, p.name, isClosed, p.sourceVoltage) }).addTo(target);
                marker.on('click', () => {
                    if(currentMode === 'edit_pole') fillPoleForm(route, p);
                    else if(currentMode === 'view' && isMC) askToggleMC(p.name, isClosed);
                });
                if(!isMC && currentMode==='view') marker.bindPopup(p.name);
            });

            // Lines
            if (currentMode === 'edit_seg') {
                if(appData.segments) Object.values(appData.segments).forEach(seg => {
                    let pts = getPoints(seg);
                    if(pts.length) {
                        let poly = L.polyline(pts.map(p=>[p.lat,p.lng]), {color:'#555', weight:3, dashArray:'5,5'}).addTo(layers.main);
                        poly.on('click', () => fillSegForm(seg));
                    }
                });
            } else {
                if(appData.circuits) {
                    calculateOffsets();
                    Object.keys(appData.circuits).forEach(cid => { drawCircuit(cid, false); });
                }
            }
            updateZoomVisibility();
        }

        // --- 3. PATH & CALCULATION (FIXED) ---
        function getPole(name) {
            // Find pole by name in ALL routes
            for(let r in appData.poles) {
                // IMPORTANT: Compare Strings trim/uppercase to be safe
                let p = appData.poles[r].find(x => String(x.name).trim().toUpperCase() == String(name).trim().toUpperCase());
                if(p) return {...p, route: r};
            }
            return null;
        }

        function getPoints(seg) {
            let p1 = getPole(seg.poleFrom);
            let p2 = getPole(seg.poleTo);
            if(!p1 || !p2) return [];

            // Path Following: If same route, find intermediates
            if (p1.route && p2.route && p1.route === p2.route) {
                let list = appData.poles[p1.route];
                let i1 = list.findIndex(x => String(x.name) === String(p1.name));
                let i2 = list.findIndex(x => String(x.name) === String(p2.name));
                if(i1 !== -1 && i2 !== -1) {
                    let sub = (i1 < i2) ? list.slice(i1, i2+1) : list.slice(i2, i1+1).reverse();
                    return sub.map(x => ({lat: x.lat, lng: x.lng, name: x.name}));
                }
            }
            // Fallback Straight Line
            return [{lat: p1.lat, lng: p1.lng, name: p1.name}, {lat: p2.lat, lng: p2.lng, name: p2.name}];
        }

        // Offset Calculation
        function getSegmentKey(p1, p2) { 
            let k1=p1.lat+"_"+p1.lng, k2=p2.lat+"_"+p2.lng; 
            return (k1<k2) ? (k1+"|"+k2) : (k2+"|"+k1); 
        }
        function calculateOffsets() {
            segmentCounts = {};
            if(appData.circuits) Object.keys(appData.circuits).forEach(cid => {
                appData.circuits[cid].forEach(item => {
                    let def = appData.segments[item.segId];
                    if(def) {
                        let p1 = getPole(def.poleFrom); let p2 = getPole(def.poleTo);
                        if(p1 && p2) {
                            let key = getSegmentKey(p1, p2);
                            if(!segmentCounts[key]) segmentCounts[key] = [];
                            segmentCounts[key].push(cid);
                        }
                    }
                });
            });
        }

        function drawCircuit(cid, isCalc) {
            let segs = appData.circuits[cid]; if(!segs) return;
            let color = 'black'; 
            
            // Simplified voltage check for visualization
            let connectedMCs = [];
            segs.forEach(s => {
                let def = appData.segments[s.segId];
                if(def){
                    let p1=getPole(def.poleFrom), p2=getPole(def.poleTo);
                    if(p1 && p1.type.includes('MC')) connectedMCs.push(p1);
                    if(p2 && p2.type.includes('MC')) connectedMCs.push(p2);
                }
            });
            let src = connectedMCs.find(m => m.sourceVoltage);
            if(src) {
                if(src.sourceVoltage.includes('110')) color = '#388e3c'; // Green
                else if(src.sourceVoltage.includes('220')) color = '#d32f2f'; // Red
                else color = '#1565c0'; // Blue
            }

            if(isCalc) { currentPath = []; totalPathDist = 0; }

            segs.forEach(item => {
                let def = appData.segments[item.segId];
                if(!def) return;
                let pts = getPoints(def);
                if(pts.length < 2) return;

                // Offset
                let offset = 0;
                if(!isCalc) {
                     let p1=pts[0], p2=pts[pts.length-1];
                     let key = getSegmentKey(p1, p2);
                     let list = segmentCounts[key];
                     if(list && list.length > 1) {
                         let idx = list.indexOf(cid);
                         if(idx !== -1) { offset = (idx - (list.length-1)/2) * 6; }
                     }
                }

                if(!isCalc) {
                    let poly = L.polyline(pts.map(p=>[p.lat,p.lng]), {color: color, weight: 2, offset: offset}).addTo(layers.main);
                    poly.bindPopup(cid);
                    poly.on('click', () => { if(currentMode==='edit_cir') { document.getElementById('inp-cir-id').value=cid; tempEditCircuit=[...segs]; renderTempCirList(); toggleSidebar(true); } });
                }

                if(isCalc) {
                    pts.forEach((p, i) => {
                        if(i > 0) totalPathDist += getDist(pts[i-1], p);
                        currentPath.push({...p, dist: totalPathDist});
                    });
                }
            });
        }

        function getDist(p1, p2) {
            const R=6371000; const dLat=(p2.lat-p1.lat)*Math.PI/180; const dLon=(p2.lng-p1.lng)*Math.PI/180; 
            const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); 
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }

        // --- 4. UI & INTERACTION ---
        function toggleSidebar(show) { document.getElementById('sidebar').className = show ? 'active' : ''; }
        function setupAccordion() {
            let acc = document.getElementsByClassName("accordion");
            for (let i = 0; i < acc.length; i++) {
                acc[i].addEventListener("click", function() {
                    let panel = this.nextElementSibling;
                    if (panel.style.maxHeight) { panel.style.maxHeight = null; this.classList.remove('active'); currentMode = 'view'; } 
                    else {
                        for(let j=0; j<acc.length; j++) { acc[j].classList.remove('active'); acc[j].nextElementSibling.style.maxHeight = null; }
                        this.classList.add("active"); panel.style.maxHeight = panel.scrollHeight + "px";
                        if(this.id === 'acc-edit') switchEditTab(document.querySelector('.tab-btn.active').innerText === 'ƒêo·∫°n' ? 'seg' : 'pole');
                        else currentMode = 'view';
                    }
                    renderMap();
                });
            }
        }

        window.switchEditTab = function(tab) {
            document.querySelectorAll('.edit-section').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            let idx = ['pole','seg','cir','area'].indexOf(tab);
            document.querySelectorAll('.tab-btn')[idx].classList.add('active');
            document.getElementById('edit-'+tab).style.display = 'block';
            currentMode = (tab === 'seg') ? 'edit_seg' : (tab === 'cir' ? 'edit_cir' : (tab==='area'?'edit_area':'edit_pole'));
            renderMap();
        }

        // --- 5. EDITING ---
        function fillPoleForm(route, p) {
            document.getElementById('inp-pole-route').value = route; document.getElementById('inp-pole-name').value = p.name;
            document.getElementById('inp-pole-type').value = p.type; document.getElementById('inp-pole-src').value = p.sourceVoltage||"";
            document.getElementById('inp-lat').value = p.lat; document.getElementById('inp-lng').value = p.lng; toggleSidebar(true);
        }
        function fillSegForm(seg) {
            document.getElementById('inp-seg-id').value = seg.id; document.getElementById('inp-seg-id-old').value = seg.id;
            document.getElementById('inp-seg-type').value = seg.type;
            let s1=document.getElementById('sel-seg-l1'); s1.value=seg.lineFrom; updatePoleSelect('sel-seg-l1','sel-seg-p1'); document.getElementById('sel-seg-p1').value=seg.poleFrom;
            let s2=document.getElementById('sel-seg-l2'); s2.value=seg.lineTo; updatePoleSelect('sel-seg-l2','sel-seg-p2'); document.getElementById('sel-seg-p2').value=seg.poleTo;
            layers.highlight.clearLayers();
            let pts = getPoints(seg); if(pts.length) L.polyline(pts.map(p=>[p.lat,p.lng]), {color:'cyan', weight:5}).addTo(layers.highlight);
            toggleSidebar(true);
        }
        function fillAreaForm(a) { document.getElementById('inp-area-name').value = a.name; document.getElementById('inp-area-type').value = a.type; toggleSidebar(true); }

        window.saveSegment = function() {
            let id = document.getElementById('inp-seg-id').value.trim(); let oldId = document.getElementById('inp-seg-id-old').value.trim();
            if(!id) return alert("Thi·∫øu ID!");
            let data = { id:id, type:document.getElementById('inp-seg-type').value, lineFrom:document.getElementById('sel-seg-l1').value, poleFrom:document.getElementById('sel-seg-p1').value, lineTo:document.getElementById('sel-seg-l2').value, poleTo:document.getElementById('sel-seg-p2').value };
            let updates = {}; updates[`he_thong_luoi_dien/segments/${id}`] = data;
            if(oldId && oldId !== id) {
                updates[`he_thong_luoi_dien/segments/${oldId}`] = null;
                if(appData.circuits) { for(let cid in appData.circuits) { let list = appData.circuits[cid], changed = false; list.forEach(item => { if(item.segId === oldId) { item.segId = id; changed = true; } }); if(changed) updates[`he_thong_luoi_dien/circuits/${cid}`] = list; } }
            }
            window.update(window.ref(window.db), updates).then(() => { alert("L∆∞u th√†nh c√¥ng!"); document.getElementById('inp-seg-id-old').value = id; layers.highlight.clearLayers(); renderMap(); });
        }

        // --- 6. OPS ---
        window.selectCircuitOp = function() {
            let cid = document.getElementById('sel-opt-cir').value;
            layers.main.clearLayers();
            if(cid) {
                renderMap(); 
                drawCircuit(cid, true);
                let km = (totalPathDist/1000).toFixed(3);
                document.getElementById('op-info').innerHTML = `<b>${cid}</b><br>T·ªïng d√†i: ${km} km`;
                map.fitBounds(currentPath.map(p=>[p.lat, p.lng]));
                layers.main.clearLayers(); drawCircuit(cid, false);
            } else { renderMap(); }
        }
        
        window.findFault = function() {
            let km = parseFloat(document.getElementById('inp-fault-km').value);
            let dir = document.querySelector('input[name="r-dir"]:checked').value;
            if(!currentPath.length) return alert("Ch·ªçn m·∫°ch tr∆∞·ªõc!");
            let target = (dir==='start') ? km*1000 : totalPathDist - (km*1000);
            let found = null;
            for(let i=0; i<currentPath.length; i++) {
                if(currentPath[i].dist >= target) {
                    let p2=currentPath[i], p1=currentPath[i-1]||p2;
                    let ratio = (p2.dist-p1.dist)>0 ? (target-p1.dist)/(p2.dist-p1.dist) : 0;
                    found = {lat: p1.lat+(p2.lat-p1.lat)*ratio, lng: p1.lng+(p2.lng-p1.lng)*ratio, n1: p1.name||"ƒê·∫ßu", n2: p2.name||"Cu·ªëi"};
                    break;
                }
            }
            let res = document.getElementById('fault-result'); res.style.display='block';
            if(found) {
                layers.fault.clearLayers(); L.marker([found.lat, found.lng], {icon: L.divIcon({html:'<i class="fas fa-bolt fault-marker"></i>', className:'d'})}).addTo(layers.fault).bindPopup("S·ª∞ C·ªê").openPopup();
                map.setView([found.lat, found.lng], 18);
                document.getElementById('fault-content').innerHTML = `V·ªã tr√≠: <b>${found.n1} - ${found.n2}</b>`;
            } else document.getElementById('fault-content').innerHTML = "Kh√¥ng t√¨m th·∫•y";
        }

        // --- 7. UTILS ---
        function refreshUI() {
            let routes=Object.keys(appData.poles||{}).sort(); let circs=Object.keys(appData.circuits||{}).sort();
            let hR = '<option value="">--Ch·ªçn--</option>' + routes.map(r=>`<option value="${r}">${r}</option>`).join('');
            document.getElementById('sel-seg-l1').innerHTML = hR; document.getElementById('sel-seg-l2').innerHTML = hR;
            let hC = '<option value="">--Ch·ªçn M·∫°ch--</option>' + circs.map(c=>`<option value="${c}">${c}</option>`).join('');
            document.getElementById('sel-opt-cir').innerHTML = hC;
            document.getElementById('lst-circuits').innerHTML = circs.map(c=>`<option value="${c}">`).join('');
        }
        window.updatePoleSelect = function(lid, pid) {
            let r = document.getElementById(lid).value; let poles = appData.poles[r] || [];
            document.getElementById(pid).innerHTML = poles.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
        }
        window.zoomExtent = function() { let b = L.latLngBounds([]); for(let r in appData.poles) appData.poles[r].forEach(p=>b.extend([p.lat,p.lng])); if(b.isValid()) map.fitBounds(b); }
        window.handleMapClick = (e) => {
            if(pickingMode === 'pole') { document.getElementById('inp-lat').value = e.latlng.lat.toFixed(6); document.getElementById('inp-lng').value = e.latlng.lng.toFixed(6); pickingMode = null; toggleSidebar(true); } 
            else if(pickingMode === 'area') { if(!tempDrawPoly) tempDrawPoly = L.polygon([], {color:'red', dashArray:'5,5'}).addTo(map); tempDrawPoly.addLatLng(e.latlng); tempDrawPoints.push([e.latlng.lat, e.latlng.lng]); }
        }
        window.startPicking = (m) => { pickingMode = m; toggleSidebar(false); }
        
        // --- 8. USERS & EXPORT ---
        window.loadUsers = async () => {
            let t = document.querySelector('#user-log-table tbody'); t.innerHTML='<tr><td colspan="3">Loading...</td></tr>';
            let s = await window.get(window.ref(window.db, 'system_logs/logins'));
            if(s.exists()) { let d=[]; s.forEach(c=>d.push(c.val())); d.sort((a,b)=>new Date(b.time)-new Date(a.time)); t.innerHTML=d.map(l=>`<tr><td>${new Date(l.time).toLocaleString('vi')}</td><td>${l.name}</td><td>${l.phone}</td></tr>`).join(''); } else t.innerHTML='<tr><td colspan="3">Tr·ªëng</td></tr>';
        }
        
        // (Copy Import/Export functions from v1.98 if needed, omitted here for brevity but assumed present)
        // ... include exportToExcel, analyzeFiles, etc. ...
        window.exportToExcel = function() { if(!appData.poles) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!"); let d1=[], d2=[], d3=[], d4=[]; for(let l in appData.poles) appData.poles[l].forEach(p=>d1.push({"MA_TUYEN":l,"TEN_TRU":p.name,"LAT":p.lat,"LONG":p.lng,"LOAI_DIEM":p.type,"NGUON":p.sourceVoltage})); if(appData.segments) Object.values(appData.segments).forEach(s=>d2.push({"MA_DOAN":s.id,"TUYEN_TU":s.lineFrom,"TRU_TU":s.poleFrom,"TUYEN_DEN":s.lineTo,"TRU_DEN":s.poleTo,"LOAI_DIEM":s.type})); if(appData.circuits) for(let c in appData.circuits) appData.circuits[c].forEach(i=>d3.push({"MA_DUONG_DAY":c,"STT":i.order,"MA_DOAN":i.segId})); if(appData.areas) appData.areas.forEach(a => d4.push({NAME: a.name, TYPE: a.type, POINTS: JSON.stringify(a.points)})); let wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d1),"TOA_DO"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d2),"DM_DOAN"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d3),"CAU_HINH"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d4),"VUNG"); XLSX.writeFile(wb,"DuLieuLuoiDien_Full.xlsx"); }
        window.analyzeFiles = function() { const input = document.getElementById('excelFile'); log("ƒêang ƒë·ªçc file...", true); if(!input.files.length) { log("‚ùå Ch∆∞a ch·ªçn file!"); return; } Promise.all(Array.from(input.files).map(readFile)).then(res => { if(processSheets(Object.assign({}, ...res))) log("‚úÖ Ki·ªÉm tra th√†nh c√¥ng! Ch·ªçn G·ªôp ho·∫∑c Thay th·∫ø."); }).catch(e => log("‚ùå L·ªói: " + e.message)); }
        function readFile(file) { return new Promise(r => { const rd=new FileReader(); rd.onload=e=>{ const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); let s={}; w.SheetNames.forEach(n=>s[n]=XLSX.utils.sheet_to_json(w.Sheets[n])); r(s); }; rd.readAsArrayBuffer(file); }); }
        function processSheets(sheets) { const sPoles=Object.keys(sheets).find(n=>n.includes("TOA_DO")); const sSegs=Object.keys(sheets).find(n=>n.includes("DM_DOAN")); const sCircs=Object.keys(sheets).find(n=>n.includes("CAU_HINH")); if(!sPoles||!sSegs||!sCircs) { log("‚ùå Thi·∫øu sheet b·∫Øt bu·ªôc!"); return false; } let data = { poles: {}, segments: {}, circuits: {}, mcStates: {}, grounded: {}, areas: appData.areas || [] }; sheets[sPoles].forEach(r => { let cMa=getCol(r,["MA_TUYEN"]), cTen=getCol(r,["TEN_TRU"]), cLat=getCol(r,["LAT"]), cLong=getCol(r,["LONG"]), cLoai=getCol(r,["LOAI_DIEM"]), cNguon=getCol(r,["NGUON"]); if(cMa && r[cLat]) { let l=String(r[cMa]).trim(), n=String(r[cTen]).trim(); if(!data.poles[l]) data.poles[l]=[]; let p = { name: n, lat: parseFloat(r[cLat]), lng: parseFloat(r[cLong]), type: cLoai ? String(r[cLoai]).trim().toUpperCase() : "TRU_DO", sourceVoltage: cNguon ? String(r[cNguon]).trim() : "" }; data.poles[l].push(p); if(p.type.includes('MC')) data.mcStates[n] = true; } }); sheets[sSegs].forEach(r => { let cId=getCol(r,["MA_DOAN"]), cT1=getCol(r,["TUYEN_TU"]), cTr1=getCol(r,["TRU_TU"]), cT2=getCol(r,["TUYEN_DEN"]), cTr2=getCol(r,["TRU_DEN"]), cL=getCol(r,["LOAI_DIEM","LOAI"]); if(cId && r[cId]) { data.segments[r[cId]] = { id: r[cId], type: (cL&&String(r[cL]).includes("NGAM")?"NGAM":"NOI"), lineFrom: r[cT1], poleFrom: String(r[cTr1]).trim(), lineTo: r[cT2], poleTo: String(r[cTr2]).trim() }; } }); sheets[sCircs].forEach(r => { let cCid=getCol(r,["MA_DUONG_DAY"]), cSid=getCol(r,["MA_DOAN"]), cStt=getCol(r,["STT"]); if(cCid && r[cCid] && cSid && r[cSid]) { let cid=r[cCid]; if(!data.circuits[cid]) data.circuits[cid]=[]; data.circuits[cid].push({segId: String(r[cSid]).trim(), order: parseInt(r[cStt]||999)}); } }); for(let k in data.circuits) data.circuits[k].sort((a,b)=>a.order-b.order); window.stagingData = data; document.getElementById('upload-actions').style.display = "block";  return true; }
        function log(msg, clear=false) { let c=document.getElementById('console'); if(clear) c.innerHTML=''; c.innerHTML+=`<div>> ${msg}</div>`; c.scrollTop=c.scrollHeight; }
        function getCol(row, candidates) { let k=Object.keys(row); for(let c of candidates){ let m=k.find(key=>key.trim().replace(/^\uFEFF/,'')===c); if(m) return m; } return null; }
        window.confirmAction = function(mode) { if(mode.includes('upload')) { window.pendingAction={type:'upload', mode:mode.split('_')[1]}; document.getElementById('confirm-msg').innerText="B·∫°n ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán?"; document.getElementById('custom-confirm').style.display='flex'; } }
        window.executeConfirm = function() {
            if(window.pendingAction.type==='upload' && window.stagingData) {
                 const rootRef = window.ref(window.db, 'he_thong_luoi_dien'); const d = window.stagingData;
                 let sequence = Promise.resolve();
                 if(window.pendingAction.mode === 'replace') { sequence = sequence.then(() => window.set(window.child(rootRef, 'poles'), null)).then(() => window.set(window.child(rootRef, 'segments'), null)).then(() => window.set(window.child(rootRef, 'circuits'), null)).then(() => window.set(window.child(rootRef, 'mcStates'), d.mcStates)); }
                 sequence.then(() => window.update(window.child(rootRef, 'poles'), d.poles)).then(() => window.update(window.child(rootRef, 'segments'), d.segments)).then(() => window.update(window.child(rootRef, 'circuits'), d.circuits)).then(() => { if(window.pendingAction.mode === 'merge') window.update(window.child(rootRef, 'mcStates'), d.mcStates); }).then(() => { alert("Th√†nh c√¥ng!"); closeConfirm(); });
            }
        }
        window.closeConfirm = () => document.getElementById('custom-confirm').style.display='none';

    </script>
</body>
</html>
