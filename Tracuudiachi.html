
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u S·ª± c·ªë L∆∞·ªõi ƒëi·ªán v2.2</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: #eef2f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 650px; }
        h2 { margin-top: 0; color: #b71c1c; text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; font-size: 13px; margin-bottom: 20px; font-style: italic; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
        textarea { width: 100%; height: 50px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; }
        input[type="datetime-local"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        
        button { width: 100%; padding: 12px; background-color: #b71c1c; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        button:hover { background-color: #8e1515; }
        button:disabled { background-color: #ccc; }

        #result { margin-top: 25px; display: none; }
        .section-title { font-weight: bold; font-size: 14px; color: #444; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; }
        
        /* Grid Weather */
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .param-box { background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #ccc; }
        .param-label { font-size: 11px; color: #666; text-transform: uppercase; }
        .param-value { font-size: 16px; font-weight: bold; color: #222; margin-top: 2px; }
        .param-unit { font-size: 11px; color: #888; font-weight: normal; }

        /* Report Box */
        .report-box { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 15px; background: #fff; }
        .risk-level { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; margin-bottom: 5px;}
        .risk-high { background-color: #d32f2f; }
        .risk-med { background-color: #f57c00; }
        .risk-low { background-color: #388e3c; }
        
        .report-text { font-size: 14px; color: #333; line-height: 1.5; margin-top: 5px; }

        .loading { text-align: center; color: #666; display: none; margin-top: 10px; }
        .coords-debug { font-family: monospace; font-size: 12px; color: #d32f2f; background: #ffebee; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2>‚ö° Ph√¢n t√≠ch S·ª± c·ªë L∆∞·ªõi ƒëi·ªán</h2>
    <div class="subtitle">Version 2.2: T√≠ch h·ª£p ƒë√°nh gi√° r·ªßi ro S√©t</div>
    
    <div class="form-group">
        <label>1. T·ªça ƒë·ªô s·ª± c·ªë:</label>
        <textarea id="rawCoords" placeholder="V√≠ d·ª•: 10,8238318, 106,7448612"></textarea>
    </div>

    <div class="form-group">
        <label>2. Th·ªùi gian x·∫£y ra (Gi·ªù:Ph√∫t Ng√†y/Th√°ng/NƒÉm):</label>
        <input type="datetime-local" id="queryTime">
    </div>

    <button id="btnSearch" onclick="processAndSearch()">üîç Ph√¢n t√≠ch nguy√™n nh√¢n</button>
    <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ tr·∫°m kh√≠ t∆∞·ª£ng...</div>

    <div id="result">
        <div class="section-title">üìç V·ªã tr√≠ & Th·ªùi gian</div>
        <div id="addressText" style="font-size:14px; margin-bottom:5px;"></div>
        <span id="parsedCoords" class="coords-debug"></span>

        <div class="section-title">üìä S·ªë li·ªáu quan tr·∫Øc</div>
        <div class="weather-grid">
            <div class="param-box" style="border-left-color: #d32f2f;">
                <div class="param-label">Gi√≥ gi·∫≠t (Gusts)</div>
                <div class="param-value"><span id="wGust">--</span> <span class="param-unit">km/h</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">T·ªëc ƒë·ªô gi√≥ TB</div>
                <div class="param-value"><span id="wSpeed">--</span> <span class="param-unit">km/h</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">H∆∞·ªõng gi√≥</div>
                <div class="param-value" style="font-size:14px;"><span id="wDirTxt">--</span></div>
            </div>
            <div class="param-box" style="border-left-color: #1976d2;">
                <div class="param-label">L∆∞·ª£ng m∆∞a</div>
                <div class="param-value"><span id="wRain">--</span> <span class="param-unit">mm</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">Nhi·ªát ƒë·ªô</div>
                <div class="param-value"><span id="wTemp">--</span> <span class="param-unit">¬∞C</span></div>
            </div>
            <div class="param-box">
                <div class="param-label">ƒê·ªô ·∫©m</div>
                <div class="param-value"><span id="wHum">--</span> <span class="param-unit">%</span></div>
            </div>
        </div>

        <div class="section-title">üõ°Ô∏è Nh·∫≠n ƒë·ªãnh kh·∫£ nƒÉng S√©t & S·ª± c·ªë</div>
        
        <div class="report-box" id="lightningReportBox">
            <div id="lightningBadge" class="risk-level risk-low">R·ª¶I RO S√âT: TH·∫§P</div>
            <div id="lightningComment" class="report-text">--</div>
        </div>

        <div class="report-box" id="windReportBox">
            <div id="windBadge" class="risk-level risk-low">R·ª¶I RO GI√ì/M∆ØA: TH·∫§P</div>
            <div id="windComment" class="report-text">--</div>
        </div>

        <div style="font-size: 11px; color: #888; margin-top: 15px; text-align: right;">
            D·ªØ li·ªáu: Open-Meteo Archive API (M√¥ h√¨nh ERA5 Reanalysis).
        </div>
    </div>
</div>

<script>
    window.onload = function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('queryTime').value = now.toISOString().slice(0,16);
    };

    async function processAndSearch() {
        const rawInput = document.getElementById('rawCoords').value;
        const timeInput = document.getElementById('queryTime').value;
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const btn = document.getElementById('btnSearch');

        resultDiv.style.display = 'none';
        
        if (!rawInput.trim()) { alert("Ch∆∞a nh·∫≠p t·ªça ƒë·ªô!"); return; }
        if (!timeInput) { alert("Ch∆∞a ch·ªçn th·ªùi gian!"); return; }

        let lat, lon;
        try {
            let cleanStr = rawInput.trim();
            let parts;
            if (cleanStr.includes('.') && !cleanStr.includes(',,')) { parts = cleanStr.split(/[\s,]+/); } 
            else { 
                if (cleanStr.includes(', ')) { let temp = cleanStr.replace(', ', '|'); parts = temp.split('|'); }
                else { let rawParts = cleanStr.split(','); if (rawParts.length === 4) parts = [rawParts[0]+'.'+rawParts[1], rawParts[2]+'.'+rawParts[3]]; else if (rawParts.length === 2) parts = rawParts; }
            }
            const numbers = parts.map(p => parseFloat(p.replace(/,/g, '.').replace(/[^0-9.-]/g, ''))).filter(n => !isNaN(n));
            if (numbers.length < 2) throw new Error("Format");
            lat = numbers[0]; lon = numbers[1];
        } catch (e) { alert("L·ªói t·ªça ƒë·ªô."); return; }

        document.getElementById('parsedCoords').textContent = `${lat}, ${lon}`;
        loadingDiv.style.display = 'block';
        btn.disabled = true;

        try {
            const addrPromise = fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`, { headers: {'Accept-Language': 'vi'} }).then(res => res.json());
            const weatherPromise = fetchWeather(lat, lon, timeInput);

            const [addrData, weatherData] = await Promise.all([addrPromise, weatherPromise]);

            document.getElementById('addressText').textContent = addrData.display_name || "N/A";

            if (weatherData) {
                // Hi·ªÉn th·ªã s·ªë li·ªáu
                document.getElementById('wTemp').textContent = weatherData.temperature_2m;
                document.getElementById('wHum').textContent = weatherData.relative_humidity_2m;
                document.getElementById('wRain').textContent = weatherData.precipitation;
                document.getElementById('wSpeed').textContent = weatherData.wind_speed_10m;
                document.getElementById('wGust').textContent = weatherData.wind_gusts_10m;
                
                const dir = weatherData.wind_direction_10m;
                document.getElementById('wDirTxt').textContent = `${getWindDirection(dir)} (${dir}¬∞)`;

                // --- LOGIC NH·∫¨N X√âT (ANALYSIS) ---
                analyzeLightning(weatherData.weather_code, weatherData.precipitation);
                analyzeWindFlashover(weatherData.wind_gusts_10m, weatherData.precipitation, weatherData.relative_humidity_2m);
            } else {
                document.getElementById('lightningComment').textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu l·ªãch s·ª≠.";
            }

            resultDiv.style.display = 'block';

        } catch (err) { alert("L·ªói: " + err.message); } 
        finally { loadingDiv.style.display = 'none'; btn.disabled = false; }
    }

    async function fetchWeather(lat, lon, isoTimeStr) {
        const inputDate = new Date(isoTimeStr);
        const today = new Date(); today.setHours(0,0,0,0);
        const dateStr = isoTimeStr.split('T')[0];
        const isPast = inputDate < today;
        
        const params = "hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,precipitation";
        let url = isPast 
            ? `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&${params}&timezone=auto`
            : `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${dateStr}&end_date=${dateStr}&${params}&timezone=auto`;

        const res = await fetch(url);
        const data = await res.json();
        if (!data.hourly) return null;
        const hourIndex = inputDate.getHours();
        return {
            temperature_2m: data.hourly.temperature_2m[hourIndex],
            relative_humidity_2m: data.hourly.relative_humidity_2m[hourIndex],
            weather_code: data.hourly.weather_code[hourIndex],
            wind_speed_10m: data.hourly.wind_speed_10m[hourIndex],
            wind_direction_10m: data.hourly.wind_direction_10m[hourIndex],
            wind_gusts_10m: data.hourly.wind_gusts_10m[hourIndex],
            precipitation: data.hourly.precipitation[hourIndex]
        };
    }

    // --- LOGIC CHUY√äN GIA ---
    function analyzeLightning(code, rain) {
        const badge = document.getElementById('lightningBadge');
        const text = document.getElementById('lightningComment');
        
        // M√£ WMO: 95, 96, 99 l√† Thunderstorm
        // M√£ 80, 81, 82 l√† M∆∞a r√†o (Showers) - th∆∞·ªùng l√† ti·ªÅn ƒë·ªÅ c·ªßa d√¥ng
        
        if ([95, 96, 99].includes(code)) {
            badge.className = "risk-level risk-high";
            badge.textContent = "R·ª¶I RO: CAO (ƒê√É C√ì D√îNG)";
            text.innerHTML = `‚ö†Ô∏è <b>Ph√°t hi·ªán ho·∫°t ƒë·ªông D√¥ng/S√©t (Thunderstorm).</b><br>D·ªØ li·ªáu ghi nh·∫≠n m√£ th·ªùi ti·∫øt ${code}. Kh·∫£ nƒÉng r·∫•t cao s·ª± c·ªë do s√©t ƒë√°nh tr·ª±c ti·∫øp v√†o ƒë∆∞·ªùng d√¢y ho·∫∑c s√©t lan truy·ªÅn g√¢y qu√° ƒëi·ªán √°p.`;
        } else if ([80, 81, 82].includes(code) || (rain > 5 && [61, 63, 65].includes(code))) {
            badge.className = "risk-level risk-med";
            badge.textContent = "R·ª¶I RO: TRUNG B√åNH";
            text.innerHTML = `‚ö†Ô∏è <b>M∆∞a r√†o n·∫∑ng h·∫°t/M∆∞a l·ªõn.</b><br>M√£ th·ªùi ti·∫øt ${code}. Tuy ch∆∞a kh·∫≥ng ƒë·ªãnh c√≥ s·∫•m ch·ªõp, nh∆∞ng ƒëi·ªÅu ki·ªán kh√≠ quy·ªÉn b·∫•t ·ªïn ƒë·ªãnh. C·∫ßn ki·ªÉm tra k·ªπ d·∫•u v·∫øt ph√≥ng ƒëi·ªán tr√™n s·ª© c√°ch ƒëi·ªán.`;
        } else {
            badge.className = "risk-level risk-low";
            badge.textContent = "R·ª¶I RO: TH·∫§P";
            text.innerHTML = `Th·ªùi ti·∫øt ghi nh·∫≠n m√£ ${code}. Ch·ªß y·∫øu l√† m∆∞a nh·ªè ho·∫∑c kh√¥ng m∆∞a. √çt c√≥ kh·∫£ nƒÉng s·ª± c·ªë do s√©t ƒë√°nh, tr·ª´ khi l√† "s√©t ƒë√°nh gi·ªØa tr·ªùi quang" (hi·∫øm g·∫∑p).`;
        }
    }

    function analyzeWindFlashover(gust, rain, humidity) {
        const badge = document.getElementById('windBadge');
        const text = document.getElementById('windComment');
        
        // Gi√≥ gi·∫≠t > 60km/h l√† nguy hi·ªÉm cho l∆∞·ªõi ƒëi·ªán (C·∫•p 7-8)
        let risk = 0; // 0: Low, 1: Med, 2: High
        let causes = [];

        if (gust >= 60) { risk = 2; causes.push("Gi√≥ l·ªëc m·∫°nh g√¢y ƒë·ªï c√¢y/rung l·∫Øc d√¢y"); }
        else if (gust >= 40) { risk = 1; causes.push("Gi√≥ gi·∫≠t kh√° m·∫°nh"); }

        if (rain > 0 && humidity > 90) {
            // M∆∞a + ·∫®m cao
            if (gust >= 30) { 
                risk = Math.max(risk, 1); 
                causes.push("M∆∞a k√®m gi√≥ l√†m ∆∞·ªõt s·ª©, gi·∫£m d√≤ng r√≤ (Flashover)"); 
            }
        }

        if (risk === 2) {
            badge.className = "risk-level risk-high";
            badge.textContent = "NGUY C∆† S·ª∞ C·ªê C∆† H·ªåC: CAO";
            text.innerHTML = `üõë <b>C·∫£nh b√°o nghi√™m tr·ªçng:</b> ${causes.join(" + ")}. T·ªëc ƒë·ªô gi√≥ gi·∫≠t ${gust} km/h c√≥ th·ªÉ g√¢y ƒë·ª©t d√¢y ho·∫∑c ƒë·ªï v·∫≠t th·ªÉ v√†o ƒë∆∞·ªùng d√¢y.`;
        } else if (risk === 1) {
            badge.className = "risk-level risk-med";
            badge.textContent = "NGUY C∆†: TRUNG B√åNH";
            text.innerHTML = `‚ö†Ô∏è <b>L∆∞u √Ω:</b> ${causes.join(". ")}. C·∫ßn ki·ªÉm tra h√†nh lang tuy·∫øn xem c√≥ c√¢y c·ªëi va qu·∫πt do gi√≥ kh√¥ng.`;
        } else {
            badge.className = "risk-level risk-low";
            badge.textContent = "NGUY C∆† C∆† H·ªåC: TH·∫§P";
            text.innerHTML = `Gi√≥ gi·∫≠t ${gust} km/h ·ªü m·ª©c an to√†n. √çt kh·∫£ nƒÉng s·ª± c·ªë do l·ª±c t√°c ƒë·ªông c·ªßa gi√≥.`;
        }
    }

    function getWindDirection(deg) {
        const dirs = ["B·∫Øc (N)", "ƒê√¥ng B·∫Øc (NE)", "ƒê√¥ng (E)", "ƒê√¥ng Nam (SE)", "Nam (S)", "T√¢y Nam (SW)", "T√¢y (W)", "T√¢y B·∫Øc (NW)"];
        return dirs[Math.round(deg / 45) % 8];
    }
</script>

</body>
</html>
