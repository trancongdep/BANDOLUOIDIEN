<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>H·ªá Th·ªëng L∆∞·ªõi ƒêi·ªán - Version 1.56</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* CSS CHU·∫®N */
        html, body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100%; width: 100%; overflow: hidden; background: #f0f2f5; }
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 1; }

        /* SIDEBAR */
        #sidebar { 
            position: fixed; top: 0; left: -100%; width: 90%; max-width: 450px; 
            bottom: calc(30px + env(safe-area-inset-bottom, 10px)); 
            background: white; z-index: 3000; box-shadow: 2px 0 10px rgba(0,0,0,0.3); 
            transition: left 0.3s ease-in-out; display: flex; flex-direction: column; 
        }
        #sidebar.active { left: 0; }
        .header { background: #004d40; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header h2 { margin: 0; font-size: 1.1rem; }
        .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .content { padding: 10px; overflow-y: auto; flex: 1; background: #fafafa; }
        
        /* FOOTER & BUTTONS */
        #menu-toggle { position: absolute; top: 10px; left: 10px; z-index: 2000; background: #004d40; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; }
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; min-height: 30px; padding-top: 5px; padding-bottom: env(safe-area-inset-bottom, 10px); background: #212121; color: #eceff1; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; border-top: 3px solid #ff6f00; z-index: 4000; }

        /* ACCORDION */
        .accordion { background-color: #eee; color: #444; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left; outline: none; font-size: 0.95rem; font-weight: bold; transition: 0.4s; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .accordion.active, .accordion:hover { background-color: #ccc; }
        .accordion:after { content: '\002B'; font-weight: bold; float: right; margin-left: 5px; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 10px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border-bottom: 1px solid #ddd; }

        /* CONTROLS & INPUTS */
        label { font-weight: 600; font-size: 0.85rem; display: block; margin: 8px 0 4px; color: #333; }
        input, select { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button.action-btn { padding: 10px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 10px; color: white; background: #00796b; transition: 0.2s; }
        
        /* N√öT G·ªòP/X√ìA C√ôNG H√ÄNG */
        .btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-row button { margin-bottom: 0; flex: 1; }
        .btn-merge { background: #2e7d32; }
        .btn-replace { background: #c62828; }

        .btn-add { background: #1565c0; margin-top: 10px; margin-bottom: 25px !important; }
        .btn-pick { background: #ff9800; color: white; width: auto; padding: 5px 10px; font-size: 0.8rem; margin-left: 5px; }
        .btn-draw-control { background: #607d8b; width: 48%; display: inline-block; margin-right: 2%; font-size: 0.85rem; }
        .btn-export { background: #2e7d32; margin-top: 5px; }
        
        /* TABS */
        .tab-container { display: flex; margin-bottom: 10px; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; font-size: 0.8rem; }
        .tab-btn.active { color: #004d40; border-bottom: 3px solid #004d40; }
        .edit-section { display: none; padding-bottom: 15px; }
        .edit-section.active { display: block; }

        #console { background: #212121; color: #00e676; font-family: monospace; padding: 10px; border-radius: 4px; font-size: 0.75rem; height: 100px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #444; }
        #upload-actions { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        /* LEGEND & FAULT */
        .legend { background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); font-size: 0.75rem; min-width: 130px; display: block; margin-right: 10px; margin-bottom: calc(45px + env(safe-area-inset-bottom, 10px)) !important; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-icon { width: 14px; height: 14px; margin-right: 6px; border: 1px solid #999; }
        .fault-box { display: none; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); border-left: 5px solid #d32f2f; width: 260px; font-size: 0.9rem; margin-right: 10px; margin-bottom: calc(45px + env(safe-area-inset-bottom, 10px)) !important; }
        .fault-header { color: #d32f2f; font-weight: bold; font-size: 1rem; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .btn-close-fault { background: #eee; border: none; padding: 2px 8px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        
        #custom-confirm { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .win-dialog { background: #f0f0f0; width: 90%; max-width: 400px; border-radius: 4px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: popIn 0.2s ease-out; }
        .win-header { background: white; padding: 10px 15px; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #ddd; }
        .win-body { padding: 20px; background: white; display: flex; align-items: center; gap: 15px; }
        .win-footer { padding: 10px 15px; background: #f3f3f3; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #ddd; }
        .win-btn { padding: 6px 20px; border: 1px solid #ccc; cursor: pointer; }
        .win-btn.primary { background: #0078d7; color: white; border-color: #005a9e; }

        /* ICONS */
        .icon-source { border-radius: 50%; border: 2px solid white; color: white; font-weight: bold; font-size: 10px; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 5px rgba(0,0,0,0.5); z-index: 2000 !important; }
        .icon-mc-on { background: #d32f2f; border: 2px solid white; border-radius: 2px; font-size: 9px; color: white; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); text-align:center; font-weight: bold; }
        .icon-mc-off { background: #388e3c; border: 2px solid white; border-radius: 2px; font-size: 9px; color: white; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); text-align:center; font-weight: bold; }
        .icon-tru-neo { background: #ff6f00; transform: rotate(45deg); border-radius: 2px; border: 1px solid white; width: 10px; height: 10px; }
        .icon-tru-do { background: #1976d2; border-radius: 50%; border: 1px solid white; width: 8px; height: 8px; }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="menu-toggle" onclick="openSidebar()"><i class="fas fa-bars"></i> MENU</button>

    <div id="custom-confirm">
        <div class="win-dialog">
            <div class="win-header"><span>X√°c nh·∫≠n</span><button style="border:none;background:none;font-size:1.2rem;cursor:pointer;" onclick="closeWinDialog()">√ó</button></div>
            <div class="win-body"><i class="fas fa-question-circle win-icon"></i><span id="win-msg">...</span></div>
            <div class="win-footer"><button class="win-btn primary" id="win-btn-yes">ƒê·ªìng √Ω</button><button class="win-btn" onclick="closeWinDialog()">H·ªßy</button></div>
        </div>
    </div>

    <div id="sidebar">
        <div class="header"><h2>H·ªÜ TH·ªêNG ƒêI·ªÜN V1.56</h2><button class="close-btn" onclick="closeSidebar()">√ó</button></div>
        <div class="content">
            <button class="accordion">1. C·∫≠p nh·∫≠t & Xu·∫•t Excel</button>
            <div class="panel" id="panel-update">
                <label>Nh·∫≠p t·ª´ File Excel:</label>
                <input type="file" id="excelFile" accept=".csv, .xlsx" multiple />
                <button class="action-btn" onclick="window.analyzeFiles()">N·∫°p & Ki·ªÉm tra</button>
                <div id="console">S·∫µn s√†ng...</div>
                <div id="upload-actions" style="display:none;">
                    <div class="btn-row">
                        <button class="action-btn btn-merge" onclick="window.showUploadConfirm('merge')">G·ªòP D·ªÆ LI·ªÜU</button>
                        <button class="action-btn btn-replace" onclick="window.showUploadConfirm('replace')">X√ìA & GHI M·ªöI</button>
                    </div>
                </div>
                <hr>
                <button class="action-btn btn-export" onclick="window.exportToExcel()">XU·∫§T RA EXCEL</button>
            </div>

            <button class="accordion">2. Nh·∫≠p li·ªáu (Th√™m m·ªõi)</button>
            <div class="panel" id="panel-entry">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('tab-pole')">ƒêi·ªÉm</button>
                    <button class="tab-btn" onclick="switchTab('tab-seg')">ƒêo·∫°n</button>
                    <button class="tab-btn" onclick="switchTab('tab-cir')">M·∫°ch</button>
                    <button class="tab-btn" onclick="switchTab('tab-area')">V√πng</button>
                </div>
                <div id="tab-pole" class="edit-section active">
                    <label>T√™n Tuy·∫øn:</label><input type="text" id="inp-pole-route" placeholder="VD: MAYCAT">
                    <label>T√™n ƒêi·ªÉm (Tr·ª•/MC):</label><input type="text" id="inp-pole-name" placeholder="VD: MC_171">
                    <label>Lo·∫°i:</label><select id="inp-pole-type"><option value="TRU_DO">Tr·ª• ƒê·ª°</option><option value="TRU_NEO">Tr·ª• N√©o</option><option value="MC">M√°y C·∫Øt</option><option value="NGUON">Ngu·ªìn</option><option value="THANH_CAI">Thanh C√°i</option></select>
                    <label>ƒêi·ªán √°p:</label><input type="number" id="inp-pole-volt">
                    <label>T·ªça ƒë·ªô: <button class="btn-pick" onclick="enableMapPick('pole')">üìç Ch·∫•m b·∫£n ƒë·ªì</button></label>
                    <div style="display:flex;gap:5px;"><input type="number" id="inp-lat" placeholder="Lat"><input type="number" id="inp-lng" placeholder="Lng"></div>
                    <button class="action-btn btn-add" onclick="window.savePole()">L∆ØU ƒêI·ªÇM</button>
                </div>
                <div id="tab-seg" class="edit-section">
                    <label>M√£ ƒêo·∫°n:</label><input type="text" id="inp-seg-id">
                    <label>ƒêi·ªÉm ƒê·∫¶U:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line1" onchange="updatePoleSelect('sel-seg-line1','sel-seg-pole1')"></select><select id="sel-seg-pole1"></select></div>
                    <label>ƒêi·ªÉm CU·ªêI:</label><div style="display:flex;gap:5px;"><select id="sel-seg-line2" onchange="updatePoleSelect('sel-seg-line2','sel-seg-pole2')"></select><select id="sel-seg-pole2"></select></div>
                    <label>Lo·∫°i:</label><select id="inp-seg-type"><option value="NOI">D√¢y N·ªïi</option><option value="NGAM">C√°p Ng·∫ßm</option><option value="THANH_CAI">Thanh C√°i (ƒêo·∫°n)</option></select>
                    <button class="action-btn btn-add" onclick="window.saveSegment()">L∆ØU ƒêO·∫†N</button>
                </div>
                <div id="tab-cir" class="edit-section">
                    <label>T√™n M·∫°ch:</label><input type="text" id="inp-cir-id" list="list-circuits"><datalist id="list-circuits"></datalist>
                    <label>Ch·ªçn ƒêo·∫°n:</label><select id="sel-cir-seg"></select>
                    <button class="action-btn btn-add" onclick="window.saveCircuitItem()">TH√äM</button>
                </div>
                <div id="tab-area" class="edit-section">
                    <label>T√™n V√πng:</label><input type="text" id="inp-area-name"><label>Lo·∫°i:</label><select id="inp-area-type"><option value="TBA">Tr·∫°m Bi·∫øn √Åp</option><option value="BUILDING">Nh√†/C√¥ng tr√¨nh</option><option value="FOUNDATION">M√≥ng/H·∫ßm</option></select>
                    <div style="margin:10px 0;"><button class="btn-pick btn-draw-control" onclick="startAreaDraw()">‚úèÔ∏è V·∫Ω</button><button class="btn-pick btn-draw-control" style="background:#fbc02d;color:black;" onclick="undoAreaPoint()">‚Ü©Ô∏è X√≥a ƒëi·ªÉm</button></div>
                    <button class="action-btn btn-add" onclick="saveArea()">L∆ØU V√ôNG</button>
                </div>
            </div>

            <button class="accordion">3. V·∫≠n h√†nh & T√¨m S·ª± C·ªë</button>
            <div class="panel">
                <label>Ch·ªçn M·∫°ch (Zoom & T√≠nh d√†i):</label>
                <select id="circuitSelect" onchange="window.zoomToTarget()"><option value="">-- To√†n c·∫£nh --</option></select>
                <div id="circuit-info" style="font-size:0.9rem; color:#00695c; margin-top:5px; font-weight:bold; background:#e8f5e9; padding:5px; border-radius:4px; text-align:center;"></div>
                <div style="border-top:1px dashed #ccc; margin:15px 0;"></div>
                <label>Nh·∫≠p Km s·ª± c·ªë:</label><input type="number" id="faultKm" step="0.01" />
                <div class="radio-group"><label><input type="radio" name="faultDir" value="start" checked> T·ª´ ƒê·∫ßu</label><label><input type="radio" name="faultDir" value="end"> T·ª´ Cu·ªëi</label></div>
                <button class="action-btn btn-find" onclick="window.findFault()">T√åM V·ªä TR√ç</button>
                <div id="result" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div class="footer">Copyright TCD software @2026 - Version 1.56</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylineoffset@1.1.1/leaflet.polylineoffset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, push, child, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app); window.set = set; window.update = update; window.ref = ref; window.onValue = onValue; window.push = push; window.child = child; window.get = get;
        window.listenCloud();
    </script>

    <script>
        // INIT MAP (DEEP ZOOM)
        let map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([16.0, 106.0], 6);
        L.control.zoom({ position: 'topright' }).addTo(map);
        
        L.Control.Extent = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                var btn = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                btn.innerHTML = '<a href="#" title="To√†n b·ªô" style="background:white;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:18px;color:black;"><i class="fas fa-globe"></i></a>';
                btn.onclick = (e) => { e.preventDefault(); if(appData.poles) { let b=[]; for(let k in appData.poles) appData.poles[k].forEach(p=>b.push([p.lat,p.lng])); if(b.length) map.fitBounds(b); }};
                return btn;
            }
        });
        map.addControl(new L.Control.Extent());
        
        // MaxNativeZoom 19 allows deep zooming by scaling up tiles
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri', maxNativeZoom: 19, maxZoom: 22}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {opacity:0.4, maxNativeZoom: 19, maxZoom: 22}).addTo(map);

        map.createPane('busbarPane'); map.getPane('busbarPane').style.zIndex = 400;
        map.createPane('linePane'); map.getPane('linePane').style.zIndex = 450;

        let layers = { areas: L.layerGroup().addTo(map), busbar: L.layerGroup().addTo(map), line: L.layerGroup().addTo(map), highlight: L.layerGroup().addTo(map), points: L.layerGroup().addTo(map), mc: L.layerGroup().addTo(map), source: L.layerGroup().addTo(map), fault: L.layerGroup().addTo(map) };
        let appData = { poles: {}, segments: {}, circuits: {}, mcStates: {}, areas: [] };
        let stagingData = null; let globalPoleMap = {};
        let currentPath = []; let currentPathTotalDist = 0; let pickingMode = null; let tempAreaPoints = []; let tempAreaPoly = null; let isPickingMap = false; let activeBusbars = {};
        const VOLTAGE_COLORS = { 500: '#2196F3', 220: '#F44336', 110: '#2E7D32', 35: '#FF9800', 22: '#FFC107', 0: '#000000', 'DEFAULT': '#607D8B' };

        // ZOOM VISIBILITY
        map.on('zoomend', () => {
            let z = map.getZoom();
            if (z < 15) { if (map.hasLayer(layers.points)) map.removeLayer(layers.points); } 
            else { if (!map.hasLayer(layers.points)) map.addLayer(layers.points); }
        });

        // UI & ACCORDION EXCLUSIVE LOGIC
        function openSidebar() { document.getElementById('sidebar').classList.add('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
        document.getElementById('menu-toggle').onclick = openSidebar;
        document.querySelector('.close-btn').onclick = closeSidebar;

        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                // Close other panels
                for (var j = 0; j < acc.length; j++) {
                    if (acc[j] !== this) {
                        acc[j].classList.remove("active");
                        acc[j].nextElementSibling.style.maxHeight = null;
                    }
                }
                // Toggle current
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) panel.style.maxHeight = null; else panel.style.maxHeight = (panel.scrollHeight + 100) + "px";
            });
        }
        function refreshPanelHeight(pid) { let p=document.getElementById(pid); if(p && p.style.maxHeight) p.style.maxHeight = (p.scrollHeight+100)+"px"; }
        window.switchTab = function(tabId) { document.querySelectorAll('.edit-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById(tabId).classList.add('active'); event.target.classList.add('active'); refreshDropdowns(); refreshPanelHeight('panel-entry'); }
        window.enableMapPick = function(mode) { pickingMode = mode; closeSidebar(); if(mode==='pole') { let btn=document.querySelector('.btn-pick'); btn.innerText="ƒêang ch·ªçn..."; btn.style.background="red"; } }
        map.on('click', function(e) { if(pickingMode === 'pole') { document.getElementById('inp-lat').value = e.latlng.lat.toFixed(6); document.getElementById('inp-lng').value = e.latlng.lng.toFixed(6); pickingMode = null; document.querySelector('.btn-pick').innerText = "üìç Ch·∫•m b·∫£n ƒë·ªì"; document.querySelector('.btn-pick').style.background = "#ff9800"; openSidebar(); alert("ƒê√£ l·∫•y t·ªça ƒë·ªô!"); } else if (pickingMode === 'area') { tempAreaPoints.push([e.latlng.lat, e.latlng.lng]); drawTempPoly(); } else { closeSidebar(); } });
        window.startAreaDraw = function() { pickingMode='area'; tempAreaPoints=[]; if(tempAreaPoly) map.removeLayer(tempAreaPoly); closeSidebar(); }
        function drawTempPoly() { if(tempAreaPoly) map.removeLayer(tempAreaPoly); if(tempAreaPoints.length>0) tempAreaPoly=L.polygon(tempAreaPoints,{color:'red',dashArray:'5,5'}).addTo(map); }
        window.undoAreaPoint = function() { tempAreaPoints.pop(); drawTempPoly(); }
        window.saveArea = function() { /* ... */ }

        // --- IMPORT LOGIC ---
        function getCol(row, candidates) { 
            let k = Object.keys(row); 
            for(let c of candidates){ 
                let m = k.find(key => key.trim().toUpperCase().replace(/^\uFEFF/,'').includes(c)); 
                if(m) return m; 
            } 
            return null; 
        }

        window.analyzeFiles = function() {
            const input = document.getElementById('excelFile');
            const consoleBox = document.getElementById('console');
            consoleBox.innerHTML = ""; // Clear console on new load
            
            if(!input.files.length) return alert("Ch∆∞a ch·ªçn file");
            
            consoleBox.innerHTML = "ƒêang ƒë·ªçc file...";
            Promise.all(Array.from(input.files).map(readFile)).then(res => processSheets(Object.assign({}, ...res)));
        }
        function readFile(file) { return new Promise(r => { const rd=new FileReader(); rd.onload=e=>{ const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); let s={}; w.SheetNames.forEach(n=>s[n]=XLSX.utils.sheet_to_json(w.Sheets[n])); r(s); }; rd.readAsArrayBuffer(file); }); }

        function processSheets(sheets) {
            const sPoles = Object.keys(sheets).find(n=>n.toUpperCase().includes("TOA_DO"));
            const sSegs = Object.keys(sheets).find(n=>n.toUpperCase().includes("DM_DOAN"));
            const sCircs = Object.keys(sheets).find(n=>n.toUpperCase().includes("CAU_HINH"));

            if(!sPoles) return alert("Thi·∫øu sheet TOA_DO");
            if(!sSegs) return alert("Thi·∫øu sheet DM_DOAN");

            let data = { poles: {}, segments: {}, circuits: {}, mcStates: {} };
            let countP = 0, countS = 0, countC = 0;
            globalPoleMap = {};

            // 1. POLES
            let pRows = sheets[sPoles];
            if(pRows.length > 0) {
                let h = pRows[0];
                let kMa = getCol(h, ["MA_TUYEN", "TUYEN"]);
                let kTen = getCol(h, ["TEN_DIEM", "TEN_TRU", "TRU"]);
                let kLat = getCol(h, ["LAT", "VI_DO"]);
                let kLng = getCol(h, ["LONG", "KINH_DO", "LNG"]);
                let kLoai = getCol(h, ["LOAI_DIEM", "LOAI", "TYPE"]);
                let kVol = getCol(h, ["DIEN_AP", "VOLTAGE"]);

                pRows.forEach(r => {
                    let l = kMa ? String(r[kMa]||"OTHER").trim().replace(/[.#$/\[\]]/g, "_") : "OTHER";
                    let n = kTen ? String(r[kTen]).trim().replace(/[.#$/\[\]]/g, "_") : "UNKNOWN";
                    let lat = parseFloat(String(r[kLat]).replace(',','.'));
                    let lng = parseFloat(String(r[kLng]).replace(',','.'));
                    let type = (kLoai && r[kLoai]) ? String(r[kLoai]).trim().toUpperCase() : "TRU_DO";
                    let volt = (kVol && r[kVol]) ? parseInt(r[kVol]) : 0;

                    if(!isNaN(lat) && !isNaN(lng)) {
                        if(!data.poles[l]) data.poles[l] = [];
                        let num = parseInt((n.match(/\d+/) || [0])[0]);
                        let pObj = { name:n, lat:lat, lng:lng, type:type, voltage:volt, line:l, sort:num };
                        data.poles[l].push(pObj);
                        globalPoleMap[n] = pObj; globalPoleMap[l+"_"+n] = pObj;
                        if(type==='MC') data.mcStates[n] = true;
                        countP++;
                    }
                });
                for(let l in data.poles) data.poles[l].sort((a,b)=>a.sort-b.sort);
            }

            // 2. SEGMENTS
            let sRows = sheets[sSegs];
            let segmentMapLocal = {};
            if(sRows.length > 0) {
                let h = sRows[0];
                let kId = getCol(h, ["MA_DOAN", "ID"]);
                let kT1 = getCol(h, ["TUYEN_TU", "FROM_LINE"]);
                let kN1 = getCol(h, ["TRU_TU", "DIEM_TU", "FROM"]);
                let kT2 = getCol(h, ["TUYEN_DEN", "TO_LINE"]);
                let kN2 = getCol(h, ["TRU_DEN", "DIEM_DEN", "TO"]);
                let kType = getCol(h, ["LOAI", "TYPE"]);

                sRows.forEach(r => {
                    let id = kId ? String(r[kId]).trim().replace(/[.#$/\[\]]/g, "_") : "SEG_"+countS;
                    let t1 = kT1 ? String(r[kT1]).trim().replace(/[.#$/\[\]]/g, "_") : "";
                    let n1 = kN1 ? String(r[kN1]).trim().replace(/[.#$/\[\]]/g, "_") : "";
                    let t2 = kT2 ? String(r[kT2]).trim().replace(/[.#$/\[\]]/g, "_") : "";
                    let n2 = kN2 ? String(r[kN2]).trim().replace(/[.#$/\[\]]/g, "_") : "";
                    let type = (kType && r[kType]) ? String(r[kType]).trim().toUpperCase() : "NOI";

                    if(n1 && n2) {
                        let segmentsToAdd = [];
                        let p1 = globalPoleMap[t1 + "_" + n1] || globalPoleMap[n1];
                        let p2 = globalPoleMap[t2 + "_" + n2] || globalPoleMap[n2];
                        let split = false;

                        if (p1 && p2 && p1.line === p2.line && t1 === t2) {
                             let linePoles = data.poles[t1];
                             let i1 = linePoles.indexOf(p1), i2 = linePoles.indexOf(p2);
                             if(i1!==-1 && i2!==-1 && Math.abs(i1-i2)>1) {
                                 let start=Math.min(i1,i2), end=Math.max(i1,i2);
                                 for(let i=start; i<end; i++) {
                                     segmentsToAdd.push({
                                         id: `${id}_sub_${i}`, originalId: id, type: type,
                                         fromLine: t1, fromNode: linePoles[i].name,
                                         toLine: t1, toNode: linePoles[i+1].name
                                     });
                                 }
                                 split = true;
                             }
                        }
                        if(!split) segmentsToAdd.push({ id:id, originalId:id, type:type, fromLine:t1, fromNode:n1, toLine:t2, toNode:n2 });

                        segmentMapLocal[id] = [];
                        segmentsToAdd.forEach(s => { data.segments[s.id] = s; segmentMapLocal[id].push(s.id); countS++; });
                    }
                });
            }

            // 3. CIRCUITS
            if(sCircs && sheets[sCircs] && sheets[sCircs].length > 0) {
                let h = sheets[sCircs][0];
                let kCid = getCol(h, ["MA_DUONG_DAY", "MACH"]);
                let kSid = getCol(h, ["MA_DOAN", "DOAN"]);
                let kStt = getCol(h, ["STT"]);

                sheets[sCircs].forEach(r => {
                    let cid = kCid ? String(r[kCid]).trim().replace(/[.#$/\[\]]/g, "_") : "DEFAULT";
                    let sid = kSid ? String(r[kSid]).trim().replace(/[.#$/\[\]]/g, "_") : "";
                    if(sid) {
                        if(!data.circuits[cid]) { data.circuits[cid]=[]; countC++; }
                        let subIds = segmentMapLocal[sid] || [sid];
                        subIds.forEach(subId => {
                            data.circuits[cid].push({ segId: subId, order: parseInt(r[kStt]||999) });
                        });
                    }
                });
            }

            stagingData = data;
            document.getElementById('upload-actions').style.display = "block";
            document.getElementById('console').innerHTML = `‚úÖ K·∫øt qu·∫£ ki·ªÉm tra:<br>- ${countP} ƒêi·ªÉm.<br>- ${countS} ƒêo·∫°n d√¢y.<br>- ${countC} M·∫°ch d√¢y.<br>B·∫•m G·ªôp/Ghi m·ªõi ƒë·ªÉ l∆∞u.`;
            refreshPanelHeight('panel-update');
        }

        function executeUpload(mode) {
            return new Promise((resolve, reject) => {
                if(!stagingData) return reject("Kh√¥ng c√≥ d·ªØ li·ªáu");
                let refRoot = window.ref(window.db, 'he_thong_luoi_dien');
                let cleanData = JSON.parse(JSON.stringify(stagingData)); 
                
                if(mode==='replace') window.set(refRoot, cleanData).then(resolve).catch(reject);
                else {
                    let updates={};
                    Object.keys(cleanData.poles).forEach(k=>updates[`poles/${k}`]=cleanData.poles[k]);
                    Object.keys(cleanData.segments).forEach(k=>updates[`segments/${k}`]=cleanData.segments[k]);
                    if(cleanData.circuits) Object.keys(cleanData.circuits).forEach(k=>updates[`circuits/${k}`]=cleanData.circuits[k]);
                    if(cleanData.mcStates) Object.keys(cleanData.mcStates).forEach(k=>updates[`mcStates/${k}`]=true);
                    window.update(refRoot, updates).then(resolve).catch(reject);
                }
            });
        }

        // --- RENDER & LOGIC ---
        function createIcon(type, name, isClosed=true) {
            let cls='my-icon icon-tru-do', sz=[12,12], html='';
            if(type.includes('MC')) { 
                cls = isClosed?'my-icon icon-mc-on':'my-icon icon-mc-off'; sz=[24,14]; 
                // MC Label: extract 171 from HVG_171
                if (name.includes('_')) html = name.split('_').pop();
                else if (name.match(/\d{3}$/)) html = name.match(/\d{3}$/)[0];
                else html = name.slice(-3);
            }
            else if(type.includes('NEO')) { cls='my-icon icon-tru-neo'; sz=[10,10]; }
            else if(type.includes('MOC')) { cls='my-icon icon-moc'; sz=[8,8]; }
            return L.divIcon({ className: cls, html: html, iconSize: sz });
        }

        // ... (Keep existing logic: buildAdjacencyList, tracePowerFlow, renderMap, listenCloud) ...
        // I will copy them back to ensure full functionality
        
        window.listenCloud = function() { window.onValue(window.ref(window.db,'he_thong_luoi_dien'), snap=>{ let val=snap.val(); if(val){ appData=val; if(!appData.mcStates) appData.mcStates={}; globalPoleMap={}; if(appData.poles) for(let l in appData.poles) appData.poles[l].forEach(p=>{ globalPoleMap[p.name]=p; globalPoleMap[l+"_"+p.name]=p; }); let nodeMap=buildAdjacencyList(); let segColors=tracePowerFlow(nodeMap); calculateOffsets(); renderMap(nodeMap, segColors); updateUI(); } }); }
        function updateUI() { const s=document.getElementById('circuitSelect'); s.innerHTML='<option value="">-- To√†n c·∫£nh --</option>'; if(appData.circuits) Object.keys(appData.circuits).forEach(k=>{ let o=document.createElement('option'); o.value=k; o.text=k; s.add(o); }); refreshDropdowns(); }
        function buildAdjacencyList() { appData.adjList={}; activeBusbars={}; let nodeMap=globalPoleMap; if(appData.segments) Object.values(appData.segments).forEach(seg=>{ if(seg.type==='THANH_CAI'){ let p1=nodeMap[seg.fromLine+"_"+seg.fromNode]||nodeMap[seg.fromNode], p2=nodeMap[seg.toLine+"_"+seg.toNode]||nodeMap[seg.toNode]; if(p1&&p2){ activeBusbars[seg.fromNode]={p1,p2}; activeBusbars[seg.toNode]={p1,p2}; } } if(!appData.adjList[seg.fromNode]) appData.adjList[seg.fromNode]=[]; if(!appData.adjList[seg.toNode]) appData.adjList[seg.toNode]=[]; appData.adjList[seg.fromNode].push({to:seg.toNode, id:seg.id, type:seg.type}); appData.adjList[seg.toNode].push({to:seg.fromNode, id:seg.id, type:seg.type}); }); return nodeMap; }
        function tracePowerFlow(nodeMap) { let segColors={}; if(appData.segments) Object.keys(appData.segments).forEach(k=>segColors[k]=null); let queue=[]; for(let l in appData.poles) appData.poles[l].forEach(p=>{ if(p.type==='NGUON') queue.push({node:p.name, voltage:p.voltage}); }); let visited={}; while(queue.length>0){ let curr=queue.shift(); let u=curr.node, volt=curr.voltage; if(!nodeMap[u]) continue; if(visited[u]>=volt) continue; visited[u]=volt; let neighbors=appData.adjList[u]||[]; neighbors.forEach(edge=>{ let canPass=true; let currNodeInfo=nodeMap[u]; if(currNodeInfo&&currNodeInfo.type==='MC'&&appData.mcStates[u]===false) canPass=false; if(canPass){ if((segColors[edge.id]||0)<volt) segColors[edge.id]=volt; queue.push({node:edge.to, voltage:volt}); } }); } if(appData.segments) Object.values(appData.segments).forEach(seg=>{ if(segColors[seg.id]===null){ let p1=nodeMap[seg.fromLine+"_"+seg.fromNode]||nodeMap[seg.fromNode], p2=nodeMap[seg.toLine+"_"+seg.toNode]||nodeMap[seg.toNode]; let v=(p1&&p1.voltage)?p1.voltage:((p2&&p2.voltage)?p2.voltage:'DEFAULT'); segColors[seg.id]=v; } }); return segColors; }
        let segmentCounts = {};
        function getSegmentKey(p1, p2) { let k1=p1.lat+"_"+p1.lng, k2=p2.lat+"_"+p2.lng; return (k1<k2)?(k1+"|"+k2):(k2+"|"+k1); }
        function calculateOffsets() { segmentCounts={}; if(appData.circuits) Object.keys(appData.circuits).forEach(cid=>{ appData.circuits[cid].forEach(item=>{ let def=appData.segments[item.segId]; if(def){ let p1=globalPoleMap[def.fromLine+"_"+def.fromNode]||globalPoleMap[def.fromNode], p2=globalPoleMap[def.toLine+"_"+def.toNode]||globalPoleMap[def.toNode]; if(p1&&p2){ let k=getSegmentKey(p1,p2); if(!segmentCounts[k]) segmentCounts[k]=[]; segmentCounts[k].push(cid); } } }); }); }
        function getProjectedPoint(P, A, B) { let x=P.lng, y=P.lat, x1=A.lng, y1=A.lat, x2=B.lng, y2=B.lat; let A_to_P={x:x-x1, y:y-y1}, A_to_B={x:x2-x1, y:y2-y1}; let AB_sq=A_to_B.x*A_to_B.x+A_to_B.y*A_to_B.y; if(AB_sq===0) return A; let t=Math.max(0,Math.min(1,(A_to_P.x*A_to_B.x+A_to_P.y*A_to_B.y)/AB_sq)); return {lat:y1+t*A_to_B.y, lng:x1+t*A_to_B.x}; }

        function renderMap(nodeMap, segColors) { Object.values(layers).forEach(l=>l.clearLayers()); updateLayerVisibility(); if(appData.areas) appData.areas.forEach(a=>{ let c='#9e9e9e'; if(a.type==='TBA') c='#ff9800'; L.polygon(a.points,{color:c,fillColor:c,fillOpacity:0.3,weight:1}).addTo(layers.areas).bindPopup(`<b>${a.name}</b><br>${a.type}`); }); for(let l in appData.poles) appData.poles[l].forEach(p=>{ let type=p.type, target=null, icon=null, zIdx=0; if(type==='NGUON'){ target=layers.source; zIdx=2000; icon=L.divIcon({className:'', html:`<div class="icon-source" style="background:${VOLTAGE_COLORS[p.voltage]||'#607D8B'};width:24px;height:24px;">${p.voltage}</div>`, iconSize:[24,24]}); } else if(type==='MC'){ target=layers.mc; let isOn=appData.mcStates[p.name]!==false; icon=createIcon(p.type, p.name, isOn); } else if(type!=='THANH_CAI'&&type!=='DIEM_NOI'){ if(map.getZoom()>=15){ target=layers.points; icon=createIcon(p.type, p.name); } } if(target&&icon){ let m=L.marker([p.lat,p.lng],{icon, zIndexOffset:zIdx}).addTo(target); if(type==='MC') m.on('click',()=>window.showMCConfirm(p.name)); else m.bindPopup(`<b>${p.name}</b><br>${l}`); } }); if(appData.segments) Object.values(appData.segments).forEach(seg=>{ let p1=nodeMap[seg.fromLine+"_"+seg.fromNode]||nodeMap[seg.fromNode], p2=nodeMap[seg.toLine+"_"+seg.toNode]||nodeMap[seg.toNode]; if(!p1||!p2) return; let color=VOLTAGE_COLORS[segColors[seg.id]]||'#000'; let weight=3; let points=[[p1.lat,p1.lng],[p2.lat,p2.lng]]; if(seg.type==='THANH_CAI'){ weight=6; L.polyline(points,{color, weight, pane:'busbarPane'}).addTo(layers.busbar); return; } let busInfo=activeBusbars[seg.fromNode]||activeBusbars[seg.toNode]; if(busInfo){ let bn=activeBusbars[seg.fromNode]?p1:p2, on=(bn===p1)?p2:p1; let H=getProjectedPoint(on, busInfo.p1, busInfo.p2); points=[[on.lat,on.lng],[H.lat,H.lng]]; } 
        let offset = 0; let key = getSegmentKey(p1, p2); let list = segmentCounts[key]; if (list && list.length > 1) { let circuitId = null; if(appData.circuits) for(let cid in appData.circuits) if(appData.circuits[cid].find(s=>s.segId===seg.id)) { circuitId=cid; break; } if (circuitId) { let idx = list.indexOf(circuitId); if (idx !== -1) { let center = (list.length - 1) / 2; offset = (idx - center) * 6; } } }
        L.polyline(points,{color, weight, pane:'linePane', offset:offset}).addTo(layers.line); }); }

        function getDist(lat1,lon1,lat2,lon2) { const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
        window.zoomToTarget = function() { let cid=document.getElementById('circuitSelect').value; layers.highlight.clearLayers(); currentPath=[]; currentPathTotalDist=0; document.getElementById('circuit-info').innerText=""; if(!cid) { if(appData.poles) { let b=[]; for(let k in appData.poles) appData.poles[k].forEach(p=>b.push([p.lat,p.lng])); map.fitBounds(b); } return; } if(appData.circuits && appData.circuits[cid]) { let nodeMap=globalPoleMap; let bounds=[]; appData.circuits[cid].forEach(item=>{ let seg=appData.segments[item.segId]; if(seg){ let p1=nodeMap[seg.fromLine+"_"+seg.fromNode]||nodeMap[seg.fromNode], p2=nodeMap[seg.toLine+"_"+seg.toNode]||nodeMap[seg.toNode]; if(p1&&p2){ let dist=getDist(p1.lat,p1.lng,p2.lat,p2.lng); currentPathTotalDist+=dist; if(currentPath.length===0) currentPath.push({lat:p1.lat, lng:p1.lng, accDist:0, name:p1.name}); let lastDist=currentPath[currentPath.length-1].accDist; currentPath.push({lat:p2.lat, lng:p2.lng, accDist:lastDist+dist, name:p2.name}); bounds.push([p1.lat,p1.lng]); bounds.push([p2.lat,p2.lng]); L.polyline([[p1.lat,p1.lng],[p2.lat,p2.lng]], {color:'yellow', weight:6, opacity:0.5}).addTo(layers.highlight); } } }); document.getElementById('circuit-info').innerText=`T·ªïng d√†i: ${(currentPathTotalDist/1000).toFixed(3)} km`; if(bounds.length) map.fitBounds(bounds); } }
        window.findFault = function() { layers.fault.clearLayers(); let km=parseFloat(document.getElementById('faultKm').value); if(isNaN(km)||currentPath.length<2) return alert("Ch·ªçn m·∫°ch!"); let target=km*1000; let dir=document.querySelector('input[name="faultDir"]:checked').value; if(dir==='end') target=currentPathTotalDist-target; if(target<0||target>currentPathTotalDist) return alert("Ngo√†i ph·∫°m vi!"); for(let i=1; i<currentPath.length; i++){ let p1=currentPath[i-1], p2=currentPath[i]; if(target>=p1.accDist && target<=p2.accDist){ let ratio=(target-p1.accDist)/(p2.accDist-p1.accDist); let lat=p1.lat+(p2.lat-p1.lat)*ratio, lng=p1.lng+(p2.lng-p1.lng)*ratio; L.marker([lat,lng], {icon:L.divIcon({html:'<i class="fas fa-bolt" style="color:red;font-size:32px;"></i>', className:''})}).addTo(layers.fault).bindPopup("S·ª∞ C·ªê").openPopup(); map.setView([lat,lng], 16); closeSidebar(); return; } } }
        
        // SAVE & EXPORT (Already defined above or stubs)
        window.savePole = window.savePole || function() {};
        window.saveSegment = window.saveSegment || function() {};
        window.saveCircuitItem = window.saveCircuitItem || function() {};
        window.exportToExcel = window.exportToExcel || function() {};

        // BUTTON HANDLER (Keep Fix)
        let pendingAction = null; 
        window.showMCConfirm = function(mcName) { /* ... */ pendingAction={type:'mc',name:mcName}; document.getElementById('custom-confirm').style.display='flex'; }
        window.showUploadConfirm = function(mode) { /* ... */ pendingAction={type:'upload',mode:mode}; document.getElementById('custom-confirm').style.display='flex'; }
        window.closeWinDialog = function() { document.getElementById('custom-confirm').style.display='none'; }
        document.getElementById('win-btn-yes').onclick = function() {
            let btn = this;
            if(!pendingAction) return;
            let originalText = btn.innerText;
            btn.innerText = "ƒêang x·ª≠ l√Ω...";
            btn.disabled = true;

            if(pendingAction.type==='mc') {
                window.update(window.ref(window.db, 'he_thong_luoi_dien/mcStates'), {[pendingAction.name]: !(appData.mcStates[pendingAction.name]!==false)})
                .then(()=>{ closeWinDialog(); btn.innerText=originalText; btn.disabled=false; })
                .catch(e=>alert(e));
            } else if(pendingAction.type==='upload') {
                executeUpload(pendingAction.mode)
                .then(()=>{ closeWinDialog(); alert("Th√†nh c√¥ng!"); btn.innerText=originalText; btn.disabled=false; })
                .catch(e=>alert("L·ªói: "+e));
            }
        };

    </script>
</body>
</html>
